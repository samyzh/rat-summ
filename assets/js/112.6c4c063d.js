(window.webpackJsonp=window.webpackJsonp||[]).push([[112],{1983:function(t,s,a){"use strict";a.r(s);var n=a(14),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h2",{attrs:{id:"简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[t._v("#")]),t._v(" 简介")]),t._v(" "),n("p",[t._v("MQTT（Message Queuing Telemetry Transport，消息队列遥测传输协议），是一种基于发布/订阅（publish/subscribe）模式的“轻量级”通讯协议，"),n("strong",[t._v("该协议构建于TCP/IP协议上;")])]),t._v(" "),n("p",[n("strong",[t._v("主流的MQTT是基于TCP连接进行数据推送的，但是同样有基于UDP的版本")]),t._v("，叫做MQTT-SN。这两种版本由于基于不同的连接方式，优缺点自然也就各有不同了。除标准版外，还有一个简化版MQTT-SN，该协议主要针对"),n("a",{attrs:{href:"http://lib.csdn.net/base/embeddeddevelopment",target:"_blank",rel:"noopener noreferrer"}},[t._v("嵌入式"),n("OutboundLink")],1),t._v("设备，这些设备一般工作于TCP/IP网络，如：ZigBee。")]),t._v(" "),n("p",[n("strong",[t._v("MQTT最大优点")]),t._v(": "),n("code",[t._v("小型传输，开销很小")]),t._v("（"),n("strong",[t._v("固定长度的头部")]),t._v("是"),n("code",[t._v("2字节")]),t._v("[byte1(8位),byte2(8位)]）协议交换最小化，以降低网络流量。可以以极少的代码和有限的带宽，为连接远程设备提供实时可靠的消息服务。")]),t._v(" "),n("h3",{attrs:{id:"mqtt-5-0-协议新增介绍"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#mqtt-5-0-协议新增介绍"}},[t._v("#")]),t._v(" MQTT 5.0 协议新增介绍")]),t._v(" "),n("p",[t._v("MQTT 5.0 协议相比 MQTT 3.1.1 协议新增了许多内容， 比如说属性，AUTH 包，还有对一些字段做了修改，比如将 Clean Session 修改成 Clean Start 配合 Session Expiry Internal 去实现更灵活的会话控制。")]),t._v(" "),n("p",[t._v("这里就简单罗列一下 5.0 协议新增的内容。")]),t._v(" "),n("ul",[n("li",[t._v("增强了扩展性")]),t._v(" "),n("li",[t._v("改善了错误报告的方式")]),t._v(" "),n("li",[t._v("定型了一些通用范式，例如能力发现和请求、响应")]),t._v(" "),n("li",[t._v("扩展机制包括用户属性(user properties)")]),t._v(" "),n("li",[t._v("性能改善，并且添加了对小客户端（small clients） 的支持")])]),t._v(" "),n("p",[n("strong",[t._v("原因码:")]),t._v(" MQTT v3.1.1 只有寥寥 6 个返回码，用来表示网络连接时可能会出现的异常行为，在引入属性后的 MQTT 5.0 协议中，仅仅这 6 个返回码显然已经不足以用来描述各种异常行为，"),n("strong",[t._v("因此MQTT 5.0 协议中将返回码改成了原因码，用来实现改善错误报告的目的。")])]),t._v(" "),n("h2",{attrs:{id:"基本概念"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#基本概念"}},[t._v("#")]),t._v(" 基本概念")]),t._v(" "),n("ol",[n("li",[n("p",[n("strong",[t._v("MQTT 客户端")])]),t._v(" "),n("blockquote",[n("p",[t._v("一个使用 MQTT 协议的设备、应用程序等，它总是建立到服务器的网络连接。")])]),t._v(" "),n("ul",[n("li",[t._v("可以发布信息，其他客户端可以订阅该信息")]),t._v(" "),n("li",[t._v("订阅其它客户端发布的消息")]),t._v(" "),n("li",[t._v("退订或删除应用程序的消息")]),t._v(" "),n("li",[t._v("断开与服务器连接")])])]),t._v(" "),n("li",[n("p",[n("strong",[t._v("MQTT 服务器")])]),t._v(" "),n("blockquote",[n("p",[t._v("MQTT 服务器以称为 Broker（消息代理），以是一个应用程序或一台设备。它是位于消息发布者 和订阅者之间")])]),t._v(" "),n("ul",[n("li",[t._v("接受来自客户端的网络连接")]),t._v(" "),n("li",[t._v("接受客户端发布的应用信息")]),t._v(" "),n("li",[t._v("处理来自客户端的订阅和退订请求")]),t._v(" "),n("li",[t._v("向订阅的客户转发应用程序消息")])])]),t._v(" "),n("li",[n("p",[n("strong",[t._v("主题（Topic）")])]),t._v(" "),n("blockquote",[n("p",[t._v("连接到一个应用程序消息的标签，该标签与服务器的订阅相匹配。服务器会将消息发送给订阅所匹配标签的每个客户端。")])]),t._v(" "),n("ul",[n("li",[t._v("要订阅的主题。一个主题可以有多个级别，级别之间用斜杠字符分隔。例如，"),n("code",[t._v("/world")]),t._v(" 和 "),n("code",[t._v("emq/emqtt/emqx")]),t._v(" 是有效的主题。")]),t._v(" "),n("li",[t._v("订阅者的Topic name支持通配符#和+ ：\n"),n("ul",[n("li",[t._v("# 支持一个主题内任意级别话题")]),t._v(" "),n("li",[t._v("+只匹配一个主题级别的通配符")])])]),t._v(" "),n("li",[t._v("客户端成功订阅某个主题后，代理会返回一条 SUBACK 消息，其中包含一个或多个 returnCode 参数")])])]),t._v(" "),n("li",[n("p",[n("strong",[t._v("主题筛选器（Topic Filter）")])]),t._v(" "),n("blockquote",[n("p",[t._v("一个对主题名通配符筛选器，在订阅表达式中使用，表示订阅所匹配到的多个主题。")])])]),t._v(" "),n("li",[n("p",[n("strong",[t._v("QoS（消息传递的服务质量水平）")])]),t._v(" "),n("blockquote",[n("p",[t._v("服务质量，标志表明此主题范围内的消息传送到客户端所需的一致程度。")])]),t._v(" "),n("ul",[n("li",[t._v("值 0：不可靠，消息基本上仅传送一次，如果当时客户端不可用，则会丢失该消息。")]),t._v(" "),n("li",[t._v("值 1：消息应传送至少 1 次。")]),t._v(" "),n("li",[t._v("值 2：消息仅传送一次。")])])]),t._v(" "),n("li",[n("p",[n("strong",[t._v("会话（Session）")])]),t._v(" "),n("blockquote",[n("p",[t._v("每个客户端与服务器建立连接后就是一个会话，客户端和服务器之间有状态交互。会话存在于一个网络之间，也可能在客户端和服务器之间跨越多个连续的网络连接。")])])]),t._v(" "),n("li",[n("p",[n("strong",[t._v("订阅（Subscription）")])]),t._v(" "),n("blockquote",[n("p",[t._v("订阅包含主题筛选器（Topic Filter）和最大服务质量（QoS）。订阅会与一个会话（Session）关联。一个会话可以包含多个订阅。每一个会话中的每个订阅都有一个不同的主题筛选器。")])]),t._v(" "),n("ul",[n("li",[t._v("客户端在成功建立TCP连接之后，发送CONNECT消息，在得到服务器端授权允许建立彼此连接的CONNACK消息之后，客户端会发送SUBSCRIBE消息，订阅感兴趣的Topic主题列表（至少一个主题）")]),t._v(" "),n("li",[t._v("订阅的主题名称采用UTF-8编码，然后紧跟着对应的QoS值")])])]),t._v(" "),n("li",[n("p",[n("strong",[t._v("发布（publish）")])]),t._v(" "),n("blockquote",[n("p",[t._v("控制报文是指从客户端向服务端或者服务端向客户端传输一个应用消息，MQTT 客户端发送消息请求，发送完成后返回应用程序线程")])]),t._v(" "),n("ul",[n("li",[t._v("比如安卓的推送服务，还有一些即时通信软件如微信等也是采用的推送技术。")])])]),t._v(" "),n("li",[n("p",[n("strong",[t._v("负载（Payload）")])]),t._v(" "),n("blockquote",[n("p",[t._v("消息订阅者所具体接收的内容")])])])]),t._v(" "),n("h2",{attrs:{id:"mqtt协议的工作方式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#mqtt协议的工作方式"}},[t._v("#")]),t._v(" MQTT协议的工作方式")]),t._v(" "),n("p",[t._v("实现MQTT协议需要客户端和服务器端通讯完成，在通讯过程中，"),n("strong",[t._v("MQTT协议中有三种身份")]),t._v("："),n("code",[t._v("发布者（Publish）")]),t._v("、"),n("code",[t._v("代理（Broker）")]),t._v("、"),n("code",[t._v("（服务器）")]),t._v("、"),n("code",[t._v("订阅者（Subscribe）")]),t._v("。其中，消息的发布者和订阅者都是客户端，消息代理是服务器，消息发布者可以同时是订阅者。")]),t._v(" "),n("p",[n("strong",[t._v("MQTT传输的消息分为")]),t._v("："),n("code",[t._v("主题（Topic）")]),t._v("和"),n("code",[t._v("负载（payload）")]),t._v("两部分：")]),t._v(" "),n("p",[t._v("（1）Topic，可以理解为消息的类型，订阅者订阅（Subscribe）后，就会收到该主题的消息内容（payload）；")]),t._v(" "),n("p",[t._v("（2）payload，可以理解为消息的内容，是指订阅者具体要使用的内容。")]),t._v(" "),n("p",[n("strong",[t._v("除了发布者和订阅者之间传递普通消息，代理还可以为发布者处")]),t._v("理保留消息和遗愿消息**，并可以更改服务质量（QoS）等级。**")]),t._v(" "),n("p",[n("strong",[t._v("Last Will")]),t._v("：即遗言机制，用于通知同一主题下的其他设备发送遗言的设备已经断开了连接。"),n("strong",[t._v("用于判断是否设备在线")])]),t._v(" "),n("h2",{attrs:{id:"mqtt协议数据包结构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#mqtt协议数据包结构"}},[t._v("#")]),t._v(" MQTT协议数据包结构")]),t._v(" "),n("blockquote",[n("p",[n("strong",[t._v("主流的MQTT协议工作在TCP之上")]),t._v("，端和代理之间通过交换预先定义的控制报文来完成通信。")])]),t._v(" "),n("p",[t._v("在MQTT协议中，一个MQTT数据包由：固定头（Fixed header）、可变头（Variable header）、消息体（payload）三部分构成。")]),t._v(" "),n("p",[t._v("**（1）固定头（Fixed header）**存在于所有MQTT数据包中，表示数据包类型及数据包的分组类标识。")]),t._v(" "),n("p",[n("strong",[t._v("（2）可变头（Variable header）"),n("strong",[t._v("存在于部分MQTT数据包中，数据包类型")]),t._v("决定了可变头是否存在及其具体内容。")])]),t._v(" "),n("p",[t._v("**（3）消息体（Payload）**存在于部分MQTT数据包中，表示客户端收到的具体内容。")]),t._v(" "),n("p",[n("strong",[t._v("MQTT报文有3个部分组成")]),t._v("，并按下表顺序出现：")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("固定报头（fixed header）")]),t._v(" "),n("th",[t._v("可变报头（variable header）")]),t._v(" "),n("th",[t._v("荷载（payload）")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("所有报文都包含")]),t._v(" "),n("td",[t._v("部分报文包含")]),t._v(" "),n("td",[t._v("部分报文包含")])])])]),t._v(" "),n("p",[t._v("所有的MQTT控制报文都有一个固定报头，期格式如下：")]),t._v(" "),n("p",[t._v("固定头**固定长度的头部是2字节[byte1(8位),byte2(8位)]**存在于所有MQTT数据包中，其结构如下：\n"),n("img",{attrs:{src:a(950),alt:"18-14-17"}})]),t._v(" "),n("p",[n("img",{attrs:{src:a(951),alt:"18-15-58"}})]),t._v(" "),n("p",[n("strong",[t._v("解释说明")]),t._v("：")]),t._v(" "),n("p",[n("strong",[t._v("MQTT数据包类型")]),t._v(":位置："),n("strong",[t._v("Byte 1")]),t._v("中bits 7-4。相于一个4位的无符号值")]),t._v(" "),n("h3",{attrs:{id:"标识位"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#标识位"}},[t._v("#")]),t._v(" 标识位")]),t._v(" "),n("blockquote",[n("p",[t._v("位置："),n("strong",[t._v("Byte 1")]),t._v("中"),n("strong",[t._v("bits 3-0")]),t._v("。")])]),t._v(" "),n("p",[t._v("在不使用标识位的消息类型中，标识位被作为保留位。如果收到无效的标志时，接收端必须关闭网络连接：")]),t._v(" "),n("p",[t._v("（1）"),n("strong",[t._v("DUP：发布消息的副本")]),t._v("。用来在保证消息的可靠传输，如果设置为1，则在下面的变长中增加MessageId，并且需要回复确认，以保证消息传输完成，但不能用于检测消息重复发送。")]),t._v(" "),n("p",[t._v("（2）"),n("strong",[t._v("QoS：发布消息的服务质量")]),t._v("，即：保证消息传递的次数")]),t._v(" "),n("p",[t._v("​       Ø00：最多一次，即：<=1")]),t._v(" "),n("p",[t._v("​      Ø01：至少一次，即：>=1")]),t._v(" "),n("p",[t._v("​      Ø10：一次，即：=1")]),t._v(" "),n("p",[t._v("​      Ø11：预留")]),t._v(" "),n("p",[t._v("（3）"),n("strong",[t._v("RETAIN： 发布保留标识")]),t._v("，表示服务器要保留这次推送的信息，如果有新的订阅者出现，就把这消息推送给它，如果设有那么推送至当前订阅者后释放。")]),t._v(" "),n("h3",{attrs:{id:"剩余长度-remaining-length"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#剩余长度-remaining-length"}},[t._v("#")]),t._v(" 剩余长度（Remaining Length）")]),t._v(" "),n("blockquote",[n("p",[t._v("地址："),n("strong",[t._v("Byte 2")]),t._v("。")])]),t._v(" "),n("blockquote",[n("p",[t._v("固定头的第二字节用来保存"),n("strong",[t._v("变长头部")]),t._v("和"),n("strong",[t._v("消息体的总大小")]),t._v("的，但不是直接保存的。这一字节是可以扩展，其保存机制，前7位用于保存长度，后一位用做标识。当最后一位为1时，表示长度不足，需要使用二个字节继续保存")])]),t._v(" "),n("h3",{attrs:{id:"mqtt可变头"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#mqtt可变头"}},[t._v("#")]),t._v(" MQTT可变头")]),t._v(" "),n("p",[t._v("MQTT数据包中包含一个可变头，"),n("strong",[t._v("它驻位于固定的头和负载之间")]),t._v("。可变头的内容因数据包类型而不同，"),n("strong",[t._v("较常的应用是作为包的标识")]),t._v("：")]),t._v(" "),n("p",[t._v("很多类型数据包中都包括一个2字节的数据包标识字段，这些类型的包有：")]),t._v(" "),n("p",[t._v("PUBLISH (QoS > 0)、PUBACK、PUBREC、PUBREL、PUBCOMP、SUBSCRIBE、SUBACK、UNSUBSCRIBE、UNSUBACK。")]),t._v(" "),n("h3",{attrs:{id:"mqtt传输的消息"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#mqtt传输的消息"}},[t._v("#")]),t._v(" MQTT传输的消息")]),t._v(" "),n("p",[t._v("在通讯过程中，MQTT协议中有"),n("strong",[t._v("三种身份")]),t._v("："),n("code",[t._v("发布者（Publish）")]),t._v("、"),n("code",[t._v("代理（Broker）（服务器）")]),t._v("、"),n("code",[t._v("订阅者（Subscribe）")]),t._v("。其中，"),n("strong",[t._v("消息的发布者和订阅者都是客户端，消息代理是服务器，消息发布者可以同时是订阅者")]),t._v("。")]),t._v(" "),n("p",[n("strong",[t._v("MQTT传输的消息")]),t._v("分为："),n("code",[t._v("主题（Topic）")]),t._v("和"),n("code",[t._v("负载（payload）")]),t._v("两部分；")]),t._v(" "),n("h4",{attrs:{id:"topic"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#topic"}},[t._v("#")]),t._v(" Topic")]),t._v(" "),n("p",[n("strong",[t._v("匹配规则")])]),t._v(" "),n("p",[t._v("主题(Topic)通过 "),n("code",[t._v("/")]),t._v(" 分割层级，支持 "),n("code",[t._v("+")]),t._v("， "),n("code",[t._v("#")]),t._v(" 通配符: 注:  单层通配符和多层通配符只能用于订阅(subscribe)消息而不能用于发布(publish)消息，层级分隔符两种情况下均可使用。")]),t._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("'+': 表示通配一个层级，例如 a/+，匹配 a/x, a/y\n'#': 表示通配多个层级，例如 a/#，匹配 a/x, a/b/c/d\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br")])]),n("h4",{attrs:{id:"payload消息体-负载"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#payload消息体-负载"}},[t._v("#")]),t._v(" Payload消息体(负载)")]),t._v(" "),n("blockquote",[n("p",[t._v("MQTT传输的消息")])]),t._v(" "),n("p",[t._v("Payload消息体位MQTT数据包的第三部分，包含CONNECT、SUBSCRIBE、SUBACK、UNSUBSCRIBE等类型的消息：")]),t._v(" "),n("p",[t._v("（1）CONNECT，消息体内容主要是：客户端的ClientID、订阅的Topic、Message以及用户名和密码。")]),t._v(" "),n("p",[t._v("（2）SUBSCRIBE，消息体内容是一系列的要订阅的主题以及QoS。")]),t._v(" "),n("p",[t._v("（3）SUBACK，消息体内容是服务器对于SUBSCRIBE所申请的主题及QoS进行确认和回复。")]),t._v(" "),n("p",[t._v("（4）UNSUBSCRIBE，消息体内容是要订阅的主题。")]),t._v(" "),n("h2",{attrs:{id:"控制报文control-packet"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#控制报文control-packet"}},[t._v("#")]),t._v(" 控制报文Control Packet")]),t._v(" "),n("blockquote",[n("p",[t._v("协议版本3定义了14种MQTT报文，用于建立/断开连接、发布消息、订阅消息和维护连接。")]),t._v(" "),n("p",[t._v("固定报头的第一字节的"),n("strong",[t._v("4-7位的值指定了报文类型")]),t._v("，其取值如下表。0和15为系统保留值；0-3位为标志位，依照报文类型有不同的含义，")]),t._v(" "),n("p",[t._v("事实上，除了PUBLISH报文以外，其他报文的标志位均为系统保留。如果收到报文的标志位无效，代理应断开连接。")])]),t._v(" "),n("p",[t._v("通过网络连接发送的信息数据包,"),n("strong",[t._v("也是通讯连接过程")]),t._v("。MQTT规范定义了"),n("strong",[t._v("十四种")]),t._v("不同类型的控制报文，其中一个（PUBLISH报文）用于传输应用消息;  "),n("strong",[t._v("常用的有五种(加粗处理)")]),t._v(":")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("报文类型")]),t._v(" "),n("th",[t._v("值")]),t._v(" "),n("th",[t._v("描述")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("CONNECT")]),t._v(" "),n("td",[t._v("1")]),t._v(" "),n("td",[t._v("客户端向代理发起连接请求")])]),t._v(" "),n("tr",[n("td",[t._v("CONNACK")]),t._v(" "),n("td",[t._v("2")]),t._v(" "),n("td",[t._v("连接确认")])]),t._v(" "),n("tr",[n("td",[t._v("PUBLISH")]),t._v(" "),n("td",[t._v("3")]),t._v(" "),n("td",[t._v("发布消息")])]),t._v(" "),n("tr",[n("td",[t._v("PUBACK")]),t._v(" "),n("td",[t._v("4")]),t._v(" "),n("td",[t._v("发布确认")])]),t._v(" "),n("tr",[n("td",[t._v("PUBREC")]),t._v(" "),n("td",[t._v("5")]),t._v(" "),n("td",[t._v("发布收到（QoS2）")])]),t._v(" "),n("tr",[n("td",[t._v("PUBREL")]),t._v(" "),n("td",[t._v("6")]),t._v(" "),n("td",[t._v("发布释放（QoS2）")])]),t._v(" "),n("tr",[n("td",[t._v("PUBCOMP")]),t._v(" "),n("td",[t._v("7")]),t._v(" "),n("td",[t._v("发布完成（QoS2）")])]),t._v(" "),n("tr",[n("td",[t._v("SUBSCRIBE")]),t._v(" "),n("td",[t._v("8")]),t._v(" "),n("td",[t._v("客户端向代理发起订阅请求")])]),t._v(" "),n("tr",[n("td",[t._v("SUBACK")]),t._v(" "),n("td",[t._v("9")]),t._v(" "),n("td",[t._v("订阅确认")])]),t._v(" "),n("tr",[n("td",[t._v("UNSUBSCRIBE")]),t._v(" "),n("td",[t._v("10")]),t._v(" "),n("td",[t._v("取消订阅")])]),t._v(" "),n("tr",[n("td",[t._v("UNSUBACK")]),t._v(" "),n("td",[t._v("11")]),t._v(" "),n("td",[t._v("取消订阅确认")])]),t._v(" "),n("tr",[n("td",[t._v("PINGREQ")]),t._v(" "),n("td",[t._v("12")]),t._v(" "),n("td",[t._v("PING请求")])]),t._v(" "),n("tr",[n("td",[t._v("PINGRESP")]),t._v(" "),n("td",[t._v("13")]),t._v(" "),n("td",[t._v("PING响应")])]),t._v(" "),n("tr",[n("td",[t._v("DISCONNECT")]),t._v(" "),n("td",[t._v("14")]),t._v(" "),n("td",[t._v("断开连接")])])])]),t._v(" "),n("p",[t._v("固定报头的"),n("strong",[t._v("第二字节起表示报文的剩余长度")]),t._v("。最大4个字节，每字节可以编码至127，并含有一位继续位，如继续位非0，则下一字节依然为剩余长度。由此，理论上一个控制报文最长可以到256MB。")]),t._v(" "),n("p",[t._v("一些报文在固定报头和荷载之间可以有一个可变报头。可变报头的内容根据报文类型不同而不同。"),n("strong",[t._v("最常见的可变报头是报文标识符（PacketIdentifier）。")])]),t._v(" "),n("p",[t._v("一些报文可以在最后携带一个荷载。不同的报文可以无荷载，可选荷载，或必须带有荷载。")]),t._v(" "),n("h2",{attrs:{id:"mqtt协议中的方法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#mqtt协议中的方法"}},[t._v("#")]),t._v(" MQTT协议中的方法")]),t._v(" "),n("p",[t._v("MQTT协议中定义了一些方法（也被称为动作），"),n("strong",[t._v("来于表示对确定资源所进行操作")]),t._v("。"),n("code",[t._v("这个资源可以代表预先存在的数据或动态生成数据，这取决于服务器的实现")]),t._v("。通常来说，资源指服务器上的文件或输出。主要方法有：")]),t._v(" "),n("p",[t._v("（1）Connect。等待与服务器建立连接。")]),t._v(" "),n("p",[t._v("（2）Disconnect。等待MQTT客户端完成所做的工作，并与服务器断开TCP/IP会话。")]),t._v(" "),n("p",[t._v("（3）Subscribe。等待完成订阅。")]),t._v(" "),n("p",[t._v("（4）UnSubscribe。等待服务器取消客户端的一个或多个topics订阅。")]),t._v(" "),n("p",[t._v("（5）Publish。MQTT客户端发送消息请求，发送完成后返回应用程序线程。")]),t._v(" "),n("h2",{attrs:{id:"三种消息发布服务质量"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三种消息发布服务质量"}},[t._v("#")]),t._v(" 三种消息发布服务质量")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("QoS 0："),n("code",[t._v("最多收到一次：数据包被发送，就是这样。没有确认是否已收到。")])])]),t._v(" "),n("li",[n("p",[t._v("QoS 1："),n("code",[t._v("至少接收一次：只要客户端未收到服务器的确认，就会发送和存储数据包。MQTT确保它将被接收，但可能存在重复。")])])]),t._v(" "),n("li",[n("p",[t._v("QoS 2："),n("code",[t._v("只收到一次：与QoS 1相同，但没有重复。")])])])]),t._v(" "),n("p",[n("strong",[t._v("关于数据消耗，显然，QoS 2> QoS 1> QoS 0，如果这是您关心的问题。")])]),t._v(" "),n("p",[n("em",[n("strong",[t._v("QoS Level 0：至多一次")])])]),t._v(" "),n("p",[t._v("这个我理解是如果接收方离线了就不能收到消息，可以用在音视频聊天请求，因为当接收方离线后就不用收到请求了，就算是接收方在线但是没有收到消息也可以通过发送方超时来重发请求。")]),t._v(" "),n("p",[n("em",[n("strong",[t._v("QoS Level 1：至少一次，有可能重复")])])]),t._v(" "),n("p",[t._v("这个可以用在普通文本聊天， 接收方离线后，服务器自动缓存消息，等接收方上线时服务器马上把消息推送给他，就算是接收方重复收包也没关系因为可以通过消息里包含的时间来过滤掉。这个级别的消息服务器得注意限制发送方的消息大小和数量，免得服务器内存被爆掉。")]),t._v(" "),n("p",[n("em",[n("strong",[t._v("QoS Level 2：只有一次，确保消息只到达一次")])])]),t._v(" "),n("p",[t._v("这个用在消息重要性比较严格的场合。IM在一般情况下用不着，或者在用户发生金钱消费有关的情况下可以使用")]),t._v(" "),n("h2",{attrs:{id:"mqtt中间broker"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#mqtt中间broker"}},[t._v("#")]),t._v(" MQTT中间broker")]),t._v(" "),n("p",[t._v("MQTT服务器(Broker)非常多，如apache的ActiveMQ，emtqqd，HiveMQ，Emitter，Mosquitto，Moquette, "),n("strong",[t._v("Mosquitto")]),t._v(","),n("strong",[t._v("RabbitMQ")]),t._v(","),n("strong",[t._v("RocketMQ")]),t._v(",等等。"),n("strong",[t._v("轻量级的mosquitto开源项目是MQTT服务器。")])]),t._v(" "),n("h3",{attrs:{id:"mosquitto"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#mosquitto"}},[t._v("#")]),t._v(" Mosquitto")]),t._v(" "),n("h4",{attrs:{id:"部署"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[t._v("#")]),t._v(" 部署")]),t._v(" "),n("blockquote",[n("p",[t._v("Docker镜像非常小,及使用的人非常多;推荐;[1.6]")])]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("docker pull eclipse-mosquitto:1.6\ndocker pull eclipse-mosquitto\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br")])]),n("p",[n("strong",[t._v("启动")])]),t._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("Three directories have been created "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" the image to be used "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" configuration, persistent storage and logs.\n/mosquitto/config\n/mosquitto/data\n/mosquitto/log\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /mosquitto\ndocker run -it -p "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1883")]),t._v(":1883 -p "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("9001")]),t._v(":9001 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    -v /config/mosquitto.conf:/mosquitto/config/mosquitto.conf "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    -v /mosquitto/data  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    -v /mosquitto/log  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    --name mosquitto "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    eclipse-mosquitto\ndocker run -it -p "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1883")]),t._v(":1883 -p "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("9001")]),t._v(":9001 -v /mosquitto/data -v /mosquitto/log --name mosquitto eclipse-mosquitto\ndocker run --restart"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("always -p "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1883")]),t._v(":1883 -p "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("9001")]),t._v(":9001 -v /mosquitto/data -v /mosquitto/log --name mosquitto eclipse-mosquitto\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#最后使用;start.sh")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" docker run -d --restart"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("always  -p "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1883")]),t._v(":1883 -p "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("9001")]),t._v(":9001 -v /home/samy/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf -v /home/samy/mosquitto/data:/mosquitto/data -v /home/samy/mosquitto/log:/mosquitto/log eclipse-mosquitto\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br")])]),n("p",[n("code",[t._v("mosquitto.conf")]),t._v(":")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("persistence true\npersistence_location /mosquitto/data/\nlog_dest file /mosquitto/log/mosquitto.log\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("p",[t._v("参照：")]),t._v(" "),n("p",[t._v("https://mosquitto.org/man/mosquitto-8.html")]),t._v(" "),n("p",[t._v("https://github.com/toke/docker-mosquitto/blob/master/config/mosquitto.conf.example")]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("# Place your local configuration in /mqtt/config/conf.d/\npid_file /var/run/mosquitto.pid\n\npersistence true\npersistence_location /mqtt/data/\n\nuser mosquitto\n# Port to use for the default listener.\nport 1883\n\nlog_dest file /mqtt/log/mosquitto.log\nlog_dest stdout\n\ninclude_dir /mqtt/config/conf.d\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br")])]),n("p",[t._v("other case:")]),t._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p /srv/mqtt/config/\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p /srv/mqtt/data/\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p /srv/mqtt/log/\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# place your mosquitto.conf in /srv/mqtt/config/")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# NOTE: You have to change the permissions of the directories")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# to allow the user to read/write to data and log and read from")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# config directory")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# For TESTING purposes you can use chmod -R 777 /srv/mqtt/*")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# Better use "-u" with a valid user id on your docker host')]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Copy the files from the config directory of this project")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# into /src/mqtt/config. Change them as needed for your")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# particular needs.")]),t._v("\n\ndocker run -ti -p "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1883")]),t._v(":1883 -p "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("9001")]),t._v(":9001 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-v /srv/mqtt/config:/mqtt/config:ro "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-v /srv/mqtt/log:/mqtt/log "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-v /srv/mqtt/data/:/mqtt/data/ "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--name mqtt toke/mosquitto\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br")])]),n("h4",{attrs:{id:"参数介绍"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#参数介绍"}},[t._v("#")]),t._v(" 参数介绍")]),t._v(" "),n("p",[t._v("安装成功后，在终端运行mosquitto_sub --help 或 mosquitto_pub —help获取脚本参数说明：")]),t._v(" "),n("p",[t._v("mosquitto_pub参数说明：")]),t._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("-d  打印debug信息\n-f  将指定文件的内容作为发送消息的内容\n-h  指定要连接的域名  默认为localhost\n-i  指定客户端clientid，默认为附加进程ID的mosquitto_pub_\n-I  指定clientId前缀\n-m  消息内容\n-n  发送一个空（null）消息\n-p  连接端口号\n-q  指定QoS的值（0,1,2）\n-t  指定topic\n-u  用户名\n-P  用户密码    \n-V  指定MQTT协议版本\n--will-payload  指定一个消息，该消息当客户端与broker意外断开连接时发出。该参数需要与--will-topic一起使用\n--will-qos  Will的QoS值。该参数需要与--will-topic一起使用\n--will-retain 指定Will消息被当做一个retain消息（即消息被广播后，该消息被保留起来）。该参数需要与--will-topic一起使 用\n--will-topic  用户发送Will消息的topic\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br")])]),n("hr"),t._v(" "),n("p",[t._v("mosquitto_sub参数说明")]),t._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("-c  指定客户端clean_session是否保存。\n-d  打印debug信息\n-h  指定要连接的域名  默认为localhost\n-i   指定客户端clientid\n-I   指定clientId前缀\n-k  keepalive 每隔一段时间，发PING消息通知broker，仍处于连接状态。 默认为60秒.\n-q 指定希望接收到QoS为什么的消息  默认QoS为0\n-R 不显示陈旧的消息\n-t 订阅topic\n-v 打印消息\n--will-payload  指定一个消息，该消息当客户端与broker意外断开连接时发出。该参数需要与--will-topic一起使用\n--will-qos  Will的QoS值。该参数需要与--will-topic一起使用\n--will-retain 指定Will消息被当做一个retain消息（即消息被广播后，该消息被保留起来）。该参数需要与--will-topic一起使"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("用\n--will-topic  用户发送Will消息的topic\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br")])]),n("h4",{attrs:{id:"常用命令"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#常用命令"}},[t._v("#")]),t._v(" 常用命令")]),t._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#订阅主题")]),t._v("\nmosquitto_sub -v -t sensor\n【-t】指定主题，此处为sensor\n【-v】打印更多的调试信息\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#发布内容")]),t._v("\nmosquitto_pub -t sensor -m "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v("\n【-t】指定主题\n【-m】指定消息内容\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("command")]),t._v(" line oper:\nmosquito\nmosquitto_sub -t "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'test/topic'")]),t._v(" -v\nmosquitto_pub -t "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'test/topic'")]),t._v(" -m "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello world'")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" mosquitto-clients \n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#mosquitto [-c config file] [ -d | --daemon ] [-p port number] [-v]")]),t._v("\nmosquitto -c mosquitto.conf //启动\n//1）订阅主题 -v:打印更多调式信息 -t：指定主题，此处为topicTest01\nmosquitto_sub -t topicTest01 -v\n//2）发布内容 -t:指定主题 -m：指定消息内容\nmosquitto_pub -t topicTest01 -m TestMessage\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#mosquitto重启")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("ps")]),t._v(" -aux "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" mosquitto //查看mosquitto的进程并kill掉；\nmosquitto -c /etc/mosquitto/mosquitto.conf -d //启动\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br")])]),n("h4",{attrs:{id:"初始化设置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#初始化设置"}},[t._v("#")]),t._v(" 初始化设置")]),t._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//egg-emqtt默认连接配置")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" mqttClient "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mqtt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("connect")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("host"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    clientId"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("clientId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    username"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("username"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    password"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("password"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    keepalive"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    protocolId"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'MQTT'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    protocolVersion"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    clean"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    reconnectPeriod"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    connectTimeout"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    rejectUnauthorized"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//mqtt && emqx")]),t._v("\nconfig"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mqtt "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    address"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mqtt://127.0.0.1:11883'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    queueSize"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    topic"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'$queue/#'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    option"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        username"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'super_user_client'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        password"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'_this_is_secrect_'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nconfig"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("emqx "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    mgmtBaseUrl"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://127.0.0.1:8080/v3'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    appId"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'egg_iot_with_mqtt'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    appSecret"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Mjg1OTEzMzAyMTI2MzA0NTUzMTkwMjcyMjIzMDg5Nzg2ODI'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br"),n("span",{staticClass:"line-number"},[t._v("28")]),n("br"),n("span",{staticClass:"line-number"},[t._v("29")]),n("br")])]),n("h4",{attrs:{id:"消息封装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#消息封装"}},[t._v("#")]),t._v(" 消息封装")]),t._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("messagePublish")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("topic"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" payload"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _option "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" option "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Object"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("assign")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" qos"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" retain"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _option"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("helper"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("emqxAPI")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("post")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/mqtt/publish'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      topic"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      payload"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      qos"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" option"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("qos"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      retain"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" option"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("retain"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br")])]),n("h4",{attrs:{id:"设备上下线"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#设备上下线"}},[t._v("#")]),t._v(" 设备上下线")]),t._v(" "),n("ul",[n("li",[n("p",[n("strong",[t._v("1:正常的上下线通知都是由客户端主动发送")]),t._v("，即：建立mqtt连接之后的第一条pub消息和断开mqtt连接之前的最后一条pub消息；")])]),t._v(" "),n("li",[n("p",[n("strong",[t._v("2:对于异常断开的连接使用MQTT的遗嘱机制让mqtt broker来自动发送异常下线消息;连接时就得先遗嘱事件；")])])]),t._v(" "),n("li",[n("p",[n("strong",[t._v("3:再加:主动询问是否设备在线;")])])])]),t._v(" "),n("p",[t._v("自带的监听事件，没有带相关信息,没有采用：mosquitto $SYS下topic ： $SYS/broker/clients/connected")]),t._v(" "),n("p",[t._v("实现：")]),t._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("mosquitto_sub "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("will"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("topic cn"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("kinfo"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("device"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("will "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("will"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("payload "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mac:11223344"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("t cn"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("kinfo"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("device"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("will  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("i sub "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("h "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("39.108")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v(".58")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("xxx"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1883")]),t._v("\nmosquitto_sub "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("will"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("topic cn"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("kinfo"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("device"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("will "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("will"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("payload "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mac:11223344"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("t cn"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("kinfo"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("device"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("will "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("h "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("39.108")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v(".58")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("xxx\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//修改后,调整")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("route")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'cn/kinfo/device/will'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" controller"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("devices"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("deviceWill"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//在线,下线,will时,存储到redis hashf类型记录下来;")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" mac"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" macStr "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("req"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("message\n "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" mac "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("helper"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("strToMac")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("macStr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("hset")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'deviceList'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mac"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'{ \"status\": 1 }'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("hdel")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'deviceList'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mac"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//获取设备列表查询下,再返回给接口;")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("index")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" service"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" app "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" res "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" service"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("device"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("listByCtx")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" devices "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" res"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rows\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" device "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("of")]),t._v(" devices"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//主动检查指定设备是否在线")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("emqtt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("publish")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token template-string"}},[n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("cn/kinfo/device/statusCheck/")]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("device"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mac"),n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" qos"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" retain"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("emqtt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("publish")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token template-string"}},[n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("cn/kinfo/")]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("device"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mac"),n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("/status")]),n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" qos"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" retain"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("success")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("res"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//获取当前在线的设备列表:")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" deviceList "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("hgetall")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'deviceList'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" arrList "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("of")]),t._v(" Object"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("entries")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deviceList"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      arrList"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("push")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        mac"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        info"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("parse")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br"),n("span",{staticClass:"line-number"},[t._v("28")]),n("br"),n("span",{staticClass:"line-number"},[t._v("29")]),n("br"),n("span",{staticClass:"line-number"},[t._v("30")]),n("br"),n("span",{staticClass:"line-number"},[t._v("31")]),n("br")])]),n("p",[t._v("**ps:**在kInfo项目中,由于设备没有15s就会息屏,下线断网,不好频繁操作上报,故现在暂时不做处理;最后还是修改了上下线功能；")]),t._v(" "),n("h3",{attrs:{id:"微消息队列-mqtt"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#微消息队列-mqtt"}},[t._v("#")]),t._v(" 微消息队列 MQTT")]),t._v(" "),n("p",[t._v("阿里云，微消息队列 MQTT 是专为物联网（IoT）、移动互联网（MI）领域设计的消息产品，覆盖互动直播、金融支付、智能餐饮、即时聊天、移动 Apps、智能设备、车联网等多种应用场景；通过对 MQTT、WebSocket 等协议的全面支持，连接端和云之间的双向通信，实现 C2C、C2B、B2C 等业务场景之间的消息通信，可支撑千万级设备与消息并发，真正做到万物互联。")]),t._v(" "),n("h3",{attrs:{id:"rocketmq"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#rocketmq"}},[t._v("#")]),t._v(" RocketMQ")]),t._v(" "),n("p",[t._v("RcoketMQ 是一款低延迟、高可靠、可伸缩、易于使用的消息中间件。具有以下特性：")]),t._v(" "),n("ol",[n("li",[t._v("支持发布/订阅（Pub/Sub）和点对点（P2P）消息模型")]),t._v(" "),n("li",[t._v("在一个队列中可靠的先进先出（FIFO）和严格的顺序传递")]),t._v(" "),n("li",[t._v("支持拉（pull）和推（push）两种消息模式")]),t._v(" "),n("li",[t._v("单一队列百万消息的堆积能力")]),t._v(" "),n("li",[t._v("支持多种消息协议，如 JMS、MQTT 等")]),t._v(" "),n("li",[t._v("分布式高可用的部署架构,满足至少一次消息传递语义")]),t._v(" "),n("li",[t._v("提供 docker 镜像用于隔离测试和云集群部署")]),t._v(" "),n("li",[t._v("提供配置、指标和监控等功能丰富的 Dashboard")])]),t._v(" "),n("h4",{attrs:{id:"mqtt-与-rocketmq-的应用场景对比"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#mqtt-与-rocketmq-的应用场景对比"}},[t._v("#")]),t._v(" MQTT 与 RocketMQ 的应用场景对比")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("产品名")]),t._v(" "),n("th",[t._v("适用场景")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("微消息队列 MQTT")]),t._v(" "),n("td",[n("strong",[t._v("面向移动端场景")]),t._v("，移动端场景一般都具备海量设备，单设备数据较少的特点。因此，微消息队列 MQTT 适用于拥有大量在线客户端（很多企业设备端过万，甚至上百万），但每个客户端消息较少的场景。")])]),t._v(" "),n("tr",[n("td",[t._v("消息队列 RocketMQ")]),t._v(" "),n("td",[n("strong",[t._v("面向服务端的消息引擎")]),t._v("，主要用于服务组件之间的解耦、异步通知、削峰填谷等，服务器规模较小（极少企业服务器规模过万），但需要大量的消息处理，吞吐量要求高。因此，消息队列 RocketMQ 适用于服务端进行大批量的数据处理和分析的场景。")])])])]),t._v(" "),n("h2",{attrs:{id:"分析调试工具"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#分析调试工具"}},[t._v("#")]),t._v(" 分析调试工具")]),t._v(" "),n("p",[n("code",[t._v("MQTT-Explorer")])]),t._v(" "),n("p",[n("img",{attrs:{src:a(952),alt:"20-00-41"}})]),t._v(" "),n("h2",{attrs:{id:"参考链接"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#参考链接"}},[t._v("#")]),t._v(" 参考链接")]),t._v(" "),n("p",[t._v("http://mosquitto.org/")]),t._v(" "),n("p",[t._v("http://mosquitto.org/ChangeLog.txt")]),t._v(" "),n("p",[t._v("https://mosquitto.org/man/mosquitto-8.html")]),t._v(" "),n("p",[t._v("https://hub.docker.com/_/eclipse-mosquitto")]),t._v(" "),n("p",[t._v("https://github.com/thomasnordquist/MQTT-Explorer")])])}),[],!1,null,null,null);s.default=e.exports},950:function(t,s,a){t.exports=a.p+"assets/img/18-14-17.9af22eb8.jpg"},951:function(t,s,a){t.exports=a.p+"assets/img/18-15-58.814bc3f4.jpg"},952:function(t,s,a){t.exports=a.p+"assets/img/20-00-41.e5794941.jpg"}}]);