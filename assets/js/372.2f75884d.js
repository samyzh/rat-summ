(window.webpackJsonp=window.webpackJsonp||[]).push([[372],{1935:function(s,t,e){"use strict";e.r(t);var a=e(14),n=Object(a.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h2",{attrs:{id:"项目背景"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#项目背景"}},[s._v("#")]),s._v(" 项目背景")]),s._v(" "),e("p",[s._v("在介绍具体迁移工作前，先简单介绍下项目情况。目前该项目上线不到一年，不太有构建相关的历史遗留债务。项目包含 1897 个模块文件（包括 node_modules 中模块），使用了 vue2 + vuex + typescript 的技术栈，构建工具使用的是 vue-cli（webpack）。算是一套比较标准的 vue 技术栈。由于是内部系统，项目对兼容性的要求较低，用户基本都使用较新的 Chrome 浏览器（少部分使用 Safari）。")]),s._v(" "),e("h2",{attrs:{id:"迁移工作"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#迁移工作"}},[s._v("#")]),s._v(" 迁移工作")]),s._v(" "),e("p",[s._v("下面具体来说下迁移中都做了哪些处理。")]),s._v(" "),e("h3",{attrs:{id:"_1、配置文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1、配置文件"}},[s._v("#")]),s._v(" 1、配置文件")]),s._v(" "),e("p",[s._v("首先需要安装 vite 并创建 vite 的配置文件。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" i -D vite\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("vue-cli-service 中使用 "),e("code",[s._v("vue.config.js")]),s._v(" 作为配置文件；而 vite 则默认会需要创建一个 "),e("code",[s._v("vite.config.ts")]),s._v(" 来作为配置文件。基础的配置文件很简单：")]),s._v(" "),e("div",{staticClass:"language-typescript line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-typescript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" defineConfig "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'vite'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("defineConfig")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  plugins"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("创建该配置文件，之前的 vue.config.js 就不再使用了。")]),s._v(" "),e("h3",{attrs:{id:"_2、入口与-html-文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2、入口与-html-文件"}},[s._v("#")]),s._v(" 2、入口与 HTML 文件")]),s._v(" "),e("p",[s._v("在 vite 中也需要指定入口文件。但和 webpack 不同，在 vite 中不是指定 js/ts 作为入口，而是指定实际的 HTML 文件作为入口。")]),s._v(" "),e("p",[s._v("在 webpack 中，用户通过将 entry 设置为入口 js（例如 "),e("code",[s._v("src/app.js")]),s._v("）来指定 js 打包的入口文件，辅以 HtmlWebpackPlugin 将生成的 js 文件路径注入到 HTML 中。而 vite 直接使用 HTML 文件，它会解析 HTML 中的 script 标签来找到入口的 js 文件。")]),s._v(" "),e("p",[s._v("因此，我们在入口 HTML 中加入对 js/ts 文件的 script 标签引用：")]),s._v(" "),e("div",{staticClass:"language-diff line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[e("span",{pre:!0,attrs:{class:"token deleted-arrow deleted"}},[e("span",{pre:!0,attrs:{class:"token prefix deleted"}},[s._v("<")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("!DOCTYPE html>\n")]),e("span",{pre:!0,attrs:{class:"token prefix deleted"}},[s._v("<")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v('html lang="en">\n')])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token deleted-arrow deleted"}},[e("span",{pre:!0,attrs:{class:"token prefix deleted"}},[s._v("<")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("head>\n")])]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(' <meta charset="utf-8">\n')]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(' <meta http-equiv="X-UA-Compatible" content="IE=edge">\n')]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(' <meta name="viewport" content="width=device-width,initial-scale=1.0">\n')]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" <title><%= htmlWebpackPlugin.options.title %></title>\n")])]),e("span",{pre:!0,attrs:{class:"token deleted-arrow deleted"}},[e("span",{pre:!0,attrs:{class:"token prefix deleted"}},[s._v("<")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("/head>\n")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token deleted-arrow deleted"}},[e("span",{pre:!0,attrs:{class:"token prefix deleted"}},[s._v("<")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("body>\n")])]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" <noscript>\n")]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("   We're sorry but <%= htmlWebpackPlugin.options.title %> doesn't work properly without JavaScript enabled.\n")]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" </noscript>\n")]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(' <div id="app"></div>\n')])]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[s._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(' <script type="module" src="/src/main.ts"><\/script>\n')])]),e("span",{pre:!0,attrs:{class:"token deleted-arrow deleted"}},[e("span",{pre:!0,attrs:{class:"token prefix deleted"}},[s._v("<")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("/body>\n")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token deleted-arrow deleted"}},[e("span",{pre:!0,attrs:{class:"token prefix deleted"}},[s._v("<")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("/html>\n")])]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br")])]),e("p",[s._v("注意上面 "),e("code",[s._v('<script type="module" src="/src/main.ts"><\/script>')]),s._v(" 这一行，它使用浏览器原生的 ESM 来加载该脚本，"),e("code",[s._v("/src/main.ts")]),s._v(" 就是入口 js 的源码位置。在 vite dev 模式启动时，它其实启动了一个类似静态服务器的 server，将 serve 源码目录，因此不需要像 webpack 那样的复杂模块打包过程。模块的依赖加载将完全依托于浏览器中对 "),e("code",[s._v("import")]),s._v(" 语法的处理，因此可以看到很长一串的脚本加载瀑布流：")]),s._v(" "),e("p",[s._v("![img](_image/01.vue-cli 迁移 vite2 实践小结/027b6d2e82584d8da2cb8a32c145fff1~tplv-k3u1fbpfcp-watermark.png)")]),s._v(" "),e("p",[s._v("这里还需要注意 "),e("a",{attrs:{href:"https://vitejs.dev/config/#root",target:"_blank",rel:"noopener noreferrer"}},[s._v("project root 的设置"),e("OutboundLink")],1),s._v("。在默认是 "),e("code",[s._v("process.cwd()")]),s._v("，而 index.html 也会在 project root 下进行寻找。为了方便我将 "),e("code",[s._v("./public/index.html")]),s._v(" 移到了 "),e("code",[s._v("./index.html")]),s._v("。")]),s._v(" "),e("h3",{attrs:{id:"_3、使用-vue-插件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3、使用-vue-插件"}},[s._v("#")]),s._v(" 3、使用 vue 插件")]),s._v(" "),e("p",[s._v("vite 2.0 提供了对 vue 项目的良好支持，但其本身并不和 vue 进行较强耦合，因此通过插件的形式来支持对 vue 技术栈的项目进行构建。vite 2.0 官网目前（2021.2.28）推荐的 vue 插件会和 "),e("a",{attrs:{href:"https://vitejs.dev/plugins/#vitejs-plugin-vue",target:"_blank",rel:"noopener noreferrer"}},[s._v("vue3 的 SFC"),e("OutboundLink")],1),s._v(" 一起使用更好。因此这里使用了一个专门用来支持 vue2 的插件 "),e("a",{attrs:{href:"https://www.npmjs.com/package/vite-plugin-vue2",target:"_blank",rel:"noopener noreferrer"}},[s._v("vite-plugin-vue2"),e("OutboundLink")],1),s._v("，支持 JSX，同时目前最新版本也是"),e("a",{attrs:{href:"https://github.com/underfin/vite-plugin-vue2/pull/13",target:"_blank",rel:"noopener noreferrer"}},[s._v("支持 vite2 的"),e("OutboundLink")],1),s._v("。")]),s._v(" "),e("p",[s._v("使用上也很简单：")]),s._v(" "),e("div",{staticClass:"language-diff line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[s._v("import { defineConfig } from 'vite';\n"),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[s._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" import { createVuePlugin } from 'vite-plugin-vue2';\n")])]),s._v("\nexport default defineConfig({\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" plugins: [\n")])]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[s._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("   createVuePlugin(),\n")])]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" ],\n")])]),s._v("});\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("h3",{attrs:{id:"_4、处理-typescript-路径映射"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4、处理-typescript-路径映射"}},[s._v("#")]),s._v(" 4、处理 typescript 路径映射")]),s._v(" "),e("p",[s._v("使用 vite 构建 ts 项目时，如果使用了 "),e("a",{attrs:{href:"https://www.typescriptlang.org/docs/handbook/module-resolution.html#path-mapping",target:"_blank",rel:"noopener noreferrer"}},[s._v("typescript 路径映射"),e("OutboundLink")],1),s._v("的功能，就需要进行特殊处理，否则会出现模块无法解析（找不到）的错误：")]),s._v(" "),e("p",[s._v("![img](_image/01.vue-cli 迁移 vite2 实践小结/e02cd3966258485abf8ee47461338cc9~tplv-k3u1fbpfcp-watermark.png)")]),s._v(" "),e("p",[s._v("这里需要使用 "),e("a",{attrs:{href:"https://github.com/aleclarson/vite-tsconfig-paths",target:"_blank",rel:"noopener noreferrer"}},[s._v("vite-tsconfig-paths"),e("OutboundLink")],1),s._v(" 这个插件来做路径映射的解析替换。其原理较为简单，大致就是 vite 插件的 "),e("a",{attrs:{href:"https://vitejs.dev/guide/api-plugin.html#universal-hooks",target:"_blank",rel:"noopener noreferrer"}},[s._v("resolveId 钩子"),e("OutboundLink")],1),s._v("阶段，利用 "),e("a",{attrs:{href:"https://www.npmjs.com/package/tsconfig-paths",target:"_blank",rel:"noopener noreferrer"}},[s._v("tsconfig-paths"),e("OutboundLink")],1),s._v(" 这个库来将路径映射解析为实际映射返回。有兴趣的可以看下该插件的实现，比较简短。")]),s._v(" "),e("p",[s._v("具体使用方式如下：")]),s._v(" "),e("div",{staticClass:"language-diff line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[s._v("import { createVuePlugin } from 'vite-plugin-vue2';\n"),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[s._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" import tsconfigPaths from 'vite-tsconfig-paths';\n")])]),s._v("\n// https://vitejs.dev/config/\nexport default defineConfig({\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" plugins: [\n")]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("   createVuePlugin(),\n")])]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[s._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("   tsconfigPaths(),\n")])]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" ],\n")])]),s._v("});\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("h3",{attrs:{id:"_5、替换-commonjs"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5、替换-commonjs"}},[s._v("#")]),s._v(" 5、替换 CommonJS")]),s._v(" "),e("p",[s._v("vite 使用 ESM 作为模块化方案，因此不支持使用 "),e("code",[s._v("require")]),s._v(" 方式来导入模块。否则在运行时会报 "),e("code",[s._v("Uncaught ReferenceError: require is not defined")]),s._v(" 的错误（浏览器并不支持 CJS，自然没有 require 方法注入）。")]),s._v(" "),e("p",[s._v("此外，也可能会遇到 ESM 和 CJS 的兼容问题。当然这并不是 vite 构建所导致的问题，但需要注意这一点。简单来说就是 ESM 有 default 这个概念，而 CJS 没有。任何导出的变量在 CJS 看来都是 module.exports 这个对象上的属性，ESM 的 default 导出也只是 cjs 上的 module.exports.default 属性而已。例如在 typescript 中我们会通过 esModuleInterop 配置来让 tsc 添加一些兼容代码帮助解析导入的模块，webpack 中也有类似操作。")]),s._v(" "),e("p",[s._v("例如之前的代码：")]),s._v(" "),e("div",{staticClass:"language-typescript line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-typescript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("module")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("exports "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("SSO_LOGIN_URL")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://xxx.yyy.com'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("SSO_LOGOUT_URL")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://xxx.yyy.com/cas/logout'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" config "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("require")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'./config'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("在导出和导入上都需要修改为 ESM，例如：")]),s._v(" "),e("div",{staticClass:"language-typescript line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-typescript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("SSO_LOGIN_URL")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://xxx.yyy.com'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("SSO_LOGOUT_URL")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://xxx.yyy.com/cas/logout'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" config "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'./config'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("h3",{attrs:{id:"_6、环境变量的使用方式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6、环境变量的使用方式"}},[s._v("#")]),s._v(" 6、环境变量的使用方式")]),s._v(" "),e("p",[s._v("使用 vue-cli（webpack）时我们经常会利用环境变量来做运行时的代码判断，例如：")]),s._v(" "),e("div",{staticClass:"language-typescript line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-typescript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("REPORTER_HOST")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" process"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("env"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("REPORTER_TYPE")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mock'")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http://mock-report.xxx.com'")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http://report.xxx.com'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n复制代码\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[e("a",{attrs:{href:"https://vitejs.dev/guide/env-and-mode.html#env-variables",target:"_blank",rel:"noopener noreferrer"}},[s._v("vite 仍然支持环境变量"),e("OutboundLink")],1),s._v("的使用，但不再提供 "),e("code",[s._v("process.env")]),s._v(" 这样的访问方式。而是需要通过 "),e("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/import.meta",target:"_blank",rel:"noopener noreferrer"}},[e("code",[s._v("import.meta.env")]),e("OutboundLink")],1),s._v(" 来访问环境变量：")]),s._v(" "),e("div",{staticClass:"language-diff line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[e("span",{pre:!0,attrs:{class:"token deleted-sign deleted"}},[e("span",{pre:!0,attrs:{class:"token prefix deleted"}},[s._v("-")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("const REPORTER_HOST = process.env.REPORTER_TYPE === 'mock'\n")])]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[s._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("const REPORTER_HOST = import.meta.env.REPORTER_TYPE === 'mock'\n")])]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" ? 'http://mock-report.xxx.com'\n")]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" : 'http://report.xxx.com';\n")])]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("与 webpack 类似，vite 也"),e("a",{attrs:{href:"https://vitejs.dev/guide/env-and-mode.html#env-variables",target:"_blank",rel:"noopener noreferrer"}},[s._v("内置了一些环境变量"),e("OutboundLink")],1),s._v("，可以直接使用。")]),s._v(" "),e("h3",{attrs:{id:"_7、import-meta-env-types"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7、import-meta-env-types"}},[s._v("#")]),s._v(" 7、"),e("code",[s._v("import.meta.env")]),s._v(" types")]),s._v(" "),e("blockquote",[e("p",[s._v("补充：vite 提供了它所需要的 types 定义，可以直接应用 "),e("a",{attrs:{href:"https://github.com/vitejs/vite/blob/v2.0.3/packages/vite/client.d.ts",target:"_blank",rel:"noopener noreferrer"}},[s._v("vite/client"),e("OutboundLink")],1),s._v(" 来引入，可以不需要通过以下方式来自己添加。")])]),s._v(" "),e("p",[s._v("如果在 typescript 中通过 "),e("a",{attrs:{href:"https://github.com/microsoft/TypeScript/issues/22861",target:"_blank",rel:"noopener noreferrer"}},[e("code",[s._v("import.meta.env")]),e("OutboundLink")],1),s._v(" 来访问环境变量，可能会有一个 ts 错误提示："),e("code",[s._v("类型“ImportMeta”上不存在属性“env”")]),s._v("。")]),s._v(" "),e("p",[s._v("![img](_image/01.vue-cli 迁移 vite2 实践小结/843da2e11495450c99a016162eef34b9~tplv-k3u1fbpfcp-watermark.png)")]),s._v(" "),e("p",[s._v("这是因为在目前版本下（v4.2.2）"),e("code",[s._v("import.meta")]),s._v(" 的定义还是一个"),e("a",{attrs:{href:"https://github.com/microsoft/TypeScript/blob/v4.2.2/lib/lib.es5.d.ts#L608-L615",target:"_blank",rel:"noopener noreferrer"}},[s._v("空的 interface"),e("OutboundLink")],1),s._v("：")]),s._v(" "),e("div",{staticClass:"language-typescript line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-typescript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("interface")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ImportMeta")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("但我们可以通过 interface 的 merge 能力，在项目中进一步定义 ImportMeta 的类型来拓展对 "),e("code",[s._v("import.meta.env")]),s._v(" 的类型支持。例如之前通过 vue-cli 生成的 ts 项目在 src 目录下会生成 "),e("code",[s._v("vue-shims.d.ts")]),s._v(" 文件，可以在这里拓展 env 类型的支持：")]),s._v(" "),e("div",{staticClass:"language-typescript line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-typescript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("declare")]),s._v(" global "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("interface")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ImportMeta")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    env"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Record"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),e("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("unknown")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("这样就不会报错了。")]),s._v(" "),e("p",[s._v("![img](_image/01.vue-cli 迁移 vite2 实践小结/39edd2d0b00b491796fc8a6403f00457~tplv-k3u1fbpfcp-watermark.png)")]),s._v(" "),e("h3",{attrs:{id:"_8、webpack-require-context"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8、webpack-require-context"}},[s._v("#")]),s._v(" 8、webpack require context")]),s._v(" "),e("p",[s._v("在 webpack 中我们可以通过 "),e("a",{attrs:{href:"https://webpack.js.org/api/module-methods/#requirecontext",target:"_blank",rel:"noopener noreferrer"}},[e("code",[s._v("require.context")]),e("OutboundLink")],1),s._v(" 方法「动态」解析模块。比较常用的一个做法就是指定某个目录，通过正则匹配等方式加载某些模块，这样在后续增加新的模块后，可以起到「动态自动导入」的效果。")]),s._v(" "),e("p",[s._v("例如在项目中，我们动态匹配 modules 文件夹下的 route.ts 文件，在全局的 vue-router 中设置 router 配置：")]),s._v(" "),e("div",{staticClass:"language-typescript line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-typescript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" routes "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("require")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("context")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'./modules'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token regex"}},[e("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[s._v("/")]),e("span",{pre:!0,attrs:{class:"token regex-source language-regex"}},[s._v("([\\w\\d-]+)\\/routes\\.ts")]),e("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[s._v("/")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("keys")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("map")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("context")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("map")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("mod "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" mod"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("__esModule "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),s._v(" mod"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" mod"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("reduce")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pre"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" list"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("pre"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("list"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("VueRouter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" routes "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("文件结构如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("src/modules\n├── admin\n│   ├── pages\n│   └── routes.ts\n├── alert\n│   ├── components\n│   ├── pages\n│   ├── routes.ts\n│   ├── store.ts\n│   └── utils\n├── environment\n│   ├── store\n│   ├── types\n│   └── utils\n└── service\n    ├── assets\n    ├── pages\n    ├── routes.ts\n    ├── store\n    └── types\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br")])]),e("p",[s._v("require context 是 webpack 提供的特有的模块方法，并不是语言标准，所以在 vite 中不再能使用 require context。但如果完全改为开发者手动 import 模块，一来是对已有代码改动容易产生模块导入的遗漏；二来是放弃了这种「灵活」的机制，对后续的开发模式也会有一定改变。但好在 vite2.0 提供了 "),e("a",{attrs:{href:"https://vitejs.dev/guide/features.html#glob-import",target:"_blank",rel:"noopener noreferrer"}},[s._v("glob 模式的模块导入"),e("OutboundLink")],1),s._v("。该功能可以实现上述目标。当然，会需要做一定的代码改动：")]),s._v(" "),e("div",{staticClass:"language-typescript line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-typescript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" routesModules "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("meta"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token generic-function"}},[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("globEager")]),e("span",{pre:!0,attrs:{class:"token generic class-name"}},[e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("unknown")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")])])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'./modules/**/routes.ts'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" routes "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Object\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("keys")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("routesModules"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token generic-function"}},[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("reduce")]),e("span",{pre:!0,attrs:{class:"token generic class-name"}},[e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),e("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("any")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")])])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pre"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" k"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("pre"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("routesMod"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("k"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("VueRouter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" routes "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n复制代码\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("主要就是将 "),e("code",[s._v("require.context")]),s._v(" 改为 "),e("code",[s._v("import.meta.globEager")]),s._v("，同时适配返回值类型。当然，为了支持 types，可以为 ImportMeta 接口添加一些类型：")]),s._v(" "),e("div",{staticClass:"language-diff line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[s._v("declare global {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" interface ImportMeta {\n")]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("   env: Record<string, unknown>;\n")])]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[s._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("   globEager<T = unknown>(globPath: string): Record<string, T>;\n")])]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" }\n")])]),s._v("}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("此外再提一下，"),e("code",[s._v("import.meta.globEager")]),s._v(" 会在构建时做静态分析将代码替换为静态 import 语句。如果希望能支持 dynamic import，请使用 "),e("code",[s._v("import.meta.glob")]),s._v(" 方法。")]),s._v(" "),e("h3",{attrs:{id:"_9、api-代理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_9、api-代理"}},[s._v("#")]),s._v(" 9、API 代理")]),s._v(" "),e("p",[s._v("vite2.0 本地开发时（DEV 模式）仍然提供了一个 HTTP server，同时也支持"),e("a",{attrs:{href:"https://vitejs.dev/config/#server-proxy",target:"_blank",rel:"noopener noreferrer"}},[s._v("通过 proxy 项设置代理"),e("OutboundLink")],1),s._v("。其背后和 webpack 一样也是使用了 "),e("a",{attrs:{href:"https://github.com/http-party/node-http-proxy",target:"_blank",rel:"noopener noreferrer"}},[s._v("http-proxy"),e("OutboundLink")],1),s._v("，因此针对 vue-cli 的 proxy 设置可以迁移到 vite 中：")]),s._v(" "),e("div",{staticClass:"language-diff line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[s._v("import { defineConfig } from 'vite';\nimport tsconfigPaths from 'vite-tsconfig-paths';\nimport { createVuePlugin } from 'vite-plugin-vue2';\n"),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[s._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" import proxy from './src/tangram/proxy-table';\n")])]),s._v("\nexport default defineConfig({\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" plugins: [\n")]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("   tsconfigPaths(),\n")]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("   createVuePlugin(),\n")]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" ],\n")])]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[s._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" server: {\n")]),e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[s._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("   proxy,\n")]),e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[s._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" }\n")])]),s._v("});\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("h3",{attrs:{id:"_10、html-内容插入"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_10、html-内容插入"}},[s._v("#")]),s._v(" 10、HTML 内容插入")]),s._v(" "),e("p",[s._v("在基于 vue-cli 中我们可以利用 webpack 的 HtmlWebpackPlugin 来实现 HTML 中值的替换，例如 "),e("code",[s._v("<%= htmlWebpackPlugin.options.title %>")]),s._v(" 这种形式来将该处模板变量在编译时，替换为实际的 title 值。要实现这样的功能也非常简单，例如 "),e("a",{attrs:{href:"https://www.npmjs.com/package/vite-plugin-html",target:"_blank",rel:"noopener noreferrer"}},[s._v("vite-plugin-html"),e("OutboundLink")],1),s._v(" 。这个插件基于 ejs 来实现模板变量注入，通过 "),e("code",[s._v("transformIndexHtml")]),s._v(" 钩子，接收原始 HTML 字符串，然后通过 ejs 渲染注入的变量后返回。")]),s._v(" "),e("p",[s._v("下面是迁移后，使用 vite-plugin-html 的配置方式：")]),s._v(" "),e("div",{staticClass:"language-diff line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[s._v("import { defineConfig } from 'vite';\nimport tsconfigPaths from 'vite-tsconfig-paths';\nimport { createVuePlugin } from 'vite-plugin-vue2';\n"),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[s._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" import { injectHtml } from 'vite-plugin-html';\n")])]),s._v("\nexport default defineConfig({\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" plugins: [\n")]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("   tsconfigPaths(),\n")]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("   createVuePlugin(),\n")])]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[s._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("   injectHtml({\n")]),e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[s._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("     injectData: {\n")]),e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[s._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("       title: '用户管理系统',\n")]),e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[s._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("     },\n")])]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("   }),\n")]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" ],\n")]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" server: {\n")]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("   proxy,\n")]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" },\n")])]),s._v("});\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br")])]),e("p",[s._v("对应的需求修改一下 HTML 的模板变量写法：")]),s._v(" "),e("div",{staticClass:"language-diff line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[e("span",{pre:!0,attrs:{class:"token deleted-arrow deleted"}},[e("span",{pre:!0,attrs:{class:"token prefix deleted"}},[s._v("<")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("!DOCTYPE html>\n")]),e("span",{pre:!0,attrs:{class:"token prefix deleted"}},[s._v("<")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v('html lang="en">\n')])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token deleted-arrow deleted"}},[e("span",{pre:!0,attrs:{class:"token prefix deleted"}},[s._v("<")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("head>\n")])]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(' <meta charset="utf-8">\n')]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(' <meta http-equiv="X-UA-Compatible" content="IE=edge">\n')]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(' <meta name="viewport" content="width=device-width,initial-scale=1.0">\n')])]),e("span",{pre:!0,attrs:{class:"token deleted-sign deleted"}},[e("span",{pre:!0,attrs:{class:"token prefix deleted"}},[s._v("-")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" <title><%= htmlWebpackPlugin.options.title %></title>\n")])]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[s._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" <title><%= title %></title>\n")])]),e("span",{pre:!0,attrs:{class:"token deleted-arrow deleted"}},[e("span",{pre:!0,attrs:{class:"token prefix deleted"}},[s._v("<")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("/head>\n")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token deleted-arrow deleted"}},[e("span",{pre:!0,attrs:{class:"token prefix deleted"}},[s._v("<")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("body>\n")])]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" <noscript>\n")])]),e("span",{pre:!0,attrs:{class:"token deleted-sign deleted"}},[e("span",{pre:!0,attrs:{class:"token prefix deleted"}},[s._v("-")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("   We're sorry but <%= htmlWebpackPlugin.options.title %> doesn't work properly without JavaScript enabled.\n")])]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[s._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("   We're sorry but <%= title %> doesn't work properly without JavaScript enabled.\n")])]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(" </noscript>\n")]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(' <div id="app"></div>\n')]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[s._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v(' <script type="module" src="/src/main.ts"><\/script>\n')])]),e("span",{pre:!0,attrs:{class:"token deleted-arrow deleted"}},[e("span",{pre:!0,attrs:{class:"token prefix deleted"}},[s._v("<")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("/body>\n")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token deleted-arrow deleted"}},[e("span",{pre:!0,attrs:{class:"token prefix deleted"}},[s._v("<")]),e("span",{pre:!0,attrs:{class:"token line"}},[s._v("/html>\n")])]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br")])]),e("h3",{attrs:{id:"_11、兼容性处理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_11、兼容性处理"}},[s._v("#")]),s._v(" 11、兼容性处理")]),s._v(" "),e("p",[s._v("在项目背景介绍上有提到该项目对兼容性要求很低，所以这块在迁移中实际并未涉及。")]),s._v(" "),e("p",[s._v("当然，如果对兼容性有要求的项目，可以使用 "),e("a",{attrs:{href:"https://github.com/vitejs/vite/tree/main/packages/plugin-legacy",target:"_blank",rel:"noopener noreferrer"}},[s._v("@vitejs/plugin-legacy"),e("OutboundLink")],1),s._v(" 插件。该插件会打包出两套代码，一套面向新式浏览器，另一套则包含各类 polyfill 和语法兼容来面向老式浏览器。同时在 HTML 中使用 "),e("a",{attrs:{href:"https://philipwalton.com/articles/using-native-javascript-modules-in-production-today/",target:"_blank",rel:"noopener noreferrer"}},[s._v("module/nomodule 技术"),e("OutboundLink")],1),s._v("来实现新/老浏览器中的「条件加载」。")]),s._v(" "),e("h2",{attrs:{id:"总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),e("p",[s._v("该项目包含 1897 个模块文件（包括 node_modules 中模块），迁移前后的构建（无缓存）耗时如下：")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th"),s._v(" "),e("th",[s._v("vue-cli")]),s._v(" "),e("th",[s._v("vite 2")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("dev 模式")]),s._v(" "),e("td",[s._v("~8s")]),s._v(" "),e("td",[s._v("~400ms")])]),s._v(" "),e("tr",[e("td",[s._v("prod 模式")]),s._v(" "),e("td",[s._v("~42s")]),s._v(" "),e("td",[s._v("~36s")])])])]),s._v(" "),e("p",[s._v("可以看到，在 DEV 模式下 vite2 构建效率的提升非常明显，这也是因为其在 DEV 模式下只做一些轻量级模块文件处理，不会做较重的打包工作，而在生产模式下，由于仍然需要使用 esbuild 和 rollup 做构建，所以在该项目中效率提升并不明显。")]),s._v(" "),e("h2",{attrs:{id:"参考链接"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考链接"}},[s._v("#")]),s._v(" 参考链接")]),s._v(" "),e("p",[s._v("https://juejin.cn/post/6934316962952544269")]),s._v(" "),e("p",[s._v("https://vitejs.dev/guide/env-and-mode.html#production-replacement")])])}),[],!1,null,null,null);t.default=n.exports}}]);