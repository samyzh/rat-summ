(window.webpackJsonp=window.webpackJsonp||[]).push([[429],{2041:function(s,a,e){"use strict";e.r(a);var t=e(14),n=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h2",{attrs:{id:"场景"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#场景"}},[s._v("#")]),s._v(" 场景")]),s._v(" "),e("p",[s._v("Vue项目运行时服务突然停止(Node内存溢出),需要重新npm run dev. OOM报错；")]),s._v(" "),e("p",[e("code",[s._v("FATAL ERROR: Ineffective mark-compacts near heap limit Allocation failed - JavaScript heap out of memory")])]),s._v(" "),e("h2",{attrs:{id:"分析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#分析"}},[s._v("#")]),s._v(" 分析")]),s._v(" "),e("p",[s._v("在Node中通过JavaScript使用内存时只能使用部分内存（64位系统：1.4 GB，32位系统：0.7 GB）；")]),s._v(" "),e("p",[s._v("这个时候，如果前端项目非常的庞大，Webpack编译时就会占用很多的系统资源，如果超出了V8引擎对Node默认的内存限制大小时，就会产生内存泄露(JavaScript heap out of memory)的错误；")]),s._v(" "),e("h3",{attrs:{id:"产生的常见原因"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#产生的常见原因"}},[s._v("#")]),s._v(" 产生的常见原因")]),s._v(" "),e("ol",[e("li",[s._v("全局变量引起的内存泄漏")]),s._v(" "),e("li",[s._v("闭包引起的内存泄漏")]),s._v(" "),e("li",[s._v("dom清空或删除时，事件未清除导致的内存泄漏")]),s._v(" "),e("li",[s._v("被遗忘的计时器或回调函数")])]),s._v(" "),e("h3",{attrs:{id:"调试方法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#调试方法"}},[s._v("#")]),s._v(" 调试方法")]),s._v(" "),e("p",[s._v("打开f12进入Memory，选中heap snapshot（堆快照），每进行一次操作就点一下左上角圆点，比较两次内存有没有回收，若有， 找到引用的这个对象，手动GC就好啦\n参考："),e("a",{attrs:{href:"https://links.jianshu.com/go?to=https%3A%2F%2Fblog.csdn.net%2Fweixin_38098195%2Farticle%2Fdetails%2F81135137",target:"_blank",rel:"noopener noreferrer"}},[s._v("一个Vue页面的内存泄露分析"),e("OutboundLink")],1)]),s._v(" "),e("h2",{attrs:{id:"解决方法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#解决方法"}},[s._v("#")]),s._v(" 解决方法")]),s._v(" "),e("h3",{attrs:{id:"升级最新nodejs版本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#升级最新nodejs版本"}},[s._v("#")]),s._v(" 升级最新nodejs版本")]),s._v(" "),e("p",[s._v("从现在的"),e("code",[s._v("node10x")]),s._v("升级到"),e("code",[s._v("node14x")])]),s._v(" "),e("h3",{attrs:{id:"max-old-space-size-推荐"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#max-old-space-size-推荐"}},[s._v("#")]),s._v(" max_old_space_size[推荐]")]),s._v(" "),e("h4",{attrs:{id:"直接覆盖node"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#直接覆盖node"}},[s._v("#")]),s._v(" 直接覆盖node")]),s._v(" "),e("p",[s._v("简单粗暴，直接在package.json替换scripts下的serve指令内容：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"serve"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node --max_old_space_size=10240 node_modules/.bin/vue-cli-service serve --open"')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("div",{staticClass:"language-json line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[s._v('"scripts"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[s._v('"dev"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node --max_old_space_size=5120 ./node_modules/.bin/vuepress dev docs"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[s._v('"build"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node --max_old_space_size=5120 ./node_modules/.bin/vuepress build docs"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n     "),e("span",{pre:!0,attrs:{class:"token property"}},[s._v('"build"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node --max_old_space_size=5120 ./node_modules/.bin/umi build"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("开发时运行npm run serve或yarn serve即可。")]),s._v(" "),e("p",[s._v("在"),e("code",[s._v("git action")]),s._v("上设置有用；推荐；")]),s._v(" "),e("h4",{attrs:{id:"优雅的覆盖npx-优先"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#优雅的覆盖npx-优先"}},[s._v("#")]),s._v(" 优雅的覆盖npx[优先]")]),s._v(" "),e("p",[s._v("和以上的方法唯一的不同，就是不需要编写vue-cli-service包的路径，代码更优雅，也不受包地址的影响。")]),s._v(" "),e("p",[s._v("全局安装npx: "),e("code",[s._v("npm i -g npx")]),s._v("  直接在package.json替换scripts下的serve指令内容：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"serve"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"npx --max_old_space_size=5120 vue-cli-service serve"')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("开发时运行npm run serve或yarn serve即可。")]),s._v(" "),e("h4",{attrs:{id:"特殊情况"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#特殊情况"}},[s._v("#")]),s._v(" 特殊情况")]),s._v(" "),e("p",[s._v("现在线上现场版本，又是通过jks构建的项目；不方便修复老版本的话；")]),s._v(" "),e("p",[e("strong",[s._v("可以用脚本的方式，hack一个新的package.json文件；")])]),s._v(" "),e("blockquote",[e("p",[s._v("解决目前jks构建时，OOM方案")])]),s._v(" "),e("p",[s._v("先执行拷贝")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" ./jks-hack-pkg.sh\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("jks配置调用pkg.json；非特殊情况下，不要使用")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("/zbak/package.json ./package.json\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("目前的原理就是替换构建命令脚本")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"build"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node --max_old_space_size=5120 ./node_modules/.bin/umi build"')]),s._v(",\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"increase-memory-limit"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#increase-memory-limit"}},[s._v("#")]),s._v(" increase-memory-limit")]),s._v(" "),e("blockquote",[e("p",[s._v("因为V8引擎有对Node进行默认的内存限制大小，那么在Node内存不足的时候，可以放宽内存大小的使用限制，可以在Node启动的时候，传递–max-old-space-size或–max-new-space-size来调整内存大小的使用限制。\n但是这种方式需要所有地方都要进行设置，因此需要安装一个插件increase-memory-limit。")])]),s._v(" "),e("p",[s._v("在"),e("code",[s._v("linux")]),s._v("上设置没有用；会死循环，本地"),e("code",[s._v("mac,win")]),s._v("可以用；")]),s._v(" "),e("h4",{attrs:{id:"全局安装方式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#全局安装方式"}},[s._v("#")]),s._v(" 全局安装方式")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -g increase-memory-limit\n$ "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" yourProject\n$ increase-memory-limit\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h4",{attrs:{id:"项目安装方式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#项目安装方式"}},[s._v("#")]),s._v(" 项目安装方式")]),s._v(" "),e("p",[s._v("如果脚本中没有暴露node命令; 在package.json里修改")]),s._v(" "),e("div",{staticClass:"language-json line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[s._v("“scripts”"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  “fixML”"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" “cross-env LIMIT="),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("5120")]),s._v(" increase-memory-limit”，\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[s._v('"build"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"npm run fixML && vuepress build docs"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n“devDependencies”"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[s._v('"cross-env"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"^7.0.3"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   "),e("span",{pre:!0,attrs:{class:"token property"}},[s._v('"increase-memory-limit"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"^1.0.7"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("执行一次 "),e("code",[s._v("npm run fixML")])])])}),[],!1,null,null,null);a.default=n.exports}}]);